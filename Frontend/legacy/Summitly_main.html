<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summitly AI - Production Real Estate Assistant | OpenAI Powered</title>
    <style>
        :root {
            --color-primary: #33808d;
            --color-primary-hover: #1d7480;
            --color-primary-active: #1a6873;
            --color-primary-dark: #165966;
            --color-bg-primary: #e8f4f8;
            --color-bg-secondary: #d4eaf0;
            --color-surface: #ffffff;
            --color-text: #134252;
            --color-text-secondary: #626c71;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-success: #33808d;
            --color-error: #c0152f;
            --color-warning: #a84b2f;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.06), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 12px;
            --radius-full: 9999px;
            --font-base: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Force light theme - disable dark mode */
        /* @media (prefers-color-scheme: dark) {
            :root {
                --color-bg-primary: #1f2121;
                --color-bg-secondary: #262828;
                --color-surface: #2a2c2c;
                --color-text: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-border: rgba(119, 124, 124, 0.3);
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-primary-active: #2996a1;
            }
        } */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-base);
            background: var(--color-bg-primary);
            color: var(--color-text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1920px;
            margin: 0 auto;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--color-border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            margin: 16px 0;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .new-chat-btn:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .quick-actions {
            padding: 0 20px;
            flex: 1;
            overflow-y: auto;
        }

        .quick-actions h3 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .action-card {
            padding: 12px;
            margin-bottom: 8px;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-card:hover {
            background: var(--color-bg-secondary);
            border-color: var(--color-primary);
            transform: translateX(4px);
        }

        .action-card-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text);
            margin-bottom: 4px;
        }

        .action-card-desc {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .filter-chip {
            padding: 6px 12px;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-chip:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--color-bg-secondary);
        }

        .chat-header {
            padding: 20px 24px;
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(51, 128, 141, 0.1);
            border: 1px solid rgba(51, 128, 141, 0.25);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
            color: var(--color-primary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--color-success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text);
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: var(--color-bg-primary);
            border-color: var(--color-primary);
        }

        /* Chat Messages */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--color-text-secondary);
            max-width: 600px;
            margin-bottom: 32px;
        }

        .suggestion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            max-width: 800px;
            width: 100%;
        }

        .suggestion-card {
            padding: 20px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .suggestion-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .suggestion-icon {
            font-size: 24px;
            margin-bottom: 12px;
        }

        .suggestion-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .suggestion-desc {
            font-size: 13px;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        .message {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .user-avatar {
            background: var(--color-primary);
            color: white;
        }

        .ai-avatar {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
        }

        .message-content {
            flex: 1;
            max-width: 800px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .message-author {
            font-weight: 600;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .message-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--color-text);
        }

        .message-text p {
            margin-bottom: 12px;
        }

        .message-text ul, .message-text ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .message-text li {
            margin-bottom: 6px;
        }

        .message-text strong {
            font-weight: 600;
            color: var(--color-text);
        }

        /* Ensure images and HTML content render properly in messages */
        .message-text img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .message-text > div {
            width: 100%;
        }

        .message-text button {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px;
            background: var(--color-surface);
            border-radius: var(--radius-md);
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--color-text-secondary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .property-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-top: 12px;
            transition: all 0.3s ease;
        }

        .property-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .property-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--color-bg-primary);
        }

        .property-details {
            padding: 16px;
        }

        .property-price {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .property-address {
            font-size: 15px;
            color: var(--color-text);
            margin-bottom: 12px;
        }

        .property-specs {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .property-spec {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .property-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .btn-small {
            padding: 8px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 13px;
            cursor: pointer;
            background: transparent;
            color: var(--color-text);
            transition: all 0.2s ease;
        }

        .btn-small:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .quick-reply-btn {
            padding: 8px 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-reply-btn:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .source-links {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .source-link {
            padding: 6px 12px;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 12px;
            color: var(--color-primary);
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .source-link:hover {
            background: var(--color-primary);
            color: white;
        }

        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            max-width: 1000px;
            margin: 0 auto;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 14px 120px 14px 16px;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            font-size: 15px;
            font-family: var(--font-base);
            color: var(--color-text);
            resize: none;
            max-height: 200px;
            transition: all 0.2s ease;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(51, 128, 141, 0.1);
        }

        .input-actions {
            position: absolute;
            right: 8px;
            bottom: 8px;
            display: flex;
            gap: 4px;
        }

        .input-icon-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-secondary);
            transition: all 0.2s ease;
        }

        .input-icon-btn:hover {
            background: var(--color-bg-secondary);
            color: var(--color-primary);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            background: var(--color-primary);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
        }

        .send-btn:hover {
            background: var(--color-primary-hover);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Structured List Response Styles */
        .structured-list-response .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(51, 128, 141, 0.15) !important;
            border-color: rgba(51, 128, 141, 0.3) !important;
        }

        .structured-list-response .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
        }

        @media (max-width: 768px) {
            .structured-list-response .items-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        /* Voice Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .voice-visualizer {
            width: 100%;
            height: 100px;
            background: var(--color-bg-primary);
            border-radius: var(--radius-md);
            margin: 24px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .voice-bar {
            width: 4px;
            background: var(--color-primary);
            border-radius: 2px;
            animation: voiceWave 1s infinite ease-in-out;
        }

        .voice-bar:nth-child(1) { height: 20px; animation-delay: 0s; }
        .voice-bar:nth-child(2) { height: 40px; animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { height: 60px; animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { height: 40px; animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { height: 20px; animation-delay: 0.4s; }

        @keyframes voiceWave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }

        .voice-controls {
            display: flex;
            gap: 12px;
        }

        .voice-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .voice-btn-primary {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .voice-btn-primary:hover {
            background: var(--color-primary-hover);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 999;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .suggestion-grid {
                grid-template-columns: 1fr;
            }

            .chat-header {
                padding: 16px;
            }

            .chat-container {
                padding: 16px;
            }

            .input-area {
                padding: 12px;
            }
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-top: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload-area:hover {
            border-color: var(--color-primary);
            background: var(--color-bg-primary);
        }

        .file-preview {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .file-preview-item {
            padding: 8px 12px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remove-file {
            cursor: pointer;
            color: var(--color-error);
        }

        /* Valuation Card Styles */
        .valuation-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin: 16px 0;
            border: 1px solid var(--color-border);
        }

        .valuation-header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: 24px;
        }

        .valuation-title {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 8px 0;
        }

        .valuation-subtitle {
            font-size: 14px;
            opacity: 0.95;
            margin: 0;
        }

        .valuation-body {
            padding: 24px;
        }

        .valuation-section {
            margin-bottom: 28px;
        }

        .valuation-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            font-size: 18px;
        }

        /* Property Info Grid */
        .property-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            background: var(--color-bg-secondary);
            padding: 16px;
            border-radius: var(--radius-md);
        }

        .property-info-item {
            display: flex;
            flex-direction: column;
        }

        .property-info-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .property-info-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
        }

        /* Valuation Stats */
        .valuation-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: var(--color-bg-secondary);
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }

        .stat-label {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .stat-sublabel {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .confidence-bar-container {
            margin-top: 8px;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: rgba(51, 128, 141, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-success) 100%);
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        /* Market Data */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .market-item {
            background: var(--color-bg-secondary);
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }

        .market-item-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 6px;
        }

        .market-item-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
        }

        /* Comparable Properties */
        .comparables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .comparable-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 16px;
            transition: all 0.2s ease;
        }

        .comparable-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .comparable-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .comparable-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .comparable-similarity {
            font-size: 12px;
            background: var(--color-success);
            color: white;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-weight: 600;
        }

        .comparable-address {
            font-size: 13px;
            color: var(--color-text);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .comparable-specs {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .comparable-spec {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Metadata */
        .valuation-metadata {
            background: var(--color-bg-secondary);
            padding: 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }

        .metadata-item {
            margin-bottom: 6px;
        }

        .metadata-item:last-child {
            margin-bottom: 0;
        }

        .metadata-label {
            font-weight: 600;
            color: var(--color-text);
        }

        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-high {
            background: rgba(39, 174, 96, 0.1);
            color: var(--color-success);
        }

        .badge-medium {
            background: rgba(243, 156, 18, 0.1);
            color: var(--color-warning);
        }

        .badge-low {
            background: rgba(231, 76, 60, 0.1);
            color: var(--color-error);
        }

        /* OpenAI Enhancement Badge */
        .openai-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
            animation: shimmer 2s infinite;
        }

        .openai-badge::before {
            content: "âœ¨";
            font-size: 14px;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .message-content.openai-enhanced {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.05) 0%, rgba(255, 165, 0, 0.05) 100%);
            border-left: 3px solid #FFD700;
            padding-left: 15px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .valuation-stats,
            .market-grid,
            .comparables-grid {
                grid-template-columns: 1fr;
            }

            .property-info-grid {
                grid-template-columns: 1fr;
            }

            .valuation-header {
                padding: 20px;
            }

            .valuation-body {
                padding: 20px;
            }

            .stat-value {
                font-size: 24px;
            }
        }

        /* Additional Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(0.95);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        /* AI Analysis Side Panel */
        .ai-analysis-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 500px;
            height: 100vh;
            background: var(--color-surface);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .ai-analysis-panel.open {
            transform: translateX(0);
        }

        .ai-panel-header {
            padding: 24px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
        }

        .ai-panel-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .ai-panel-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: background 0.2s;
        }

        .ai-panel-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .ai-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .ai-analyzing {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .ai-analyzing-icon {
            font-size: 48px;
            animation: pulse 1.5s ease-in-out infinite;
            margin-bottom: 20px;
        }

        .ai-analyzing-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 24px;
        }

        .ai-analyzing-sources {
            width: 100%;
            max-width: 400px;
        }

        .ai-source-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            animation: shimmer 2s linear infinite;
            background: linear-gradient(90deg, 
                var(--color-bg-secondary) 0%, 
                rgba(51, 128, 141, 0.1) 50%, 
                var(--color-bg-secondary) 100%);
            background-size: 2000px 100%;
        }

        .ai-source-icon {
            font-size: 20px;
        }

        .ai-source-text {
            flex: 1;
            font-size: 14px;
            color: var(--color-text);
        }

        .ai-source-status {
            font-size: 12px;
            color: var(--color-success);
        }

        /* Property Search Grid */
        .property-search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin: 16px 0;
        }

        .property-search-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .property-search-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }

        .property-image-container {
            width: 100%;
            height: 200px;
            overflow: hidden;
            background: var(--color-bg-primary);
        }

        .property-no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--color-text-secondary);
        }

        .loading-address {
            color: var(--color-text-secondary);
            font-style: italic;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Button Styles */
        .btn-small {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary {
            background: var(--color-bg-secondary);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-border);
        }

        /* Carousel Controls */
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .carousel-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .carousel-btn.prev {
            left: 12px;
        }

        .carousel-btn.next {
            right: 12px;
        }

        .image-counter {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }

        .property-image-carousel {
            position: relative;
        }

        /* File Upload Styles */
        .file-upload-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: 32px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-zone:hover {
            border-color: var(--color-primary);
            background: var(--color-bg-secondary);
        }

        .upload-btn {
            padding: 12px 24px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-top: 16px;
            transition: all 0.2s ease;
        }

        .upload-btn:hover {
            background: var(--color-primary-hover);
        }

        /* Property Details Modal Styles */
        .property-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .property-details-content {
            background: var(--color-bg-primary);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
        }

        .modal-close-btn:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }

        .property-loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text);
        }

        .property-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .property-details-body {
            padding: 24px;
        }

        /* Property Carousel Styles */
        .property-carousel {
            position: relative;
            margin-bottom: 24px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--color-bg-secondary);
        }

        .carousel-main {
            position: relative;
            width: 100%;
            height: 400px;
            background: var(--color-bg-secondary);
        }

        .carousel-main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 5;
        }

        .carousel-nav:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-nav.prev {
            left: 16px;
        }

        .carousel-nav.next {
            right: 16px;
        }

        .carousel-counter {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .carousel-thumbnails {
            display: flex;
            gap: 8px;
            padding: 12px;
            overflow-x: auto;
            background: var(--color-bg-primary);
        }

        .carousel-thumbnails::-webkit-scrollbar {
            height: 6px;
        }

        .carousel-thumbnails::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }

        .carousel-thumb {
            flex-shrink: 0;
            width: 80px;
            height: 60px;
            border-radius: var(--radius-md);
            cursor: pointer;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .carousel-thumb:hover {
            border-color: var(--color-primary);
            transform: scale(1.05);
        }

        .carousel-thumb.active {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(var(--color-primary-rgb), 0.2);
        }

        .carousel-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Property Details Layout */
        .property-header {
            margin-bottom: 20px;
        }

        .property-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 12px;
        }

        .property-price-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .property-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .detail-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
        }

        .property-section {
            margin-bottom: 24px;
        }

        .section-header {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-border);
        }

        .property-description {
            color: var(--color-text);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .features-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .features-list li {
            padding: 8px 12px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            color: var(--color-text);
            font-size: 14px;
        }

        .info-grid {
            display: grid;
            gap: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
        }

        .info-label {
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .info-value {
            color: var(--color-text);
            font-weight: 500;
        }

        .property-actions-bar {
            display: flex;
            gap: 12px;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
            margin-top: 24px;
        }

        .property-actions-bar button {
            flex: 1;
        }

        /* AI Sidebar Insight Sections */
        .insight-section {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }

        .insight-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-title .icon {
            font-size: 18px;
        }

        .estimated-value-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .estimated-value-card .label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .estimated-value-card .value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .estimated-value-card .range {
            font-size: 14px;
            opacity: 0.85;
        }

        /* ==================== ENHANCED SCHOOL LISTINGS ==================== */
        
        .schools-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: var(--color-bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }

        .schools-header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
        }

        .schools-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .schools-subtitle {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 20px;
        }

        .school-item {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .school-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .school-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
        }

        .school-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .school-name {
            font-weight: 700;
            color: var(--color-text);
            font-size: 16px;
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .school-type {
            font-size: 12px;
            color: var(--color-primary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .school-rating {
            background: linear-gradient(135deg, var(--color-success) 0%, #28a745 100%);
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .school-rating.high {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .school-rating.medium {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .school-rating.low {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .school-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .school-address {
            font-size: 13px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .school-level {
            font-size: 13px;
            color: var(--color-text);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .school-features {
            margin-top: 12px;
        }

        .school-features-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .school-features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .school-feature-tag {
            background: var(--color-bg-primary);
            color: var(--color-primary);
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(51, 128, 141, 0.2);
        }

        .school-distance {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(51, 128, 141, 0.1);
            color: var(--color-primary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 600;
        }

        .school-actions {
            margin-top: 16px;
            display: flex;
            gap: 8px;
        }

        .school-btn {
            background: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .school-btn:hover {
            background: var(--color-primary);
            color: white;
            transform: translateY(-1px);
        }

        .school-btn.primary {
            background: var(--color-primary);
            color: white;
        }

        .school-btn.primary:hover {
            background: var(--color-primary-hover);
        }

        /* Accessibility Enhancements */
        .school-item[role="article"] {
            outline: none;
        }

        .school-item:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .schools-container {
                grid-template-columns: 1fr;
                padding: 16px;
                gap: 16px;
            }

            .school-item {
                padding: 16px;
            }

            .school-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .school-rating {
                align-self: flex-start;
            }

            .schools-title {
                font-size: 20px;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .school-item {
                background: var(--color-surface);
                border-color: var(--color-border);
            }

            .school-feature-tag {
                background: rgba(51, 128, 141, 0.2);
                color: var(--color-primary);
            }
        }

        /* ==================== COMPREHENSIVE AMENITY SYSTEM ==================== */
        
        .amenity-response {
            width: 100%;
            max-width: 100%;
        }

        .amenity-header {
            text-align: center;
            margin-bottom: 32px;
            padding: 24px;
            background: linear-gradient(135deg, var(--color-bg-primary) 0%, var(--color-bg-secondary) 100%);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }

        .amenity-header h2 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: var(--color-text);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .amenity-header p {
            font-size: 16px;
            color: var(--color-text-secondary);
            margin: 0 0 16px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .amenity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
            margin-top: 16px;
        }

        .amenity-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
        }

        .amenity-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(51, 128, 141, 0.15);
            border-color: rgba(51, 128, 141, 0.3);
        }

        .amenity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .amenity-card:hover::before {
            opacity: 1;
        }

        .amenity-card-header {
            margin-bottom: 16px;
        }

        .amenity-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .amenity-type {
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .amenity-rating {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 600;
            background: rgba(51, 128, 141, 0.1);
            color: var(--color-primary);
            border: 1px solid rgba(51, 128, 141, 0.2);
        }

        .amenity-rating.high {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
            border-color: rgba(34, 197, 94, 0.2);
        }

        .amenity-rating.medium {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border-color: rgba(245, 158, 11, 0.2);
        }

        .amenity-rating.low {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border-color: rgba(239, 68, 68, 0.2);
        }

        .amenity-details {
            margin-bottom: 20px;
        }

        .amenity-address {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .amenity-level {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 500;
            margin-bottom: 12px;
            padding: 6px 12px;
            background: var(--color-bg-primary);
            border-radius: var(--radius-md);
            width: fit-content;
        }

        .amenity-special {
            font-size: 14px;
            color: var(--color-text);
            line-height: 1.5;
            background: var(--color-bg-secondary);
            padding: 12px;
            border-radius: var(--radius-md);
            border-left: 3px solid var(--color-primary);
        }

        .amenity-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .amenity-btn {
            padding: 10px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: transparent;
            color: var(--color-text);
            transition: all 0.2s ease;
            flex: 1;
        }

        .amenity-btn:hover {
            background: var(--color-bg-primary);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .amenity-btn.primary {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .amenity-btn.primary:hover {
            background: var(--color-primary-hover);
            border-color: var(--color-primary-hover);
            color: white;
        }

        /* Mobile Responsive for Amenities */
        @media (max-width: 768px) {
            .amenity-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .amenity-card {
                padding: 20px;
            }

            .amenity-header {
                padding: 20px;
                margin-bottom: 24px;
            }

            .amenity-header h2 {
                font-size: 24px;
            }

            .amenity-actions {
                flex-direction: column;
            }

            .amenity-btn {
                padding: 12px 16px;
            }
        }

        /* Accessibility Enhancements for Amenities */
        .amenity-card[role="article"] {
            outline: none;
        }

        .amenity-card:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        /* ==================== END COMPREHENSIVE AMENITY SYSTEM ==================== */
        

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .metric-value {
            font-weight: 600;
            color: var(--color-text);
            font-size: 14px;
        }

        .metric-value.positive {
            color: #10b981;
        }

        .metric-value.negative {
            color: #ef4444;
        }

        .pros-cons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .pros-list, .cons-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .pros-list li {
            padding: 8px;
            margin-bottom: 6px;
            color: var(--color-text);
            font-size: 13px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .pros-list li::before {
            content: "âœ“";
            color: #10b981;
            font-weight: bold;
            flex-shrink: 0;
        }

        .cons-list li {
            padding: 8px;
            margin-bottom: 6px;
            color: var(--color-text);
            font-size: 13px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .cons-list li::before {
            content: "âœ—";
            color: #ef4444;
            font-weight: bold;
            flex-shrink: 0;
        }

        .data-sources-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
        }

        #sourcesToggle {
            background: none;
            border: none;
            color: var(--color-primary);
            cursor: pointer;
            padding: 8px 0;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        #sourcesToggle:hover {
            color: var(--color-primary-hover);
        }

        #sourcesContent {
            margin-top: 12px;
        }

        .source-item {
            padding: 10px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border-left: 3px solid var(--color-primary);
        }

        .source-title {
            font-weight: 600;
            color: var(--color-text);
            font-size: 13px;
            margin-bottom: 4px;
        }

        .source-url {
            font-size: 12px;
            color: var(--color-primary);
            text-decoration: none;
            word-break: break-all;
        }

        .source-url:hover {
            text-decoration: underline;
        }

        .source-type {
            display: inline-block;
            background: var(--color-primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Responsive Styles for Modal */
        @media (max-width: 768px) {
            .property-details-modal {
                padding: 0;
            }

            .property-details-content {
                max-height: 100vh;
                border-radius: 0;
                max-width: 100%;
            }

            .carousel-main {
                height: 300px;
            }

            .property-details-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .pros-cons-grid {
                grid-template-columns: 1fr;
            }

            .property-actions-bar {
                flex-direction: column;
            }
        }

        /* ==================== ENHANCED SIDEBAR STYLES ==================== */
        
        /* City Selector */
        .filter-group {
            margin-bottom: 24px;
        }

        .filter-group-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .custom-select-wrapper {
            position: relative;
        }

        .custom-select {
            width: 100%;
            padding: 12px 40px 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--color-text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .custom-select:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--color-primary);
            transform: translateY(-1px);
        }

        .custom-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(51, 128, 141, 0.1);
        }

        .custom-select option {
            background: var(--color-surface);
            color: var(--color-text);
            padding: 12px;
        }

        .select-arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--color-text-secondary);
            font-size: 10px;
            transition: all 0.3s ease;
        }

        .custom-select:hover + .select-arrow {
            color: var(--color-primary);
        }

        /* Quick Actions Grid */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 500;
            text-align: left;
        }

        .action-btn:hover {
            background: rgba(51, 128, 141, 0.15);
            border-color: var(--color-primary);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 16px rgba(51, 128, 141, 0.2);
        }

        .action-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .action-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .action-label {
            flex: 1;
            font-weight: 500;
        }

        /* Filter Pills */
        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-pill {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: var(--color-text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }

        .filter-pill:hover {
            background: rgba(51, 128, 141, 0.2);
            border-color: var(--color-primary);
            transform: translateY(-1px);
        }

        .filter-pill.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(51, 128, 141, 0.3);
        }

        /* Apply Filters Button */
        .apply-filters-btn {
            width: 100%;
            padding: 14px 20px;
            margin-top: 20px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(51, 128, 141, 0.3);
        }

        .apply-filters-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(51, 128, 141, 0.4);
        }

        .apply-filters-btn:active {
            transform: translateY(0);
        }

        /* Clear Filters Button */
        .clear-filters-btn {
            width: 100%;
            padding: 12px 20px;
            margin-top: 12px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--color-text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-filters-btn:hover {
            background: rgba(192, 21, 47, 0.1);
            border-color: var(--color-error);
            color: var(--color-error);
        }

        /* Sidebar Content Scrollbar */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(51, 128, 141, 0.3);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: rgba(51, 128, 141, 0.5);
        }

        /* Selected City Badge */
        .selected-city-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Active Filter Count Badge */
        .filter-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--color-primary);
            color: white;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            margin-left: auto;
        }

        /* ==================== END ENHANCED SIDEBAR STYLES ==================== */

        /* ==================== PROPERTY ANALYSIS ENHANCEMENT STYLES ==================== */
        .property-analysis-container {
            transition: all 0.3s ease;
            border: 1px solid rgba(51, 128, 141, 0.1);
        }

        .property-analysis-container:hover {
            box-shadow: 0 8px 32px rgba(51, 128, 141, 0.15);
            transform: translateY(-2px);
        }

        .analysis-header {
            position: relative;
            overflow: hidden;
        }

        .analysis-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .property-analysis-container:hover .analysis-header::before {
            transform: translateX(100%);
        }

        .warning-section {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Analysis metrics styling */
        .analysis-metric {
            display: inline-block;
            background: linear-gradient(135deg, rgba(51, 128, 141, 0.1), rgba(51, 128, 141, 0.05));
            border: 1px solid rgba(51, 128, 141, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            margin: 4px;
            font-size: 14px;
            font-weight: 600;
            color: #33808d;
            transition: all 0.3s ease;
        }

        .analysis-metric:hover {
            background: #33808d;
            color: white;
            transform: scale(1.05);
        }

        /* Confidence badge */
        .confidence-badge {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3); }
            50% { box-shadow: 0 4px 16px rgba(39, 174, 96, 0.5); }
            100% { box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3); }
        }

        /* ==================== END PROPERTY ANALYSIS ENHANCEMENT STYLES ==================== */
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">ðŸ </div>
                    <span>Summitly AI</span>
                </div>
                <button class="new-chat-btn" onclick="startNewChat()">
                    <span>âœ¨</span>
                    <span>New Conversation</span>
                </button>
            </div>

            <div class="quick-actions sidebar-content">
                <!-- City Selector -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>ðŸ™ï¸</span>
                        <span>SELECT CITY</span>
                    </div>
                    <div class="custom-select-wrapper">
                        <select id="citySelector" class="custom-select" onchange="handleCityChange(this.value)">
                            <option value="">Choose a city...</option>
                            <option value="Toronto">Toronto</option>
                            <option value="Mississauga">Mississauga</option>
                            <option value="Brampton">Brampton</option>
                            <option value="Oakville">Oakville</option>
                            <option value="Burlington">Burlington</option>
                            <option value="Hamilton">Hamilton</option>
                            <option value="Ottawa">Ottawa</option>
                            <option value="Kingston">Kingston</option>
                            <option value="London">London</option>
                            <option value="Kitchener">Kitchener</option>
                            <option value="Waterloo">Waterloo</option>
                            <option value="Guelph">Guelph</option>
                            <option value="Windsor">Windsor</option>
                        </select>
                        <span class="select-arrow">â–¼</span>
                    </div>
                    <div id="selectedCityBadge"></div>
                </div>

                <!-- Quick Actions -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>âš¡</span>
                        <span>QUICK ACTIONS</span>
                    </div>
                    <div class="quick-actions-grid">
                        <button class="action-btn" onclick="handleQuickAction('search')">
                            <span class="action-icon">ðŸ”</span>
                            <span class="action-label">Search Properties</span>
                        </button>
                        <button class="action-btn" onclick="handleQuickAction('market')">
                            <span class="action-icon">ðŸ“ˆ</span>
                            <span class="action-label">Market Analysis</span>
                        </button>
                        <button class="action-btn" onclick="handleQuickAction('neighborhood')">
                            <span class="action-icon">ðŸ˜ï¸</span>
                            <span class="action-label">Neighborhood Intel</span>
                        </button>
                        <button class="action-btn" onclick="handleQuickAction('roi')">
                            <span class="action-icon">ðŸ’°</span>
                            <span class="action-label">ROI Calculator</span>
                        </button>
                        <button class="action-btn" onclick="handleQuickAction('dashboard')">
                            <span class="action-icon">ðŸ“Š</span>
                            <span class="action-label">Manager Dashboard</span>
                        </button>
                    </div>
                </div>

                <!-- Price Range Filters -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>ðŸ’µ</span>
                        <span>PRICE RANGE</span>
                    </div>
                    <div class="filter-pills">
                        <button class="filter-pill" onclick="handleFilterClick('priceRange', 'under500k', this)">
                            Under $500K
                        </button>
                        <button class="filter-pill" onclick="handleFilterClick('priceRange', '500k-750k', this)">
                            $500K-$750K
                        </button>
                        <button class="filter-pill" onclick="handleFilterClick('priceRange', '750k-1m', this)">
                            $750K-$1M
                        </button>
                        <button class="filter-pill" onclick="handleFilterClick('priceRange', 'over1m', this)">
                            $1M+
                        </button>
                    </div>
                </div>

                <!-- Property Type Filters -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>ðŸ¡</span>
                        <span>PROPERTY TYPE</span>
                    </div>
                    <div class="filter-pills">
                        <button class="filter-pill" onclick="handleFilterClick('propertyType', 'Condo', this)">
                            Condo
                        </button>
                        <button class="filter-pill" onclick="handleFilterClick('propertyType', 'House', this)">
                            House
                        </button>
                        <button class="filter-pill" onclick="handleFilterClick('propertyType', 'Townhouse', this)">
                            Townhouse
                        </button>
                    </div>
                </div>

                <!-- Location Filters -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>ðŸ“</span>
                        <span>LOCATION</span>
                    </div>
                    <div class="filter-pills">
                        <button class="filter-pill" onclick="handleFilterClick('location', 'Downtown', this)">
                            Downtown
                        </button>
                        <button class="filter-pill" onclick="handleFilterClick('location', 'Waterfront', this)">
                            Waterfront
                        </button>
                        <button class="filter-pill" onclick="handleFilterClick('location', 'Suburbs', this)">
                            Suburbs
                        </button>
                    </div>
                </div>

                <!-- Amenities Section -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>ðŸ¢</span>
                        <span>AMENITIES</span>
                    </div>
                    <div class="filter-pills">
                        <button class="filter-pill" onclick="handleAmenityClick('schools', this)">
                            ðŸŽ“ Schools
                        </button>
                        <button class="filter-pill" onclick="handleAmenityClick('shopping', this)">
                            ðŸ›ï¸ Shopping
                        </button>
                        <button class="filter-pill" onclick="handleAmenityClick('grocery', this)">
                            ðŸ›’ Grocery
                        </button>
                        <button class="filter-pill" onclick="handleAmenityClick('hospitals', this)">
                            ðŸ¥ Hospitals
                        </button>
                        <button class="filter-pill" onclick="handleAmenityClick('parks', this)">
                            ðŸŒ³ Parks
                        </button>
                    </div>
                </div>

                <!-- Apply Filters Button -->
                <button class="apply-filters-btn" onclick="applyAllFilters()">
                    ðŸŽ¯ Apply Filters
                </button>

                <!-- Clear Filters Button -->
                <button class="clear-filters-btn" onclick="clearAllFilters()">
                    ðŸ—‘ï¸ Clear All Filters
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="chat-header">
                <div class="header-left">
                    <button class="icon-btn" onclick="toggleSidebar()">â˜°</button>
                    <div class="status-badge">
                        <div class="status-dot"></div>
                        <span>Llama 3.2 + Exa AI Active</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="openVoiceModal()" title="Voice Chat">ðŸŽ¤</button>
                    <button class="icon-btn" onclick="toggleTheme()" title="Toggle Theme">ðŸŒ™</button>
                    <button class="icon-btn" onclick="showSettings()" title="Settings">âš™ï¸</button>
                </div>
            </header>

            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">ðŸ </div>
                    <h1 class="welcome-title">Welcome Zubair to Your AI Real Estate Assistant</h1>
                    <p class="welcome-subtitle">
                        Powered by Llama 3.2 and Exa AI with live market data. Ask anything about Canadian real estate, 
                        get property recommendations, market analysis, and connect with expert brokers.
                    </p>
                    <div class="suggestion-grid">
                        <div class="suggestion-card" onclick="sendMessage('Show me 2-bedroom condos in Toronto under $800K')">
                            <div class="suggestion-icon">ðŸ”</div>
                            <div class="suggestion-title">Property Search</div>
                            <div class="suggestion-desc">Find your perfect home with smart filters</div>
                        </div>
                        <div class="suggestion-card" onclick="sendMessage('What are the current market trends in Vancouver?')">
                            <div class="suggestion-icon">ðŸ“ˆ</div>
                            <div class="suggestion-title">Market Insights</div>
                            <div class="suggestion-desc">Live data on trends and predictions</div>
                        </div>
                        <div class="suggestion-card" onclick="sendMessage('Compare investment potential: Toronto vs Montreal')">
                            <div class="suggestion-icon">ðŸ’Ž</div>
                            <div class="suggestion-title">Investment Analysis</div>
                            <div class="suggestion-desc">ROI calculations and recommendations</div>
                        </div>
                        <div class="suggestion-card" onclick="sendMessage('Tell me about schools in Yorkville neighborhood')">
                            <div class="suggestion-icon">ðŸ˜ï¸</div>
                            <div class="suggestion-title">Neighborhood Data</div>
                            <div class="suggestion-desc">Schools, safety, amenities analysis</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Ask about properties, market trends, neighborhoods, or anything real estate..."
                            rows="1"
                            onkeydown="handleKeyPress(event)"
                        ></textarea>
                        <div class="input-actions">
                            <button class="input-icon-btn" onclick="uploadFile()" title="Upload Image/Video">ðŸ“Ž</button>
                            <button class="input-icon-btn" onclick="openVoiceModal()" title="Voice Input">ðŸŽ¤</button>
                            <button class="input-icon-btn" onclick="showFileUpload()" title="Attach File">ðŸ“„</button>
                        </div>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendUserMessage()">
                        âž¤
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Voice Modal -->
    <div class="modal-overlay" id="voiceModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Voice Conversation</h2>
                <p class="modal-subtitle">Speak naturally - I'm listening</p>
            </div>
            <div class="voice-visualizer" id="voiceVisualizer">
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
            </div>
            <div class="voice-controls">
                <button class="voice-btn" onclick="closeVoiceModal()">Cancel</button>
                <button class="voice-btn voice-btn-primary" onclick="toggleVoiceRecording()">ðŸŽ¤ Start Recording</button>
            </div>
        </div>
    </div>

    <!-- AI Analysis Side Panel -->
    <div class="ai-analysis-panel" id="aiAnalysisPanel">
        <div class="ai-panel-header">
            <h2 class="ai-panel-title">ðŸ¤– AI Property Analysis</h2>
            <button class="ai-panel-close" onclick="closeAIAnalysisPanel()">âœ•</button>
        </div>
        <div class="ai-panel-body" id="aiPanelBody">
            <!-- Content will be dynamically loaded -->
        </div>
    </div>

    <script>
        // ==================== ENHANCED SIDEBAR STATE & HANDLERS ====================
        
        /**
         * Global filter state management
         */
        // ==================== PRODUCTION CONFIGURATION ====================
        
        /**
         * Dynamic API Configuration for Production Deployment
         * Automatically detects environment and uses appropriate base URL
         */
        const getApiBaseUrl = () => {
            // For Render deployment, use the current domain
            if (window.location.hostname.includes('render.com') || 
                window.location.hostname.includes('onrender.com')) {
                return `https://${window.location.hostname}`;
            }
            // For localhost development
            else if (window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1') {
                return `http://${window.location.hostname}:5050`;
            }
            // For any other production deployment
            else {
                return `https://${window.location.hostname}`;
            }
        };

        const filterState = {
            selectedCity: '',
            priceRange: '',
            propertyType: '',
            location: '',
            apiBaseUrl: getApiBaseUrl()
        };

        // Log current configuration
        console.log('ðŸš€ Summitly Production Frontend Loaded');
        console.log('ðŸŒ API Base URL:', filterState.apiBaseUrl);
        console.log('ðŸ“ Environment:', window.location.hostname.includes('render') ? 'Production (Render)' : 'Development');

        /**
         * Handle city selection change
         */
        async function handleCityChange(city) {
            if (!city) {
                document.getElementById('selectedCityBadge').innerHTML = '';
                filterState.selectedCity = '';
                return;
            }

            filterState.selectedCity = city;
            
            // Show selected city badge
            document.getElementById('selectedCityBadge').innerHTML = `
                <div class="selected-city-badge">
                    ðŸ“ ${city}
                </div>
            `;

            console.log('ðŸ™ï¸ City selected:', city);

            // Make API calls to fetch city data
            try {
                let hasErrors = false;
                
                // Fetch properties for the city
                const propertiesResponse = await fetch(`${filterState.apiBaseUrl}/api/properties/city?name=${city}`);
                if (propertiesResponse.ok) {
                    const properties = await propertiesResponse.json();
                    console.log('âœ… Properties loaded for', city, ':', properties);
                } else {
                    console.warn('âš ï¸ Properties endpoint returned status:', propertiesResponse.status);
                    hasErrors = true;
                }

                // Fetch city analysis
                const analysisResponse = await fetch(`${filterState.apiBaseUrl}/api/analysis/city?name=${city}`);
                if (analysisResponse.ok) {
                    const analysis = await analysisResponse.json();
                    console.log('âœ… City analysis loaded for', city, ':', analysis);
                } else {
                    console.warn('âš ï¸ Analysis endpoint returned status:', analysisResponse.status);
                    hasErrors = true;
                }

                // Only show warning if there were actual errors
                if (hasErrors) {
                    addMessage('assistant', `âš ï¸ Could not load complete data for ${city}, but you can still search properties.`);
                } else {
                    addMessage('assistant', `âœ… Loaded data for ${city}. You can now apply filters or use Quick Actions!`);
                }
            } catch (error) {
                console.error('âŒ Error loading city data:', error);
                addMessage('assistant', `âš ï¸ Could not load complete data for ${city}, but you can still search properties.`);
            }
        }

        /**
         * Handle quick action button clicks
         */
        async function handleQuickAction(action) {
            if (!filterState.selectedCity) {
                addMessage('assistant', 'âš ï¸ Please select a city first!');
                return;
            }

            const city = filterState.selectedCity;
            console.log('âš¡ Quick action:', action, 'for city:', city);

            // Define action-specific messages and endpoints
            const actions = {
                search: {
                    message: `Show me available properties in ${city}`,
                    endpoint: '/chat',
                    description: 'ðŸ” Searching properties'
                },
                market: {
                    message: `Give me a market analysis for ${city}`,
                    endpoint: '/chat',
                    description: 'ðŸ“ˆ Analyzing market trends'
                },
                neighborhood: {
                    message: `Analyze neighborhoods in ${city} for investment potential`,
                    endpoint: '/chat',
                    description: 'ðŸ˜ï¸ Analyzing neighborhoods'
                },
                roi: {
                    message: `Calculate ROI for properties in ${city}`,
                    endpoint: '/chat',
                    description: 'ðŸ’° Calculating ROI'
                },
                dashboard: {
                    message: null, // Special case - opens dashboard
                    endpoint: '/api/manager/dashboard-stats',
                    description: 'ðŸ“Š Opening dashboard'
                }
            };

            const selectedAction = actions[action];
            if (!selectedAction) return;

            // Special case for dashboard
            if (action === 'dashboard') {
                toggleDashboard();
                return;
            }

            // Send message through chat
            if (selectedAction.message) {
                addMessage('user', selectedAction.message);
                sendMessage(selectedAction.message);
            }
        }

        /**
         * Handle filter pill clicks (Price Range, Property Type, Location)
         */
        function handleFilterClick(filterType, value, button) {
            // Toggle active class
            const isActive = button.classList.contains('active');
            
            // Remove active from all pills in the same group
            const group = button.parentElement;
            group.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
            });

            // If it wasn't active, activate it
            if (!isActive) {
                button.classList.add('active');
                filterState[filterType] = value;
                console.log(`âœ… Filter set: ${filterType} = ${value}`);
            } else {
                filterState[filterType] = '';
                console.log(`âŒ Filter cleared: ${filterType}`);
            }
        }

        /**
         * Apply all selected filters
         */
        async function applyAllFilters() {
            if (!filterState.selectedCity) {
                addMessage('assistant', 'âš ï¸ Please select a city first!');
                return;
            }

            const activeFilters = [];
            let query = `Show me properties in ${filterState.selectedCity}`;

            // Add price range
            if (filterState.priceRange) {
                const priceMap = {
                    'under500k': 'under $500K',
                    '500k-750k': 'between $500K and $750K',
                    '750k-1m': 'between $750K and $1M',
                    'over1m': 'over $1M'
                };
                query += ` priced ${priceMap[filterState.priceRange]}`;
                activeFilters.push(`ðŸ’µ ${priceMap[filterState.priceRange]}`);
            }

            // Add property type
            if (filterState.propertyType) {
                query += ` that are ${filterState.propertyType}s`;
                activeFilters.push(`ðŸ¡ ${filterState.propertyType}`);
            }

            // Add location
            if (filterState.location) {
                query += ` in ${filterState.location} areas`;
                activeFilters.push(`ðŸ“ ${filterState.location}`);
            }

            console.log('ðŸŽ¯ Applying filters:', {
                city: filterState.selectedCity,
                priceRange: filterState.priceRange,
                propertyType: filterState.propertyType,
                location: filterState.location,
                query: query
            });

            // Show active filters summary
            if (activeFilters.length > 0) {
                const filterSummary = `ðŸŽ¯ Searching with filters:\n${activeFilters.join('\n')}`;
                addMessage('user', filterSummary);
            }

            // Send the search query
            addMessage('user', query);
            sendMessage(query);
        }

        /**
         * Clear all filters
         */
        function clearAllFilters() {
            // Reset state
            filterState.priceRange = '';
            filterState.propertyType = '';
            filterState.location = '';

            // Remove active class from all pills
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
            });

            console.log('ðŸ—‘ï¸ All filters cleared');
            addMessage('assistant', 'âœ… All filters have been cleared. Select new filters to search again!');
        }

        /**
         * Handle amenity button clicks
         */
        async function handleAmenityClick(amenity, button) {
            console.log('ðŸš€ handleAmenityClick called with:', amenity, 'button:', button);
            
            if (!filterState.selectedCity) {
                addMessage('assistant', 'âš ï¸ Please select a city first!');
                return;
            }

            const city = filterState.selectedCity;
            console.log('ðŸ¢ Amenity clicked:', amenity, 'for city:', city);

            // Toggle active state
            button.classList.toggle('active');

            if (!button.classList.contains('active')) {
                return; // User deselected
            }

            // Remove active from other amenity pills
            document.querySelectorAll('.filter-pill').forEach(pill => {
                if (pill !== button && pill.textContent.includes(amenity === 'schools' ? 'ðŸŽ“' : 
                    amenity === 'shopping' ? 'ðŸ›ï¸' : amenity === 'grocery' ? 'ðŸ›’' : 
                    amenity === 'hospitals' ? 'ðŸ¥' : 'ðŸŒ³')) {
                    pill.classList.remove('active');
                }
            });

            try {
                console.log('ðŸ” Starting amenity processing...');
                
                // Simple test first
                addMessage('assistant', `ðŸ§ª Testing amenity system for ${amenity} in ${city}...`);
                
                console.log('ðŸ” About to call getComprehensiveAmenityData...');
                console.log('ðŸ” Function exists?', typeof getComprehensiveAmenityData);
                
                const amenityData = getComprehensiveAmenityData(city, amenity);
                
                console.log('ðŸ” Amenity data found:', amenityData ? amenityData.length : 'none', 'items for', amenity, 'in', city);
                console.log('ðŸ“Š Raw data:', amenityData);
                
                if (amenityData && amenityData.length > 0) {
                    console.log('âœ… Found local data, displaying...');
                    
                    // Simple test message first
                    addMessage('assistant', `âœ… Found ${amenityData.length} ${amenity} in ${city}! Loading detailed information...`);
                    
                    // Display comprehensive local data
                    displayAmenityData(amenityData, amenity, city);
                    console.log('âœ… displayAmenityData completed');
                } else {
                    console.log('ðŸ¤– No local data, falling back to AI query');
                    addMessage('assistant', `ðŸ¤– No local data for ${amenity} in ${city}, using AI query...`);
                    
                    // Fallback to intelligent ChatGPT queries for cities without comprehensive data
                    const amenityQueries = {
                        'schools': `List the top 10 best schools (elementary, middle, and high schools) in ${city}. Include school names, ratings, addresses, and what makes them special. Focus on both public and private schools with good academic reputations.`,
                        'shopping': `List the top 10 shopping centers, malls, and major retail areas in ${city}. Include names, locations, anchor stores, and what makes each shopping destination unique.`,
                        'grocery': `List the top 10 grocery stores and supermarkets in ${city}. Include major chains like Loblaws, Metro, Food Basics, No Frills, and specialty stores. Mention locations and what makes each store special.`,
                        'hospitals': `List the top 10 hospitals, medical centers, and healthcare facilities in ${city}. Include hospital names, specialties, addresses, and key services they provide.`,
                        'parks': `List the top 10 parks, recreational areas, and green spaces in ${city}. Include park names, locations, amenities (playgrounds, trails, sports facilities), and what makes each park special.`
                    };
                    
                    const query = amenityQueries[amenity] || `Tell me about ${amenityLabels[amenity]} in ${city}`;
                    await sendMessage(query);
                }
            } catch (error) {
                console.error('âŒ Error in handleAmenityClick:', error);
                console.error('âŒ Error stack:', error.stack);
                addMessage('assistant', `âŒ Error: ${error.message}. Please check console for details.`);
            }

            const amenityLabels = {
                'schools': 'ðŸŽ“ Schools',
                'shopping': 'ðŸ›ï¸ Shopping Centers',
                'grocery': 'ðŸ›’ Grocery Stores',
                'hospitals': 'ðŸ¥ Hospitals',
                'parks': 'ðŸŒ³ Parks'
            };
        }

        /**
         * Comprehensive amenity database for all Canadian cities
         */
        function getComprehensiveAmenityData(city, amenity) {
            const amenityDatabase = {
                'Mississauga': {
                    'schools': [
                        {
                            name: "John Fraser Secondary School",
                            type: "Public â€¢ High School",
                            rating: "9.3/10",
                            ratingSource: "GreatSchools",
                            address: "2665 Erin Centre Blvd, Mississauga, ON L5M 5W6",
                            level: "High School",
                            special: "Top-ranked STEM programs, Advanced Placement courses, award-winning arts programs"
                        },
                        {
                            name: "St. Aloysius Gonzaga Secondary School",
                            type: "Catholic â€¢ High School", 
                            rating: "8.8/10",
                            ratingSource: "GreatSchools",
                            address: "2800 Erin Centre Blvd, Mississauga, ON L5M 5W1",
                            level: "High School",
                            special: "IB World School, strong athletics program, community service focus"
                        },
                        {
                            name: "Port Credit Secondary School",
                            type: "Public â€¢ High School",
                            rating: "8.5/10", 
                            ratingSource: "Fraser Institute",
                            address: "70 Mineola Rd E, Mississauga, ON L5G 2E5",
                            level: "High School",
                            special: "Heritage building, strong arts program, lakefront location"
                        },
                        {
                            name: "Glenforest Secondary School",
                            type: "Public â€¢ High School",
                            rating: "8.7/10",
                            ratingSource: "GreatSchools", 
                            address: "3575 Kaneff Cres, Mississauga, ON L5A 1X4",
                            level: "High School",
                            special: "Technology focus, excellent computer science programs, modern facilities"
                        },
                        {
                            name: "Meadowvale Secondary School",
                            type: "Public â€¢ High School",
                            rating: "8.2/10",
                            ratingSource: "Fraser Institute",
                            address: "6800 Montevideo Rd, Mississauga, ON L5N 2M5", 
                            level: "High School",
                            special: "Strong business programs, diverse community, excellent graduation rates"
                        },
                        {
                            name: "Applewood Heights Secondary School",
                            type: "Public â€¢ High School",
                            rating: "7.9/10",
                            ratingSource: "GreatSchools",
                            address: "465 Burnhamthorpe Rd W, Mississauga, ON L5B 4B8",
                            level: "High School", 
                            special: "Established 1957, strong tradition, excellent sports programs"
                        },
                        {
                            name: "Streetsville Secondary School",
                            type: "Public â€¢ High School",
                            rating: "8.1/10",
                            ratingSource: "Fraser Institute",
                            address: "1821 Bristol Rd W, Mississauga, ON L5M 4Z8",
                            level: "High School",
                            special: "Heritage school, small class sizes, personalized learning"
                        },
                        {
                            name: "TMS - The Maronite School",
                            type: "Private â€¢ Elementary/Middle",
                            rating: "9.1/10",
                            ratingSource: "Private School Review", 
                            address: "365 Britannia Rd E, Mississauga, ON L4Z 2H6",
                            level: "Elementary/Middle School",
                            special: "Trilingual education (English/French/Arabic), small class sizes, strong academics"
                        },
                        {
                            name: "Mississauga Secondary School",
                            type: "Public â€¢ High School",
                            rating: "7.8/10",
                            ratingSource: "GreatSchools",
                            address: "1801 Britannia Rd W, Mississauga, ON L5M 0G5",
                            level: "High School",
                            special: "Heritage school established 1950, strong community connections"
                        },
                        {
                            name: "Stephen Lewis Secondary School",
                            type: "Public â€¢ High School", 
                            rating: "8.3/10",
                            ratingSource: "Fraser Institute",
                            address: "6050 Montevideo Rd, Mississauga, ON L5N 2M5",
                            level: "High School",
                            special: "Newest high school in Mississauga, modern facilities, innovative programs"
                        }
                    ],
                    'shopping': [
                        {
                            name: "Square One Shopping Centre",
                            type: "Major Shopping Mall",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "100 City Centre Dr, Mississauga, ON L5B 2C9",
                            special: "Canada's largest shopping mall, 360+ stores, major brands like Hudson's Bay, Walmart, Best Buy"
                        },
                        {
                            name: "Heartland Town Centre", 
                            type: "Outdoor Shopping Plaza",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews", 
                            address: "5965 Mavis Rd, Mississauga, ON L5R 3T7",
                            special: "Outdoor lifestyle center, major retailers like Canadian Tire, Chapters, Winners"
                        },
                        {
                            name: "Dixie Outlet Mall",
                            type: "Outlet Shopping Center",
                            rating: "4.0/5", 
                            ratingSource: "Google Reviews",
                            address: "1250 South Service Rd, Mississauga, ON L5E 1V4", 
                            special: "Factory outlet prices, brands like Nike, Adidas, Kitchen Stuff Plus"
                        },
                        {
                            name: "Erin Mills Town Centre",
                            type: "Shopping Mall",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "5100 Erin Mills Pkwy, Mississauga, ON L5M 4Z5",
                            special: "West-end shopping hub, Walmart, Metro, Shoppers Drug Mart, 170+ stores"
                        },
                        {
                            name: "Port Credit GO Station Plaza",
                            type: "Mixed-Use Shopping",
                            rating: "4.2/5", 
                            ratingSource: "Google Reviews",
                            address: "110 Lakeshore Rd E, Mississauga, ON L5G 1E6",
                            special: "Waterfront shopping, upscale boutiques, restaurants, GO train access"
                        },
                        {
                            name: "Meadowvale Town Centre",
                            type: "Community Shopping Center",
                            rating: "3.9/5",
                            ratingSource: "Google Reviews", 
                            address: "6677 Meadowvale Town Centre Cir, Mississauga, ON L5N 2R5",
                            special: "Anchor stores: Metro, Shoppers Drug Mart, variety of services and dining"
                        },
                        {
                            name: "Clarkson GO Centre",
                            type: "Transit-Oriented Shopping",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "2185 Lakeshore Rd W, Mississauga, ON L5J 1J3", 
                            special: "Connected to GO station, Loblaws, LCBO, medical services"
                        },
                        {
                            name: "Streetsville Glen Shopping Centre", 
                            type: "Community Shopping Plaza",
                            rating: "3.8/5",
                            ratingSource: "Google Reviews",
                            address: "6965 Mississauga Rd, Mississauga, ON L5N 2L3",
                            special: "Historic Streetsville area, local businesses, Food Basics, specialty shops"
                        },
                        {
                            name: "Sheridan Centre",
                            type: "Shopping Plaza",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "2225 Erin Mills Pkwy, Mississauga, ON L5K 1T9",
                            special: "Walmart Supercentre, Canadian Tire, diverse dining options"
                        },
                        {
                            name: "Winston Park Centre",
                            type: "Community Shopping", 
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "2225 Hurontario St, Mississauga, ON L5A 2G1",
                            special: "Neighbourhood shopping, Metro, TD Bank, local services"
                        }
                    ],
                    'grocery': [
                        {
                            name: "Loblaws City Centre",
                            type: "Full-Service Supermarket",
                            rating: "4.1/5", 
                            ratingSource: "Google Reviews",
                            address: "100 City Centre Dr, Mississauga, ON L5B 2C9",
                            special: "Premium location in Square One, Joe Fresh clothing, pharmacy, full deli"
                        },
                        {
                            name: "Metro Erin Mills",
                            type: "Full-Service Supermarket", 
                            rating: "4.2/5",
                            ratingSource: "Google Reviews", 
                            address: "5100 Erin Mills Pkwy, Mississauga, ON L5M 4Z5",
                            special: "Large selection, excellent produce, full-service deli and bakery"
                        },
                        {
                            name: "Walmart Supercentre Heartland",
                            type: "Supercentre",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "5965 Mavis Rd, Mississauga, ON L5R 3T7", 
                            special: "One-stop shopping, grocery + general merchandise, competitive prices"
                        },
                        {
                            name: "No Frills Dixie",
                            type: "Discount Supermarket",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews", 
                            address: "1535 Dixie Rd, Mississauga, ON L5E 1V4",
                            special: "Low prices, bulk buying options, PC Optimum rewards"
                        },
                        {
                            name: "Food Basics Meadowvale",
                            type: "Discount Supermarket",
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "6677 Meadowvale Town Centre Cir, Mississauga, ON L5N 2R5", 
                            special: "Affordable groceries, weekly specials, local community focus"
                        },
                        {
                            name: "Farm Boy Mississauga",
                            type: "Premium Grocery",
                            rating: "4.4/5",
                            ratingSource: "Google Reviews",
                            address: "3045 Mavis Rd, Mississauga, ON L5B 4M6",
                            special: "Fresh, local produce, artisanal products, excellent prepared foods"
                        },
                        {
                            name: "Longos Port Credit",
                            type: "Premium Supermarket", 
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "346 Lakeshore Rd W, Mississauga, ON L5H 1G8", 
                            special: "Upscale grocer, excellent meat and seafood, gourmet selections"
                        },
                        {
                            name: "T&T Supermarket Mississauga",
                            type: "Asian Supermarket",
                            rating: "4.2/5", 
                            ratingSource: "Google Reviews",
                            address: "222 Cherry St, Mississauga, ON L5B 0A8",
                            special: "Largest Asian grocery chain, authentic ingredients, hot food counter"
                        },
                        {
                            name: "Oceans Fresh Food Market",
                            type: "International Supermarket",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews", 
                            address: "6085 Mavis Rd, Mississauga, ON L5R 3M6",
                            special: "South Asian specialties, halal meats, international products"
                        },
                        {
                            name: "Coppa's Fresh Market",
                            type: "Independent Grocer",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews",
                            address: "1500 Dundas St E, Mississauga, ON L4X 1L4", 
                            special: "Family-owned, Italian specialties, fresh pasta, excellent customer service"
                        }
                    ],
                    'hospitals': [
                        {
                            name: "Trillium Health Partners - Mississauga Hospital",
                            type: "Full-Service Hospital",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews", 
                            address: "100 Queensway W, Mississauga, ON L5B 1B8",
                            special: "Major trauma center, emergency services, cardiac care, maternity ward"
                        },
                        {
                            name: "Credit Valley Hospital",
                            type: "Full-Service Hospital",
                            rating: "4.1/5", 
                            ratingSource: "Google Reviews",
                            address: "2200 Eglinton Ave W, Mississauga, ON L5M 2N1",
                            special: "Cancer care, cardiac surgery, women's health, mental health services"
                        },
                        {
                            name: "Queensway Health Centre", 
                            type: "Rehabilitation Hospital",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews", 
                            address: "150 Sherway Dr, Etobicoke, ON M9C 1A5",
                            special: "Specialized rehabilitation, complex care, transitional care programs"
                        },
                        {
                            name: "Mississauga Medical Centre",
                            type: "Medical Clinic Complex",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "1333 Neyagawa Blvd, Oakville, ON L6M 0H3", 
                            special: "Multi-specialty clinic, walk-in services, diagnostic imaging"
                        },
                        {
                            name: "Erin Mills Medical Centre",
                            type: "Community Health Center", 
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "5100 Erin Mills Pkwy, Mississauga, ON L5M 4Z5",
                            special: "Family medicine, pediatrics, specialist referrals"
                        },
                        {
                            name: "Sherway Medical Centre",
                            type: "Specialist Medical Center",
                            rating: "4.1/5", 
                            ratingSource: "Google Reviews",
                            address: "1333 Shawnmarr Rd, Mississauga, ON L5J 2P5",
                            special: "Cardiology, orthopedics, diagnostic services"
                        },
                        {
                            name: "Meadowvale Medical Centre", 
                            type: "Family Health Team",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "6630 Meadowvale Town Centre Cir, Mississauga, ON L5N 4L8", 
                            special: "Comprehensive family care, chronic disease management"
                        },
                        {
                            name: "Port Credit Medical Centre",
                            type: "Community Clinic",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "145 Lakeshore Rd W, Mississauga, ON L5H 1G2", 
                            special: "Waterfront location, family practice, urgent care"
                        },
                        {
                            name: "Streetsville Medical Centre",
                            type: "Multi-Specialty Clinic",
                            rating: "3.8/5", 
                            ratingSource: "Google Reviews",
                            address: "34 Queen St S, Mississauga, ON L5M 1J6",
                            special: "Historic Streetsville, family medicine, pediatrics"
                        },
                        {
                            name: "Square One Medical Centre",
                            type: "Walk-in Clinic",
                            rating: "3.7/5",
                            ratingSource: "Google Reviews", 
                            address: "100 City Centre Dr, Mississauga, ON L5B 2C9",
                            special: "Convenient mall location, no appointment needed, extended hours"
                        }
                    ],
                    'parks': [
                        {
                            name: "Jack Darling Memorial Park",
                            type: "Lakefront Park",
                            rating: "4.6/5", 
                            ratingSource: "Google Reviews",
                            address: "1180 Lakeshore Rd W, Mississauga, ON L5H 1G6",
                            special: "Lake Ontario waterfront, marina, beach access, picnic areas, walking trails"
                        },
                        {
                            name: "Kariya Park",
                            type: "Japanese Garden",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews", 
                            address: "3600 Kariya Dr, Mississauga, ON L5B 3C1",
                            special: "Authentic Japanese garden, koi pond, traditional architecture, peaceful setting"
                        },
                        {
                            name: "Rattray Marsh Conservation Area",
                            type: "Nature Preserve",
                            rating: "4.4/5", 
                            ratingSource: "Google Reviews",
                            address: "3050 Mississauga Rd, Mississauga, ON L5L 2L8", 
                            special: "Wetland preserve, bird watching, boardwalk trails, environmental education"
                        },
                        {
                            name: "Erindale Park",
                            type: "River Valley Park",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "1695 Dundas St W, Mississauga, ON L5C 1T9",
                            special: "Credit River valley, hiking trails, historic mill ruins, cross-country skiing"
                        },
                        {
                            name: "Mississauga Valley Park", 
                            type: "Community Park",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "1275 Mississauga Valley Blvd, Mississauga, ON L5A 3R8",
                            special: "Large open spaces, sports fields, playground, community centre"
                        },
                        {
                            name: "Port Credit Memorial Park",
                            type: "Waterfront Park",
                            rating: "4.4/5", 
                            ratingSource: "Google Reviews", 
                            address: "151 Lakeshore Rd W, Mississauga, ON L5H 1G2",
                            special: "Historic lighthouse, lakefront views, festivals and events, marina access"
                        },
                        {
                            name: "Huron Park",
                            type: "Recreation Park",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "830 Hurontario St, Mississauga, ON L5G 3H5", 
                            special: "Sports facilities, tennis courts, baseball diamonds, community programs"
                        },
                        {
                            name: "Creditview Sandalwood Park",
                            type: "Family Park", 
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "6990 Creditview Rd, Mississauga, ON L5N 8R5",
                            special: "Adventure playground, splash pad, sports courts, family-friendly"
                        },
                        {
                            name: "Lakefront Promenade",
                            type: "Waterfront Trail",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews", 
                            address: "Lakeshore Rd W, Mississauga, ON",
                            special: "11km waterfront trail, cycling path, scenic views, connects multiple parks"
                        },
                        {
                            name: "Streetsville Memorial Park",
                            type: "Historic Community Park",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "245 Queen St S, Mississauga, ON L5M 1L2", 
                            special: "Historic village setting, cenotaph, community events, walking paths"
                        }
                    ]
                },
                
                'Toronto': {
                    'schools': [
                        {
                            name: "University of Toronto Schools",
                            type: "Private â€¢ High School",
                            rating: "9.8/10",
                            ratingSource: "Fraser Institute",
                            address: "371 Bloor St W, Toronto, ON M5S 2R7",
                            level: "High School",
                            special: "Laboratory school, exceptional academics, university preparation"
                        },
                        {
                            name: "Earl Haig Secondary School",
                            type: "Public â€¢ High School", 
                            rating: "9.2/10",
                            ratingSource: "Fraser Institute",
                            address: "100 Princess Ave, Toronto, ON M2N 3R5",
                            level: "High School",
                            special: "Claude Watson Arts Program, gifted program, performing arts focus"
                        },
                        {
                            name: "North Toronto Collegiate Institute",
                            type: "Public â€¢ High School",
                            rating: "8.9/10",
                            ratingSource: "Fraser Institute", 
                            address: "70 Roehampton Ave, Toronto, ON M4P 1P9",
                            level: "High School",
                            special: "IB World School, advanced academics, historic building"
                        },
                        {
                            name: "Crescent School", 
                            type: "Private â€¢ Boys School",
                            rating: "9.5/10",
                            ratingSource: "Fraser Institute",
                            address: "2365 Bayview Ave, Toronto, ON M2L 1A2",
                            level: "Elementary/High School",
                            special: "All-boys education, strong academics, extensive athletics program"
                        },
                        {
                            name: "Havergal College",
                            type: "Private â€¢ Girls School",
                            rating: "9.4/10", 
                            ratingSource: "Fraser Institute",
                            address: "1451 Avenue Rd, Toronto, ON M5N 2H9",
                            level: "Elementary/High School",
                            special: "All-girls education, IB program, leadership development"
                        },
                        {
                            name: "Marc Garneau Collegiate Institute",
                            type: "Public â€¢ High School",
                            rating: "8.7/10",
                            ratingSource: "Fraser Institute", 
                            address: "135 Overlea Blvd, Toronto, ON M4H 1A1",
                            level: "High School",
                            special: "STEM focus, aerospace program, technology integration"
                        },
                        {
                            name: "Lawrence Park Collegiate Institute",
                            type: "Public â€¢ High School",
                            rating: "8.8/10",
                            ratingSource: "Fraser Institute",
                            address: "125 Chatsworth Dr, Toronto, ON M4R 1S2", 
                            level: "High School",
                            special: "French Immersion, advanced placement, strong community"
                        },
                        {
                            name: "Upper Canada College",
                            type: "Private â€¢ Boys School",
                            rating: "9.6/10",
                            ratingSource: "Fraser Institute",
                            address: "200 Lonsdale Rd, Toronto, ON M4V 1W6",
                            level: "Elementary/High School", 
                            special: "Prestigious all-boys school, IB program, extensive alumni network"
                        },
                        {
                            name: "Martingrove Collegiate Institute",
                            type: "Public â€¢ High School",
                            rating: "8.1/10", 
                            ratingSource: "Fraser Institute",
                            address: "50 Winterton Dr, Etobicoke, ON M9V 2J9",
                            level: "High School",
                            special: "Diverse programs, arts focus, community partnerships"
                        },
                        {
                            name: "The Bishop Strachan School",
                            type: "Private â€¢ Girls School",
                            rating: "9.3/10",
                            ratingSource: "Fraser Institute", 
                            address: "298 Lonsdale Rd, Toronto, ON M4V 1X2",
                            level: "Elementary/High School",
                            special: "All-girls Anglican school, strong academics, leadership programs"
                        }
                    ],
                    // Add other Toronto amenity categories here...
                    'shopping': [
                        {
                            name: "Eaton Centre",
                            type: "Major Shopping Mall",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews", 
                            address: "220 Yonge St, Toronto, ON M5B 2H1",
                            special: "Downtown landmark, 250+ stores, H&M flagship, direct subway access"
                        },
                        {
                            name: "Yorkdale Shopping Centre", 
                            type: "Luxury Shopping Mall",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "3401 Dufferin St, Toronto, ON M6A 2T9", 
                            special: "Luxury brands, Apple Store, Tesla showroom, premium shopping experience"
                        },
                        {
                            name: "Sherway Gardens",
                            type: "Upscale Shopping Centre",
                            rating: "4.2/5", 
                            ratingSource: "Google Reviews",
                            address: "25 The West Mall, Etobicoke, ON M9C 1B8",
                            special: "Upscale retailers, Nordstrom, excellent dining, convenient parking"
                        },
                        {
                            name: "Fairview Mall",
                            type: "Regional Shopping Centre",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "1800 Sheppard Ave E, North York, ON M2J 5A7",
                            special: "Anchor stores include Hudson's Bay, Metro, 170+ stores and services"
                        },
                        {
                            name: "Scarborough Town Centre",
                            type: "Major Shopping Mall",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews", 
                            address: "300 Borough Dr, Scarborough, ON M1P 4P5",
                            special: "Eastern GTA hub, 200+ stores, direct RT access, major renovations"
                        },
                        {
                            name: "Dufferin Mall",
                            type: "Community Shopping Centre",
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "900 Dufferin St, Toronto, ON M6H 4A9",
                            special: "Walmart Supercentre, No Frills, diverse community shopping"
                        },
                        {
                            name: "Pacific Mall",
                            type: "Asian Shopping Centre",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "4300 Steeles Ave E, Markham, ON L3R 0Y5",
                            special: "Largest indoor Asian mall in North America, 270+ stores"
                        },
                        {
                            name: "Hillcrest Mall", 
                            type: "Regional Shopping Centre",
                            rating: "3.8/5",
                            ratingSource: "Google Reviews",
                            address: "9350 Yonge St, Richmond Hill, ON L4C 5G2",
                            special: "Sears outlet, Winners, Good Life Fitness, community focus"
                        },
                        {
                            name: "Promenade Mall",
                            type: "Shopping Centre",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "1 Promenade Cir, Thornhill, ON L4J 4P8",
                            special: "Loblaws, Winners, diverse dining options, movie theatre"
                        }
                    ],
                    'grocery': [
                        {
                            name: "Loblaws at Maple Leaf Gardens",
                            type: "Premium Supermarket",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "60 Carlton St, Toronto, ON M5B 1J2",
                            special: "Historic Maple Leaf Gardens location, Joe Fresh, full-service pharmacy"
                        },
                        {
                            name: "Metro at College Park",
                            type: "Urban Supermarket",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "444 Yonge St, Toronto, ON M5B 2H4",
                            special: "Downtown location, connected to College Park, urban convenience"
                        },
                        {
                            name: "Pusateri's Fine Foods",
                            type: "Gourmet Grocery",
                            rating: "4.4/5",
                            ratingSource: "Google Reviews",
                            address: "57 Yorkville Ave, Toronto, ON M5R 1B7",
                            special: "Luxury grocer, gourmet products, premium meats and seafood"
                        },
                        {
                            name: "T&T Supermarket Cherry Street",
                            type: "Asian Supermarket",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "222 Cherry St, Toronto, ON M5A 3L2",
                            special: "Flagship location, extensive Asian groceries, hot food counter"
                        },
                        {
                            name: "FreshCo Bloor West",
                            type: "Discount Supermarket",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "2289 Bloor St W, Toronto, ON M6S 1P1",
                            special: "Competitive prices, fresh produce, PC Optimum rewards"
                        },
                        {
                            name: "Sobeys Urban Fresh",
                            type: "Urban Format Store",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "87 Front St E, Toronto, ON M5E 1C3",
                            special: "Downtown format, grab-and-go options, Scene+ rewards"
                        },
                        {
                            name: "No Frills Dufferin",
                            type: "Discount Supermarket",
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "900 Dufferin St, Toronto, ON M6H 4A9",
                            special: "Low prices, bulk options, community-focused"
                        },
                        {
                            name: "Longo's Maple Leaf Square",
                            type: "Premium Supermarket",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "15 York St, Toronto, ON M5J 0A3",
                            special: "Entertainment District location, premium products, extended hours"
                        },
                        {
                            name: "Farm Boy Toronto",
                            type: "Fresh Market",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews", 
                            address: "15 Lower Jarvis St, Toronto, ON M5E 1M4",
                            special: "Farm-fresh products, artisanal goods, excellent prepared foods"
                        },
                        {
                            name: "Bulk Barn Queen Street",
                            type: "Bulk Foods Store",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "579 Queen St W, Toronto, ON M5V 2B6",
                            special: "Bulk foods, nuts, grains, baking supplies, eco-friendly shopping"
                        }
                    ],
                    'hospitals': [
                        {
                            name: "Toronto General Hospital",
                            type: "Major Teaching Hospital",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "200 Elizabeth St, Toronto, ON M5G 2C4",
                            special: "World-renowned multi-organ transplant center, cardiac surgery, research"
                        },
                        {
                            name: "Hospital for Sick Children (SickKids)",
                            type: "Pediatric Hospital",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews",
                            address: "555 University Ave, Toronto, ON M5G 1X8",
                            special: "Leading pediatric hospital, research institute, specialized child care"
                        },
                        {
                            name: "Mount Sinai Hospital",
                            type: "Teaching Hospital",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "600 University Ave, Toronto, ON M5G 1X5",
                            special: "Women's and infants' health, high-risk pregnancies, emergency services"
                        },
                        {
                            name: "Princess Margaret Cancer Centre",
                            type: "Cancer Specialty Hospital",
                            rating: "4.4/5",
                            ratingSource: "Google Reviews",
                            address: "610 University Ave, Toronto, ON M5G 2M9",
                            special: "Leading cancer research and treatment, comprehensive cancer care"
                        },
                        {
                            name: "St. Michael's Hospital",
                            type: "Trauma Center",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "30 Bond St, Toronto, ON M5B 1W8",
                            special: "Level 1 trauma center, downtown emergency services, cardiac care"
                        },
                        {
                            name: "Sunnybrook Health Sciences Centre",
                            type: "Academic Health Science Centre",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "2075 Bayview Ave, Toronto, ON M4N 3M5",
                            special: "Trauma center, veterans care, Odette Cancer Centre"
                        },
                        {
                            name: "Toronto Western Hospital",
                            type: "Teaching Hospital",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "399 Bathurst St, Toronto, ON M5T 2S8",
                            special: "Neurosurgery, spine care, mental health services"
                        },
                        {
                            name: "North York General Hospital",
                            type: "Community Hospital",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "4001 Leslie St, North York, ON M2K 1E1",
                            special: "Full-service community hospital, emergency services, seniors care"
                        },
                        {
                            name: "Scarborough Health Network",
                            type: "Multi-Site Hospital System",
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "3050 Lawrence Ave E, Scarborough, ON M1P 2V5",
                            special: "Three hospital campuses, emergency services, community focus"
                        },
                        {
                            name: "Women's College Hospital",
                            type: "Ambulatory Care Hospital",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "76 Grenville St, Toronto, ON M5S 1B2",
                            special: "Women's health focus, ambulatory care, mental health services"
                        }
                    ],
                    'parks': [
                        {
                            name: "High Park",
                            type: "Urban Park",
                            rating: "4.6/5",
                            ratingSource: "Google Reviews",
                            address: "1873 Bloor St W, Toronto, ON M6R 2Z3",
                            special: "Toronto's largest park, cherry blossoms, hiking trails, Grenadier Cafe"
                        },
                        {
                            name: "Toronto Islands",
                            type: "Island Park System",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews",
                            address: "Toronto Islands, Toronto, ON",
                            special: "Car-free islands, beaches, Centreville Amusement Park, spectacular city views"
                        },
                        {
                            name: "Trinity Bellwoods Park",
                            type: "Urban Community Park",
                            rating: "4.4/5",
                            ratingSource: "Google Reviews",
                            address: "155 Crawford St, Toronto, ON M6J 2V5",
                            special: "Hip neighborhood park, dog off-leash area, community events, trendy location"
                        },
                        {
                            name: "Riverdale Park East",
                            type: "Scenic Overlook Park",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews",
                            address: "550 Broadview Ave, Toronto, ON M4K 2N6",
                            special: "Best skyline views of downtown Toronto, sledding hill, sports facilities"
                        },
                        {
                            name: "Harbourfront Centre",
                            type: "Waterfront Cultural Park",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "235 Queens Quay W, Toronto, ON M5J 2G8",
                            special: "Cultural events, festivals, waterfront walking, art galleries"
                        },
                        {
                            name: "Scarborough Bluffs",
                            type: "Natural Escarpment Park",
                            rating: "4.7/5",
                            ratingSource: "Google Reviews",
                            address: "1 Brimley Rd S, Scarborough, ON M1M 3W3",
                            special: "Dramatic cliffs, Lake Ontario views, hiking trails, photography spot"
                        },
                        {
                            name: "Rouge Valley",
                            type: "Conservation Area",
                            rating: "4.4/5",
                            ratingSource: "Google Reviews",
                            address: "Rouge Valley, Toronto, ON",
                            special: "Urban wilderness, hiking trails, wildlife viewing, river valleys"
                        },
                        {
                            name: "Kew Gardens",
                            type: "Beachfront Park",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "2075 Queen St E, Toronto, ON M4E 1E5",
                            special: "Sandy beach, boardwalk, historic Leuty Lifeguard Station"
                        },
                        {
                            name: "Don Valley Brick Works",
                            type: "Historic Site Park",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews",
                            address: "550 Bayview Ave, Toronto, ON M4W 3X8",
                            special: "Former brick factory, nature trails, Saturday farmers market, bird watching"
                        },
                        {
                            name: "Centennial Park",
                            type: "Multi-Use Recreation Park",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "256 Centennial Park Rd, Etobicoke, ON M9C 5N3",
                            special: "Ski and snowboard facility, golf course, conservatory, large green spaces"
                        }
                    ]
                }
            };
            
            const result = amenityDatabase[city] && amenityDatabase[city][amenity] ? amenityDatabase[city][amenity] : null;
            console.log('ðŸ—ƒï¸ Database lookup:', city, amenity, 'result:', result ? result.length : 'null');
            return result;
        }

        /**
         * Display comprehensive amenity data in the enhanced format
         */
        function displayAmenityData(data, amenity, city) {
            console.log('ðŸ“ displayAmenityData called with:', data.length, 'items for', amenity, 'in', city);
            
            try {
                const amenityLabels = {
                'schools': 'ðŸŽ“ Educational Institutions',
                'shopping': 'ðŸ›ï¸ Shopping Centers',
                'grocery': 'ðŸ›’ Grocery Stores', 
                'hospitals': 'ðŸ¥ Medical Facilities',
                'parks': 'ðŸŒ³ Parks & Recreation'
            };

            const amenityIcons = {
                'schools': 'ðŸŽ“',
                'shopping': 'ðŸ›ï¸',
                'grocery': 'ðŸ›’',
                'hospitals': 'ðŸ¥', 
                'parks': 'ðŸŒ³'
            };

            let content = `
                <div class="amenity-response">
                    <div class="amenity-header">
                        <h2>${amenityIcons[amenity]} ${amenityLabels[amenity]}</h2>
                        <p>Comprehensive ${amenity} information with ratings and details for ${city}</p>
                        <div class="openai-badge">AI Enhanced</div>
                    </div>
                    <div class="amenity-grid">
            `;

            data.forEach((item, index) => {
                content += renderAmenityCard(item, amenity, index);
            });

            content += `
                    </div>
                </div>
            `;

            console.log('ðŸ“¤ About to call addMessage with content length:', content.length);
            addMessage('assistant', content, { 
                isAI: true,
                quickReplies: [`Tell me more about ${city} ${amenity}`, `Compare with nearby cities`, `Find specific ${amenity} recommendations`]
            });
            console.log('âœ… addMessage completed successfully');
            
            } catch (error) {
                console.error('âŒ Error in displayAmenityData:', error);
                throw error; // Re-throw to be caught by handleAmenityClick
            }
        }

        /**
         * Get rating class for color-coding
         */
        function getRatingClass(rating) {
            if (rating >= 8.5 || rating >= 4.3) return 'high';
            if (rating >= 7.0 || rating >= 3.8) return 'medium';
            return 'low';
        }

        /**
         * Render individual amenity cards
         */
        function renderAmenityCard(item, amenity, index) {
            const typeInfo = getAmenityTypeInfo(amenity);
            
            // Parse rating safely
            let ratingValue = item.rating;
            let numericRating = parseFloat(ratingValue);
            if (isNaN(numericRating)) {
                // Try to extract number from string like "9.3/10"
                const match = ratingValue.match(/(\d+\.?\d*)/);
                numericRating = match ? parseFloat(match[1]) : 0;
            }
            
            return `
                <div class="amenity-card" role="article" tabindex="0" data-amenity-id="${index}">
                    <div class="amenity-card-header">
                        <div class="amenity-name">${item.name}</div>
                        <div class="amenity-type">${item.type}</div>
                        <div class="amenity-rating ${getRatingClass(numericRating)}">
                            â­ ${item.rating}${item.ratingSource ? ` (${item.ratingSource})` : ''}
                        </div>
                    </div>
                    
                    <div class="amenity-details">
                        <div class="amenity-address">
                            ðŸ“ ${item.address}
                        </div>
                        
                        ${item.level ? `
                            <div class="amenity-level">
                                ðŸŽ’ ${item.level}
                            </div>
                        ` : ''}
                        
                        <div class="amenity-special">
                            ${item.special}
                        </div>
                    </div>
                    
                    <div class="amenity-actions">
                        <button class="amenity-btn primary" onclick="getAmenityDetails('${item.name.replace(/'/g, "\\'")}')">
                            View Details
                        </button>
                        <button class="amenity-btn" onclick="getDirections('${item.address.replace(/'/g, "\\'")}')">
                            Directions
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Get amenity type information for styling
         */
        function getAmenityTypeInfo(amenity) {
            const typeInfo = {
                'schools': { icon: 'ðŸŽ“', label: 'Educational Institution' },
                'shopping': { icon: 'ðŸ›ï¸', label: 'Shopping Center' },
                'grocery': { icon: 'ðŸ›’', label: 'Grocery Store' },
                'hospitals': { icon: 'ðŸ¥', label: 'Medical Facility' },
                'parks': { icon: 'ðŸŒ³', label: 'Park & Recreation' }
            };
            return typeInfo[amenity] || { icon: 'ðŸ“', label: 'Location' };
        }

        /**
         * Get directions to an amenity
         */
        function getDirections(address) {
            const encodedAddress = encodeURIComponent(address);
            const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
            window.open(mapsUrl, '_blank');
        }

        /**
         * Get detailed information about an amenity
         */
        function getAmenityDetails(name) {
            sendMessage(`Tell me more detailed information about ${name}, including services, hours, contact information, and recent reviews.`);
        }

        /**
         * Handle "Tell Me More" clicks with auto follow-up questions
         */
        async function handleTellMeMore(id, type = 'property') {
            console.log('ðŸ” Tell me more:', id, type);
            
            showTypingIndicator();
            addMessage('user', 'Tell me more about this');

            try {
                let response;
                
                // Choose endpoint based on type
                if (type === 'url') {
                    // Use EXA details endpoint for URLs
                    response = await fetch(`${filterState.apiBaseUrl}/api/exa/details?url=${encodeURIComponent(id)}&topic=${filterState.selectedCity || 'real estate'}`);
                } else {
                    // Use regular details endpoint for properties
                    response = await fetch(`${filterState.apiBaseUrl}/api/details?id=${id}&type=${type}`);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log('âœ… Details received:', data);

                // Display follow-up questions first
                if (data.follow_up_questions && data.follow_up_questions.length > 0) {
                    displayFollowUpQuestions(data.follow_up_questions, id);
                }

                // Then display detailed information
                if (data.details) {
                    displayDetailedInfo(data.details, type);
                }

            } catch (error) {
                console.error('âŒ Error fetching details:', error);
                addMessage('assistant', 'âš ï¸ Could not load detailed information. Please try again.');
            } finally {
                hideTypingIndicator();
            }
        }

        /**
         * Display follow-up questions
         */
        function displayFollowUpQuestions(questions, contextId) {
            let html = `
                <div class="follow-up-questions" style="
                    background: linear-gradient(135deg, rgba(51, 128, 141, 0.1) 0%, rgba(29, 116, 128, 0.1) 100%);
                    border: 1px solid rgba(51, 128, 141, 0.2);
                    border-radius: 12px;
                    padding: 20px;
                    margin: 12px 0;
                ">
                    <h4 style="margin: 0 0 16px 0; color: var(--color-primary); display: flex; align-items: center; gap: 8px;">
                        <span>ðŸ’¡</span>
                        <span>You might also want to know:</span>
                    </h4>
                    <div style="display: grid; gap: 10px;">
                        ${questions.map((question, idx) => `
                            <button onclick="sendMessage('${question.replace(/'/g, "\\'")}')" style="
                                padding: 14px 18px;
                                background: white;
                                border: 1px solid rgba(51, 128, 141, 0.2);
                                border-radius: 10px;
                                color: var(--color-text-primary);
                                font-size: 14px;
                                text-align: left;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            " onmouseover="this.style.background='var(--color-bg-secondary)'; this.style.borderColor='var(--color-primary)';" 
                               onmouseout="this.style.background='white'; this.style.borderColor='rgba(51, 128, 141, 0.2)';">
                                <span style="
                                    min-width: 24px;
                                    height: 24px;
                                    background: var(--color-primary);
                                    color: white;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 12px;
                                    font-weight: 600;
                                ">${idx + 1}</span>
                                <span style="flex: 1;">${question}</span>
                                <span style="opacity: 0.5;">â†’</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            addMessage('assistant', html);
        }

        /**
         * Display detailed information
         */
        function displayDetailedInfo(details, type) {
            let html = '';

            if (type === 'property' && details.address) {
                // Property details
                html = `
                    <div class="detailed-info" style="
                        background: var(--color-bg-primary);
                        border-radius: 12px;
                        padding: 24px;
                        margin: 12px 0;
                        border: 1px solid var(--color-border);
                    ">
                        <h3 style="margin: 0 0 20px 0; color: var(--color-primary);">ðŸ“‹ Detailed Information</h3>
                        <div style="display: grid; gap: 16px;">
                            ${details.address ? `<div><strong>Address:</strong> ${details.address}</div>` : ''}
                            ${details.price ? `<div><strong>Price:</strong> $${details.price.toLocaleString()}</div>` : ''}
                            ${details.bedrooms ? `<div><strong>Bedrooms:</strong> ${details.bedrooms}</div>` : ''}
                            ${details.bathrooms ? `<div><strong>Bathrooms:</strong> ${details.bathrooms}</div>` : ''}
                            ${details.sqft ? `<div><strong>Square Feet:</strong> ${details.sqft.toLocaleString()}</div>` : ''}
                            ${details.description ? `<div><strong>Description:</strong><br>${details.description}</div>` : ''}
                        </div>
                    </div>
                `;
            } else if (details.text) {
                // General content details
                html = `
                    <div class="detailed-info" style="
                        background: var(--color-bg-primary);
                        border-radius: 12px;
                        padding: 24px;
                        margin: 12px 0;
                        border: 1px solid var(--color-border);
                    ">
                        <h3 style="margin: 0 0 20px 0; color: var(--color-primary);">ðŸ“‹ ${details.title || 'Detailed Information'}</h3>
                        <div style="line-height: 1.6; color: var(--color-text-primary);">
                            ${details.text}
                        </div>
                        ${details.url ? `
                            <div style="margin-top: 16px;">
                                <a href="${details.url}" target="_blank" style="
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 8px;
                                    padding: 10px 16px;
                                    background: var(--color-primary);
                                    color: white;
                                    text-decoration: none;
                                    border-radius: 8px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                ">
                                    <span>View Full Source</span>
                                    <span>â†—</span>
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                html = `
                    <div class="detailed-info" style="
                        background: var(--color-bg-primary);
                        border-radius: 12px;
                        padding: 24px;
                        margin: 12px 0;
                        border: 1px solid var(--color-border);
                    ">
                        <p>${details.message || 'Detailed information is being processed.'}</p>
                    </div>
                `;
            }

            addMessage('assistant', html);
        }

        // ==================== END ENHANCED SIDEBAR HANDLERS ====================

        // ==================== CORE CLASSES ====================
        
        /**
         * Cache utility for storing API responses
         */
        class Cache {
            constructor(ttl = 300000) { // 5 minutes default
                this.cache = new Map();
                this.ttl = ttl;
            }
            
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                if (Date.now() - item.timestamp > this.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                return item.data;
            }
            
            set(key, data) {
                this.cache.set(key, { data, timestamp: Date.now() });
            }
            
            clear() {
                this.cache.clear();
            }
        }

        /**
         * Complete API Service Layer - All 32 Backend Endpoints
         */
        class SummitlyAPI {
            constructor(baseURL = '') {
                this.baseURL = baseURL;
                this.cache = new Cache(300000);
                this.activeRequests = new Map();
            }

            async request(endpoint, options = {}, retries = 3, useCache = false) {
                const url = `${this.baseURL}${endpoint}`;
                const cacheKey = `${endpoint}_${JSON.stringify(options.body || {})}`;
                
                // Check cache
                if (useCache && options.method === 'GET' || options.method === 'POST') {
                    const cached = this.cache.get(cacheKey);
                    if (cached) return cached;
                }
                
                // Retry logic
                for (let attempt = 0; attempt < retries; attempt++) {
                    try {
                        const response = await fetch(url, {
                            ...options,
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();
                        
                        if (useCache) {
                            this.cache.set(cacheKey, data);
                        }
                        
                        return data;
                    } catch (error) {
                        console.error(`Attempt ${attempt + 1}/${retries} failed:`, error);
                        if (attempt === retries - 1) throw error;
                        await this.sleep(Math.pow(2, attempt) * 1000);
                    }
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // ===== INTELLIGENT CHAT ENDPOINTS =====
            async intelligentChatSync(message, sessionId, context = {}) {
                return await this.request('/api/intelligent-chat-sync', {
                    method: 'POST',
                    body: JSON.stringify({ message, session_id: sessionId, context })
                });
            }

            async intelligentChat(message, sessionId) {
                return await this.request('/api/intelligent-chat', {
                    method: 'POST',
                    body: JSON.stringify({ message, session_id: sessionId })
                });
            }

            async intelligentSearch(message) {
                return await this.request('/api/intelligent-search', {
                    method: 'POST',
                    body: JSON.stringify({ message })
                });
            }

            async intelligentReset(sessionId) {
                return await this.request('/api/intelligent-reset', {
                    method: 'POST',
                    body: JSON.stringify({ session_id: sessionId })
                });
            }

            // ===== VOICE & MULTIMODAL ENDPOINTS =====
            async voiceChat(audioBlob, sessionId) {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('session_id', sessionId);

                const response = await fetch(`${this.baseURL}/api/voice-chat`, {
                    method: 'POST',
                    body: formData
                });
                return await response.json();
            }

            async multimodalChat(text, files, sessionId) {
                const formData = new FormData();
                formData.append('text', text);
                formData.append('session_id', sessionId);
                
                if (files && files.length > 0) {
                    files.forEach((file) => {
                        if (file.type.startsWith('image/')) {
                            formData.append('images', file);
                        } else if (file.type.startsWith('video/')) {
                            formData.append('video', file);
                        } else if (file.type.startsWith('audio/')) {
                            formData.append('audio', file);
                        }
                    });
                }

                const response = await fetch(`${this.baseURL}/api/multimodal-chat`, {
                    method: 'POST',
                    body: formData
                });
                return await response.json();
            }

            // ===== PROPERTY & LOCATION ENDPOINTS =====
            async propertyAnalysis(mlsNumber, analysisType = 'full') {
                return await this.request('/api/property-analysis', {
                    method: 'POST',
                    body: JSON.stringify({ mls_number: mlsNumber, analysis_type: analysisType })
                });
            }

            async locationInsights(location, radius = 2) {
                return await this.request('/api/location-insights', {
                    method: 'POST',
                    body: JSON.stringify({ location, radius })
                }, 3, true); // Cache location data
            }

            // ===== REPLIERS MLS ENDPOINTS =====
            async repliersNLPSearch(query, filters = {}) {
                return await this.request('/api/repliers-nlp-search', {
                    method: 'POST',
                    body: JSON.stringify({ query, filters })
                }, 3, true);
            }

            async repliersPropertyDetails(mlsId) {
                return await this.request(`/api/repliers-property-details/${mlsId}`, {
                    method: 'GET'
                }, 3, true);
            }

            async repliersEstimate(mlsNumber) {
                return await this.request('/api/repliers-estimate', {
                    method: 'POST',
                    body: JSON.stringify({ mls_number: mlsNumber })
                });
            }

            // ===== MANAGER ENDPOINTS =====
            async getDashboardStats() {
                return await this.request('/api/manager/dashboard-stats', { method: 'GET' });
            }

            async getLeads() {
                return await this.request('/api/manager/leads', { method: 'GET' });
            }

            async getBrokers() {
                return await this.request('/api/manager/brokers', { method: 'GET' }, 3, true);
            }

            async updateLeadStatus(leadId, status) {
                return await this.request('/api/manager/update-lead-status', {
                    method: 'POST',
                    body: JSON.stringify({ lead_id: leadId, status })
                });
            }

            async assignBroker(leadId, brokerId) {
                return await this.request('/api/manager/assign-broker', {
                    method: 'POST',
                    body: JSON.stringify({ lead_id: leadId, broker_id: brokerId })
                });
            }

            // ===== UTILITY ENDPOINTS =====
            async getHealth() {
                return await this.request('/api/health', { method: 'GET' });
            }
        }

        /**
         * Application State Management
         */
        class AppState {
            constructor() {
                this.sessionId = this.generateSessionId();
                this.chatHistory = [];
                this.userProfile = {};
                this.activeProperty = null;
                this.viewMode = 'chat'; // 'chat' | 'dashboard' | 'search'
                this.uploadedFiles = [];
                this.searchFilters = {};
                this.loadFromStorage();
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            addMessage(sender, content, metadata = {}) {
                const message = {
                    sender,
                    content,
                    metadata,
                    timestamp: new Date()
                };
                this.chatHistory.push(message);
                this.saveToStorage();
                return message;
            }

            clearHistory() {
                this.chatHistory = [];
                this.saveToStorage();
            }

            setActiveProperty(property) {
                this.activeProperty = property;
                this.saveToStorage();
            }

            setViewMode(mode) {
                this.viewMode = mode;
            }

            saveToStorage() {
                try {
                    localStorage.setItem('summitly_state', JSON.stringify({
                        sessionId: this.sessionId,
                        chatHistory: this.chatHistory.slice(-50), // Last 50 messages
                        userProfile: this.userProfile,
                        timestamp: Date.now()
                    }));
                } catch (e) {
                    console.warn('Failed to save to localStorage:', e);
                }
            }

            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('summitly_state');
                    if (!saved) return;
                    
                    const state = JSON.parse(saved);
                    if (Date.now() - state.timestamp > 86400000) return; // 24hr expiry
                    
                    this.sessionId = state.sessionId || this.sessionId;
                    this.chatHistory = state.chatHistory || [];
                    this.userProfile = state.userProfile || {};
                } catch (e) {
                    console.warn('Failed to load from localStorage:', e);
                }
            }
        }

        /**
         * File Upload Manager
         */
        class FileUploadManager {
            constructor() {
                this.files = [];
                this.maxSize = 50 * 1024 * 1024; // 50MB
                this.supportedFormats = {
                    image: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
                    video: ['mp4', 'webm', 'mov'],
                    audio: ['mp3', 'wav', 'webm', 'ogg'],
                    document: ['pdf', 'doc', 'docx']
                };
            }

            validateFile(file) {
                if (file.size > this.maxSize) {
                    throw new Error(`File ${file.name} exceeds 50MB limit`);
                }

                const ext = file.name.split('.').pop().toLowerCase();
                const isSupported = Object.values(this.supportedFormats).some(formats => 
                    formats.includes(ext)
                );

                if (!isSupported) {
                    throw new Error(`File type .${ext} is not supported`);
                }

                return true;
            }

            addFile(file) {
                this.validateFile(file);
                this.files.push({
                    file,
                    id: Date.now() + Math.random(),
                    preview: null
                });
            }

            async generatePreview(file) {
                return new Promise((resolve) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    } else {
                        resolve(null);
                    }
                });
            }

            removeFile(id) {
                this.files = this.files.filter(f => f.id !== id);
            }

            clear() {
                this.files = [];
            }

            getFiles() {
                return this.files.map(f => f.file);
            }
        }

        /**
         * Voice Recording Manager
         */
        class VoiceManager {
            constructor() {
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.stream = null;
                this.isRecording = false;
                this.audioContext = null;
                this.analyser = null;
            }

            async initialize() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    const source = this.audioContext.createMediaStreamSource(this.stream);
                    source.connect(this.analyser);
                    return true;
                } catch (error) {
                    console.error('Microphone access denied:', error);
                    throw new Error('Please enable microphone access to use voice features');
                }
            }

            async startRecording() {
                if (!this.stream) {
                    await this.initialize();
                }

                this.audioChunks = [];
                this.mediaRecorder = new MediaRecorder(this.stream);
                
                this.mediaRecorder.ondataavailable = (event) => {
                    this.audioChunks.push(event.data);
                };

                this.mediaRecorder.start();
                this.isRecording = true;
            }

            async stopRecording() {
                return new Promise((resolve) => {
                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.audioChunks, { type: 'audio/webm' });
                        this.isRecording = false;
                        resolve(blob);
                    };
                    this.mediaRecorder.stop();
                });
            }

            visualize(canvas) {
                if (!this.analyser || !canvas) return;

                const ctx = canvas.getContext('2d');
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                const draw = () => {
                    if (!this.isRecording) return;
                    
                    requestAnimationFrame(draw);
                    this.analyser.getByteFrequencyData(dataArray);

                    ctx.fillStyle = '#e8f4f8';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    const barWidth = (canvas.width / bufferLength) * 2.5;
                    let x = 0;

                    for (let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * canvas.height;
                        ctx.fillStyle = `rgb(51, 128, 141)`;
                        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                        x += barWidth + 1;
                    }
                };

                draw();
            }

            cleanup() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                if (this.audioContext) {
                    this.audioContext.close();
                }
            }
        }

        // ==================== GLOBAL STATE ====================
        
        // Initialize core instances
        const api = new SummitlyAPI(getApiBaseUrl());
        const appState = new AppState();
        const fileManager = new FileUploadManager();
        const voiceManager = new VoiceManager();
        
        // Legacy compatibility
        let chatHistory = appState.chatHistory;
        let isRecording = false;
        let currentSessionId = appState.sessionId;

        // Initialize
        function init() {
            adjustTextareaHeight();
            document.getElementById('chatInput').addEventListener('input', adjustTextareaHeight);
        }

        // Generate Session ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Textarea Auto-resize
        function adjustTextareaHeight() {
            const textarea = document.getElementById('chatInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        // Toggle Sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        // Handle Enter Key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendUserMessage();
            }
        }

        // ==================== ENHANCED MESSAGE HANDLING ====================

        /**
         * Send User Message (with file support)
         */
        function sendUserMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const files = fileManager.getFiles();
            
            // If files attached, use multimodal
            if (files.length > 0) {
                sendMultimodalMessage();
                return;
            }
            
            if (!message) return;
            
            sendMessage(message);
            input.value = '';
            adjustTextareaHeight();
        }

        /**
         * Send Message (main function)
         */
        function sendMessage(message) {
            // Hide welcome screen
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }

            // Add user message
            addMessage('user', message);
            appState.addMessage('user', message);

            // Show typing indicator
            showTypingIndicator();

            // Call AI API
            handleAIResponse(message);
        }

        /**
         * Enhanced Message Rendering
         */
        function addMessage(sender, content, options = {}) {
            console.log('ðŸŽ¨ addMessage called:', { sender, contentLength: content?.length, hasHTML: content?.includes('<div'), openai: options.openai });
            
            const container = document.getElementById('chatContainer');
            if (!container) {
                console.error('âŒ chatContainer not found!');
                return;
            }
            
            const message = document.createElement('div');
            message.className = 'message';
            
            const isUser = sender === 'user';
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Determine AI provider label
            let aiLabel = 'AI Assistant';
            let badgeHTML = '';
            let contentClass = 'message-content';
            
            if (!isUser) {
                if (options.openai) {
                    badgeHTML = '<span class="openai-badge">AI Enhanced</span>';
                    contentClass += ' openai-enhanced';
                    console.log('âœ¨ Adding OpenAI badge to message');
                } else if (options.exa) {
                    aiLabel = 'AI Assistant (Research Mode)';
                } else if (options.llama) {
                    aiLabel = 'AI Assistant (Local Model)';
                }
            }
            
            message.innerHTML = `
                <div class="message-avatar ${isUser ? 'user-avatar' : 'ai-avatar'}">
                    ${isUser ? 'U' : 'ðŸ¤–'}
                </div>
                <div class="${contentClass}">
                    <div class="message-header">
                        <span class="message-author">${isUser ? 'You' : aiLabel}</span>
                        ${badgeHTML}
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text"></div>
                    ${options.quickReplies ? generateQuickReplies(options.quickReplies) : ''}
                    ${options.properties ? generatePropertyCards(options.properties) : ''}
                    ${options.sources ? generateSourceLinks(options.sources) : ''}
                </div>
            `;
            
            // CRITICAL FIX: Set content as innerHTML to render HTML (photos, cards, etc.)
            const messageTextDiv = message.querySelector('.message-text');
            if (messageTextDiv) {
                // Enhance text responses for better visual appeal
                const enhancedContent = enhanceTextResponse(content, !isUser);
                messageTextDiv.innerHTML = enhancedContent;
                console.log('âœ… Enhanced content rendered:', enhancedContent.includes('<h3') ? 'Enhanced with formatting' : enhancedContent.includes('<div') ? 'Contains HTML' : 'Plain text');
            }
            
            container.appendChild(message);
            console.log('âœ… Message added to DOM');
            scrollToBottom();
        }

        /**
         * File Upload Integration
         */
        function showFileUpload() {
            const input = document.getElementById('fileInput');
            if (!input) {
                const newInput = document.createElement('input');
                newInput.type = 'file';
                newInput.id = 'fileInput';
                newInput.multiple = true;
                newInput.accept = 'image/*,video/*,.pdf,.doc,.docx';
                newInput.style.display = 'none';
                newInput.onchange = (e) => handleFileUpload(Array.from(e.target.files));
                document.body.appendChild(newInput);
                newInput.click();
            } else {
                input.click();
            }
        }

        /**
         * Drag and Drop Support
         */
        function setupDragDrop() {
            const inputArea = document.querySelector('.input-area');
            if (!inputArea) return;

            inputArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                inputArea.style.background = 'rgba(51, 128, 141, 0.1)';
            });

            inputArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                inputArea.style.background = '';
            });

            inputArea.addEventListener('drop', (e) => {
                e.preventDefault();
                inputArea.style.background = '';
                const files = Array.from(e.dataTransfer.files);
                handleFileUpload(files);
            });
        }

        /**
         * Keyboard Shortcuts
         */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Cmd/Ctrl + K: Focus search/input
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('chatInput')?.focus();
                }

                // Cmd/Ctrl + D: Toggle Dashboard
                if ((e.metaKey || e.ctrlKey) && e.key === 'd') {
                    e.preventDefault();
                    toggleDashboard();
                }

                // Cmd/Ctrl + N: New Chat
                if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                    e.preventDefault();
                    startNewChat();
                }

                // Cmd/Ctrl + U: Upload File
                if ((e.metaKey || e.ctrlKey) && e.key === 'u') {
                    e.preventDefault();
                    showFileUpload();
                }

                // Cmd/Ctrl + Shift + V: Voice Input
                if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'v') {
                    e.preventDefault();
                    openVoiceModal();
                }
            });
        }

        /**
         * Enhanced Initialization
         */
        function init() {
            adjustTextareaHeight();
            document.getElementById('chatInput').addEventListener('input', adjustTextareaHeight);
            setupDragDrop();
            setupKeyboardShortcuts();
            
            // Check system health
            checkSystemHealth();
            
            // Add welcome message
            if (chatHistory.length === 0) {
                setTimeout(() => {
                    addMessage('ai', 'Hello! I\'m your AI real estate assistant. I can help you search properties, calculate valuations, analyze neighborhoods, and connect you with expert brokers. How can I assist you today?', {
                        quickReplies: ['Search properties', 'Property valuation', 'Market analysis', 'Contact broker']
                    });
                }, 500);
            }
        }

        /**
         * Check System Health
         */
        async function checkSystemHealth() {
            try {
                const health = await api.getHealth();
                if (health.status === 'healthy') {
                    console.log('âœ… All systems operational');
                }
            } catch (error) {
                console.warn('âš ï¸ Some services may be unavailable');
            }
        }

        /**
         * Start New Chat
         */
        function startNewChat() {
            if (confirm('Start a new conversation? Current chat will be saved.')) {
                appState.clearHistory();
                chatHistory = [];
                document.getElementById('chatContainer').innerHTML = `
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">ðŸ </div>
                        <h1 class="welcome-title">Welcome to Summitly AI</h1>
                        <p class="welcome-subtitle">
                            Your intelligent real estate assistant powered by Llama 3.2, Exa AI, and live MLS data.
                        </p>
                    </div>
                `;
                appState.sessionId = appState.generateSessionId();
                currentSessionId = appState.sessionId;
                init();
            }
        }

        // DUPLICATE FUNCTION REMOVED - Using the enhanced version at line 3762

        async function handleAIResponse(userMessage) {
            try {
                // Call real API endpoint
                const response = await fetch(`${getApiBaseUrl()}/api/intelligent-chat-sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: userMessage,
                        session_id: currentSessionId
                    })
                });

                const data = await response.json();
                
                // Hide typing indicator
                hideTypingIndicator();
                
                console.log('ðŸ” API Response:', data);

                if (data.success) {
                    // Extract AI provider flags
                    const isOpenAI = data.openai_enhanced || false;
                    const isExa = data.exa_enhanced || false;
                    const isLlama = data.llama_fallback || false;
                    
                    // Log which AI was used
                    if (isOpenAI) {
                        console.log('âœ¨ OpenAI-enhanced response detected');
                    } else if (isExa) {
                        console.log('ðŸ” Exa-enhanced response detected');
                    } else if (isLlama) {
                        console.log('ðŸ¦™ Llama fallback response detected');
                    }
                    
                    // Check if this is a valuation response with structured data
                    if (data.response_type === 'valuation' && data.structured_data) {
                        console.log('ðŸ“Š Rendering beautiful valuation card with AI estimate');
                        
                        // Use new beautiful card renderer
                        const valuationHTML = renderValuationCard(data);
                        
                        addMessage('ai', valuationHTML, {
                            quickReplies: data.quick_replies || [],
                            openai: isOpenAI,
                            exa: isExa,
                            llama: isLlama
                        });
                    } 
                    // Check if this is a property search response with properties array
                    else if (data.properties && Array.isArray(data.properties) && data.properties.length > 0) {
                        console.log('ðŸ  Rendering property search results');
                        addPropertySearchMessage(data.properties, data.response, data.quick_replies || []);
                    }
                    // Check if response contains EXA results (market analysis, etc.)
                    else if (data.exa_results && data.exa_results.length > 0) {
                        console.log('ðŸŒ Rendering EXA results with AI summary');
                        await renderExaResultsWithSummary(data, userMessage);
                    }
                    else {
                        // Regular message response (including property details with HTML)
                        console.log('ðŸ’¬ Rendering regular message', data.response ? 'with content' : 'empty');
                        console.log('ðŸ“ Response contains HTML:', data.response.includes('<div'));
                        
                        // Check if response contains URLs for summary generation
                        const urlRegex = /https?:\/\/[^\s]+/g;
                        const urls = data.response.match(urlRegex);
                        
                        if (urls && urls.length > 2 && shouldGenerateSummary(userMessage)) {
                            // Generate AI summary for responses with multiple URLs
                            await addMessageWithExaSummary(data.response, userMessage, urls, data.quick_replies || []);
                        } else {
                            console.log('ðŸ” Regular OpenAI response - About to call addMessage:', {
                                length: data.response.length,
                                preview: data.response.substring(0, 200) + '...',
                                containsSchools: data.response.includes('schools'),
                                containsSchoolsLower: data.response.toLowerCase().includes('schools'),
                                containsType: data.response.includes('Type:'),
                                containsRating: data.response.includes('Rating:'),
                                containsAddress: data.response.includes('Address:'),
                                isOpenAI: isOpenAI,
                                firstLine: data.response.split('\n')[0],
                                fullResponseForDebug: data.response // Show full response to debug content
                            });
                            
                            addMessage('ai', data.response, {
                                quickReplies: data.quick_replies || [],
                                openai: isOpenAI,
                                exa: isExa,
                                llama: isLlama
                            });
                            
                            console.log('âœ… addMessage called for regular OpenAI response');
                        }
                    }
                } else {
                    console.log('âŒ API returned error:', data.error);
                    addMessage('ai', data.error || 'Sorry, I encountered an error processing your request.');
                }
            } catch (error) {
                console.error('Error calling API:', error);
                hideTypingIndicator();
                
                // Enhanced error handling for production
                let errorMessage = 'Sorry, I\'m having trouble connecting to the server. Please try again.';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ðŸŒ Connection issue. Please check your internet connection and try again.';
                } else if (error.message.includes('500')) {
                    errorMessage = 'âš™ï¸ Our AI service is temporarily unavailable. We\'re working to fix this quickly!';
                } else if (error.message.includes('timeout')) {
                    errorMessage = 'â±ï¸ Request timed out. The AI is taking longer than usual - please try again.';
                }
                
                addMessage('ai', errorMessage);
                
                // Log error for production monitoring
                console.log('ðŸ” Production Error Details:', {
                    error: error.message,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                });
            }
        }

        /**
         * Check if message should trigger EXA summary generation
         */
        function shouldGenerateSummary(message) {
            const summaryKeywords = ['market', 'analysis', 'trends', 'research', 'compare', 'investment', 'roi', 'neighborhood'];
            return summaryKeywords.some(keyword => message.toLowerCase().includes(keyword));
        }

        /**
         * Render EXA results with AI-generated summary
         */
        async function renderExaResultsWithSummary(data, query) {
            try {
                const exaResults = data.exa_results || [];
                const urls = exaResults.map(r => r.url);
                
                // Call summary endpoint
                const summaryResponse = await fetch(`${filterState.apiBaseUrl}/api/exa/summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        city: filterState.selectedCity,
                        query: query,
                        urls: urls,
                        results: exaResults
                    })
                });

                if (summaryResponse.ok) {
                    const summaryData = await summaryResponse.json();
                    displayExaSummaryAndSources(summaryData, exaResults);
                } else {
                    // Fallback: show results without summary
                    displayExaResults(exaResults);
                }
            } catch (error) {
                console.error('Error generating EXA summary:', error);
                displayExaResults(data.exa_results);
            }
        }

        /**
         * Add message with EXA summary
         */
        async function addMessageWithExaSummary(responseText, query, urls, quickReplies = []) {
            try {
                // Extract text content from response (remove URLs for cleaner display)
                const cleanText = responseText.replace(/https?:\/\/[^\s]+/g, '').trim();
                
                // Generate summary
                const summaryResponse = await fetch(`${filterState.apiBaseUrl}/api/exa/summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        city: filterState.selectedCity,
                        query: query,
                        urls: urls,
                        results: urls.map(url => ({ url, text: cleanText, title: 'Source' }))
                    })
                });

                if (summaryResponse.ok) {
                    const summaryData = await summaryResponse.json();
                    
                    // Combine summary with original response
                    const enhancedHTML = `
                        ${cleanText ? `<div style="margin-bottom: 20px;">${cleanText}</div>` : ''}
                        ${generateExaSummaryHTML(summaryData.summary, urls)}
                    `;
                    
                    addMessage('ai', enhancedHTML, { quickReplies });
                } else {
                    // Fallback: show original response
                    addMessage('ai', responseText, { quickReplies });
                }
            } catch (error) {
                console.error('Error adding message with summary:', error);
                addMessage('ai', responseText, { quickReplies });
            }
        }

        /**
         * Display EXA summary and sources
         */
        function displayExaSummaryAndSources(summaryData, results) {
            const html = generateExaSummaryHTML(summaryData.summary, summaryData.sources);
            addMessage('assistant', html);
        }

        /**
         * Escape HTML to prevent rendering issues
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Format bullet text - preserve markdown bold (**text**) but escape other HTML
         */
        function formatBulletText(text) {
            // First escape all HTML
            let formatted = escapeHtml(text);
            
            // Then convert markdown bold to HTML
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            return formatted;
        }

        /**
         * Generate EXA summary HTML
         */
        function generateExaSummaryHTML(summary, sources) {
            const bullets = summary?.bullets || [];
            const sourcesArray = sources || [];
            
            console.log('ðŸŽ¨ Generating EXA summary HTML:', {
                bulletsCount: bullets.length,
                sourcesCount: sourcesArray.length,
                bullets: bullets
            });

            // Filter out empty bullets
            const validBullets = bullets.filter(b => b && b.trim().length > 0);
            
            if (validBullets.length === 0) {
                console.warn('âš ï¸ No valid bullets to display');
                return `
                    <div class="exa-summary-container" style="
                        background: linear-gradient(135deg, #33808d 0%, #1d7480 100%);
                        border-radius: 16px;
                        padding: 24px;
                        color: white;
                        margin: 12px 0;
                        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                    ">
                        <h3 style="margin: 0 0 16px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                            <span>ðŸ¤–</span>
                            <span>AI Market Summary</span>
                        </h3>
                        <div style="padding: 16px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                            <p style="margin: 0; opacity: 0.9;">ðŸ“Š Analyzing market data...</p>
                            <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.7;">Check the data sources below for detailed information</p>
                        </div>
                        ${sourcesArray.length > 0 ? `
                            <details open style="margin-top: 20px; cursor: pointer;">
                                <summary style="font-weight: 600; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; user-select: none; display: flex; align-items: center; justify-content: space-between;">
                                    <span>ðŸ“š Data Sources (${sourcesArray.length})</span>
                                    <span style="font-size: 12px; opacity: 0.7;">Click to collapse</span>
                                </summary>
                                <div style="margin-top: 12px; max-height: 300px; overflow-y: auto;">
                                    ${sourcesArray.map((url, idx) => {
                                        try {
                                            const hostname = new URL(url).hostname;
                                            return `
                                                <div style="margin: 8px 0; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; transition: all 0.3s ease;" 
                                                     onmouseover="this.style.background='rgba(255,255,255,0.15)'" 
                                                     onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                                    <a href="${url}" target="_blank" style="color: white; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                                                        <span style="min-width: 28px; height: 28px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600;">${idx + 1}</span>
                                                        <div style="flex: 1;">
                                                            <div style="font-size: 13px; font-weight: 500; margin-bottom: 2px;">${hostname}</div>
                                                            <div style="font-size: 11px; opacity: 0.7;">Click to view source</div>
                                                        </div>
                                                        <span style="font-size: 14px; opacity: 0.7;">â†—</span>
                                                    </a>
                                                </div>
                                            `;
                                        } catch (e) {
                                            return `
                                                <div style="margin: 8px 0; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                                    <a href="${url}" target="_blank" style="color: white; text-decoration: none;">
                                                        <span>${idx + 1}. ${url}</span>
                                                    </a>
                                                </div>
                                            `;
                                        }
                                    }).join('')}
                                </div>
                            </details>
                        ` : ''}
                    </div>
                `;
            }

            return `
                <div class="exa-summary-container" style="
                    background: linear-gradient(135deg, #33808d 0%, #1d7480 100%);
                    border-radius: 16px;
                    padding: 24px;
                    color: white;
                    margin: 12px 0;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                ">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                        <span>ðŸ¤–</span>
                        <span>AI Market Summary</span>
                    </h3>
                    
                    <div class="summary-bullets" style="margin-bottom: 20px;">
                        ${validBullets.map(bullet => `
                            <div style="margin: 10px 0; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; backdrop-filter: blur(10px); line-height: 1.6; font-size: 15px;">
                                ${formatBulletText(bullet)}
                            </div>
                        `).join('')}
                    </div>

                    ${sourcesArray.length > 0 ? `
                        <details style="margin-top: 20px; cursor: pointer;">
                            <summary style="font-weight: 600; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; user-select: none; display: flex; align-items: center; justify-content: space-between;">
                                <span>ðŸ“š Data Sources (${sourcesArray.length})</span>
                                <span style="font-size: 12px; opacity: 0.7;">Click to expand</span>
                            </summary>
                            <div style="margin-top: 12px; max-height: 300px; overflow-y: auto;">
                                ${sourcesArray.map((url, idx) => {
                                    const hostname = new URL(url).hostname;
                                    return `
                                        <div style="margin: 8px 0; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; transition: all 0.3s ease;" 
                                             onmouseover="this.style.background='rgba(255,255,255,0.15)'" 
                                             onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                            <a href="${url}" target="_blank" style="color: white; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                                                <span style="min-width: 28px; height: 28px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600;">${idx + 1}</span>
                                                <div style="flex: 1;">
                                                    <div style="font-size: 13px; font-weight: 500; margin-bottom: 2px;">${hostname}</div>
                                                    <div style="font-size: 11px; opacity: 0.7;">Click to view source</div>
                                                </div>
                                                <span style="font-size: 14px; opacity: 0.7;">â†—</span>
                                            </a>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </details>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Display EXA results without summary (fallback)
         */
        function displayExaResults(results) {
            if (!results || results.length === 0) {
                addMessage('assistant', 'No results found.');
                return;
            }

            let html = `
                <div class="exa-results" style="padding: 16px; background: var(--color-bg-primary); border-radius: 12px; margin: 12px 0;">
                    <h3 style="margin: 0 0 16px 0; color: var(--color-primary);">ðŸ” Search Results</h3>
                    <div style="display: grid; gap: 12px;">
                        ${results.slice(0, 10).map((result, idx) => `
                            <div style="padding: 14px; background: var(--color-bg-secondary); border-radius: 8px; border-left: 3px solid var(--color-primary); transition: all 0.3s ease;" 
                                 onmouseover="this.style.transform='translateX(4px)'" 
                                 onmouseout="this.style.transform='translateX(0)'">
                                <div style="display: flex; align-items: start; gap: 12px;">
                                    <span style="min-width: 24px; height: 24px; background: var(--color-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${idx + 1}</span>
                                    <div style="flex: 1;">
                                        <a href="${result.url}" target="_blank" style="color: var(--color-primary); text-decoration: none; font-weight: 600; font-size: 15px; display: inline-flex; align-items: center; gap: 6px;">
                                            ${result.title || 'View Source'}
                                            <span style="font-size: 12px; opacity: 0.7;">â†—</span>
                                        </a>
                                        ${result.text ? `<p style="margin: 8px 0 0 0; font-size: 14px; color: var(--color-text-secondary); line-height: 1.5;">${result.text.substring(0, 200)}...</p>` : ''}
                                        <button onclick="handleTellMeMore('${result.url}', 'url')" style="
                                            margin-top: 10px;
                                            padding: 6px 14px;
                                            background: rgba(51, 128, 141, 0.1);
                                            border: 1px solid rgba(51, 128, 141, 0.3);
                                            border-radius: 6px;
                                            color: var(--color-primary);
                                            font-size: 13px;
                                            font-weight: 500;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                        " onmouseover="this.style.background='rgba(51, 128, 141, 0.2)'" 
                                           onmouseout="this.style.background='rgba(51, 128, 141, 0.1)'">
                                            ðŸ“– Tell Me More
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            addMessage('assistant', html);
        }

        // ==================== UI HELPER FUNCTIONS ====================
        
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#33808d'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoadingOverlay(message = 'Processing...') {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                `;
                overlay.innerHTML = `
                    <div style="background: white; padding: 32px; border-radius: 12px; text-align: center;">
                        <div class="spinner" style="width: 48px; height: 48px; border: 4px solid #e8f4f8; border-top-color: #33808d; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                        <p style="color: #134252; font-size: 16px;">${message}</p>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'flex';
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        // ==================== ENHANCED UI RENDERERS ====================

        /**
         * Render Property Card with Gallery
         */
        function renderPropertyCard(property) {
            const images = property.images || [property.image || '/static/images/no-property-image.svg'];
            let imageGalleryHTML = '';
            
            if (images.length > 1) {
                imageGalleryHTML = `
                    <div class="property-image-carousel" data-property-id="${property.id}">
                        <img src="${images[0]}" alt="${property.address}" class="property-image">
                        <button class="carousel-btn prev" onclick="navigateCarousel('${property.id}', -1)">â€¹</button>
                        <button class="carousel-btn next" onclick="navigateCarousel('${property.id}', 1)">â€º</button>
                        <div class="image-counter">1 / ${images.length}</div>
                    </div>
                `;
            } else {
                imageGalleryHTML = `<img src="${images[0]}" alt="${property.address}" class="property-image">`;
            }

            return `
                <div class="property-card" data-property-id="${property.id}" data-images='${JSON.stringify(images)}'>
                    ${imageGalleryHTML}
                    <div class="property-details">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div class="property-price">${property.price}</div>
                            <button class="favorite-btn" onclick="toggleFavorite('${property.id}')" style="background: none; border: none; font-size: 20px; cursor: pointer;">â™¡</button>
                        </div>
                        <div class="property-address">${property.address}</div>
                        <div class="property-specs">
                            ${property.beds ? `<span class="property-spec">ðŸ›ï¸ ${property.beds} beds</span>` : ''}
                            ${property.baths ? `<span class="property-spec">ðŸš¿ ${property.baths} baths</span>` : ''}
                            ${property.sqft ? `<span class="property-spec">ðŸ“ ${property.sqft}</span>` : ''}
                            ${property.type ? `<span class="property-spec">ðŸ  ${property.type}</span>` : ''}
                        </div>
                        ${property.tags ? `
                            <div class="property-tags" style="display: flex; gap: 8px; margin: 12px 0;">
                                ${property.tags.map(tag => `<span class="tag" style="padding: 4px 12px; background: rgba(51, 128, 141, 0.1); border-radius: 12px; font-size: 12px;">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div class="property-actions">
                            <button class="btn-small" onclick="viewPropertyDetails('${property.id}', '${property.mls_number || ''}')">Full Details</button>
                            <button class="btn-small" onclick="scheduleViewing('${property.id}')">Schedule Tour</button>
                            <button class="btn-small" onclick="calculateROI('${property.mls_number || property.id}')">ROI Analysis</button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Navigate Image Carousel
         */
        function navigateCarousel(propertyId, direction) {
            const card = document.querySelector(`[data-property-id="${propertyId}"]`);
            if (!card) return;

            const images = JSON.parse(card.dataset.images || '[]');
            const img = card.querySelector('.property-image');
            const counter = card.querySelector('.image-counter');
            
            let currentIndex = parseInt(card.dataset.currentIndex || '0');
            currentIndex = (currentIndex + direction + images.length) % images.length;
            
            card.dataset.currentIndex = currentIndex;
            img.src = images[currentIndex];
            if (counter) counter.textContent = `${currentIndex + 1} / ${images.length}`;
        }

        /**
         * Render Audio Player
         */
        function renderAudioPlayer(audioUrl, transcription = '') {
            return `
                <div class="audio-player-card" style="background: var(--color-surface); padding: 16px; border-radius: var(--radius-md); margin: 12px 0;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <button onclick="toggleAudioPlay(this)" style="width: 40px; height: 40px; border-radius: 50%; background: var(--color-primary); color: white; border: none; cursor: pointer; font-size: 18px;">
                            â–¶ï¸
                        </button>
                        <audio src="${audioUrl}" style="display: none;"></audio>
                        <div class="audio-waveform" style="flex: 1; height: 40px; background: var(--color-bg-secondary); border-radius: 4px;"></div>
                    </div>
                    ${transcription ? `<p style="font-size: 13px; color: var(--color-text-secondary); font-style: italic;">"${transcription}"</p>` : ''}
                </div>
            `;
        }

        function toggleAudioPlay(button) {
            const audio = button.nextElementSibling;
            if (audio.paused) {
                audio.play();
                button.textContent = 'â¸ï¸';
            } else {
                audio.pause();
                button.textContent = 'â–¶ï¸';
            }
        }

        /**
         * Render Location Insights Map
         */
        function renderLocationMap(locationData) {
            return `
                <div class="location-map-card" style="background: var(--color-surface); border-radius: var(--radius-lg); overflow: hidden; margin: 16px 0;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--color-border);">
                        <h3 style="margin: 0 0 8px 0;">ðŸ“ ${locationData.location}</h3>
                        <p style="color: var(--color-text-secondary); font-size: 14px;">Neighborhood Insights</p>
                    </div>
                    <div class="location-insights" style="padding: 20px;">
                        ${locationData.schools ? `
                            <div class="insight-item" style="display: flex; gap: 16px; padding: 16px; background: var(--color-bg-secondary); border-radius: var(--radius-md); margin-bottom: 12px;">
                                <span style="font-size: 32px;">ðŸ«</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">Schools</div>
                                    <div style="font-size: 14px; color: var(--color-text-secondary);">${locationData.schools.count} within ${locationData.schools.radius}km</div>
                                    <div style="color: var(--color-success); font-size: 14px;">â˜…â˜…â˜…â˜…â˜… ${locationData.schools.rating}/10</div>
                                </div>
                            </div>
                        ` : ''}
                        ${locationData.transit ? `
                            <div class="insight-item" style="display: flex; gap: 16px; padding: 16px; background: var(--color-bg-secondary); border-radius: var(--radius-md); margin-bottom: 12px;">
                                <span style="font-size: 32px;">ðŸš‡</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">Transit</div>
                                    <div style="font-size: 14px; color: var(--color-text-secondary);">${locationData.transit.stations} stations nearby</div>
                                    <div style="font-size: 14px;">Walk Score: ${locationData.transit.walkScore}/100</div>
                                </div>
                            </div>
                        ` : ''}
                        ${locationData.amenities ? `
                            <div class="insight-item" style="display: flex; gap: 16px; padding: 16px; background: var(--color-bg-secondary); border-radius: var(--radius-md);">
                                <span style="font-size: 32px;">ðŸ›’</span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">Amenities</div>
                                    <div style="font-size: 14px; color: var(--color-text-secondary);">${locationData.amenities.restaurants}+ restaurants, ${locationData.amenities.stores}+ stores</div>
                                    <div style="font-size: 14px;">Bike Score: ${locationData.amenities.bikeScore}/100</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        /**
         * Render Search Results
         */
        function renderSearchResults(properties, query) {
            if (!properties || properties.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ”</div>
                        <p>No properties found for "${query}"</p>
                        <button class="btn-small" onclick="sendMessage('Show me all available properties')" style="margin-top: 16px;">Browse All</button>
                    </div>
                `;
            }

            return `
                <div class="search-results-header" style="margin-bottom: 16px;">
                    <h3 style="margin: 0;">Found ${properties.length} ${properties.length === 1 ? 'property' : 'properties'}</h3>
                    <p style="color: var(--color-text-secondary); font-size: 14px; margin: 4px 0 0 0;">Matching your search criteria</p>
                </div>
                <div class="properties-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                    ${properties.map(prop => renderPropertyCard(prop)).join('')}
                </div>
            `;
        }

        // Add valuation message with structured data
        async function addValuationMessage(structuredData, aiAnalysisText = '', quickReplies = []) {
            const container = document.getElementById('chatContainer');
            const message = document.createElement('div');
            message.className = 'message';
            
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Fetch owner-listed price from Repliers if MLS number is available
            let ownerListedPrice = null;
            let propertyImages = [];
            if (structuredData.property && structuredData.property.mls_number) {
                try {
                    const response = await fetch(`${getApiBaseUrl()}/api/property-details?mls=${structuredData.property.mls_number}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    if (data.success && data.property) {
                        ownerListedPrice = data.property.price || data.property.list_price;
                        propertyImages = data.property.images || [];
                    }
                } catch (error) {
                    console.error('Failed to fetch owner-listed price:', error);
                }
            }
            
            // Build owner-listed price section (shown first)
            let ownerPriceHTML = '';
            if (ownerListedPrice) {
                ownerPriceHTML = `
                    <div class="valuation-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 24px; border-radius: var(--radius-lg); margin-bottom: 24px;">
                        <h3 class="section-title" style="margin-bottom: 16px;">
                            <span class="section-icon">ðŸ’µ</span>
                            Owner Listed Price
                        </h3>
                        <div style="text-align: center;">
                            <div style="font-size: 42px; font-weight: 700; color: var(--color-primary); margin-bottom: 8px;">
                                $${formatNumber(ownerListedPrice)}
                            </div>
                            <div style="font-size: 14px; color: var(--color-text-secondary);">
                                Current asking price from MLS listing
                            </div>
                        </div>
                    </div>
                `;
            }

            // Build property images section
            let propertyImagesHTML = '';
            if (propertyImages && propertyImages.length > 0) {
                propertyImagesHTML = `
                    <div class="valuation-section" style="margin-bottom: 24px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            ${propertyImages.slice(0, 4).map(img => `
                                <img src="${img}" alt="Property" 
                                     style="width: 100%; height: 150px; object-fit: cover; border-radius: var(--radius-md);"
                                     onerror="this.style.display='none'">
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Build property info section
            let propertyInfoHTML = '';
            if (structuredData.property) {
                const prop = structuredData.property;
                propertyInfoHTML = `
                    <div class="valuation-section">
                        <h3 class="section-title">
                            <span class="section-icon">ðŸ </span>
                            Property Information
                        </h3>
                        <div class="property-info-grid">
                            ${prop.address ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">Address</div>
                                    <div class="property-info-value">${prop.address}</div>
                                </div>
                            ` : ''}
                            ${prop.mls_number ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">MLS Number</div>
                                    <div class="property-info-value">${prop.mls_number}</div>
                                </div>
                            ` : ''}
                            ${prop.property_type ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">Property Type</div>
                                    <div class="property-info-value">${capitalizeFirst(prop.property_type)}</div>
                                </div>
                            ` : ''}
                            ${prop.bedrooms ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">Bedrooms</div>
                                    <div class="property-info-value">${prop.bedrooms}</div>
                                </div>
                            ` : ''}
                            ${prop.bathrooms ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">Bathrooms</div>
                                    <div class="property-info-value">${prop.bathrooms}</div>
                                </div>
                            ` : ''}
                            ${prop.square_footage ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">Square Footage</div>
                                    <div class="property-info-value">${formatNumber(prop.square_footage)} sq ft</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Build valuation stats section
            let valuationStatsHTML = '';
            if (structuredData.valuation) {
                const val = structuredData.valuation;
                
                valuationStatsHTML = `
                    <div class="valuation-section">
                        <h3 class="section-title">
                            <span class="section-icon">ðŸ’°</span>
                            AI Estimated Value
                        </h3>
                        <div class="valuation-stats">
                            <div class="stat-card">
                                <div class="stat-label">Our AI Estimate</div>
                                <div class="stat-value">$${formatNumber(val.estimated_value)}</div>
                                <div class="stat-sublabel">${val.method || 'Direct Comparison Approach'}</div>
                            </div>
                            ${val.value_range ? `
                                <div class="stat-card">
                                    <div class="stat-label">Value Range</div>
                                    <div class="stat-value" style="font-size: 18px;">
                                        $${formatNumber(val.value_range.min)} - $${formatNumber(val.value_range.max)}
                                    </div>
                                    <div class="stat-sublabel">Based on comparable properties</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Build market data section
            let marketDataHTML = '';
            if (structuredData.market_data) {
                const market = structuredData.market_data;
                marketDataHTML = `
                    <div class="valuation-section">
                        <h3 class="section-title">
                            <span class="section-icon">ðŸ“Š</span>
                            Market Context
                        </h3>
                        <div class="market-grid">
                            ${market.avg_price_per_sqft ? `
                                <div class="market-item">
                                    <div class="market-item-label">Avg Price per Sq Ft</div>
                                    <div class="market-item-value">$${formatNumber(market.avg_price_per_sqft)}</div>
                                </div>
                            ` : ''}
                            ${market.comparables_analyzed ? `
                                <div class="market-item">
                                    <div class="market-item-label">Comparables Analyzed</div>
                                    <div class="market-item-value">${market.comparables_analyzed}</div>
                                </div>
                            ` : ''}
                            ${market.area ? `
                                <div class="market-item">
                                    <div class="market-item-label">Area</div>
                                    <div class="market-item-value">${market.area}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Build comparables section
            let comparablesHTML = '';
            if (structuredData.comparables && structuredData.comparables.length > 0) {
                const comparablesCards = structuredData.comparables.map((comp, index) => `
                    <div class="comparable-card" data-mls="${comp.mls_id}" data-index="${index}">
                        <div class="comparable-header">
                            <div class="comparable-price">$${formatNumber(comp.sale_price || comp.price)}</div>
                            ${comp.similarity_score ? `
                                <div class="comparable-similarity">${Math.round(comp.similarity_score)}% match</div>
                            ` : ''}
                        </div>
                        <div class="comparable-address" id="comp-address-${index}">
                            ${comp.address && comp.address !== 'Unknown' ? comp.address : '<span class="loading-address">Loading address...</span>'}
                        </div>
                        ${comp.mls_id ? `<div style="font-size: 12px; color: var(--color-text-secondary); margin: 4px 0;">MLS: ${comp.mls_id}</div>` : ''}
                        ${comp.sale_date ? `<div style="font-size: 12px; color: var(--color-text-secondary); margin: 4px 0;">ðŸ“… ${comp.sale_date}</div>` : ''}
                        <div class="comparable-specs">
                            ${comp.bedrooms ? `<div class="comparable-spec">ðŸ›ï¸ ${comp.bedrooms} beds</div>` : ''}
                            ${comp.bathrooms ? `<div class="comparable-spec">ðŸš¿ ${comp.bathrooms} baths</div>` : ''}
                            ${comp.sqft || comp.square_footage ? `<div class="comparable-spec">ðŸ“ ${formatNumber(comp.sqft || comp.square_footage)} sq ft</div>` : ''}
                            ${comp.distance_km || comp.distance ? `<div class="comparable-spec">ðŸ“ ${comp.distance_km || comp.distance} km away</div>` : ''}
                        </div>
                        <div class="comparable-actions" style="margin-top: 12px; display: flex; gap: 8px;">
                            <button class="btn-small btn-primary" onclick="openAIAnalysisPanel('${comp.mls_id}', 'comparable')">
                                ðŸ¤– AI Analysis
                            </button>
                            <button class="btn-small btn-secondary" onclick="viewPropertyDetails('${comp.mls_id}', '${comp.mls_id}')">
                                ðŸ“‹ View Details
                            </button>
                        </div>
                    </div>
                `).join('');

                comparablesHTML = `
                    <div class="valuation-section">
                        <h3 class="section-title">
                            <span class="section-icon">ðŸ˜ï¸</span>
                            Comparable Properties (${structuredData.comparables.length})
                        </h3>
                        <div class="comparables-grid">
                            ${comparablesCards}
                        </div>
                    </div>
                `;
            }

            // Build metadata section
            let metadataHTML = '';
            if (structuredData.metadata) {
                const meta = structuredData.metadata;
                metadataHTML = `
                    <div class="valuation-section">
                        <div class="valuation-metadata">
                            ${meta.valuation_date ? `
                                <div class="metadata-item">
                                    <span class="metadata-label">Valuation Date:</span> ${meta.valuation_date}
                                </div>
                            ` : ''}
                            ${meta.data_source ? `
                                <div class="metadata-item">
                                    <span class="metadata-label">Data Source:</span> ${meta.data_source}
                                </div>
                            ` : ''}
                            ${meta.disclaimer ? `
                                <div class="metadata-item" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border);">
                                    <em>${meta.disclaimer}</em>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Build AI Analysis section from the response text
            let aiAnalysisHTML = '';
            if (aiAnalysisText) {
                // Convert markdown to HTML (basic conversion)
                const analysisHTML = aiAnalysisText
                    .replace(/### \*\*(.+?)\*\*/g, '<h4 style="color: var(--color-primary); margin: 16px 0 8px 0;">$1</h4>')
                    .replace(/## (.+)/g, '<h3 style="margin: 20px 0 12px 0; color: var(--color-text);">$1</h3>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n\n/g, '</p><p style="margin: 12px 0;">')
                    .replace(/\n/g, '<br>');
                
                aiAnalysisHTML = `
                    <div class="valuation-section">
                        <h3 class="section-title">
                            <span class="section-icon">ðŸ¤–</span>
                            AI Analysis & Insights
                        </h3>
                        <div style="background: var(--color-bg-secondary); padding: 20px; border-radius: var(--radius-md); line-height: 1.7;">
                            <p style="margin: 12px 0;">${analysisHTML}</p>
                        </div>
                    </div>
                `;
            }

            // Build Data Sources section
            const dataSourcesHTML = `
                <div class="valuation-section">
                    <h3 class="section-title">
                        <span class="section-icon">ðŸ“š</span>
                        Data Sources & Methodology
                    </h3>
                    <div style="background: #f8f9fa; padding: 16px; border-radius: var(--radius-md); border-left: 4px solid var(--color-primary);">
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <strong>ðŸ¢ Primary Data Source:</strong> 
                                <span style="color: var(--color-text-secondary);">Repliers.io Real Estate MLS Database</span>
                            </div>
                            <div>
                                <strong>ðŸ“Š Methodology:</strong> 
                                <span style="color: var(--color-text-secondary);">Direct Comparison Approach (CUSPAP)</span>
                            </div>
                            <div>
                                <strong>ðŸ¤– AI Model:</strong> 
                                <span style="color: var(--color-text-secondary);">Llama 3.2 90B Vision + RAG (Retrieval-Augmented Generation)</span>
                            </div>
                            <div>
                                <strong>ðŸ“… Analysis Date:</strong> 
                                <span style="color: var(--color-text-secondary);">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                            </div>
                            <div>
                                <strong>âœ… Data Freshness:</strong> 
                                <span style="color: var(--color-text-secondary);">Live MLS data updated in real-time</span>
                            </div>
                            <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-border);">
                                <em style="font-size: 13px; color: var(--color-text-secondary);">
                                    ðŸ’¡ This analysis combines machine learning with professional appraisal methodologies 
                                    to provide accurate market valuations based on current Canadian real estate data.
                                </em>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Build the complete valuation card
            const valuationCard = `
                <div class="valuation-card">
                    <div class="valuation-header">
                        <h2 class="valuation-title">ðŸ  Property Valuation Report</h2>
                        <p class="valuation-subtitle">Comprehensive market analysis using live Canadian real estate data</p>
                    </div>
                    <div class="valuation-body">
                        ${ownerPriceHTML}
                        ${propertyImagesHTML}
                        ${propertyInfoHTML}
                        ${valuationStatsHTML}
                        ${marketDataHTML}
                        ${comparablesHTML}
                        ${aiAnalysisHTML}
                        ${dataSourcesHTML}
                        ${metadataHTML}
                    </div>
                </div>
            `;

            message.innerHTML = `
                <div class="message-avatar ai-avatar">ðŸ¤–</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">AI Assistant</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">
                        ${valuationCard}
                        ${quickReplies.length > 0 ? generateQuickReplies(quickReplies) : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(message);
            scrollToBottom();
            
            chatHistory.push({ 
                sender: 'ai', 
                content: 'Property Valuation Report', 
                structuredData: structuredData, 
                timestamp: new Date() 
            });

            // Fetch real addresses for comparables with "Unknown" address
            if (structuredData.comparables) {
                structuredData.comparables.forEach((comp, index) => {
                    if ((!comp.address || comp.address === 'Unknown') && comp.mls_id) {
                        fetchComparableAddress(comp.mls_id, index);
                    }
                });
            }
        }

        /**
         * Fetch real property address from Repliers API
         */
        async function fetchComparableAddress(mlsId, index) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/property-details?mls=${mlsId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.success && data.property && data.property.address) {
                    const addressElement = document.getElementById(`comp-address-${index}`);
                    if (addressElement) {
                        const fullAddress = `${data.property.address.street}, ${data.property.address.city}, ${data.property.address.province}`;
                        addressElement.innerHTML = fullAddress;
                        addressElement.classList.remove('loading-address');
                    }
                }
            } catch (error) {
                console.error(`Failed to fetch address for MLS ${mlsId}:`, error);
                const addressElement = document.getElementById(`comp-address-${index}`);
                if (addressElement) {
                    addressElement.innerHTML = `MLS ${mlsId}`;
                    addressElement.classList.remove('loading-address');
                }
            }
        }

        /**
         * ï¿½ Enhanced Property Analysis Formatter
         * Specifically formats property valuation and analysis content
         * @param {string} content - Property analysis text
         * @returns {string} Formatted HTML with professional property analysis layout
         */
        function enhancePropertyAnalysis(content) {
            console.log('ðŸ  Enhancing property analysis content');
            
            const sections = content.split(/(?=ðŸ“|âš ï¸|ðŸ“Š|ðŸ’°|ðŸ“ˆ|ðŸŽ¯)/);
            let enhanced = '<div class="property-analysis-container" style="background: #ffffff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin: 16px 0;">';
            
            for (let section of sections) {
                section = section.trim();
                if (!section) continue;
                
                // Main property analysis section
                if (section.startsWith('ðŸ“ Property Analysis')) {
                    const lines = section.split('\n').filter(l => l.trim());
                    const title = lines[0].replace('ðŸ“ ', '');
                    const mainAnalysis = lines.slice(1).join(' ').trim();
                    
                    enhanced += `
                    <div class="analysis-header" style="background: linear-gradient(135deg, #33808d 0%, #1d7480 100%); padding: 24px; color: white;">
                        <h2 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 50%; font-size: 20px;">ðŸ“</span>
                            ${title}
                        </h2>
                    </div>
                    <div class="analysis-content" style="padding: 24px;">
                        ${formatAnalysisContent(mainAnalysis)}
                    </div>`;
                }
                
                // Warning/Important note section
                else if (section.startsWith('âš ï¸')) {
                    const content = section.replace(/âš ï¸\s*\*\*Important Note:\*\*\s*/, '').trim();
                    enhanced += `
                    <div class="warning-section" style="margin: 0 24px 24px 24px; background: linear-gradient(135deg, rgba(255, 165, 0, 0.1) 0%, rgba(255, 140, 0, 0.05) 100%); border-left: 4px solid #FFA500; padding: 20px; border-radius: 8px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="background: #FFA500; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;">âš ï¸</span>
                            <div>
                                <h4 style="margin: 0 0 8px 0; color: #CC7A00; font-weight: 600; font-size: 16px;">Important Market Context</h4>
                                <p style="margin: 0; line-height: 1.6; color: #8B5A00; font-size: 14px;">${content}</p>
                            </div>
                        </div>
                    </div>`;
                }
                
                // Regular content sections
                else {
                    enhanced += `
                    <div style="padding: 0 24px 16px 24px;">
                        <p style="line-height: 1.7; color: #2c3e50; font-size: 15px; margin: 12px 0;">${formatAnalysisText(section)}</p>
                    </div>`;
                }
            }
            
            enhanced += '</div>';
            return enhanced;
        }

        /**
         * Format analysis content with value highlighting
         */
        function formatAnalysisContent(text) {
            // Highlight key values and percentages
            let formatted = text
                .replace(/\$[\d,]+/g, match => `<strong style="color: #33808d; font-weight: 700; background: rgba(51, 128, 141, 0.1); padding: 2px 6px; border-radius: 4px;">${match}</strong>`)
                .replace(/(\d+%)(?!\w)/g, '<strong style="color: #27ae60; font-weight: 600;">$1</strong>')
                .replace(/(high confidence \(\d+%\))/gi, '<span style="background: rgba(39, 174, 96, 0.1); color: #27ae60; padding: 4px 8px; border-radius: 12px; font-weight: 600; font-size: 13px;">$1</span>');
            
            return `<p style="font-size: 16px; line-height: 1.8; color: #2c3e50; margin: 0;">${formatted}</p>`;
        }

        /**
         * Format analysis text with better typography
         */
        function formatAnalysisText(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #2c3e50; font-weight: 600;">$1</strong>')
                .replace(/MLS [A-Z]\d+/g, match => `<span style="background: rgba(51, 128, 141, 0.1); color: #33808d; padding: 2px 6px; border-radius: 4px; font-weight: 500; font-size: 13px;">${match}</span>`)
                .replace(/\$[\d,]+/g, match => `<strong style="color: #33808d; font-weight: 600;">${match}</strong>`)
                .replace(/(\d+%)(?!\w)/g, '<strong style="color: #27ae60;">$1</strong>');
        }

        /**
         * ï¿½ðŸŽ¨ Enhance ChatGPT Text Response with Visual Formatting
         * Transforms plain text responses into visually appealing, structured content
         * @param {string} content - Raw text content from ChatGPT
         * @param {boolean} isAI - Whether this is an AI response
         * @returns {string} Enhanced HTML with better typography and visual hierarchy
         */
        /**
         * ï¿½ Enhanced School Data Visualization
         * Production-ready school listings with accessibility and modern design
         */
        function enhanceSchoolDataVisualization(content) {
            console.log('ðŸŽ“ Enhancing school data visualization');
            
            const lines = content.split('\n').filter(line => line.trim());
            let schoolsHtml = `
                <div class="schools-container" role="region" aria-label="School Information">
                    <div class="schools-header">
                        <h3 class="schools-title">
                            <span>ðŸŽ“</span>
                            Educational Institutions
                        </h3>
                        <p class="schools-subtitle">Comprehensive school information with ratings and details</p>
                    </div>
            `;
            
            let currentSchool = {};
            let schoolCount = 0;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Match school entries (numbered list format)
                const schoolMatch = line.match(/^(\d+)\.\s*\*\*(.+?)\*\*/);
                if (schoolMatch) {
                    // Save previous school if exists
                    if (currentSchool.name) {
                        schoolsHtml += renderSchoolCard(currentSchool, schoolCount++);
                    }
                    
                    // Start new school
                    const fullName = schoolMatch[2];
                    currentSchool = {
                        name: fullName,
                        type: extractSchoolType(fullName),
                        level: extractSchoolLevel(fullName),
                        features: [],
                        rating: 'Not Rated',
                        address: 'Address not available'
                    };
                    continue;
                }
                
                // Parse school details
                if (line.includes('**Level:**')) {
                    currentSchool.level = line.replace(/.*\*\*Level:\*\*\s*/, '').replace(/\*\*/g, '');
                } else if (line.includes('**Type:**')) {
                    currentSchool.type = line.replace(/.*\*\*Type:\*\*\s*/, '').replace(/\*\*/g, '');
                } else if (line.includes('**Notable Features:**') || line.includes('**Programs:**')) {
                    currentSchool.features = line.replace(/.*\*\*.*?\*\*\s*/, '').split(',').map(f => f.trim());
                } else if (line.includes('**Address:**')) {
                    currentSchool.address = line.replace(/.*\*\*Address:\*\*\s*/, '').replace(/\*\*/g, '');
                } else if (line.includes('**Rating:**')) {
                    currentSchool.rating = line.replace(/.*\*\*Rating:\*\*\s*/, '').replace(/\*\*/g, '');
                }
            }
            
            // Add last school
            if (currentSchool.name) {
                schoolsHtml += renderSchoolCard(currentSchool, schoolCount++);
            }
            
            schoolsHtml += `
                </div>
                <div style="margin-top: 16px; padding: 12px; background: var(--color-bg-secondary); border-radius: 8px; font-size: 13px; color: var(--color-text-secondary); text-align: center;">
                    ðŸ’¡ <strong>Real-time data:</strong> School information is fetched live and may vary. Contact schools directly for the most current details.
                </div>
            `;
            
            return schoolsHtml;
        }
        
        /**
         * Extract school type from name
         */
        function extractSchoolType(name) {
            const nameLower = name.toLowerCase();
            if (nameLower.includes('catholic') || nameLower.includes('separate')) return 'Catholic';
            if (nameLower.includes('private') || nameLower.includes('independent')) return 'Private';
            if (nameLower.includes('montessori')) return 'Montessori';
            if (nameLower.includes('french') || nameLower.includes('immersion')) return 'French Immersion';
            return 'Public';
        }
        
        /**
         * Extract school level from name
         */
        function extractSchoolLevel(name) {
            const nameLower = name.toLowerCase();
            if (nameLower.includes('elementary') || nameLower.includes('primary')) return 'Elementary';
            if (nameLower.includes('middle') || nameLower.includes('junior')) return 'Middle School';
            if (nameLower.includes('high') || nameLower.includes('secondary') || nameLower.includes('collegiate')) return 'High School';
            if (nameLower.includes('k-8') || nameLower.includes('k-12')) return 'K-12';
            return 'Mixed Levels';
        }
        
        /**
         * Render individual school card
         */
        function renderSchoolCard(school, index) {
            const ratingClass = getRatingClass(school.rating);
            const features = school.features.slice(0, 4); // Limit features
            
            return `
                <article class="school-item" role="article" tabindex="0" aria-label="School: ${school.name}">
                    <div class="school-header">
                        <div>
                            <h4 class="school-name">${school.name}</h4>
                            <div class="school-type">${school.type} â€¢ ${school.level}</div>
                        </div>
                        <div class="school-rating ${ratingClass}" aria-label="Rating: ${school.rating}">
                            â­ ${school.rating}
                        </div>
                    </div>
                    
                    <div class="school-details">
                        <div class="school-address">
                            <span>ðŸ“</span>
                            ${school.address}
                        </div>
                        <div class="school-level">
                            <span>ðŸŽ’</span>
                            ${school.level}
                        </div>
                    </div>
                    
                    ${features.length > 0 ? `
                        <div class="school-features">
                            <div class="school-features-title">
                                <span>âœ¨</span>
                                Notable Features
                            </div>
                            <div class="school-features-list">
                                ${features.map(feature => `
                                    <span class="school-feature-tag">${feature}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="school-actions">
                        <button class="school-btn primary" onclick="getSchoolDetails('${school.name}')">
                            View Details
                        </button>
                        <button class="school-btn" onclick="getSchoolDirections('${school.address}')">
                            Directions
                        </button>
                    </div>
                </article>
            `;
        }
        
        // Duplicate getRatingClass function removed - using the numeric version above
        
        /**
         * School action handlers
         */
        function getSchoolDetails(schoolName) {
            sendMessage(`Tell me more details about ${schoolName} school including programs, enrollment, and contact information`);
        }
        
        function getSchoolDirections(address) {
            if (address && address !== 'Address not available') {
                const encodedAddress = encodeURIComponent(address);
                window.open(`https://maps.google.com/maps?q=${encodedAddress}`, '_blank');
            } else {
                showToast('Address not available for directions', 'warning');
            }
        }

        /**
         * ï¿½ðŸ« Enhance Structured Lists (Schools, Shopping, Amenities)
         * Formats list-based responses into attractive, structured cards
         */
        function enhanceStructuredListResponse(content) {
            console.log('ðŸŽ¯ Enhancing structured list response');
            console.log('ðŸ” Raw content for parsing:');
            console.log(content);
            console.log('ðŸ” First 10 lines:');
            content.split('\n').slice(0, 10).forEach((line, i) => {
                console.log(`Line ${i}: "${line}"`);
            });
            
            // Split content into sections
            const lines = content.split('\n').filter(line => line.trim());
            let enhanced = '<div class="structured-list-response" style="padding: 20px; background: linear-gradient(135deg, #f8fcfd 0%, #e8f4f8 100%); border-radius: 16px; margin: 16px 0;">';
            
            // Determine content type and header based on actual content analysis
            let headerTitle = "Local Information";
            let headerIcon = "ðŸ“";
            
            const contentLower = content.toLowerCase();
            const hasSchoolKeywords = contentLower.includes('school') || contentLower.includes('elementary') || 
                                    contentLower.includes('secondary') || contentLower.includes('high school') ||
                                    contentLower.includes('collegiate') || contentLower.includes('academy');
            const hasShoppingKeywords = contentLower.includes('shopping') || contentLower.includes('mall') || 
                                      contentLower.includes('retail') || contentLower.includes('store');
            const hasGroceryKeywords = contentLower.includes('grocery') || contentLower.includes('supermarket') ||
                                     contentLower.includes('loblaws') || contentLower.includes('metro') || 
                                     contentLower.includes('food basics');
            const hasHealthKeywords = contentLower.includes('hospital') || contentLower.includes('medical') || 
                                    contentLower.includes('health') || contentLower.includes('clinic');
            const hasRestaurantKeywords = contentLower.includes('restaurant') || contentLower.includes('dining') ||
                                        contentLower.includes('food') || contentLower.includes('cuisine');
            const hasParkKeywords = contentLower.includes('park') || contentLower.includes('recreation') ||
                                  contentLower.includes('green space') || contentLower.includes('outdoor');
            const hasMarketKeywords = contentLower.includes('market') || contentLower.includes('trend') ||
                                    contentLower.includes('price') || contentLower.includes('investment');
            
            // Priority-based detection (most specific first)
            if (hasSchoolKeywords) {
                headerTitle = "Educational Institutions";
                headerIcon = "ï¿½";
                return enhanceSchoolDataVisualization(content);
            } else if (hasGroceryKeywords && !hasShoppingKeywords) {
                headerTitle = "Grocery Stores & Supermarkets";
                headerIcon = "ðŸ›’";
            } else if (hasShoppingKeywords) {
                headerTitle = "Shopping Centers & Retail";
                headerIcon = "ðŸ›ï¸";
            } else if (hasHealthKeywords) {
                headerTitle = "Hospitals & Medical Centers";
                headerIcon = "ðŸ¥";
            } else if (hasRestaurantKeywords) {
                headerTitle = "Dining & Restaurants";
                headerIcon = "ðŸ½ï¸";
            } else if (hasParkKeywords) {
                headerTitle = "Parks & Recreation";
                headerIcon = "ðŸŒ³";
            } else if (hasMarketKeywords) {
                headerTitle = "Market Analysis & Trends";
                headerIcon = "ðŸ“ˆ";
            }
            
            console.log('ðŸŽ¯ Header detection:', {
                contentType: headerTitle,
                hasSchoolKeywords,
                hasShoppingKeywords,
                hasGroceryKeywords,
                hasHealthKeywords,
                hasRestaurantKeywords,
                hasParkKeywords,
                hasMarketKeywords
            });
            
            // Add header
            enhanced += `
            <div style="text-align: center; margin-bottom: 32px;">
                <h2 style="color: #33808d; font-size: 24px; font-weight: 700; margin: 0 0 12px 0; display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <span style="background: linear-gradient(135deg, #33808d, #1d7480); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 28px;">${headerIcon}</span>
                    ${headerTitle}
                </h2>
            </div>`;
            
            let currentItem = null;
            let items = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                console.log(`ðŸ” Processing line ${i}: "${line}"`);
                
                // Skip empty lines
                if (!line) continue;
                
                // Detect numbered list items - multiple formats
                if (line.match(/^\d+\./)) {
                    // Save previous item
                    if (currentItem) {
                        items.push(currentItem);
                        console.log('ðŸ“‹ Saved item:', currentItem.name, 'with details:', currentItem.details);
                    }
                    
                    // Extract item name - handle different formats
                    let name = '';
                    if (line.includes('**')) {
                        // Format: "1. **Name**" or "1. **Name** - additional info"
                        const nameMatch = line.match(/^\d+\.\s\*\*(.*?)\*\*/);
                        name = nameMatch ? nameMatch[1].trim() : '';
                    } else {
                        // Format: "1. Name" or "1. Name - additional info"
                        name = line.replace(/^\d+\.\s*/, '').split('-')[0].trim();
                    }
                    
                    currentItem = {
                        name: name,
                        details: {},
                        description: ''
                    };
                    console.log('ï¿½ Started new item:', name);
                    
                    // Check if there's inline information in the same line
                    if (line.includes(' - ')) {
                        const parts = line.split(' - ');
                        for (let i = 1; i < parts.length; i++) {
                            const part = parts[i].trim();
                            if (part.toLowerCase().includes('location:') || part.toLowerCase().includes('address:')) {
                                currentItem.details['Address'] = part.replace(/location:\s*/i, '').replace(/address:\s*/i, '').trim();
                                console.log('ðŸ“ Found inline address:', currentItem.details['Address']);
                            } else if (part.toLowerCase().includes('special:') || part.toLowerCase().includes('known for:')) {
                                currentItem.description = part.replace(/special:\s*/i, '').replace(/known for:\s*/i, '').trim();
                                console.log('ðŸ“– Found inline description:', currentItem.description);
                            }
                        }
                    }
                }
                // Parse item details - handle multiple formats
                else if (currentItem && ((line.includes('-') && line.includes('**') && line.includes(':')) || 
                                       (line.includes('**') && line.includes(':') && !line.match(/^\d+\./)))) {
                    // Handle both "- **Type:**" and "   - **Type:**" formats
                    const detailMatch = line.match(/.*?-\s*\*\*(.*?)\*\*:\s*(.*)/);
                    if (detailMatch) {
                        const key = detailMatch[1].trim();
                        const value = detailMatch[2].trim();
                        
                        console.log(`ðŸ” Parsing detail line: "${line}"`);
                        console.log(`ðŸ”‘ Extracted key: "${key}", value: "${value}"`);
                        
                        // Handle different key variations
                        if (key === 'Special Features' || key === 'Specialty') {
                            currentItem.description = value;
                            console.log(`ðŸ“– Added description: ${value}`);
                        } else {
                            currentItem.details[key] = value;
                            console.log(`ðŸ“ Added detail: ${key} = ${value}`);
                        }
                    } else {
                        console.log(`âŒ Failed to parse detail line: "${line}"`);
                    }
                }
                // Alternative parsing for details without dash (format: "   **Type:** Value")
                else if (currentItem && line.includes('**') && line.includes(':') && !line.match(/^\d+\./)) {
                    const detailMatch = line.match(/\*\*(.*?)\*\*:\s*(.*)/);
                    if (detailMatch) {
                        const key = detailMatch[1].trim();
                        const value = detailMatch[2].trim();
                        
                        console.log(`ðŸ” Parsing alt detail line: "${line}"`);
                        console.log(`ðŸ”‘ Extracted key: "${key}", value: "${value}"`);
                        
                        if (key === 'Special Features' || key === 'Specialty') {
                            currentItem.description = value;
                            console.log(`ðŸ“– Added description from alt format: ${value}`);
                        } else {
                            currentItem.details[key] = value;
                            console.log(`ðŸ“ Added detail from alt format: ${key} = ${value}`);
                        }
                    } else {
                        console.log(`âŒ Failed to parse alt detail line: "${line}"`);
                    }
                }
                // Parse simple format without markdown (format: "Location: Address" or "Special Features: Description")
                else if (currentItem && line.includes(':') && !line.match(/^\d+\./) && !line.includes('**')) {
                    const parts = line.split(':');
                    if (parts.length >= 2) {
                        const key = parts[0].replace(/^-\s*/, '').trim();
                        const value = parts.slice(1).join(':').trim();
                        
                        console.log(`ðŸ” Parsing simple format: "${line}"`);
                        console.log(`ðŸ”‘ Simple key: "${key}", value: "${value}"`);
                        
                        // Map common keys
                        if (key.toLowerCase().includes('location') || key.toLowerCase().includes('address')) {
                            currentItem.details['Address'] = value;
                            console.log(`ðŸ“ Added address (simple): ${value}`);
                        } else if (key.toLowerCase().includes('special') || key.toLowerCase().includes('known for') || 
                                 key.toLowerCase().includes('features') || key.toLowerCase().includes('unique')) {
                            currentItem.description = value;
                            console.log(`ðŸ“– Added description (simple): ${value}`);
                        } else if (key.toLowerCase().includes('type') || key.toLowerCase().includes('category')) {
                            currentItem.details['Type'] = value;
                            console.log(`ðŸª Added type (simple): ${value}`);
                        }
                    }
                }
            }
            
            // Add the last item
            if (currentItem) {
                items.push(currentItem);
                console.log('ðŸ“‹ Final item saved:', currentItem.name, 'with details:', currentItem.details);
            }
            
            console.log('ðŸŽ¯ Final parsing results:');
            console.log(`âœ… Found ${items.length} items total`);
            items.forEach((item, i) => {
                console.log(`Item ${i+1}: "${item.name}"`);
                console.log(`  Details:`, JSON.stringify(item.details, null, 2));
                console.log(`  Description:`, item.description);
                console.log(`  Type:`, item.details['Type']);
                console.log(`  Address:`, item.details['Address']);
            });
            
            // Render items as cards
            enhanced += '<div class="items-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-top: 24px;">';
            
            items.forEach((item, index) => {
                const rating = item.details['Rating'] || 'N/A';
                const type = item.details['Type'] || '';
                const address = item.details['Address'] || '';
                
                console.log(`ðŸŽ¨ Rendering card ${index + 1} for "${item.name}":`, {
                    rating: rating,
                    type: type,
                    address: address,
                    description: item.description,
                    allDetails: item.details
                });
                
                // Color scheme based on rating
                let ratingColor = '#33808d';
                let ratingBg = 'rgba(51, 128, 141, 0.1)';
                if (rating !== 'N/A') {
                    const ratingNum = parseFloat(rating);
                    if (ratingNum >= 8.5) {
                        ratingColor = '#27ae60';
                        ratingBg = 'rgba(39, 174, 96, 0.1)';
                    } else if (ratingNum >= 7.5) {
                        ratingColor = '#f39c12';
                        ratingBg = 'rgba(243, 156, 18, 0.1)';
                    } else if (ratingNum < 7.0) {
                        ratingColor = '#e74c3c';
                        ratingBg = 'rgba(231, 76, 60, 0.1)';
                    }
                }
                
                enhanced += `
                <div class="item-card" style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 8px 24px rgba(51, 128, 141, 0.1); border: 1px solid rgba(51, 128, 141, 0.1); transition: all 0.3s ease; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, ${ratingColor}, ${ratingColor}88);"></div>
                    
                    <div style="display: flex; justify-content: between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
                        <div style="flex: 1;">
                            <h3 style="color: #2c3e50; font-size: 20px; font-weight: 700; margin: 0 0 8px 0; line-height: 1.3;">${item.name}</h3>
                            ${type ? `<span style="background: rgba(51, 128, 141, 0.1); color: #33808d; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">${type}</span>` : ''}
                        </div>
                        ${rating !== 'N/A' ? `
                        <div style="background: ${ratingBg}; border: 2px solid ${ratingColor}; border-radius: 12px; padding: 8px 12px; text-align: center; min-width: 60px;">
                            <div style="color: ${ratingColor}; font-weight: 700; font-size: 18px; line-height: 1;">${rating}</div>
                            <div style="color: ${ratingColor}; font-size: 11px; opacity: 0.8;">RATING</div>
                        </div>` : ''}
                    </div>
                    
                    ${address ? `
                    <div style="display: flex; align-items: start; gap: 8px; margin: 16px 0; padding: 12px; background: rgba(51, 128, 141, 0.05); border-radius: 8px;">
                        <span style="color: #33808d; font-size: 16px; margin-top: 2px;">ðŸ“</span>
                        <span style="color: #1a6873; font-size: 14px; line-height: 1.4;">${address}</span>
                    </div>` : ''}
                    
                    ${item.description ? `
                    <div style="margin-top: 16px;">
                        <h4 style="color: #33808d; font-size: 14px; font-weight: 600; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">What Makes It Special</h4>
                        <p style="color: #4a6741; font-size: 14px; line-height: 1.6; margin: 0; background: rgba(39, 174, 96, 0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #27ae60;">${item.description}</p>
                    </div>` : ''}
                </div>`;
            });
            
            enhanced += '</div></div>';
            
            console.log('âœ… Enhanced structured list with', items.length, 'items');
            return enhanced;
        }

        function enhanceTextResponse(content, isAI = true) {
            console.log('ðŸš¨ === ENHANCEMENT FUNCTION CALLED ===');
            console.log('ðŸŽ¨ enhanceTextResponse called:', { contentLength: content.length, isAI, hasHTML: content.includes('<div'), preview: content.substring(0, 100) });
            console.log('ðŸ“ Full content for debugging:', content);
            
            // Skip enhancement if content already has HTML tags (valuation cards, photos, etc.)
            if (content.includes('<div') || content.includes('<img') || content.includes('<button')) {
                console.log('â­ï¸ Skipping enhancement: content already has HTML');
                return content;
            }
            
            // Skip enhancement for non-AI messages
            if (!isAI) {
                console.log('â­ï¸ Skipping enhancement: not AI message');
                return content;
            }

            // Special handling for property analysis content
            if (content.includes('Property Analysis') || content.includes('valuation') || 
                content.includes('comparable') || content.includes('market analysis')) {
                return enhancePropertyAnalysis(content);
            }

            // Special handling for structured lists (schools, shopping centers, amenities)
            // Only apply structured formatting to list-based content with specific patterns
            const hasNumberedList = content.match(/^\d+\.\s+/m); // Numbered list at start of line
            const hasStructuredKeywords = content.includes('**Type:**') || content.includes('**Address:**') || 
                                        content.includes('**Specialty:**') || content.includes('Location:') ||
                                        content.includes('Special Features:');
            const hasLocationBasedContent = (content.includes('schools') || content.includes('grocery') || 
                                           content.includes('shopping') || content.includes('hospital') || 
                                           content.includes('park')) && hasNumberedList;
            
            const isStructuredContent = hasLocationBasedContent && 
                                      (hasStructuredKeywords || content.length > 500) &&
                                      !content.toLowerCase().includes('market trend') &&
                                      !content.toLowerCase().includes('investment') &&
                                      !content.toLowerCase().includes('analysis');
                
                console.log('ðŸ” Structured content detection:', {
                isStructuredContent,
                hasSchools: content.includes('schools'),
                hasType: content.includes('Type:') || content.includes('**Type:**'),
                hasAddress: content.includes('Address:') || content.includes('**Address:**'),
                hasSpecialty: content.includes('**Specialty:**'),
                hasSecondarySchool: content.includes('Secondary School'),
                hasElementarySchool: content.includes('Elementary School'),
                hasColonelBy: content.includes('Colonel By'),
                hasLisgar: content.includes('Lisgar Collegiate'),
                hasNumberedList: content.includes('1.') && content.includes('**'),
                hasSimpleNumberedList: content.match(/\d+\.\s+\w+/) !== null,
                contentLength: content.length,
                contentPreview: content.substring(0, 300),
                firstFewLines: content.split('\n').slice(0, 5)
            });            if (isStructuredContent) {
                console.log('ðŸ« Detected structured list content, applying enhanced formatting');
                return enhanceStructuredListResponse(content);
            }
            
            // Split into paragraphs and process each
            const paragraphs = content.split('\n').filter(line => line.trim());
            let enhanced = '';
            let inList = false;
            
            for (let i = 0; i < paragraphs.length; i++) {
                const para = paragraphs[i].trim();
                if (!para) continue;
                
                // Headers (lines that are standalone and followed by content)
                if (i < paragraphs.length - 1 && 
                    para.length < 80 && 
                    !para.includes('.') && 
                    !para.startsWith('-') && 
                    !para.startsWith('â€¢') &&
                    !para.includes('$') &&
                    paragraphs[i + 1].trim().length > para.length) {
                    
                    if (inList) {
                        enhanced += '</ul>';
                        inList = false;
                    }
                    enhanced += `<h3 style="color: #33808d; font-size: 18px; font-weight: 700; margin: 20px 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <span style="background: linear-gradient(135deg, #33808d, #1d7480); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 16px;">âœ¨</span>
                        ${para}
                    </h3>`;
                    continue;
                }
                
                // List items (lines starting with bullet points, dashes, or numbers)
                if (para.match(/^[-â€¢*]\s/) || para.match(/^\d+\.\s/)) {
                    if (!inList) {
                        enhanced += '<ul style="margin: 16px 0; padding-left: 0; list-style: none;">';
                        inList = true;
                    }
                    
                    const listContent = para.replace(/^[-â€¢*]\s/, '').replace(/^\d+\.\s/, '');
                    enhanced += `<li style="margin: 8px 0; padding: 12px 16px; background: rgba(51, 128, 141, 0.05); border-left: 3px solid #33808d; border-radius: 0 8px 8px 0; display: flex; align-items: start; gap: 8px;">
                        <span style="color: #33808d; font-weight: 600; margin-top: 2px;">â–¸</span>
                        <span style="line-height: 1.6;">${listContent}</span>
                    </li>`;
                    continue;
                }
                
                // Close list if we were in one
                if (inList && !para.match(/^[-â€¢*]\s/) && !para.match(/^\d+\.\s/)) {
                    enhanced += '</ul>';
                    inList = false;
                }
                
                // Key information (lines with important keywords)
                if (para.includes('important') || para.includes('note') || para.includes('remember') || 
                    para.includes('tip') || para.includes('warning') || para.includes('advice')) {
                    enhanced += `<div style="background: linear-gradient(135deg, rgba(51, 128, 141, 0.1), rgba(29, 116, 128, 0.05)); border: 1px solid rgba(51, 128, 141, 0.2); border-radius: 12px; padding: 16px; margin: 16px 0; box-shadow: 0 2px 8px rgba(51, 128, 141, 0.1);">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="background: #33808d; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-top: 2px;">ðŸ’¡</span>
                            <div style="line-height: 1.7; color: #1a6873;">${para}</div>
                        </div>
                    </div>`;
                    continue;
                }
                
                // Price/dollar mentions (make them stand out)
                let processedPara = para;
                if (para.includes('$')) {
                    processedPara = para.replace(/\$[\d,]+/g, match => 
                        `<strong style="color: #33808d; font-weight: 700;">${match}</strong>`
                    );
                }
                
                // Regular paragraphs with better typography
                enhanced += `<p style="line-height: 1.7; margin: 12px 0; color: #134252; font-size: 15px;">${processedPara}</p>`;
            }
            
            // Close any open list
            if (inList) {
                enhanced += '</ul>';
            }
            
            // Wrap everything in a styled container
            const result = `<div style="padding: 4px 0;">${enhanced}</div>`;
            console.log('âœ… Enhanced content generated:', { originalLength: content.length, enhancedLength: result.length, hasHeaders: result.includes('<h3'), hasLists: result.includes('<ul>') });
            return result;
        }

        /**
         * ðŸŽ¨ Render Beautiful Valuation Card with AI Estimate
         * Formats structured valuation data from backend into visually appealing HTML
         * @param {Object} valuationData - Structured valuation data from backend API
         * @returns {string} HTML string for valuation card
         */
        function renderValuationCard(valuationData) {
            const structured = valuationData.structured_data || valuationData;
            
            // Extract data with fallbacks
            const listPrice = structured.list_price || 0;
            const aiEstimate = structured.ai_estimate || structured.valuation?.estimated_value || 0;
            const adjustmentRange = structured.adjustment_range || structured.valuation?.value_range || {};
            const confidence = structured.confidence || structured.valuation?.confidence_score || 0;
            const description = structured.description || '';
            const comparables = structured.comparables || structured.comparables_simple || [];
            const property = structured.property || {};
            
            // Calculate range
            const rangeLow = adjustmentRange.low || (aiEstimate * 0.93);
            const rangeHigh = adjustmentRange.high || (aiEstimate * 1.07);
            
            // Calculate price difference
            let priceDiff = 0;
            let priceDiffPct = 0;
            let diffIndicator = '';
            let diffColor = '';
            let diffIcon = '';
            
            if (listPrice > 0 && aiEstimate > 0) {
                priceDiff = aiEstimate - listPrice;
                priceDiffPct = (priceDiff / listPrice) * 100;
                
                if (Math.abs(priceDiffPct) >= 1) {
                    if (priceDiffPct > 0) {
                        diffIndicator = 'Above List Price';
                        diffColor = '#4CAF50';
                        diffIcon = 'ðŸ“ˆ';
                    } else {
                        diffIndicator = 'Below List Price';
                        diffColor = '#FF9800';
                        diffIcon = 'ðŸ“‰';
                    }
                }
            }
            
            // Build HTML with BRAND COLORS
            const html = `
                <div class="valuation-card" style="background: linear-gradient(135deg, #33808d 0%, #1d7480 100%); border-radius: 16px; padding: 24px; margin: 16px 0; color: white; box-shadow: 0 8px 20px rgba(51, 128, 141, 0.3);">
                    <h2 style="margin: 0 0 20px 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                        <span style="background: rgba(255, 255, 255, 0.2); padding: 8px; border-radius: 8px; font-size: 20px;">ðŸ </span>
                        Property Valuation Report
                    </h2>
                    
                    <!-- Property Info -->
                    ${property.address ? `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 14px; opacity: 0.9;">ðŸ“ ${property.address || ''}</div>
                            ${property.city ? `<div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">${property.city}, ${property.province || 'ON'}</div>` : ''}
                            ${property.bedrooms || property.bathrooms || property.sqft ? `
                                <div style="font-size: 13px; opacity: 0.9; margin-top: 8px;">
                                    ${property.bedrooms ? property.bedrooms + ' bed' : ''} 
                                    ${property.bathrooms ? ' â€¢ ' + property.bathrooms + ' bath' : ''} 
                                    ${property.sqft ? ' â€¢ ' + property.sqft.toLocaleString() + ' sqft' : ''}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Price Comparison -->
                    <div class="price-comparison" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <!-- List Price -->
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 16px; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;">ðŸ“‹ List Price</div>
                            <div style="font-size: 28px; font-weight: 700;">$${listPrice.toLocaleString()}</div>
                        </div>
                        
                        <!-- AI Estimate (HIGHLIGHTED) -->
                        <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 16px; border-radius: 12px; border: 3px solid rgba(255, 255, 255, 0.4); box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);">
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #333;">âœ¨ AI Estimated Value</div>
                            <div style="font-size: 32px; font-weight: 800; color: #333;">$${aiEstimate.toLocaleString()}</div>
                            <div style="font-size: 12px; margin-top: 8px; color: #555; font-weight: 600;">
                                Range: $${Math.round(rangeLow).toLocaleString()} - $${Math.round(rangeHigh).toLocaleString()}
                            </div>
                            <div style="font-size: 11px; margin-top: 6px; color: #666;">
                                ðŸŽ¯ Confidence: ${confidence}%
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Difference Indicator -->
                    ${diffIndicator ? `
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <span style="font-size: 14px;">${diffIcon} ${diffIndicator}: </span>
                            <span style="font-size: 16px; font-weight: 700; color: ${diffColor};">
                                $${Math.abs(priceDiff).toLocaleString()} (${priceDiffPct > 0 ? '+' : ''}${priceDiffPct.toFixed(1)}%)
                            </span>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Description Section -->
                ${description ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 16px 0; color: #333; font-size: 18px; font-weight: 700;">ðŸ“ Property Analysis</h3>
                        <div style="color: #666; line-height: 1.8;">
                            ${formatPropertyDescription(description)}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Comparable Properties -->
                ${comparables && comparables.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 16px 0; color: #333; font-size: 18px; font-weight: 700;">ðŸ˜ï¸ Comparable Properties (${comparables.length})</h3>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                            ${comparables.slice(0, 5).map((comp, i) => `
                                <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; border-left: 4px solid #33808d;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 700; color: #333; margin-bottom: 4px;">${i + 1}. ${comp.address || 'Comparable Property'}</div>
                                            <div style="font-size: 13px; color: #666;">MLS: ${comp.mls_id || 'N/A'}</div>
                                            <div style="font-size: 14px; color: #33808d; margin-top: 6px; font-weight: 600;">
                                                Sold: $${(comp.sold_price || comp.sale_price || 0).toLocaleString()}
                                            </div>
                                            <div style="font-size: 12px; color: #999; margin-top: 4px;">${comp.sold_date || comp.sale_date || 'Recently'}</div>
                                        </div>
                                        <div style="background: #33808d; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                            ðŸ“ ${(comp.distance_km || 0).toFixed(1)}km
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${comparables.length > 5 ? `
                            <div style="text-align: center; margin-top: 16px; padding: 12px; background: #e8f4f8; border-radius: 8px;">
                                <span style="color: #33808d; font-weight: 600;">+${comparables.length - 5} more comparables analyzed</span>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <!-- Data Sources Footer -->
                <div style="background: #f8f9fa; border-radius: 8px; padding: 14px; margin: 16px 0; border-left: 4px solid #4CAF50;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        <div style="margin-bottom: 6px;"><strong>ðŸ” Data Sources:</strong> Repliers MLS Database, Recent Sales Data, Market Trends</div>
                        <div style="margin-bottom: 6px;"><strong>ðŸ¤– AI Model:</strong> OpenAI GPT-4o-mini with Canadian Real Estate Training</div>
                        <div><strong>ðŸ“Š Analysis Date:</strong> ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                    </div>
                </div>
            `;
            
            return html;
        }

        /**
         * Format property description with better visual structure
         * @param {string} description - Raw description text
         * @returns {string} Formatted HTML
         */
        function formatPropertyDescription(description) {
            if (!description) return '';
            
            const lines = description.split('\n').filter(line => line.trim());
            let formatted = '';
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                // Convert bullet points
                if (trimmed.startsWith('â€¢') || trimmed.startsWith('-') || trimmed.startsWith('*')) {
                    formatted += `<div style="margin: 8px 0 8px 20px; color: #555;">âœ“ ${trimmed.substring(1).trim()}</div>`;
                }
                // Headers (lines ending with colon)
                else if (trimmed.endsWith(':')) {
                    formatted += `<div style="font-weight: 700; color: #33808d; margin: 16px 0 8px 0;">${trimmed}</div>`;
                }
                // Section markers (## or **)
                else if (trimmed.startsWith('##') || trimmed.startsWith('**')) {
                    const text = trimmed.replace(/^##\s*/, '').replace(/^\*\*/, '').replace(/\*\*$/, '');
                    formatted += `<div style="font-weight: 700; color: #33808d; margin: 16px 0 8px 0;">${text}</div>`;
                }
                // Regular paragraphs
                else {
                    formatted += `<div style="margin: 8px 0;">${trimmed}</div>`;
                }
            }
            
            return formatted;
        }

        /**
         * Display property search results
         */
        function addPropertySearchMessage(properties, responseText, quickReplies = []) {
            const container = document.getElementById('chatContainer');
            const message = document.createElement('div');
            message.className = 'message';
            
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Build property cards grid
            const propertyCards = properties.map((prop, index) => `
                <div class="property-search-card" data-mls="${prop.mls_number || prop.mls_id}" data-index="${index}">
                    <div class="property-image-container">
                        ${prop.images && prop.images.length > 0 ? `
                            <img src="${prop.images[0]}" alt="${prop.address}" class="property-image" 
                                 onerror="this.src='/static/images/no-property-image.svg'">
                        ` : `
                            <div class="property-image property-no-image">ðŸ  No Image</div>
                        `}
                    </div>
                    <div class="property-details">
                        <div class="property-price">$${formatNumber(prop.price || prop.list_price)}</div>
                        <div class="property-address">${prop.address || 'Address not available'}</div>
                        ${prop.mls_number || prop.mls_id ? `
                            <div style="font-size: 12px; color: var(--color-text-secondary); margin: 4px 0;">
                                MLS: ${prop.mls_number || prop.mls_id}
                            </div>
                        ` : ''}
                        <div class="property-specs">
                            ${prop.bedrooms || prop.beds ? `<span class="property-spec">ðŸ›ï¸ ${prop.bedrooms || prop.beds} beds</span>` : ''}
                            ${prop.bathrooms || prop.baths ? `<span class="property-spec">ðŸš¿ ${prop.bathrooms || prop.baths} baths</span>` : ''}
                            ${prop.sqft || prop.square_footage ? `<span class="property-spec">ðŸ“ ${formatNumber(prop.sqft || prop.square_footage)} sq ft</span>` : ''}
                        </div>
                        <div class="property-actions" style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn-small btn-primary" onclick="openAIAnalysisPanel('${prop.mls_number || prop.mls_id}', 'property')">
                                ðŸ¤– AI Analysis
                            </button>
                            <button class="btn-small btn-secondary" onclick="viewPropertyDetails('${prop.mls_number || prop.mls_id}', '${prop.mls_number || prop.mls_id}')">
                                ðŸ“‹ View Details
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            message.innerHTML = `
                <div class="message-avatar ai-avatar">ðŸ¤–</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">AI Assistant</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">
                        <div style="margin-bottom: 16px;">${responseText || ''}</div>
                        <div class="property-search-grid">
                            ${propertyCards}
                        </div>
                        ${quickReplies.length > 0 ? generateQuickReplies(quickReplies) : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(message);
            scrollToBottom();
            
            chatHistory.push({ 
                sender: 'ai', 
                content: 'Property Search Results', 
                properties: properties, 
                timestamp: new Date() 
            });
        }

        function generatePropertyCards(properties) {
            return properties.map(prop => `
                <div class="property-card">
                    <img src="${prop.image}" alt="${prop.address}" class="property-image">
                    <div class="property-details">
                        <div class="property-price">${prop.price}</div>
                        <div class="property-address">${prop.address}</div>
                        <div class="property-specs">
                            <span class="property-spec">ðŸ›ï¸ ${prop.beds} beds</span>
                            <span class="property-spec">ðŸš¿ ${prop.baths} baths</span>
                            <span class="property-spec">ðŸ“ ${prop.sqft}</span>
                        </div>
                        <div class="property-actions">
                            <button class="btn-small" onclick="viewProperty(${prop.id})">View Details</button>
                            <button class="btn-small" onclick="scheduleViewing(${prop.id})">Schedule Tour</button>
                            <button class="btn-small" onclick="analyzeProperty(${prop.id})">Investment Analysis</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function generateQuickReplies(replies) {
            return `
                <div class="quick-replies">
                    ${replies.map(reply => `
                        <button class="quick-reply-btn" onclick="sendMessage('${reply}')">${reply}</button>
                    `).join('')}
                </div>
            `;
        }

        function generateSourceLinks(sources) {
            return `
                <div class="source-links">
                    ${sources.map(source => `
                        <a href="${source.url}" class="source-link" target="_blank">ðŸ“„ ${source.title}</a>
                    `).join('')}
                </div>
            `;
        }

        function showTypingIndicator() {
            const container = document.getElementById('chatContainer');
            const indicator = document.createElement('div');
            indicator.className = 'message';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-avatar ai-avatar">ðŸ¤–</div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            container.appendChild(indicator);
            scrollToBottom();
        }

        // ==================== AI ANALYSIS SIDE PANEL ====================

        /**
         * Open AI Analysis Panel with Perplexity-style animation (Quick Insights Mode)
         */
        async function openAIAnalysisPanel(mlsId, type = 'property') {
            const panel = document.getElementById('aiAnalysisPanel');
            const body = document.getElementById('aiPanelBody');
            
            // Open panel
            panel.classList.add('open');
            
            // Show analyzing animation
            body.innerHTML = `
                <div class="ai-analyzing">
                    <div class="ai-analyzing-icon">ðŸ¤–</div>
                    <div class="ai-analyzing-text">Analyzing Property Data...</div>
                    <div class="ai-analyzing-sources">
                        <div class="ai-source-item">
                            <div class="ai-source-icon">ðŸ¢</div>
                            <div class="ai-source-text">Fetching property details</div>
                            <div class="ai-source-status">âœ“</div>
                        </div>
                        <div class="ai-source-item">
                            <div class="ai-source-icon">ðŸ«</div>
                            <div class="ai-source-text">Analyzing schools & amenities</div>
                            <div class="ai-source-status">...</div>
                        </div>
                        <div class="ai-source-item">
                            <div class="ai-source-icon">ðŸ¤–</div>
                            <div class="ai-source-text">Generating AI insights</div>
                            <div class="ai-source-status">...</div>
                        </div>
                        <div class="ai-source-item">
                            <div class="ai-source-icon">ðŸ“ˆ</div>
                            <div class="ai-source-text">Calculating value estimate</div>
                            <div class="ai-source-status">...</div>
                        </div>
                    </div>
                </div>
            `;

            // Simulate analysis steps
            await new Promise(resolve => setTimeout(resolve, 500));
            updateAnalysisStep(1);
            await new Promise(resolve => setTimeout(resolve, 600));
            updateAnalysisStep(2);
            await new Promise(resolve => setTimeout(resolve, 700));
            updateAnalysisStep(3);
            
            // Fetch lightweight AI analysis (Quick Insights Mode)
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/property-analysis`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mls_number: mlsId,
                        mode: 'quick_insights',
                        session_id: currentSessionId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Display quick insights
                    displayQuickInsights(data, mlsId);
                } else {
                    body.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                            <p>Unable to fetch analysis. Please try again.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('AI Analysis error:', error);
                body.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                        <p>Error loading analysis: ${error.message}</p>
                    </div>
                `;
            }
        }

        function updateAnalysisStep(step) {
            const sources = document.querySelectorAll('.ai-source-item');
            if (sources[step]) {
                const status = sources[step].querySelector('.ai-source-status');
                if (status) status.textContent = 'âœ“';
            }
        }

        /**
         * Display Quick Insights in AI Analysis Panel
         */
        function displayQuickInsights(data, mlsId) {
            const body = document.getElementById('aiPanelBody');
            
            const insights = data.insights || {};
            const estimated = insights.estimated_value || {};
            const actualPrice = insights.actual_price;
            const schools = insights.schools || [];
            const neighborhood = insights.neighborhood || {};
            const connectivity = insights.connectivity || {};
            const market = insights.market_trend || {};
            const rental = insights.rental_potential || {};
            const pros = insights.pros || [];
            const cons = insights.cons || [];
            const sources = data.sources || [];

            body.innerHTML = `
                <div style="line-height: 1.7;">
                    <!-- Price Comparison Section -->
                    <div style="background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); padding: 24px; border-radius: var(--radius-lg); margin-bottom: 20px; color: white;">
                        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">ðŸ  MLS ${mlsId}</div>
                        
                        ${actualPrice ? `
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 13px; opacity: 0.8; margin-bottom: 4px;">List Price</div>
                                <div style="font-size: 28px; font-weight: 700;">
                                    $${formatNumber(actualPrice)}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div>
                            <div style="font-size: 13px; opacity: 0.8; margin-bottom: 4px;">AI Estimated Value</div>
                            <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">
                                $${formatNumber(estimated.mid || estimated.estimated_value || 0)}
                            </div>
                            ${estimated.low && estimated.high ? `
                                <div style="display: flex; justify-content: space-between; font-size: 12px; opacity: 0.85;">
                                    <div>Range: $${formatNumber(estimated.low)} - $${formatNumber(estimated.high)}</div>
                                </div>
                            ` : ''}
                            
                            <!-- See Full Report Button -->
                            ${mlsId ? `
                                <button 
                                    onclick="viewFullPropertyReport('${mlsId}')" 
                                    style="
                                        margin-top: 20px;
                                        width: 100%;
                                        padding: 14px 24px;
                                        background: white;
                                        color: #1d7480;
                                        border: none;
                                        border-radius: 10px;
                                        font-size: 15px;
                                        font-weight: 700;
                                        cursor: pointer;
                                        transition: all 0.3s ease;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 10px;
                                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                                    "
                                    onmouseover="this.style.background='#f0f8ff'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 6px 16px rgba(0, 0, 0, 0.2)'"
                                    onmouseout="this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'"
                                >
                                    <span style="font-size: 18px;">ðŸ“Š</span>
                                    <span>See Full Property Report</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Schools Section -->
                    ${schools.length > 0 ? `
                        <div class="insight-section">
                            <h3 class="insight-title">ðŸ« Nearby Schools</h3>
                            ${schools.map(school => `
                                <div class="school-item">
                                    <div class="school-header">
                                        <strong>${school.name || 'School'}</strong>
                                        ${school.rating ? `<span class="school-rating">â­ ${school.rating}/10</span>` : ''}
                                    </div>
                                    <div class="school-details">
                                        ${school.type ? `<span>${school.type}</span>` : ''}
                                        ${school.distance ? `<span>ðŸ“ ${school.distance}</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}

                    <!-- Neighborhood Insights -->
                    ${neighborhood.summary ? `
                        <div class="insight-section">
                            <h3 class="insight-title">ðŸ˜ï¸ Neighborhood Insights</h3>
                            <p style="margin-bottom: 12px;">${neighborhood.summary}</p>
                            ${neighborhood.safety_score ? `
                                <div class="metric-row">
                                    <span>ðŸ›¡ï¸ Safety Score:</span>
                                    <strong>${neighborhood.safety_score}/10</strong>
                                </div>
                            ` : ''}
                            ${neighborhood.walkability ? `
                                <div class="metric-row">
                                    <span>ðŸš¶ Walkability:</span>
                                    <strong>${neighborhood.walkability}/100</strong>
                                </div>
                            ` : ''}
                            ${neighborhood.demographics ? `
                                <div style="margin-top: 8px; font-size: 14px; color: var(--color-text-secondary);">
                                    ${neighborhood.demographics}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Connectivity -->
                    ${connectivity.summary ? `
                        <div class="insight-section">
                            <h3 class="insight-title">ðŸš‡ Connectivity</h3>
                            <p style="margin-bottom: 12px;">${connectivity.summary}</p>
                            ${connectivity.transit_score ? `
                                <div class="metric-row">
                                    <span>ðŸšŒ Transit Score:</span>
                                    <strong>${connectivity.transit_score}/100</strong>
                                </div>
                            ` : ''}
                            ${connectivity.commute_time ? `
                                <div class="metric-row">
                                    <span>â±ï¸ Avg Commute:</span>
                                    <strong>${connectivity.commute_time}</strong>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Market Trend -->
                    ${market.summary ? `
                        <div class="insight-section">
                            <h3 class="insight-title">ðŸ“ˆ Market Trend</h3>
                            <p>${market.summary}</p>
                            ${market.appreciation ? `
                                <div class="metric-row">
                                    <span>ðŸ“Š 12-Month Appreciation:</span>
                                    <strong style="color: ${market.appreciation > 0 ? '#27ae60' : '#e74c3c'};">
                                        ${market.appreciation > 0 ? '+' : ''}${market.appreciation}%
                                    </strong>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Rental Potential -->
                    ${rental.summary ? `
                        <div class="insight-section">
                            <h3 class="insight-title">ðŸ’° Investment Outlook</h3>
                            <p style="margin-bottom: 12px;">${rental.summary}</p>
                            ${rental.estimated_rent ? `
                                <div class="metric-row">
                                    <span>ðŸ’µ Est. Monthly Rent:</span>
                                    <strong>$${formatNumber(rental.estimated_rent)}/mo</strong>
                                </div>
                            ` : ''}
                            ${rental.roi ? `
                                <div class="metric-row">
                                    <span>ðŸ“ˆ Potential ROI:</span>
                                    <strong>${rental.roi}%</strong>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Pros & Cons -->
                    ${(pros.length > 0 || cons.length > 0) ? `
                        <div class="insight-section">
                            <h3 class="insight-title">âš–ï¸ Pros & Cons</h3>
                            ${pros.length > 0 ? `
                                <div style="margin-bottom: 16px;">
                                    <strong style="color: #27ae60;">âœ“ Pros:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px;">
                                        ${pros.map(pro => `<li>${pro}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${cons.length > 0 ? `
                                <div>
                                    <strong style="color: #e74c3c;">âœ— Cons:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px;">
                                        ${cons.map(con => `<li>${con}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    <!-- Data Sources Section -->
                    ${sources.length > 0 ? `
                        <div class="insight-section" style="border-top: 2px solid var(--color-border); padding-top: 16px; margin-top: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleDataSources()">
                                <div style="font-size: 14px; color: var(--color-text-secondary);">
                                    ï¿½ Data Sources Used
                                </div>
                                <button class="btn-small btn-secondary" id="sourcesToggle">
                                    View Sources â†’
                                </button>
                            </div>
                            <div id="sourcesContent" style="display: none; margin-top: 16px; max-height: 300px; overflow-y: auto;">
                                ${sources.map(source => `
                                    <div style="padding: 12px; background: var(--color-bg-secondary); border-radius: var(--radius-sm); margin-bottom: 8px;">
                                        <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">${source.title || 'Source'}</div>
                                        ${source.url ? `
                                            <a href="${source.url}" target="_blank" style="font-size: 12px; color: var(--color-primary); text-decoration: none;">
                                                ${source.url}
                                            </a>
                                        ` : ''}
                                        ${source.type ? `
                                            <div style="font-size: 11px; color: var(--color-text-secondary); margin-top: 4px;">
                                                Type: ${source.type}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function closeAIAnalysisPanel() {
            const panel = document.getElementById('aiAnalysisPanel');
            panel.classList.remove('open');
        }

        /**
         * View full property valuation report
         * Closes the AI Analysis panel and sends a chat message to generate the full report
         */
        function viewFullPropertyReport(mlsNumber) {
            if (!mlsNumber) {
                console.error('MLS number not available');
                return;
            }
            
            // Close the AI Analysis panel
            closeAIAnalysisPanel();
            
            // Send message to generate full valuation report
            const message = `value of MLS: ${mlsNumber}`;
            sendMessage(message);
            
            // Scroll to chat to show the response
            setTimeout(() => {
                const chatContainer = document.querySelector('.chat-container') || document.querySelector('#chatMessages');
                if (chatContainer) {
                    chatContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }

        function toggleDataSources() {
            const content = document.getElementById('sourcesContent');
            const toggle = document.getElementById('sourcesToggle');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'â†‘ Hide Sources';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'View Sources â†’';
            }
        }

        /**
         * View Property Details - Opens modal with full property information
         */
        async function viewPropertyDetails(propertyId, mlsNumber) {
            // Use MLS number if available, otherwise use property ID
            const mls = mlsNumber || propertyId;
            
            if (!mls) {
                showToast('No MLS number available', 'error');
                return;
            }
            
            // Show loading modal
            const modal = document.createElement('div');
            modal.className = 'property-details-modal';
            modal.id = 'propertyDetailsModal';
            modal.innerHTML = `
                <div class="modal-backdrop" onclick="closePropertyDetails()"></div>
                <div class="property-details-content">
                    <button class="modal-close-btn" onclick="closePropertyDetails()">âœ•</button>
                    <div class="property-loading">
                        <div class="spinner" style="width: 48px; height: 48px; border: 4px solid #e8f4f8; border-top-color: #33808d; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                        <p>Loading property details...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            try {
                // Fetch property details from our /api/property-details endpoint
                const response = await fetch(`${getApiBaseUrl()}/api/property-details?mls=${mls}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success && data.property) {
                    displayPropertyDetails(data.property);
                } else {
                    document.querySelector('.property-loading').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                            <p>Unable to load property details.</p>
                            <button class="btn-small btn-primary" onclick="closePropertyDetails()" style="margin-top: 16px;">Close</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error fetching property details:', error);
                document.querySelector('.property-loading').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                        <p>Error: ${error.message}</p>
                        <button class="btn-small btn-primary" onclick="closePropertyDetails()" style="margin-top: 16px;">Close</button>
                    </div>
                `;
            }
        }

        function displayPropertyDetails(property) {
            const content = document.querySelector('.property-details-content');
            const images = property.images || [];
            
            content.innerHTML = `
                <button class="modal-close-btn" onclick="closePropertyDetails()">âœ•</button>
                <div class="property-details-body">
                    <!-- Image Carousel -->
                    ${images.length > 0 ? `
                        <div class="property-carousel">
                            <div class="carousel-main">
                                <img src="${images[0]}" alt="Property" class="carousel-main-image" id="mainImage" onerror="this.src='/static/images/no-property-image.svg'">
                                ${images.length > 1 ? `
                                    <button class="carousel-nav prev" onclick="navigatePropertyCarousel(-1)">â€¹</button>
                                    <button class="carousel-nav next" onclick="navigatePropertyCarousel(1)">â€º</button>
                                    <div class="carousel-counter">${1} / ${images.length}</div>
                                ` : ''}
                            </div>
                            ${images.length > 1 ? `
                                <div class="carousel-thumbnails">
                                    ${images.map((img, index) => `
                                        <img src="${img}" alt="Thumbnail ${index + 1}" 
                                             class="carousel-thumb ${index === 0 ? 'active' : ''}" 
                                             onclick="selectPropertyImage(${index})"
                                             onerror="this.src='/static/images/no-property-thumbnail.svg'">
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div style="height: 300px; background: var(--color-bg-primary); display: flex; align-items: center; justify-content: center; font-size: 48px; border-radius: var(--radius-lg);">
                            ðŸ 
                        </div>
                    `}

                    <!-- Property Header -->
                    <div class="property-header">
                        <h2 class="property-title">${property.address || 'Property Details'}</h2>
                        <div class="property-price-badge">$${formatNumber(property.price || property.list_price)}</div>
                    </div>

                    <!-- Key Details Grid -->
                    <div class="property-details-grid">
                        ${property.bedrooms ? `
                            <div class="detail-item">
                                <div class="detail-icon">ðŸ›ï¸</div>
                                <div>
                                    <div class="detail-label">Bedrooms</div>
                                    <div class="detail-value">${property.bedrooms}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${property.bathrooms ? `
                            <div class="detail-item">
                                <div class="detail-icon">ðŸš¿</div>
                                <div>
                                    <div class="detail-label">Bathrooms</div>
                                    <div class="detail-value">${property.bathrooms}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${property.sqft || property.square_footage ? `
                            <div class="detail-item">
                                <div class="detail-icon">ðŸ“</div>
                                <div>
                                    <div class="detail-label">Square Feet</div>
                                    <div class="detail-value">${formatNumber(property.sqft || property.square_footage)}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${property.property_type ? `
                            <div class="detail-item">
                                <div class="detail-icon">ðŸ </div>
                                <div>
                                    <div class="detail-label">Type</div>
                                    <div class="detail-value">${capitalizeFirst(property.property_type)}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${property.lot_size ? `
                            <div class="detail-item">
                                <div class="detail-icon">ðŸ“</div>
                                <div>
                                    <div class="detail-label">Lot Size</div>
                                    <div class="detail-value">${property.lot_size}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${property.year_built ? `
                            <div class="detail-item">
                                <div class="detail-icon">ðŸ“…</div>
                                <div>
                                    <div class="detail-label">Year Built</div>
                                    <div class="detail-value">${property.year_built}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Description -->
                    ${property.description ? `
                        <div class="property-section">
                            <h3 class="section-header">ðŸ“ Description</h3>
                            <p class="property-description">${property.description}</p>
                        </div>
                    ` : ''}

                    <!-- Features -->
                    ${property.features && property.features.length > 0 ? `
                        <div class="property-section">
                            <h3 class="section-header">âœ¨ Key Features</h3>
                            <ul class="features-list">
                                ${property.features.map(feature => `<li>${feature}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <!-- MLS Information -->
                    <div class="property-section">
                        <h3 class="section-header">ðŸ“‹ Property Information</h3>
                        <div class="info-grid">
                            ${property.mls_number ? `
                                <div class="info-row">
                                    <span class="info-label">MLS Number:</span>
                                    <span class="info-value">${property.mls_number}</span>
                                </div>
                            ` : ''}
                            ${property.status ? `
                                <div class="info-row">
                                    <span class="info-label">Status:</span>
                                    <span class="info-value">${property.status}</span>
                                </div>
                            ` : ''}
                            ${property.list_date ? `
                                <div class="info-row">
                                    <span class="info-label">Listed Date:</span>
                                    <span class="info-value">${property.list_date}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="property-actions-bar">
                        <button class="btn-primary" onclick="openAIAnalysisPanel('${property.mls_number}', 'property')">
                            ðŸ¤– AI Analysis
                        </button>
                        <button class="btn-secondary" onclick="sendMessage('Schedule a viewing for MLS ${property.mls_number}')">
                            ðŸ“… Schedule Viewing
                        </button>
                    </div>
                </div>
            `;

            // Store images for carousel navigation
            window.propertyImages = images;
            window.currentImageIndex = 0;
        }

        function navigatePropertyCarousel(direction) {
            const images = window.propertyImages || [];
            if (images.length <= 1) return;

            window.currentImageIndex = (window.currentImageIndex + direction + images.length) % images.length;
            selectPropertyImage(window.currentImageIndex);
        }

        function selectPropertyImage(index) {
            const images = window.propertyImages || [];
            if (!images[index]) return;

            const mainImage = document.getElementById('mainImage');
            const counter = document.querySelector('.carousel-counter');
            const thumbs = document.querySelectorAll('.carousel-thumb');

            if (mainImage) mainImage.src = images[index];
            if (counter) counter.textContent = `${index + 1} / ${images.length}`;
            
            thumbs.forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });

            window.currentImageIndex = index;
        }

        function closePropertyDetails() {
            const modal = document.getElementById('propertyDetailsModal');
            if (modal) modal.remove();
        }

        // ==================== VOICE & MULTIMODAL FEATURES ====================

        /**
         * Handle Voice Input
         */
        async function handleVoiceInput() {
            try {
                if (voiceManager.isRecording) {
                    // Stop recording
                    showLoadingOverlay('Processing your voice...');
                    const audioBlob = await voiceManager.stopRecording();
                    
                    // Send to API
                    const response = await api.voiceChat(audioBlob, appState.sessionId);
                    hideLoadingOverlay();
                    
                    if (response.success) {
                        // Add user message (transcription)
                        if (response.transcription) {
                            addMessage('user', response.transcription);
                        }
                        
                        // Add AI response
                        if (response.audio_url) {
                            const audioHTML = renderAudioPlayer(response.audio_url, response.response);
                            addMessage('ai', audioHTML);
                        } else {
                            addMessage('ai', response.response);
                        }
                        
                        showToast('Voice message processed!', 'success');
                    } else {
                        showToast('Voice processing failed', 'error');
                    }
                    
                    closeVoiceModal();
                } else {
                    // Start recording
                    await voiceManager.startRecording();
                    isRecording = true;
                    
                    // Visualize
                    const canvas = document.getElementById('voiceWaveform');
                    if (canvas) {
                        voiceManager.visualize(canvas);
                    }
                    
                    // Update UI
                    const btn = document.querySelector('.voice-btn-primary');
                    if (btn) {
                        btn.textContent = 'â¹ï¸ Stop Recording';
                        btn.style.background = 'var(--color-error)';
                    }
                }
            } catch (error) {
                console.error('Voice error:', error);
                showToast(error.message || 'Voice feature unavailable', 'error');
                hideLoadingOverlay();
            }
        }

        /**
         * Handle File Upload
         */
        async function handleFileUpload(files) {
            if (!files || files.length === 0) return;

            try {
                // Validate files
                for (const file of files) {
                    fileManager.addFile(file);
                }

                // Show preview
                const previewGrid = document.getElementById('filePreviewGrid') || createFilePreviewGrid();
                previewGrid.innerHTML = '';

                for (const fileItem of fileManager.files) {
                    const preview = await fileManager.generatePreview(fileItem.file);
                    const previewCard = document.createElement('div');
                    previewCard.className = 'file-preview-card';
                    previewCard.style.cssText = 'position: relative; background: var(--color-surface); border-radius: 8px; padding: 12px; border: 1px solid var(--color-border);';
                    previewCard.innerHTML = `
                        ${preview ? `<img src="${preview}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;">` : ''}
                        <div style="font-size: 13px; margin-bottom: 4px;">${fileItem.file.name}</div>
                        <div style="font-size: 11px; color: var(--color-text-secondary);">${(fileItem.file.size / 1024).toFixed(1)} KB</div>
                        <button onclick="removeFile('${fileItem.id}')" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">Ã—</button>
                    `;
                    previewGrid.appendChild(previewCard);
                }

                showToast(`${files.length} file(s) ready to upload`, 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function createFilePreviewGrid() {
            const grid = document.createElement('div');
            grid.id = 'filePreviewGrid';
            grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 16px;';
            const inputArea = document.querySelector('.input-area');
            if (inputArea) {
                inputArea.insertBefore(grid, inputArea.firstChild);
            }
            return grid;
        }

        function removeFile(fileId) {
            fileManager.removeFile(fileId);
            const previewGrid = document.getElementById('filePreviewGrid');
            if (previewGrid) {
                handleFileUpload(fileManager.getFiles());
                if (fileManager.files.length === 0) {
                    previewGrid.remove();
                }
            }
        }

        /**
         * Send Multimodal Message (Text + Files)
         */
        async function sendMultimodalMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const files = fileManager.getFiles();

            if (!message && files.length === 0) {
                showToast('Please enter a message or upload files', 'error');
                return;
            }

            try {
                showLoadingOverlay('Analyzing...');

                // Add user message
                if (message) {
                    addMessage('user', message);
                }
                if (files.length > 0) {
                    addMessage('user', `ðŸ“Ž ${files.length} file(s) attached`);
                }

                // Call multimodal API
                const response = await api.multimodalChat(message || 'Analyze these files', files, appState.sessionId);
                
                hideLoadingOverlay();

                if (response.success) {
                    addMessage('ai', response.response);
                    showToast('Analysis complete!', 'success');
                } else {
                    throw new Error(response.error || 'Analysis failed');
                }

                // Clear input
                input.value = '';
                fileManager.clear();
                const previewGrid = document.getElementById('filePreviewGrid');
                if (previewGrid) previewGrid.remove();
                adjustTextareaHeight();
                
            } catch (error) {
                hideLoadingOverlay();
                showToast(error.message, 'error');
                addMessage('ai', 'Sorry, I encountered an error processing your files. Please try again.');
            }
        }

        /**
         * Property Actions
         */
        async function viewPropertyDetails(propertyId, mlsNumber) {
            try {
                console.log('ðŸ“‹ CORRECT View Details function called:', { propertyId, mlsNumber });
                showLoadingOverlay('Loading property details...');
                
                // Always use the chat message approach since it includes photos and full formatting
                hideLoadingOverlay();
                
                if (mlsNumber && mlsNumber !== 'undefined' && mlsNumber !== 'null') {
                    // Send message with MLS number for detailed property info with photos
                    console.log('ðŸ” Sending message for MLS:', mlsNumber);
                    sendMessage(`Tell me more about property ${mlsNumber}`);
                } else if (propertyId && propertyId !== 'undefined' && propertyId !== 'null') {
                    // Fallback to property ID
                    console.log('ðŸ” Sending message for property ID:', propertyId);
                    sendMessage(`Tell me more about property ${propertyId}`);
                } else {
                    // Last resort - generic request
                    console.log('ðŸ” Sending generic property details request');
                    sendMessage(`Show me more details about this property`);
                }
            } catch (error) {
                hideLoadingOverlay();
                console.error('âŒ View Details error:', error);
                showToast('Failed to load property details', 'error');
            }
        }

        async function calculateROI(mlsNumber) {
            sendMessage(`Calculate the investment ROI for MLS ${mlsNumber}`);
        }

        function scheduleViewing(propertyId) {
            const message = `I would like to schedule a viewing for property ${propertyId}`;
            sendMessage(message);
            showToast('Viewing request sent!', 'success');
        }

        function toggleFavorite(propertyId) {
            // TODO: Implement favorites
            showToast('Added to favorites!', 'success');
        }

        /**
         * Property Search with Filters
         */
        async function searchProperties(query, filters = {}) {
            try {
                showLoadingOverlay('Searching properties...');
                
                const response = await api.repliersNLPSearch(query, filters);
                hideLoadingOverlay();
                
                if (response.success && response.properties) {
                    const resultsHTML = renderSearchResults(response.properties, query);
                    addMessage('ai', resultsHTML);
                    showToast(`Found ${response.properties.length} properties`, 'success');
                } else {
                    addMessage('ai', 'No properties found matching your criteria. Try adjusting your search.');
                }
            } catch (error) {
                hideLoadingOverlay();
                showToast('Search failed', 'error');
                addMessage('ai', 'Sorry, the search service is temporarily unavailable.');
            }
        }

        /**
         * Location Insights
         */
        async function getLocationInsights(location) {
            try {
                showLoadingOverlay('Analyzing neighborhood...');
                
                const response = await api.locationInsights(location);
                hideLoadingOverlay();
                
                if (response.success && response.insights) {
                    const mapHTML = renderLocationMap(response.insights);
                    addMessage('ai', mapHTML);
                } else {
                    addMessage('ai', `Here's what I know about ${location}...`);
                }
            } catch (error) {
                hideLoadingOverlay();
                addMessage('ai', 'Location analysis is currently unavailable.');
            }
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        function scrollToBottom() {
            const container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        }

        // ==================== MANAGER DASHBOARD ====================

        /**
         * Toggle Dashboard View
         */
        async function toggleDashboard() {
            const sidebar = document.getElementById('sidebar');
            const chatContainer = document.getElementById('chatContainer');
            
            if (appState.viewMode === 'dashboard') {
                // Switch back to chat
                appState.setViewMode('chat');
                loadDashboard(false);
            } else {
                // Switch to dashboard
                appState.setViewMode('dashboard');
                await loadDashboard(true);
            }
        }

        /**
         * Load Manager Dashboard
         */
        async function loadDashboard(show = true) {
            if (!show) {
                // Return to chat view
                location.reload();
                return;
            }

            try {
                showLoadingOverlay('Loading dashboard...');
                
                const [statsResponse, leadsResponse, brokersResponse] = await Promise.all([
                    api.getDashboardStats(),
                    api.getLeads(),
                    api.getBrokers()
                ]);
                
                hideLoadingOverlay();

                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = renderDashboard(statsResponse, leadsResponse, brokersResponse);
                
            } catch (error) {
                hideLoadingOverlay();
                showToast('Failed to load dashboard', 'error');
                console.error('Dashboard error:', error);
            }
        }

        /**
         * Render Dashboard HTML
         */
        function renderDashboard(stats, leads, brokers) {
            return `
                <div class="manager-dashboard-view" style="padding: 24px;">
                    <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                        <div>
                            <h2 style="margin: 0 0 8px 0;">Lead Management Dashboard</h2>
                            <p style="color: var(--color-text-secondary); margin: 0;">Monitor and manage your real estate leads</p>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="exportLeads()" class="btn-small">ðŸ“Š Export Excel</button>
                            <button onclick="toggleDashboard()" class="btn-small">ðŸ’¬ Back to Chat</button>
                        </div>
                    </div>
                    
                    <div class="dashboard-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                        <div class="stat-card">
                            <div class="stat-value">${stats.total_leads || 0}</div>
                            <div class="stat-label">Total Leads</div>
                            <div class="stat-sublabel" style="color: var(--color-success);">+12% this week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.active_leads || 0}</div>
                            <div class="stat-label">Active Leads</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${brokers.brokers?.length || 0}</div>
                            <div class="stat-label">Active Brokers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round((stats.conversion_rate || 0) * 100)}%</div>
                            <div class="stat-label">Conversion Rate</div>
                        </div>
                    </div>
                    
                    <div class="leads-section" style="background: var(--color-surface); border-radius: var(--radius-lg); padding: 24px;">
                        <h3 style="margin: 0 0 20px 0;">Recent Leads</h3>
                        <div class="leads-table-container" style="overflow-x: auto;">
                            <table class="leads-table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid var(--color-border);">
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Name</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Email</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Broker</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Date</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${leads.leads?.map(lead => `
                                        <tr style="border-bottom: 1px solid var(--color-border);">
                                            <td style="padding: 12px;">${lead.name || 'N/A'}</td>
                                            <td style="padding: 12px;">${lead.email || 'N/A'}</td>
                                            <td style="padding: 12px;">
                                                <select onchange="updateLeadStatus(${lead.id}, this.value)" style="padding: 6px 12px; border: 1px solid var(--color-border); border-radius: 6px;">
                                                    <option value="New" ${lead.status === 'New' ? 'selected' : ''}>New</option>
                                                    <option value="Contacted" ${lead.status === 'Contacted' ? 'selected' : ''}>Contacted</option>
                                                    <option value="Qualified" ${lead.status === 'Qualified' ? 'selected' : ''}>Qualified</option>
                                                    <option value="Converted" ${lead.status === 'Converted' ? 'selected' : ''}>Converted</option>
                                                    <option value="Lost" ${lead.status === 'Lost' ? 'selected' : ''}>Lost</option>
                                                </select>
                                            </td>
                                            <td style="padding: 12px;">
                                                <select onchange="assignBrokerToLead(${lead.id}, this.value)" style="padding: 6px 12px; border: 1px solid var(--color-border); border-radius: 6px;">
                                                    <option value="">Unassigned</option>
                                                    ${brokers.brokers?.map(broker => `
                                                        <option value="${broker.id}" ${lead.assigned_broker === broker.name ? 'selected' : ''}>
                                                            ${broker.name}
                                                        </option>
                                                    `).join('') || ''}
                                                </select>
                                            </td>
                                            <td style="padding: 12px; color: var(--color-text-secondary);">${lead.date || 'N/A'}</td>
                                            <td style="padding: 12px;">
                                                <button onclick="viewLeadDetails(${lead.id})" class="btn-small">View</button>
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="6" style="padding: 24px; text-align: center; color: var(--color-text-secondary);">No leads found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Update Lead Status
         */
        async function updateLeadStatus(leadId, status) {
            try {
                const response = await api.updateLeadStatus(leadId, status);
                if (response.success) {
                    showToast(`Lead status updated to ${status}`, 'success');
                }
            } catch (error) {
                showToast('Failed to update status', 'error');
            }
        }

        /**
         * Assign Broker to Lead
         */
        async function assignBrokerToLead(leadId, brokerId) {
            if (!brokerId) return;
            
            try {
                const response = await api.assignBroker(leadId, parseInt(brokerId));
                if (response.success) {
                    showToast('Broker assigned successfully', 'success');
                }
            } catch (error) {
                showToast('Failed to assign broker', 'error');
            }
        }

        function viewLeadDetails(leadId) {
            showToast('Lead details view coming soon', 'info');
        }

        function exportLeads() {
            showToast('Exporting leads to Excel...', 'info');
            // API call would go here
        }

        // Property Actions (Legacy support)
        function viewProperty(id) {
            viewPropertyDetails(id);
        }

        function analyzeProperty(id) {
            calculateROI(id);
        }

        // Voice Functions
        function openVoiceModal() {
            document.getElementById('voiceModal').classList.add('active');
        }

        function closeVoiceModal() {
            document.getElementById('voiceModal').classList.remove('active');
            if (isRecording) toggleVoiceRecording();
        }

        function toggleVoiceRecording() {
            isRecording = !isRecording;
            const btn = event.target;
            if (isRecording) {
                btn.textContent = 'â¹ï¸ Stop Recording';
                btn.style.background = 'var(--color-error)';
            } else {
                btn.textContent = 'ðŸŽ¤ Start Recording';
                btn.style.background = 'var(--color-primary)';
                closeVoiceModal();
                // Simulate voice to text
                setTimeout(() => {
                    sendMessage('Show me 2-bedroom condos in downtown Toronto under $800K');
                }, 500);
            }
        }

        // Other Functions
        function uploadFile() {
            alert('File upload feature - Connect to your backend /upload endpoint');
        }

        function showFileUpload() {
            alert('File attachment feature - Connect to your backend');
        }

        function startNewChat() {
            if (confirm('Start a new conversation? Current chat will be saved.')) {
                chatHistory = [];
                document.getElementById('chatContainer').innerHTML = `
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">ðŸ </div>
                        <h1 class="welcome-title">Welcome Zubair to Your AI Real Estate Assistant</h1>
                        <p class="welcome-subtitle">
                            Powered by Llama 3.2 and Exa AI with live market data. Ask anything about Canadian real estate.
                        </p>
                    </div>
                `;
                currentSessionId = generateSessionId();
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
        }

        function showSettings() {
            alert('Settings panel - Configure voice preferences, broker selection, notification settings');
        }

        // ==================== PRODUCTION INITIALIZATION ====================
        
        /**
         * Initialize production-ready Summitly frontend
         */
        function initProduction() {
            console.log('ðŸš€ Summitly Production Frontend Initializing...');
            
            // Run original initialization
            init();
            
            // Test API connectivity
            testApiConnectivity();
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
            
            // Add production welcome message
            setTimeout(() => {
                addMessage('ai', `âœ¨ **Summitly AI is ready!** I'm powered by OpenAI and ready to help you with real estate research, property analysis, and market insights. 
                
ðŸŒŸ **What I can do:**
â€¢ Search and analyze properties in any Canadian city
â€¢ Provide detailed neighborhood information 
â€¢ Generate market analysis and investment insights
â€¢ Answer questions about schools, amenities, and local data

Ask me anything about real estate or try a quick action from the sidebar!`);
            }, 1500);
            
            console.log('âœ… Summitly Production Frontend Ready!');
        }
        
        /**
         * Test API connectivity and show status
         */
        async function testApiConnectivity() {
            try {
                // Try a simple health check first
                const response = await fetch(`${getApiBaseUrl()}/health`, { 
                    method: 'GET'
                }).catch(() => {
                    // If /health doesn't exist, try root endpoint
                    return fetch(getApiBaseUrl(), { method: 'GET' });
                });
                
                console.log('âœ… API connection successful');
                updateConnectionStatus('connected');
            } catch (error) {
                console.error('âŒ API connection failed:', error);
                updateConnectionStatus('disconnected');
            }
        }
        
        /**
         * Update connection status indicator
         */
        function updateConnectionStatus(status) {
            const statusDot = document.querySelector('.status-dot');
            const statusBadge = document.querySelector('.status-badge');
            
            if (statusDot && statusBadge) {
                switch (status) {
                    case 'connected':
                        statusDot.style.background = 'var(--color-success)';
                        statusBadge.innerHTML = '<div class="status-dot"></div>AI Connected';
                        break;
                    case 'warning':
                        statusDot.style.background = 'var(--color-warning)';
                        statusBadge.innerHTML = '<div class="status-dot"></div>Limited Service';
                        break;
                    case 'disconnected':
                        statusDot.style.background = 'var(--color-error)';
                        statusBadge.innerHTML = '<div class="status-dot"></div>Connecting...';
                        break;
                }
            }
        }
        
        /**
         * Setup keyboard shortcuts for better UX
         */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + Enter to send message
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    const input = document.querySelector('.message-input');
                    if (input && input.value.trim()) {
                        sendMessage(input.value.trim());
                        input.value = '';
                    }
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
        }

        // Initialize production version on load
        window.addEventListener('load', initProduction);
    </script>
</body>
</html>

