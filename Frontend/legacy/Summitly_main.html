<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summitly AI - AI-Powered Real Estate Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* CanaryAI-inspired color palette */
            --color-primary: #1976D2;
            --color-primary-hover: #1565C0;
            --color-primary-active: #0D47A1;
            --color-primary-dark: #0D47A1;
            --color-primary-light: #42A5F5;
            --color-primary-rgb: 25, 118, 210;
            
            /* Background colors */
            --color-bg-primary: #f5f7fa;
            --color-bg-secondary: #ffffff;
            --color-bg-tertiary: #e8edf2;
            --color-surface: #ffffff;
            
            /* Text colors */
            --color-text: #1a202c;
            --color-text-secondary: #64748b;
            --color-text-muted: #94a3b8;
            
            /* Border and dividers */
            --color-border: #e2e8f0;
            --color-border-light: #f1f5f9;
            
            /* Status colors */
            --color-success: #10b981;
            --color-success-light: #d1fae5;
            --color-error: #ef4444;
            --color-error-light: #fee2e2;
            --color-warning: #f59e0b;
            --color-warning-light: #fef3c7;
            --color-info: #3b82f6;
            --color-info-light: #dbeafe;
            
            /* Shadows - CanaryAI style */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.08), 0 4px 16px rgba(0, 0, 0, 0.04);
            --shadow-card-hover: 0 8px 24px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.06);
            
            /* Border radius */
            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            --radius-full: 9999px;
            
            /* Typography */
            --font-base: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'SF Mono', 'Monaco', 'Consolas', monospace;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.35s ease;
        }

        /* Reset & Base Styles - CanaryAI Style */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-base);
            background: var(--color-bg-primary);
            color: var(--color-text);
            line-height: 1.6;
            overflow-x: hidden;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            display: grid;
            grid-template-columns: 1fr;
            min-height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            background: var(--color-bg-primary);
        }
        
        /* When right panel is visible */
        .app-container.has-right-panel {
            grid-template-columns: 1fr 400px;
        }
        
        /* Right Panel - Property Results */
        .right-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--color-surface);
            border-left: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform var(--transition-normal);
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }
        
        .right-panel.active {
            transform: translateX(0);
        }
        
        .right-panel-header {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--color-surface);
        }
        
        .right-panel-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            margin: 0;
        }
        
        .right-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
        }
        
        .property-cards-container {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }
        
        /* Right panel property card styles */
        .right-panel .property-card-mini {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .right-panel .property-card-mini:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .right-panel .property-card-mini-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }
        
        .right-panel .property-card-mini-content {
            padding: var(--spacing-md);
        }
        
        .right-panel .property-card-mini-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--spacing-xs);
        }
        
        .right-panel .property-card-mini-address {
            font-size: 13px;
            color: var(--color-text);
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }
        
        .right-panel .property-card-mini-details {
            font-size: 12px;
            color: var(--color-text-secondary);
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .right-panel .property-card-mini-details span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Right Panel Responsive */
        @media (max-width: 1024px) {
            .right-panel {
                width: 350px;
            }
            
            .app-container.has-right-panel {
                grid-template-columns: 1fr 350px;
            }
        }
        
        @media (max-width: 768px) {
            .right-panel {
                width: 100%;
                max-width: 100%;
            }
            
            .app-container.has-right-panel {
                grid-template-columns: 1fr;
            }
            
            .right-panel .property-card-mini-image {
                height: 140px;
            }
        }

        /* Sidebar - CanaryAI Style */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-normal);
            transform: translateX(-100%);
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal), visibility var(--transition-normal);
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            background: var(--color-surface);
        }

        .sidebar-close-btn {
            margin-left: auto;
            font-size: 20px;
            color: var(--color-text-secondary);
            transition: all var(--transition-fast);
            cursor: pointer;
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-close-btn:hover {
            color: var(--color-text);
            background: var(--color-bg-tertiary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text);
            letter-spacing: -0.02em;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: transparent;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .new-chat-btn {
            width: 100%;
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: all var(--transition-fast);
            box-shadow: 0 2px 4px rgba(25, 118, 210, 0.2);
        }

        .new-chat-btn:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.3);
        }
        
        /* Chat History Styles */
        .chat-history-section {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
        }
        
        .chat-history-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-muted);
            letter-spacing: 0.08em;
            margin-bottom: var(--spacing-sm);
            padding: 0 var(--spacing-sm);
        }
        
        .chat-history-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .chat-history-item {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .chat-history-item:hover {
            background: var(--color-bg-tertiary);
        }
        
        .chat-history-item.active {
            background: var(--color-primary-light);
            border-left: 3px solid var(--color-primary);
        }
        
        .chat-history-item-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .chat-history-item-title .icon {
            font-size: 14px;
        }
        
        .chat-history-item-meta {
            font-size: 11px;
            color: var(--color-text-muted);
        }
        
        .chat-history-empty {
            padding: var(--spacing-xl);
            text-align: center;
            color: var(--color-text-muted);
            font-size: 13px;
        }
        
        /* Sidebar Filters Section */
        .sidebar-filters-section {
            border-top: 1px solid var(--color-border);
            padding: var(--spacing-md);
        }
        
        .sidebar-filters-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: var(--spacing-sm);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .sidebar-filters-toggle:hover {
            color: var(--color-text);
        }
        
        .sidebar-filters-content {
            margin-top: var(--spacing-sm);
        }

        .quick-actions {
            padding: 0 var(--spacing-lg);
            flex: 1;
            overflow-y: auto;
        }

        .quick-actions h3 {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-muted);
            margin-bottom: var(--spacing-md);
            letter-spacing: 0.08em;
        }

        .action-card {
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .action-card:hover {
            background: var(--color-bg-tertiary);
            border-color: var(--color-primary);
            transform: translateX(4px);
            box-shadow: var(--shadow-sm);
        }

        .action-card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--spacing-xs);
        }

        .action-card-desc {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .filter-chip {
            padding: 6px 14px;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--color-text-secondary);
        }

        .filter-chip:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Main Content - CanaryAI Style */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--color-bg-primary);
            width: 100%;
            min-height: 100vh;
            transition: margin-left var(--transition-normal);
        }

        /* Header - CanaryAI Style */
        .chat-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-xs);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: var(--color-info-light);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
            color: var(--color-primary);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: var(--color-success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-secondary);
            transition: all var(--transition-fast);
            font-size: 16px;
        }

        .icon-btn:hover {
            background: var(--color-bg-primary);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        /* Chat Container - CanaryAI Style */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-xl);
            display: flex;
            flex-direction: column;
            background: var(--color-bg-primary);
        }

        /* Welcome Screen - CanaryAI Style */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
            padding: var(--spacing-2xl);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-icon {
            width: 100px;
            height: 100px;
            background: transparent;
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-lg);
            animation: float 3s ease-in-out infinite;
        }

        .welcome-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            filter: drop-shadow(0 4px 12px rgba(25, 118, 210, 0.25));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .hero-badge {
            display: inline-block;
            padding: 8px 20px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-transform: none;
            letter-spacing: 0.02em;
            border-radius: var(--radius-full);
            margin-bottom: var(--spacing-md);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .hero-main-title {
            font-size: 32px;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: var(--spacing-md);
            color: var(--color-text);
            letter-spacing: -0.02em;
            max-width: 600px;
        }

        .number-highlight {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .action-highlight {
            color: var(--color-success);
            font-weight: 700;
        }

        .hero-description {
            font-size: 16px;
            color: var(--color-text-secondary);
            max-width: 500px;
            margin-bottom: var(--spacing-sm);
            line-height: 1.6;
        }

        .hero-stats {
            font-size: 14px;
            color: var(--color-text-muted);
            margin-top: var(--spacing-sm);
        }

        .stats-number {
            font-weight: 700;
            font-size: 15px;
            color: var(--color-primary);
        }

        /* Trending Prompts - CanaryAI Style */
        .trending-prompts {
            margin-top: 32px;
            max-width: 700px;
            width: 100%;
        }

        .trending-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
            text-align: left;
        }

        .trending-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .trending-prompt {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .trending-prompt:hover {
            border-color: var(--color-primary);
            background: rgba(25, 118, 210, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.15);
        }

        .trending-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .trending-text {
            font-size: 13px;
            color: var(--color-text-primary);
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .trending-grid {
                grid-template-columns: 1fr;
            }
            
            .trending-prompt {
                padding: 12px 14px;
            }
        }

        /* Suggestion Cards - CanaryAI Style */
        .suggestion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: var(--spacing-md);
            max-width: 800px;
            width: 100%;
            margin-top: var(--spacing-xl);
        }

        .suggestion-card {
            padding: var(--spacing-lg);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            text-align: left;
            box-shadow: var(--shadow-card);
        }

        .suggestion-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-card-hover);
            border-color: var(--color-primary);
        }

        .suggestion-icon {
            font-size: 24px;
            margin-bottom: var(--spacing-md);
        }

        .suggestion-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text);
        }

        .suggestion-desc {
            font-size: 13px;
            color: var(--color-text-secondary);
            line-height: 1.5;
        }

        /* Messages - CanaryAI Style */
        .message {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .user-avatar {
            background: var(--color-primary);
            color: white;
        }

        .ai-avatar {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
        }

        .message-content {
            flex: 1;
            max-width: 800px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .message-author {
            font-weight: 600;
            font-size: 14px;
        }

        .message-time {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .message-text {
            font-size: 15px;
            line-height: 1.6;
            color: var(--color-text);
        }

        .message-text p {
            margin-bottom: 12px;
        }

        .message-text ul, .message-text ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .message-text li {
            margin-bottom: 6px;
        }

        .message-text strong {
            font-weight: 600;
            color: var(--color-text);
        }

        /* Ensure images and HTML content render properly in messages */
        .message-text img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .message-text > div {
            width: 100%;
        }

        .message-text button {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px;
            background: var(--color-surface);
            border-radius: var(--radius-md);
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--color-text-secondary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Enhanced Typing Indicator Styles */
        .typing-indicator-enhanced {
            position: relative;
            overflow: hidden;
        }

        .typing-indicator-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmerEnhanced 2s infinite;
        }

        @keyframes shimmerEnhanced {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .typing-dots-enhanced {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .typing-dot-enhanced {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: typingBounceEnhanced 1.4s ease-in-out infinite;
        }

        @keyframes typingBounceEnhanced {
            0%, 60%, 100% { 
                transform: translateY(0) scale(1);
                opacity: 0.7;
            }
            30% { 
                transform: translateY(-12px) scale(1.2);
                opacity: 1;
            }
        }

        .typing-text-enhanced {
            font-size: 14px;
            letter-spacing: 0.3px;
            animation: fadeInPulse 1s ease-in-out infinite alternate;
        }

        @keyframes fadeInPulse {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        @keyframes slideInLeft {
            0% {
                opacity: 0;
                transform: translateX(-20px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Property Cards - CanaryAI Style */
        .property-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-top: var(--spacing-md);
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-card);
        }

        .property-card:hover {
            box-shadow: var(--shadow-card-hover);
            transform: translateY(-4px);
            border-color: var(--color-primary);
        }

        .property-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--color-bg-tertiary);
        }

        .property-details {
            padding: var(--spacing-lg);
        }

        .property-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--spacing-sm);
            letter-spacing: -0.02em;
        }

        .property-address {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: var(--spacing-sm);
        }

        .property-specs {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .property-spec {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .property-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        /* Property Status Badge - CanaryAI Style */
        .property-status-badge {
            position: absolute;
            top: var(--spacing-md);
            left: var(--spacing-md);
            background: var(--color-primary);
            color: white;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .property-status-badge.sold {
            background: var(--color-error);
        }

        .property-status-badge.pending {
            background: var(--color-warning);
        }

        /* Button Styles - CanaryAI Style */
        .btn-small {
            padding: 10px 18px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: var(--color-surface);
            color: var(--color-text);
            transition: all var(--transition-fast);
        }

        .btn-small:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            transform: translateY(-1px);
        }

        .btn-small.primary {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .btn-small.primary:hover {
            background: var(--color-primary-hover);
            border-color: var(--color-primary-hover);
        }

        .btn-small.secondary {
            background: var(--color-surface);
            color: var(--color-primary);
            border-color: var(--color-primary);
        }

        .btn-small.secondary:hover {
            background: var(--color-info-light);
        }

        /* Quick Replies - CanaryAI Style */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        .quick-reply-btn {
            padding: 10px 18px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-xs);
        }

        .quick-reply-btn:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .quick-reply-btn:active {
            transform: translateY(0);
        }

        /* Source Links - CanaryAI Style */
        .source-links {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .source-link {
            padding: 6px 14px;
            background: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 500;
            color: var(--color-primary);
            text-decoration: none;
            transition: all var(--transition-fast);
        }

        .source-link:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Input Area - CanaryAI Style */
        .input-area {
            padding: var(--spacing-lg) var(--spacing-xl);
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
            position: sticky;
            bottom: 0;
        }

        .input-container {
            display: flex;
            gap: var(--spacing-md);
            align-items: flex-end;
            max-width: 900px;
            margin: 0 auto;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            padding: 16px 130px 16px 20px;
            background: var(--color-bg-primary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-xl);
            font-size: 15px;
            font-family: var(--font-base);
            color: var(--color-text);
            resize: none;
            max-height: 200px;
            transition: all var(--transition-fast);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(25, 118, 210, 0.1);
            background: var(--color-surface);
        }

        .chat-input::placeholder {
            color: var(--color-text-muted);
        }

        .input-actions {
            position: absolute;
            right: 12px;
            bottom: 12px;
            display: flex;
            gap: 6px;
        }

        .input-icon-btn {
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            transition: all var(--transition-fast);
            font-size: 16px;
        }

        .input-icon-btn:hover {
            background: var(--color-bg-tertiary);
            color: var(--color-primary);
        }

        .send-btn {
            width: 48px;
            height: 48px;
            background: var(--color-primary);
            border: none;
            border-radius: var(--radius-lg);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all var(--transition-fast);
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.3);
        }

        .send-btn:hover {
            background: var(--color-primary-hover);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Autocomplete Suggestions - CanaryAI Style */
        .autocomplete-suggestions {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-sm);
            max-height: 300px;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            display: none;
            z-index: 100;
        }

        .autocomplete-suggestions.show {
            display: block;
            animation: slideUpFade 0.2s ease-out;
        }

        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .suggestion-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.active {
            background: var(--color-bg-primary);
            color: var(--color-primary);
        }

        .suggestion-icon {
            font-size: 18px;
            opacity: 0.7;
        }

        .suggestion-text {
            flex: 1;
            font-size: 14px;
            color: var(--color-text);
        }

        .suggestion-item:hover .suggestion-text,
        .suggestion-item.active .suggestion-text {
            color: var(--color-primary);
            font-weight: 500;
        }

        .suggestion-category {
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-secondary);
            background: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
        }

        /* Structured List Response Styles */
        .structured-list-response .item-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(51, 128, 141, 0.15) !important;
            border-color: rgba(51, 128, 141, 0.3) !important;
        }

        .structured-list-response .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
        }

        @media (max-width: 768px) {
            .structured-list-response .items-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        /* Voice Modal */


        .modal {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text);
            letter-spacing: -0.02em;
        }

        .modal-subtitle {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        /* Market Analysis Panel - CanaryAI Style */
        .market-analysis-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .market-analysis-panel.open {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .market-analysis-content {
            background: var(--color-surface);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            min-width: 800px;
            min-height: 600px;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .market-analysis-header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
            padding: var(--spacing-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .market-analysis-close {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            font-size: 20px;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .market-analysis-close:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        .market-analysis-body {
            padding: var(--spacing-xl);
        }

        @media (max-width: 768px) {
            .market-analysis-content {
                min-width: 95vw;
                min-height: 95vh;
                margin: 10px;
                border-radius: var(--radius-lg);
            }
        }

        .voice-visualizer {
            width: 100%;
            height: 100px;
            background: var(--color-bg-primary);
            border-radius: var(--radius-lg);
            margin: var(--spacing-lg) 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .voice-bar {
            width: 4px;
            background: var(--color-primary);
            border-radius: 2px;
            animation: voiceWave 1s infinite ease-in-out;
        }

        .voice-bar:nth-child(1) { height: 20px; animation-delay: 0s; }
        .voice-bar:nth-child(2) { height: 40px; animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { height: 60px; animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { height: 40px; animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { height: 20px; animation-delay: 0.4s; }

        @keyframes voiceWave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }

        .voice-controls {
            display: flex;
            gap: var(--spacing-md);
        }

        .voice-btn {
            flex: 1;
            padding: var(--spacing-md);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: var(--color-surface);
        }

        .voice-btn-primary {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .voice-btn-primary:hover {
            background: var(--color-primary-hover);
        }

        /* Responsive Design - CanaryAI Style */
        @media (max-width: 768px) {
            .hero-main-title {
                font-size: 24px;
            }

            .hero-badge {
                font-size: 11px;
                padding: 6px 16px;
            }

            .hero-description {
                font-size: 14px;
            }

            .hero-stats {
                font-size: 12px;
            }

            .stats-number {
                font-size: 14px;
            }

            .welcome-icon {
                width: 80px;
                height: 80px;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 999;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .suggestion-grid {
                grid-template-columns: 1fr;
            }

            .chat-header {
                padding: var(--spacing-md);
            }

            .chat-container {
                padding: var(--spacing-md);
            }

            .input-area {
                padding: var(--spacing-md);
            }
        }

        /* File Upload - CanaryAI Style */
        .file-upload-area {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-top: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload-area:hover {
            border-color: var(--color-primary);
            background: var(--color-bg-primary);
        }

        .file-preview {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .file-preview-item {
            padding: 8px 12px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .remove-file {
            cursor: pointer;
            color: var(--color-error);
        }

        /* Valuation Card Styles */
        .valuation-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin: 16px 0;
            border: 1px solid var(--color-border);
        }

        .valuation-header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: 24px;
        }

        .valuation-title {
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 8px 0;
        }

        .valuation-subtitle {
            font-size: 14px;
            opacity: 0.95;
            margin: 0;
        }

        .valuation-body {
            padding: 24px;
        }

        .valuation-section {
            margin-bottom: 28px;
        }

        .valuation-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            font-size: 18px;
        }

        /* Property Info Grid */
        .property-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            background: var(--color-bg-secondary);
            padding: 16px;
            border-radius: var(--radius-md);
        }

        .property-info-item {
            display: flex;
            flex-direction: column;
        }

        .property-info-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .property-info-value {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
        }

        /* Valuation Stats */
        .valuation-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: var(--color-bg-secondary);
            padding: 20px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }

        .stat-label {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .stat-sublabel {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .confidence-bar-container {
            margin-top: 8px;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: rgba(51, 128, 141, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-success) 100%);
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        /* Market Data */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .market-item {
            background: var(--color-bg-secondary);
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
        }

        .market-item-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 6px;
        }

        .market-item-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
        }

        /* Comparable Properties */
        .comparables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .comparable-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: 16px;
            transition: all 0.2s ease;
        }

        .comparable-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .comparable-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .comparable-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .comparable-similarity {
            font-size: 12px;
            background: var(--color-success);
            color: white;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-weight: 600;
        }

        .comparable-address {
            font-size: 13px;
            color: var(--color-text);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .comparable-specs {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .comparable-spec {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Metadata */
        .valuation-metadata {
            background: var(--color-bg-secondary);
            padding: 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--color-text-secondary);
            border: 1px solid var(--color-border);
        }

        .metadata-item {
            margin-bottom: 6px;
        }

        .metadata-item:last-child {
            margin-bottom: 0;
        }

        .metadata-label {
            font-weight: 600;
            color: var(--color-text);
        }

        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-high {
            background: rgba(39, 174, 96, 0.1);
            color: var(--color-success);
        }

        .badge-medium {
            background: rgba(243, 156, 18, 0.1);
            color: var(--color-warning);
        }

        .badge-low {
            background: rgba(231, 76, 60, 0.1);
            color: var(--color-error);
        }

        /* OpenAI Enhancement Badge - Hidden, keeping class for compatibility */
        .openai-badge {
            display: none;
        }

        .openai-badge::before {
            content: "";
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .message-content.openai-enhanced {
            /* Clean styling without golden accents */
            background: transparent;
            border-left: none;
            padding-left: 0;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .valuation-stats,
            .market-grid,
            .comparables-grid {
                grid-template-columns: 1fr;
            }

            .property-info-grid {
                grid-template-columns: 1fr;
            }

            .valuation-header {
                padding: 20px;
            }

            .valuation-body {
                padding: 20px;
            }

            .stat-value {
                font-size: 24px;
            }
        }

        /* Additional Animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(0.95);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        /* AI Analysis Side Panel - CanaryAI Style */
        .ai-analysis-panel {
            position: fixed;
            left: 0;
            top: 0;
            width: 420px;
            height: 100vh;
            background: var(--color-surface);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.12);
            transform: translateX(-100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .ai-analysis-panel.open {
            transform: translateX(0);
        }

        .ai-panel-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
        }

        .ai-panel-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.01em;
        }

        .ai-panel-close {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ai-panel-close:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg);
        }

        .ai-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
        }

        /* Property Details Side Panel (Right) - CanaryAI Style */
        .property-details-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: 480px;
            height: 100vh;
            background: var(--color-surface);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.12);
            transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .property-details-panel.open {
            transform: translateX(0);
        }

        .property-panel-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
        }

        .property-panel-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.01em;
        }

        .property-panel-close {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .property-panel-close:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .property-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .property-detail-image-section {
            width: 100%;
            height: 280px;
            background: var(--color-bg-primary);
            position: relative;
            overflow: hidden;
        }

        .property-detail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .property-detail-price-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 24px;
            font-weight: 700;
            backdrop-filter: blur(10px);
        }

        .property-detail-content {
            padding: 24px;
        }

        .property-detail-address {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .property-detail-mls {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 20px;
        }

        .property-detail-specs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--color-bg-primary);
            border-radius: var(--radius-md);
        }

        .property-spec-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .property-spec-icon {
            font-size: 20px;
        }

        .property-spec-label {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .property-spec-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
        }

        .property-detail-description {
            margin-bottom: 24px;
            padding: 16px;
            background: var(--color-bg-primary);
            border-radius: var(--radius-md);
            color: var(--color-text);
            line-height: 1.6;
        }

        .property-detail-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--color-border);
        }

        .property-detail-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .property-loading-spinner {
            font-size: 48px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .ai-analyzing {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .ai-analyzing-icon {
            font-size: 48px;
            animation: pulse 1.5s ease-in-out infinite;
            margin-bottom: 20px;
        }

        .ai-analyzing-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 24px;
        }

        .ai-analyzing-sources {
            width: 100%;
            max-width: 400px;
        }

        .ai-source-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            animation: shimmer 2s linear infinite;
            background: linear-gradient(90deg, 
                var(--color-bg-secondary) 0%, 
                rgba(51, 128, 141, 0.1) 50%, 
                var(--color-bg-secondary) 100%);
            background-size: 2000px 100%;
        }

        .ai-source-icon {
            font-size: 20px;
        }

        .ai-source-text {
            flex: 1;
            font-size: 14px;
            color: var(--color-text);
        }

        .ai-source-status {
            font-size: 12px;
            color: var(--color-success);
        }

        /* Property Search Grid - CanaryAI Style */
        .property-search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }

        .property-search-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-card);
            position: relative;
        }

        .property-search-card:hover {
            box-shadow: var(--shadow-card-hover);
            transform: translateY(-6px);
            border-color: var(--color-primary);
        }

        .property-image-container {
            width: 100%;
            height: 180px;
            overflow: hidden;
            background: var(--color-bg-tertiary);
            position: relative;
        }

        .property-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-slow);
        }

        .property-search-card:hover .property-image-container img {
            transform: scale(1.05);
        }

        /* Image Navigation Arrows */
        .image-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            opacity: 0;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .image-nav-btn:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .image-nav-btn.prev {
            left: 8px;
        }

        .image-nav-btn.next {
            right: 8px;
        }

        .property-image-container:hover .image-nav-btn {
            opacity: 1;
        }

        /* Image Counter Badge */
        .image-counter-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            z-index: 5;
        }

        .property-no-image {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--color-text-muted);
            height: 100%;
        }

        .loading-address {
            color: var(--color-text-secondary);
            font-style: italic;
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Property Card Content - CanaryAI Style */
        .property-card-content {
            padding: var(--spacing-lg);
        }

        .property-card-status {
            position: absolute;
            top: var(--spacing-md);
            left: var(--spacing-md);
            background: var(--color-primary);
            color: white;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: var(--radius-sm);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .property-card-price {
            font-size: 22px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--spacing-sm);
            letter-spacing: -0.02em;
        }

        .property-card-address {
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 4px;
            line-height: 1.3;
        }

        .property-card-city {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .property-card-specs {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-md);
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .property-card-spec {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .property-card-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--color-border-light);
        }

        .property-card-actions .btn-small {
            flex: 1;
            justify-content: center;
        }

        /* Primary action button - CanaryAI style */
        .btn-property-report {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            flex: 1;
        }

        .btn-property-report:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        /* Secondary action button - CanaryAI style */
        .btn-view-details {
            background: var(--color-surface);
            color: var(--color-primary);
            border: 2px solid var(--color-primary);
            padding: 10px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            flex: 1;
        }

        .btn-view-details:hover {
            background: var(--color-info-light);
        }

        /* Button Styles - CanaryAI Style */
        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary {
            background: var(--color-bg-secondary);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-border);
        }

        /* Carousel Controls */
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .carousel-btn:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .carousel-btn.prev {
            left: 12px;
        }

        .carousel-btn.next {
            right: 12px;
        }

        .image-counter {
            position: absolute;
            bottom: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }

        .property-image-carousel {
            position: relative;
        }

        /* File Upload Styles */
        .file-upload-zone {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            padding: 32px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-zone:hover {
            border-color: var(--color-primary);
            background: var(--color-bg-secondary);
        }

        .upload-btn {
            padding: 12px 24px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-top: 16px;
            transition: all 0.2s ease;
        }

        .upload-btn:hover {
            background: var(--color-primary-hover);
        }

        /* Property Details Modal Styles */
        .property-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .property-details-content {
            background: var(--color-bg-primary);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
        }

        .modal-close-btn:hover {
            background: rgba(0, 0, 0, 0.7);
            transform: scale(1.1);
        }

        .property-loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text);
        }

        .property-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .property-details-body {
            padding: 24px;
        }

        /* Property Carousel Styles */
        .property-carousel {
            position: relative;
            margin-bottom: 24px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--color-bg-secondary);
        }

        .carousel-main {
            position: relative;
            width: 100%;
            height: 400px;
            background: var(--color-bg-secondary);
        }

        .carousel-main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 5;
        }

        .carousel-nav:hover {
            background: rgba(0, 0, 0, 0.8);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-nav.prev {
            left: 16px;
        }

        .carousel-nav.next {
            right: 16px;
        }

        .carousel-counter {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .carousel-thumbnails {
            display: flex;
            gap: 8px;
            padding: 12px;
            overflow-x: auto;
            background: var(--color-bg-primary);
        }

        .carousel-thumbnails::-webkit-scrollbar {
            height: 6px;
        }

        .carousel-thumbnails::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 3px;
        }

        .carousel-thumb {
            flex-shrink: 0;
            width: 80px;
            height: 60px;
            border-radius: var(--radius-md);
            cursor: pointer;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .carousel-thumb:hover {
            border-color: var(--color-primary);
            transform: scale(1.05);
        }

        .carousel-thumb.active {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(var(--color-primary-rgb), 0.2);
        }

        .carousel-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Property Details Layout */
        .property-header {
            margin-bottom: 20px;
        }

        .property-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 12px;
        }

        .property-price-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .property-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .detail-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .detail-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
        }

        .property-section {
            margin-bottom: 24px;
        }

        .section-header {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-border);
        }

        .property-description {
            color: var(--color-text);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .features-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .features-list li {
            padding: 8px 12px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            color: var(--color-text);
            font-size: 14px;
        }

        .info-grid {
            display: grid;
            gap: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
        }

        .info-label {
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .info-value {
            color: var(--color-text);
            font-weight: 500;
        }

        .property-actions-bar {
            display: flex;
            gap: 8px;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .property-actions-bar button {
            flex: 1;
            min-width: 110px;
            font-size: 13px;
            padding: 10px 12px;
        }

        .property-detail-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .property-detail-actions button {
            flex: 1;
            min-width: 140px;
        }

        /* AI Sidebar Insight Sections */
        .insight-section {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }

        .insight-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-title .icon {
            font-size: 18px;
        }

        .estimated-value-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .estimated-value-card .label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .estimated-value-card .value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .estimated-value-card .range {
            font-size: 14px;
            opacity: 0.85;
        }

        /* ==================== ENHANCED SCHOOL LISTINGS - CanaryAI Style ==================== */
        
        .schools-list {
            max-height: 450px;
            overflow-y: auto;
            padding: 4px;
        }

        .school-card {
            padding: 16px;
            margin: 10px 0;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            background: var(--color-bg-primary);
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .school-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
            transform: translateY(-2px);
        }

        .school-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--color-text);
            margin-bottom: 8px;
        }

        .school-type {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            background: rgba(25, 118, 210, 0.1);
            color: var(--color-primary);
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 500;
            margin-right: 8px;
        }

        .school-rating {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
        }

        .school-distance {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .school-programs {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 8px;
        }

        .program-tag {
            display: inline-block;
            padding: 3px 8px;
            background: var(--color-bg-tertiary);
            border-radius: var(--radius-sm);
            margin-right: 6px;
            margin-top: 4px;
            font-size: 11px;
            color: var(--color-text-secondary);
        }

        .schools-loading {
            text-align: center;
            padding: 24px;
            color: var(--color-text-secondary);
        }

        .schools-error {
            color: #d32f2f;
            background: #ffebee;
            padding: 16px;
            border-radius: var(--radius-md);
            margin: 10px 0;
            font-size: 13px;
        }

        .schools-metadata {
            font-size: 11px;
            color: var(--color-text-muted);
            margin-bottom: 12px;
            text-align: center;
            padding: 8px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-sm);
        }

        .hidden {
            display: none !important;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .schools-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: var(--color-bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }

        .schools-header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 20px;
        }

        .schools-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .schools-subtitle {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 20px;
        }

        .school-item {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .school-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-primary);
        }

        .school-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
        }

        .school-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .school-name {
            font-weight: 700;
            color: var(--color-text);
            font-size: 16px;
            line-height: 1.3;
            margin-bottom: 4px;
        }

        .school-type {
            font-size: 12px;
            color: var(--color-primary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .school-rating {
            background: linear-gradient(135deg, var(--color-success) 0%, #28a745 100%);
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .school-rating.high {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .school-rating.medium {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .school-rating.low {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .school-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .school-address {
            font-size: 13px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .school-level {
            font-size: 13px;
            color: var(--color-text);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .school-features {
            margin-top: 12px;
        }

        .school-features-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .school-features-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .school-feature-tag {
            background: var(--color-bg-primary);
            color: var(--color-primary);
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 11px;
            font-weight: 600;
            border: 1px solid rgba(51, 128, 141, 0.2);
        }

        .school-distance {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(51, 128, 141, 0.1);
            color: var(--color-primary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 600;
        }

        .school-actions {
            margin-top: 16px;
            display: flex;
            gap: 8px;
        }

        .school-btn {
            background: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            padding: 8px 16px;
            border-radius: var(--radius-md);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .school-btn:hover {
            background: var(--color-primary);
            color: white;
            transform: translateY(-1px);
        }

        .school-btn.primary {
            background: var(--color-primary);
            color: white;
        }

        .school-btn.primary:hover {
            background: var(--color-primary-hover);
        }

        /* Accessibility Enhancements */
        .school-item[role="article"] {
            outline: none;
        }

        .school-item:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .schools-container {
                grid-template-columns: 1fr;
                padding: 16px;
                gap: 16px;
            }

            .school-item {
                padding: 16px;
            }

            .school-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .school-rating {
                align-self: flex-start;
            }

            .schools-title {
                font-size: 20px;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .school-item {
                background: var(--color-surface);
                border-color: var(--color-border);
            }

            .school-feature-tag {
                background: rgba(51, 128, 141, 0.2);
                color: var(--color-primary);
            }
        }

        /* ==================== MARKET ANALYSIS STYLES (FEATURE 2) ==================== */
        
        .market-analysis-container {
            background: #f0f8ff;
            border-left: 4px solid #1976d2;
            padding: 20px;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
        }

        .market-analysis-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .market-analysis-title {
            font-size: 18px;
            font-weight: 700;
            color: #1976d2;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .market-analysis-subtitle {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: 16px;
        }

        .market-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .market-stat-item {
            background: var(--color-surface);
            border: 1px solid rgba(25, 118, 210, 0.2);
            border-radius: var(--radius-md);
            padding: 12px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .market-stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: #1976d2;
        }

        .market-stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #1976d2;
            margin-bottom: 4px;
        }

        .market-stat-label {
            font-size: 11px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .market-analysis-text {
            background: rgba(25, 118, 210, 0.05);
            padding: 16px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(25, 118, 210, 0.1);
            margin-bottom: 20px;
        }

        .market-analysis-text p {
            font-size: 14px;
            line-height: 1.5;
            color: var(--color-text);
            margin: 0;
        }

        .market-graphs-container {
            margin-top: 20px;
        }

        .market-graphs-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .market-graphs-title {
            font-size: 16px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 8px;
        }

        .market-graphs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .market-graph-item {
            background: var(--color-surface);
            border: 1px solid rgba(25, 118, 210, 0.2);
            border-radius: var(--radius-md);
            padding: 16px;
            position: relative;
        }

        .market-graph-title {
            font-size: 14px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 8px;
            text-align: center;
        }

        .market-graph-subtitle {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-align: center;
            margin-bottom: 12px;
        }

        .market-chart-container {
            width: 100%;
            height: 250px;
            position: relative;
        }

        .market-loading {
            text-align: center;
            padding: 20px;
            color: #1976d2;
        }

        .market-error {
            color: #d32f2f;
            background: #ffebee;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            text-align: center;
        }

        .market-metadata {
            font-size: 10px;
            color: #999;
            text-align: center;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(25, 118, 210, 0.1);
        }

        /* Mobile Responsive for Market Analysis */
        @media (max-width: 768px) {
            .market-stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .market-graphs-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .market-analysis-container {
                padding: 16px;
            }

            .market-chart-container {
                height: 200px;
            }
        }

        /* ==================== UNIFIED PROPERTY MODAL SYSTEM ==================== */
        
        .unified-property-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }



        /* ==================== COMPREHENSIVE AMENITY SYSTEM ==================== */
        
        .amenity-response {
            width: 100%;
            max-width: 100%;
        }

        .amenity-header {
            text-align: center;
            margin-bottom: 32px;
            padding: 24px;
            background: linear-gradient(135deg, var(--color-bg-primary) 0%, var(--color-bg-secondary) 100%);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }

        .amenity-header h2 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: var(--color-text);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .amenity-header p {
            font-size: 16px;
            color: var(--color-text-secondary);
            margin: 0 0 16px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .amenity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
            margin-top: 16px;
        }

        .amenity-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            cursor: pointer;
        }

        .amenity-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(51, 128, 141, 0.15);
            border-color: rgba(51, 128, 141, 0.3);
        }

        .amenity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .amenity-card:hover::before {
            opacity: 1;
        }

        .amenity-card-header {
            margin-bottom: 16px;
        }

        .amenity-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .amenity-type {
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .amenity-rating {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 600;
            background: rgba(51, 128, 141, 0.1);
            color: var(--color-primary);
            border: 1px solid rgba(51, 128, 141, 0.2);
        }

        .amenity-rating.high {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
            border-color: rgba(34, 197, 94, 0.2);
        }

        .amenity-rating.medium {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
            border-color: rgba(245, 158, 11, 0.2);
        }

        .amenity-rating.low {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border-color: rgba(239, 68, 68, 0.2);
        }

        .amenity-details {
            margin-bottom: 20px;
        }

        .amenity-address {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .amenity-level {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 500;
            margin-bottom: 12px;
            padding: 6px 12px;
            background: var(--color-bg-primary);
            border-radius: var(--radius-md);
            width: fit-content;
        }

        .amenity-special {
            font-size: 14px;
            color: var(--color-text);
            line-height: 1.5;
            background: var(--color-bg-secondary);
            padding: 12px;
            border-radius: var(--radius-md);
            border-left: 3px solid var(--color-primary);
        }

        .amenity-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .amenity-btn {
            padding: 10px 16px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            background: transparent;
            color: var(--color-text);
            transition: all 0.2s ease;
            flex: 1;
        }

        .amenity-btn:hover {
            background: var(--color-bg-primary);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .amenity-btn.primary {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .amenity-btn.primary:hover {
            background: var(--color-primary-hover);
            border-color: var(--color-primary-hover);
            color: white;
        }

        /* Mobile Responsive for Amenities */
        @media (max-width: 768px) {
            .amenity-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .amenity-card {
                padding: 20px;
            }

            .amenity-header {
                padding: 20px;
                margin-bottom: 24px;
            }

            .amenity-header h2 {
                font-size: 24px;
            }

            .amenity-actions {
                flex-direction: column;
            }

            .amenity-btn {
                padding: 12px 16px;
            }
        }

        /* Accessibility Enhancements for Amenities */
        .amenity-card[role="article"] {
            outline: none;
        }

        .amenity-card:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }

        /* ==================== END COMPREHENSIVE AMENITY SYSTEM ==================== */
        

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .metric-value {
            font-weight: 600;
            color: var(--color-text);
            font-size: 14px;
        }

        .metric-value.positive {
            color: #10b981;
        }

        .metric-value.negative {
            color: #ef4444;
        }

        .pros-cons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .pros-list, .cons-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .pros-list li {
            padding: 8px;
            margin-bottom: 6px;
            color: var(--color-text);
            font-size: 13px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .pros-list li::before {
            content: "";
            color: #10b981;
            font-weight: bold;
            flex-shrink: 0;
        }

        .cons-list li {
            padding: 8px;
            margin-bottom: 6px;
            color: var(--color-text);
            font-size: 13px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .cons-list li::before {
            content: "";
            color: #ef4444;
            font-weight: bold;
            flex-shrink: 0;
        }

        .data-sources-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
        }

        #sourcesToggle {
            background: none;
            border: none;
            color: var(--color-primary);
            cursor: pointer;
            padding: 8px 0;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        #sourcesToggle:hover {
            color: var(--color-primary-hover);
        }

        #sourcesContent {
            margin-top: 12px;
        }

        .source-item {
            padding: 10px;
            background: var(--color-bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: 8px;
            border-left: 3px solid var(--color-primary);
        }

        .source-title {
            font-weight: 600;
            color: var(--color-text);
            font-size: 13px;
            margin-bottom: 4px;
        }

        .source-url {
            font-size: 12px;
            color: var(--color-primary);
            text-decoration: none;
            word-break: break-all;
        }

        .source-url:hover {
            text-decoration: underline;
        }

        .source-type {
            display: inline-block;
            background: var(--color-primary);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Responsive Styles for Modal */
        @media (max-width: 768px) {
            .property-details-modal {
                padding: 0;
            }

            .property-details-content {
                max-height: 100vh;
                border-radius: 0;
                max-width: 100%;
            }

            .carousel-main {
                height: 300px;
            }

            .property-details-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .pros-cons-grid {
                grid-template-columns: 1fr;
            }

            .property-actions-bar {
                flex-direction: column;
            }
        }

        /* ==================== ENHANCED SIDEBAR STYLES ==================== */
        
        /* City Selector */
        .filter-group {
            margin-bottom: 24px;
        }

        .filter-group-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .custom-select-wrapper {
            position: relative;
        }

        .custom-select {
            width: 100%;
            padding: 12px 40px 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--color-text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .custom-select:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--color-primary);
            transform: translateY(-1px);
        }

        .custom-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(51, 128, 141, 0.1);
        }

        .custom-select option {
            background: var(--color-surface);
            color: var(--color-text);
            padding: 12px;
        }

        .select-arrow {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--color-text-secondary);
            font-size: 10px;
            transition: all 0.3s ease;
        }

        .custom-select:hover + .select-arrow {
            color: var(--color-primary);
        }

        /* Quick Actions Grid */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 14px;
            font-weight: 500;
            text-align: left;
        }

        .action-btn:hover {
            background: rgba(51, 128, 141, 0.15);
            border-color: var(--color-primary);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 16px rgba(51, 128, 141, 0.2);
        }

        .action-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .action-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .action-label {
            flex: 1;
            font-weight: 500;
        }

        /* Filter Pills */
        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-pill {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: var(--color-text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }

        .filter-pill:hover {
            background: rgba(51, 128, 141, 0.2);
            border-color: var(--color-primary);
            transform: translateY(-1px);
        }

        .filter-pill.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(51, 128, 141, 0.3);
        }

        /* Apply Filters Button */
        .apply-filters-btn {
            width: 100%;
            padding: 14px 20px;
            margin-top: 20px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(51, 128, 141, 0.3);
        }

        .apply-filters-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(51, 128, 141, 0.4);
        }

        .apply-filters-btn:active {
            transform: translateY(0);
        }

        /* Clear Filters Button */
        .clear-filters-btn {
            width: 100%;
            padding: 12px 20px;
            margin-top: 12px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--color-text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-filters-btn:hover {
            background: rgba(192, 21, 47, 0.1);
            border-color: var(--color-error);
            color: var(--color-error);
        }

        /* Sidebar Content Scrollbar */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(51, 128, 141, 0.3);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: rgba(51, 128, 141, 0.5);
        }

        /* Selected City Badge */
        .selected-city-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover));
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Active Filter Count Badge */
        .filter-count-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: var(--color-primary);
            color: white;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 700;
            margin-left: auto;
        }

        /* ==================== END ENHANCED SIDEBAR STYLES ==================== */

        /* ==================== PROPERTY ANALYSIS ENHANCEMENT STYLES ==================== */
        .property-analysis-container {
            transition: all 0.3s ease;
            border: 1px solid rgba(51, 128, 141, 0.1);
        }

        .property-analysis-container:hover {
            box-shadow: 0 8px 32px rgba(51, 128, 141, 0.15);
            transform: translateY(-2px);
        }

        .analysis-header {
            position: relative;
            overflow: hidden;
        }

        .analysis-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .property-analysis-container:hover .analysis-header::before {
            transform: translateX(100%);
        }

        .warning-section {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Analysis metrics styling */
        .analysis-metric {
            display: inline-block;
            background: linear-gradient(135deg, rgba(25, 118, 210, 0.1), rgba(25, 118, 210, 0.05));
            border: 1px solid rgba(25, 118, 210, 0.2);
            padding: 8px 12px;
            border-radius: 20px;
            margin: 4px;
            font-size: 14px;
            font-weight: 600;
            color: #1976D2;
            transition: all 0.3s ease;
        }

        .analysis-metric:hover {
            background: #1976D2;
            color: white;
            transform: scale(1.05);
        }

        /* Confidence badge */
        .confidence-badge {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3); }
            50% { box-shadow: 0 4px 16px rgba(39, 174, 96, 0.5); }
            100% { box-shadow: 0 2px 8px rgba(39, 174, 96, 0.3); }
        }

        /* ==================== END PROPERTY ANALYSIS ENHANCEMENT STYLES ==================== */

        /* ==================== MODAL STYLES ==================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }

        .modal-body {
            padding: 24px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        /* ==================== END MODAL STYLES ==================== */

        /* ==================== MARKET STATS LOADING ANIMATION ==================== */
        
        .market-stats-loader {
            background: linear-gradient(135deg, var(--color-surface) 0%, var(--color-bg-secondary) 100%);
            border-radius: var(--radius-lg);
            padding: 32px;
            margin: 20px 0;
            box-shadow: var(--shadow-lg);
            animation: fadeInUp 0.4s ease-out;
            overflow: hidden;
            position: relative;
        }

        .market-stats-loader::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(51, 128, 141, 0.1), transparent);
            animation: shimmer 2s infinite;
        }

        .loader-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .loader-icon {
            font-size: 32px;
            animation: pulse 2s ease-in-out infinite;
        }

        .loader-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text);
        }

        .loader-subtitle {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }

        .market-insight-carousel {
            background: white;
            border-radius: var(--radius-md);
            padding: 20px;
            margin: 20px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .market-insight {
            font-size: 16px;
            line-height: 1.6;
            color: var(--color-text);
            text-align: center;
            animation: fadeInScale 0.6s ease-out;
            opacity: 0;
            animation-fill-mode: forwards;
        }

        .market-insight.active {
            opacity: 1;
        }

        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .market-insight strong {
            color: var(--color-primary);
            font-weight: 600;
        }

        .loading-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .loading-stat-card {
            background: white;
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .loading-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(51, 128, 141, 0.05), transparent);
            animation: shimmer 2s infinite;
            animation-delay: calc(var(--delay) * 0.2s);
        }

        .loading-stat-card:nth-child(1) { --delay: 0; }
        .loading-stat-card:nth-child(2) { --delay: 1; }
        .loading-stat-card:nth-child(3) { --delay: 2; }
        .loading-stat-card:nth-child(4) { --delay: 3; }

        .loading-stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .loading-stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .loading-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-primary);
            font-variant-numeric: tabular-nums;
        }

        .loading-progress-bar {
            height: 4px;
            background: rgba(51, 128, 141, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 24px;
        }

        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-primary-hover));
            border-radius: 2px;
            animation: progressFill 3s ease-in-out forwards;
        }

        @keyframes progressFill {
            0% { width: 0%; }
            50% { width: 60%; }
            100% { width: 85%; }
        }

        .loading-status-text {
            text-align: center;
            margin-top: 12px;
            font-size: 13px;
            color: var(--color-text-secondary);
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Property Results Fade In */
        .property-search-grid {
            animation: fadeInUp 0.5s ease-out;
        }

        .property-search-card {
            animation: slideInCard 0.4s ease-out backwards;
            animation-delay: calc(var(--index) * 0.05s);
        }

        @keyframes slideInCard {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Smooth transition between loading and results */
        .message-content {
            position: relative;
        }

        .results-container {
            animation: fadeIn 0.6s ease-out;
        }

        /* ==================== END MARKET STATS LOADING ANIMATION ==================== */
    </style>
</head>
<body>
    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    
    <div class="app-container">
        <!-- Left Sidebar - Chat History -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <img src="summitly_logo.webp" alt="Summitly">
                    </div>
                    <span>Summitly AI</span>
                </div>
                <button class="icon-btn sidebar-close-btn" onclick="toggleSidebar()" title="Close Sidebar"></button>
            </div>
            <div style="padding: 0 20px 12px 20px;">
                <button class="new-chat-btn" onclick="startNewChat()">
                    <span></span>
                    <span>New Conversation</span>
                </button>
            </div>

            <div class="sidebar-content">
                <!-- Chat History Section -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span></span>
                        <span>CHAT HISTORY</span>
                    </div>
                    <div class="chat-history-list" id="chatHistoryList">
                        <!-- Chat sessions will be populated here -->
                        <div class="chat-history-empty" id="chatHistoryEmpty">
                            <p style="color: var(--color-text-secondary); font-size: 13px; text-align: center; padding: 20px;">
                                No previous conversations yet.<br>Start a new chat to begin!
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Today's Chats -->
                <div class="filter-group" id="todayChatsSection" style="display: none;">
                    <div class="filter-group-title">
                        <span></span>
                        <span>TODAY</span>
                    </div>
                    <div class="chat-session-list" id="todayChatsList"></div>
                </div>

                <!-- Previous Chats -->
                <div class="filter-group" id="previousChatsSection" style="display: none;">
                    <div class="filter-group-title">
                        <span></span>
                        <span>PREVIOUS</span>
                    </div>
                    <div class="chat-session-list" id="previousChatsList"></div>
                </div>

                <!-- Quick Filters (Collapsed) -->
                <div class="filter-group">
                    <div class="filter-group-title" onclick="toggleQuickFilters()" style="cursor: pointer;">
                        <span></span>
                        <span>QUICK FILTERS</span>
                        <span id="filterToggleIcon" style="margin-left: auto;"></span>
                    </div>
                    <div class="quick-filters-content" id="quickFiltersContent" style="display: none;">
                        <!-- City Selector -->
                        <div class="custom-select-wrapper" style="margin-bottom: 12px;">
                            <select id="citySelector" class="custom-select" onchange="handleCityChange(this.value)">
                                <option value="">Choose a city...</option>
                                <option value="Toronto">Toronto</option>
                                <option value="Mississauga">Mississauga</option>
                                <option value="Brampton">Brampton</option>
                                <option value="Oakville">Oakville</option>
                                <option value="Burlington">Burlington</option>
                                <option value="Hamilton">Hamilton</option>
                                <option value="Ottawa">Ottawa</option>
                                <option value="Kingston">Kingston</option>
                                <option value="London">London</option>
                                <option value="Kitchener">Kitchener</option>
                                <option value="Waterloo">Waterloo</option>
                                <option value="Guelph">Guelph</option>
                                <option value="Windsor">Windsor</option>
                            </select>
                            <span class="select-arrow"></span>
                        </div>
                        <div id="selectedCityBadge"></div>
                        
                        <!-- Property Type Pills -->
                        <div class="filter-pills" style="margin-top: 8px;">
                            <button class="filter-pill" onclick="handleFilterClick('propertyType', 'Condo', this)">Condo</button>
                            <button class="filter-pill" onclick="handleFilterClick('propertyType', 'House', this)">House</button>
                            <button class="filter-pill" onclick="handleFilterClick('propertyType', 'Townhouse', this)">Townhouse</button>
                        </div>
                        
                        <!-- Price Pills -->
                        <div class="filter-pills" style="margin-top: 8px;">
                            <button class="filter-pill" onclick="handleFilterClick('priceRange', 'under500k', this)">< $500K</button>
                            <button class="filter-pill" onclick="handleFilterClick('priceRange', '500k-1m', this)">$500K-$1M</button>
                            <button class="filter-pill" onclick="handleFilterClick('priceRange', 'over1m', this)">$1M+</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="chat-header">
                <div class="header-left">
                    <button class="icon-btn" onclick="toggleSidebar()"></button>
                    <div class="status-badge">
                        <div class="status-dot"></div>
                        <span>Llama 3.2 + Exa AI Active</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleRightPanel()" title="Toggle Properties Panel" id="propertyPanelBtn"></button>
                </div>
            </header>

            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon animated-icon">
                        <img src="summitly_logo.webp" alt="Summitly Logo" onerror="this.style.display='none'; console.error('Logo failed to load from:', this.src);">
                    </div>
                    <div class="hero-badge">Canada's #1 place to buy, sell, and rent</div>
                    <h1 class="hero-main-title" id="welcomeTitle">
                        Welcome to Your AI Real Estate Assistant
                    </h1>
                    <p class="hero-description">
                        Find homes you'll love with fast search, real photos, and trusted data.
                    </p>
                    <div class="hero-stats">
                        Search <span class="stats-number">336,092</span> listings from trusted REALTORS
                    </div>
                    
                    <!-- Trending Prompts Section -->
                    <div class="trending-prompts" id="trendingPromptsSection">
                        <div class="trending-title"> Popular searches</div>
                        <div class="trending-grid">
                            <button class="trending-prompt" onclick="sendMessage('Show me 2-bedroom condos in Toronto under $700K')">
                                <span class="trending-icon"></span>
                                <span class="trending-text">2BR condos in Toronto under $700K</span>
                            </button>
                            <button class="trending-prompt" onclick="sendMessage('Find houses with 3+ bedrooms in Mississauga')">
                                <span class="trending-icon"></span>
                                <span class="trending-text">3+ BR houses in Mississauga</span>
                            </button>
                            <button class="trending-prompt" onclick="sendMessage('What are the best neighborhoods in Ottawa for families?')">
                                <span class="trending-icon"></span>
                                <span class="trending-text">Family neighborhoods in Ottawa</span>
                            </button>
                            <button class="trending-prompt" onclick="sendMessage('Show me luxury homes over $2M in Vancouver')">
                                <span class="trending-icon"></span>
                                <span class="trending-text">Luxury homes in Vancouver</span>
                            </button>
                            <button class="trending-prompt" onclick="sendMessage('Compare real estate market trends: Toronto vs Calgary')">
                                <span class="trending-icon"></span>
                                <span class="trending-text">Toronto vs Calgary market</span>
                            </button>
                            <button class="trending-prompt" onclick="sendMessage('Find townhouses near good schools in Oakville')">
                                <span class="trending-icon"></span>
                                <span class="trending-text">Townhouses near schools in Oakville</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <!-- Autocomplete Suggestions -->
                        <div class="autocomplete-suggestions" id="autocompleteSuggestions"></div>
                        
                        <textarea 
                            class="chat-input" 
                            id="chatInput" 
                            placeholder="Ask about properties, market trends, neighborhoods, or anything real estate..."
                            rows="1"
                            onkeydown="handleKeyPress(event)"
                            oninput="handleInputChange(event)"
                        ></textarea>
                        <div class="input-actions">
                            <button class="input-icon-btn" onclick="uploadFile()" title="Upload Image/Video"></button>
                            <button class="input-icon-btn" onclick="showVoiceDisabled()" title="Voice Input (Coming Soon)"></button>
                            <button class="input-icon-btn" onclick="showFileUpload()" title="Attach File"></button>
                        </div>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendUserMessage()">
                        
                    </button>
                </div>
            </div>
        </main>

        <!-- Right Panel - Property Results -->
        <aside class="right-panel" id="rightPanel">
            <div class="right-panel-header">
                <h2 class="right-panel-title">
                    <span></span>
                    <span>Properties</span>
                </h2>
                <button class="icon-btn" onclick="toggleRightPanel()" title="Close Panel"></button>
            </div>
            <div class="right-panel-content" id="rightPanelContent">
                <!-- Empty State -->
                <div class="right-panel-empty" id="rightPanelEmpty">
                    <div style="text-align: center; padding: 40px 20px; color: var(--color-text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: var(--color-text);">No Properties Yet</h3>
                        <p style="font-size: 13px; line-height: 1.5;">
                            Search for properties in the chat to see results here.
                        </p>
                        <div style="margin-top: 20px;">
                            <button class="btn-small btn-primary" onclick="sendMessage('Show me condos in Toronto under $700k')" style="padding: 10px 16px;">
                                 Try a Search
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Property Cards Container -->
                <div class="property-cards-container" id="propertyCardsContainer" style="display: none;">
                    <!-- Property cards will be dynamically added here -->
                </div>
                
                <!-- Property Details Section (shown when a property is selected) -->
                <div class="property-details-section" id="propertyDetailsSection" style="display: none;">
                    <!-- Property details will be shown here -->
                </div>
            </div>
        </aside>
    </div>

    <!-- Welcome Name Collection Modal -->
    <div class="modal-overlay" id="welcomeModal" style="display: flex;">
        <div class="modal" style="max-width: 450px; width: 90%; text-align: center; margin: auto;">
            <div class="modal-body" style="padding: 32px 24px;">
                <!-- Logo -->
                <div style="margin-bottom: 24px;">
                    <img src="summitly_logo.webp" alt="Summitly Logo" 
                         style="width: 100px; height: 100px; object-fit: contain; filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));"
                         onerror="this.style.display='none';">
                </div>
                
                <!-- Title -->
                <h2 class="modal-title" style="font-size: 28px; font-weight: 700; color: #1a1a1a; margin-bottom: 12px;">
                    Welcome to Summitly AI!
                </h2>
                
                <!-- Description -->
                <p style="margin-bottom: 28px; color: #64748b; font-size: 16px; line-height: 1.5;">
                    Your AI-powered real estate assistant is ready to help you find the perfect property.
                </p>
                
                <!-- Name Input -->
                <div style="margin: 24px 0;">
                    <label for="userName" style="display: block; margin-bottom: 10px; font-weight: 600; color: #1a1a1a; font-size: 15px;">
                        What's your name?
                    </label>
                    <input type="text" id="userName" placeholder="Enter your name..." 
                           style="width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 16px; text-align: center; transition: border-color 0.3s ease;"
                           onkeypress="if(event.key==='Enter') saveUserName()"
                           onfocus="this.style.borderColor='#1976D2'"
                           onblur="this.style.borderColor='#e2e8f0'">
                </div>
                
                <!-- Get Started Button -->
                <button onclick="saveUserName()" 
                        style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; padding: 14px 40px; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; width: 100%; margin-top: 8px;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(25, 118, 210, 0.4)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    Get Started 
                </button>
            </div>
        </div>
    </div>

    <!-- Voice Modal (Disabled) -->
    <div class="modal-overlay" id="voiceModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Voice Conversation</h2>
                <p class="modal-subtitle">Speak naturally - I'm listening</p>
            </div>
            <div class="voice-visualizer" id="voiceVisualizer">
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
            </div>
            <div class="voice-controls">
                <button class="voice-btn" onclick="closeVoiceModal()">Cancel</button>
                <button class="voice-btn voice-btn-primary" onclick="toggleVoiceRecording()"> Start Recording</button>
            </div>
        </div>
    </div>

    <!-- Market Analysis Center Panel -->
    <div class="market-analysis-panel" id="marketAnalysisPanel">
        <div class="market-analysis-content">
            <div class="market-analysis-header">
                <div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 700;"> Market Analysis</h2>
                    <p style="margin: 4px 0 0 0; font-size: 14px; opacity: 0.9;" id="marketAnalysisSubtitle">Loading market data...</p>
                </div>
                <button class="market-analysis-close" onclick="closeMarketAnalysisPanel()"></button>
            </div>
            <div class="market-analysis-body" id="marketAnalysisBody">
                <!-- Content will be dynamically loaded -->
            </div>
        </div>
    </div>

    <!-- AI Analysis Side Panel -->
    <!-- Property Details Side Panel (Left) -->
    <div class="property-details-panel" id="propertyDetailsPanel">
        <div class="property-panel-header">
            <h2 class="property-panel-title"> Property Details</h2>
            <button class="property-panel-close" onclick="closePropertyDetailsPanel()"></button>
        </div>
        <div class="property-panel-body" id="propertyPanelBody">
            <!-- Content will be dynamically loaded -->
        </div>
    </div>

    <!-- AI Analysis Side Panel (Right) -->
    <div class="ai-analysis-panel" id="aiAnalysisPanel">
        <div class="ai-panel-header">
            <h2 class="ai-panel-title"> AI Property Analysis</h2>
            <button class="ai-panel-close" onclick="closeAIAnalysisPanel()"></button>
        </div>
        <div class="ai-panel-body" id="aiPanelBody">
            <!-- Content will be dynamically loaded -->
        </div>
    </div>

    <!-- Chart.js for Market Analysis Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.1/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        // ==================== ENHANCED SIDEBAR STATE & HANDLERS ====================
        
        /**
         * Global filter state management
         */
        // ==================== PRODUCTION CONFIGURATION ====================
        
        /**
         * Dynamic API Configuration for Production Deployment
         * Automatically detects environment and uses appropriate base URL
         */
        const getApiBaseUrl = () => {
            // For Render deployment, use the current domain
            if (window.location.hostname.includes('render.com') || 
                window.location.hostname.includes('onrender.com')) {
                return `https://${window.location.hostname}`;
            }
            // For localhost development
            else if (window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1') {
                return `http://${window.location.hostname}:5050`;
            }
            // For any other production deployment
            else {
                return `https://${window.location.hostname}`;
            }
        };

        const filterState = {
            selectedCity: '',
            priceRange: '',
            propertyType: '',
            location: '',
            apiBaseUrl: getApiBaseUrl()
        };

        // Log current configuration
        console.log(' Summitly Production Frontend Loaded');
        console.log(' API Base URL:', filterState.apiBaseUrl);
        console.log(' Environment:', window.location.hostname.includes('render') ? 'Production (Render)' : 'Development');

        /**
         * Toggle Quick Filters dropdown visibility
         */
        function toggleQuickFilters() {
            const content = document.getElementById('quickFiltersContent');
            const icon = document.getElementById('filterToggleIcon');
            
            if (!content) return;
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                if (icon) icon.textContent = '';
            } else {
                content.style.display = 'none';
                if (icon) icon.textContent = '';
            }
        }

        /**
         * Handle city selection change
         */
        async function handleCityChange(city) {
            if (!city) {
                document.getElementById('selectedCityBadge').innerHTML = '';
                filterState.selectedCity = '';
                return;
            }

            filterState.selectedCity = city;
            
            // Show selected city badge
            document.getElementById('selectedCityBadge').innerHTML = `
                <div class="selected-city-badge">
                     ${city}
                </div>
            `;

            console.log(' City selected:', city);

            // Make API calls to fetch city data
            try {
                let hasErrors = false;
                
                // Fetch properties for the city
                const propertiesResponse = await fetch(`${filterState.apiBaseUrl}/api/properties/city?name=${city}`);
                if (propertiesResponse.ok) {
                    const properties = await propertiesResponse.json();
                    console.log(' Properties loaded for', city, ':', properties);
                } else {
                    console.warn(' Properties endpoint returned status:', propertiesResponse.status);
                    hasErrors = true;
                }

                // Fetch city analysis
                const analysisResponse = await fetch(`${filterState.apiBaseUrl}/api/analysis/city?name=${city}`);
                if (analysisResponse.ok) {
                    const analysis = await analysisResponse.json();
                    console.log(' City analysis loaded for', city, ':', analysis);
                } else {
                    console.warn(' Analysis endpoint returned status:', analysisResponse.status);
                    hasErrors = true;
                }

                // Only show warning if there were actual errors
                if (hasErrors) {
                    addMessage('assistant', ` Could not load complete data for ${city}, but you can still search properties.`);
                } else {
                    addMessage('assistant', ` Loaded data for ${city}. You can now apply filters or use Quick Actions!`);
                }
            } catch (error) {
                console.error(' Error loading city data:', error);
                addMessage('assistant', ` Could not load complete data for ${city}, but you can still search properties.`);
            }
        }

        /**
         * Handle quick action button clicks
         */
        async function handleQuickAction(action) {
            if (!filterState.selectedCity) {
                addMessage('assistant', ' Please select a city first!');
                return;
            }

            const city = filterState.selectedCity;
            console.log(' Quick action:', action, 'for city:', city);

            // Define action-specific messages and endpoints
            const actions = {
                search: {
                    message: `Show me available properties in ${city}`,
                    endpoint: '/chat',
                    description: ' Searching properties'
                },
                market: {
                    message: `Give me a market analysis for ${city}`,
                    endpoint: '/chat',
                    description: ' Analyzing market trends'
                },
                neighborhood: {
                    message: `Analyze neighborhoods in ${city} for investment potential`,
                    endpoint: '/chat',
                    description: ' Analyzing neighborhoods'
                },
                roi: {
                    message: `Calculate ROI for properties in ${city}`,
                    endpoint: '/chat',
                    description: ' Calculating ROI'
                },
                dashboard: {
                    message: null, // Special case - opens dashboard
                    endpoint: '/api/manager/dashboard-stats',
                    description: ' Opening dashboard'
                }
            };

            const selectedAction = actions[action];
            if (!selectedAction) return;

            // Special case for dashboard
            if (action === 'dashboard') {
                toggleDashboard();
                return;
            }

            // Send message through chat
            if (selectedAction.message) {
                addMessage('user', selectedAction.message);
                sendMessage(selectedAction.message);
            }
        }

        /**
         * Handle filter pill clicks (Price Range, Property Type, Location)
         */
        function handleFilterClick(filterType, value, button) {
            // Toggle active class
            const isActive = button.classList.contains('active');
            
            // Remove active from all pills in the same group
            const group = button.parentElement;
            group.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
            });

            // If it wasn't active, activate it
            if (!isActive) {
                button.classList.add('active');
                filterState[filterType] = value;
                console.log(` Filter set: ${filterType} = ${value}`);
            } else {
                filterState[filterType] = '';
                console.log(` Filter cleared: ${filterType}`);
            }
        }

        /**
         * Apply all selected filters
         */
        async function applyAllFilters() {
            if (!filterState.selectedCity) {
                addMessage('assistant', ' Please select a city first!');
                return;
            }

            const activeFilters = [];
            let query = `Show me properties in ${filterState.selectedCity}`;

            // Add price range
            if (filterState.priceRange) {
                const priceMap = {
                    'under500k': 'under $500K',
                    '500k-750k': 'between $500K and $750K',
                    '750k-1m': 'between $750K and $1M',
                    'over1m': 'over $1M'
                };
                query += ` priced ${priceMap[filterState.priceRange]}`;
                activeFilters.push(` ${priceMap[filterState.priceRange]}`);
            }

            // Add property type
            if (filterState.propertyType) {
                query += ` that are ${filterState.propertyType}s`;
                activeFilters.push(` ${filterState.propertyType}`);
            }

            // Add location
            if (filterState.location) {
                query += ` in ${filterState.location} areas`;
                activeFilters.push(` ${filterState.location}`);
            }

            console.log(' Applying filters:', {
                city: filterState.selectedCity,
                priceRange: filterState.priceRange,
                propertyType: filterState.propertyType,
                location: filterState.location,
                query: query
            });

            // Show active filters summary
            if (activeFilters.length > 0) {
                const filterSummary = ` Searching with filters:\n${activeFilters.join('\n')}`;
                addMessage('user', filterSummary);
            }

            // Send the search query
            addMessage('user', query);
            sendMessage(query);
        }

        /**
         * Clear all filters
         */
        function clearAllFilters() {
            // Reset state
            filterState.priceRange = '';
            filterState.propertyType = '';
            filterState.location = '';

            // Remove active class from all pills
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
            });

            console.log(' All filters cleared');
            addMessage('assistant', ' All filters have been cleared. Select new filters to search again!');
        }

        /**
         * Handle amenity button clicks
         */
        async function handleAmenityClick(amenity, button) {
            console.log(' handleAmenityClick called with:', amenity, 'button:', button);
            
            if (!filterState.selectedCity) {
                addMessage('assistant', ' Please select a city first!');
                return;
            }

            const city = filterState.selectedCity;
            console.log(' Amenity clicked:', amenity, 'for city:', city);

            // Toggle active state
            button.classList.toggle('active');

            if (!button.classList.contains('active')) {
                return; // User deselected
            }

            // Remove active from other amenity pills
            document.querySelectorAll('.filter-pill').forEach(pill => {
                if (pill !== button && pill.textContent.includes(amenity === 'schools' ? '' : 
                    amenity === 'shopping' ? '' : amenity === 'grocery' ? '' : 
                    amenity === 'hospitals' ? '' : '')) {
                    pill.classList.remove('active');
                }
            });

            try {
                console.log(' Starting amenity processing...');
                
                // Simple test first
                addMessage('assistant', ` Testing amenity system for ${amenity} in ${city}...`);
                
                console.log(' About to call getComprehensiveAmenityData...');
                console.log(' Function exists?', typeof getComprehensiveAmenityData);
                
                const amenityData = getComprehensiveAmenityData(city, amenity);
                
                console.log(' Amenity data found:', amenityData ? amenityData.length : 'none', 'items for', amenity, 'in', city);
                console.log(' Raw data:', amenityData);
                
                if (amenityData && amenityData.length > 0) {
                    console.log(' Found local data, displaying...');
                    
                    // Simple test message first
                    addMessage('assistant', ` Found ${amenityData.length} ${amenity} in ${city}! Loading detailed information...`);
                    
                    // Display comprehensive local data
                    displayAmenityData(amenityData, amenity, city);
                    console.log(' displayAmenityData completed');
                } else {
                    console.log(' No local data, falling back to AI query');
                    addMessage('assistant', ` No local data for ${amenity} in ${city}, using AI query...`);
                    
                    // Fallback to intelligent ChatGPT queries for cities without comprehensive data
                    const amenityQueries = {
                        'schools': `List the top 10 best schools (elementary, middle, and high schools) in ${city}. Include school names, ratings, addresses, and what makes them special. Focus on both public and private schools with good academic reputations.`,
                        'shopping': `List the top 10 shopping centers, malls, and major retail areas in ${city}. Include names, locations, anchor stores, and what makes each shopping destination unique.`,
                        'grocery': `List the top 10 grocery stores and supermarkets in ${city}. Include major chains like Loblaws, Metro, Food Basics, No Frills, and specialty stores. Mention locations and what makes each store special.`,
                        'hospitals': `List the top 10 hospitals, medical centers, and healthcare facilities in ${city}. Include hospital names, specialties, addresses, and key services they provide.`,
                        'parks': `List the top 10 parks, recreational areas, and green spaces in ${city}. Include park names, locations, amenities (playgrounds, trails, sports facilities), and what makes each park special.`
                    };
                    
                    const query = amenityQueries[amenity] || `Tell me about ${amenityLabels[amenity]} in ${city}`;
                    await sendMessage(query);
                }
            } catch (error) {
                console.error(' Error in handleAmenityClick:', error);
                console.error(' Error stack:', error.stack);
                addMessage('assistant', ` Error: ${error.message}. Please check console for details.`);
            }

            const amenityLabels = {
                'schools': ' Schools',
                'shopping': ' Shopping Centers',
                'grocery': ' Grocery Stores',
                'hospitals': ' Hospitals',
                'parks': ' Parks'
            };
        }

        /**
         * Comprehensive amenity database for all Canadian cities
         */
        function getComprehensiveAmenityData(city, amenity) {
            const amenityDatabase = {
                'Mississauga': {
                    'schools': [
                        {
                            name: "John Fraser Secondary School",
                            type: "Public  High School",
                            rating: "9.3/10",
                            ratingSource: "GreatSchools",
                            address: "2665 Erin Centre Blvd, Mississauga, ON L5M 5W6",
                            level: "High School",
                            special: "Top-ranked STEM programs, Advanced Placement courses, award-winning arts programs"
                        },
                        {
                            name: "St. Aloysius Gonzaga Secondary School",
                            type: "Catholic  High School", 
                            rating: "8.8/10",
                            ratingSource: "GreatSchools",
                            address: "2800 Erin Centre Blvd, Mississauga, ON L5M 5W1",
                            level: "High School",
                            special: "IB World School, strong athletics program, community service focus"
                        },
                        {
                            name: "Port Credit Secondary School",
                            type: "Public  High School",
                            rating: "8.5/10", 
                            ratingSource: "Fraser Institute",
                            address: "70 Mineola Rd E, Mississauga, ON L5G 2E5",
                            level: "High School",
                            special: "Heritage building, strong arts program, lakefront location"
                        },
                        {
                            name: "Glenforest Secondary School",
                            type: "Public  High School",
                            rating: "8.7/10",
                            ratingSource: "GreatSchools", 
                            address: "3575 Kaneff Cres, Mississauga, ON L5A 1X4",
                            level: "High School",
                            special: "Technology focus, excellent computer science programs, modern facilities"
                        },
                        {
                            name: "Meadowvale Secondary School",
                            type: "Public  High School",
                            rating: "8.2/10",
                            ratingSource: "Fraser Institute",
                            address: "6800 Montevideo Rd, Mississauga, ON L5N 2M5", 
                            level: "High School",
                            special: "Strong business programs, diverse community, excellent graduation rates"
                        },
                        {
                            name: "Applewood Heights Secondary School",
                            type: "Public  High School",
                            rating: "7.9/10",
                            ratingSource: "GreatSchools",
                            address: "465 Burnhamthorpe Rd W, Mississauga, ON L5B 4B8",
                            level: "High School", 
                            special: "Established 1957, strong tradition, excellent sports programs"
                        },
                        {
                            name: "Streetsville Secondary School",
                            type: "Public  High School",
                            rating: "8.1/10",
                            ratingSource: "Fraser Institute",
                            address: "1821 Bristol Rd W, Mississauga, ON L5M 4Z8",
                            level: "High School",
                            special: "Heritage school, small class sizes, personalized learning"
                        },
                        {
                            name: "TMS - The Maronite School",
                            type: "Private  Elementary/Middle",
                            rating: "9.1/10",
                            ratingSource: "Private School Review", 
                            address: "365 Britannia Rd E, Mississauga, ON L4Z 2H6",
                            level: "Elementary/Middle School",
                            special: "Trilingual education (English/French/Arabic), small class sizes, strong academics"
                        },
                        {
                            name: "Mississauga Secondary School",
                            type: "Public  High School",
                            rating: "7.8/10",
                            ratingSource: "GreatSchools",
                            address: "1801 Britannia Rd W, Mississauga, ON L5M 0G5",
                            level: "High School",
                            special: "Heritage school established 1950, strong community connections"
                        },
                        {
                            name: "Stephen Lewis Secondary School",
                            type: "Public  High School", 
                            rating: "8.3/10",
                            ratingSource: "Fraser Institute",
                            address: "6050 Montevideo Rd, Mississauga, ON L5N 2M5",
                            level: "High School",
                            special: "Newest high school in Mississauga, modern facilities, innovative programs"
                        }
                    ],
                    'shopping': [
                        {
                            name: "Square One Shopping Centre",
                            type: "Major Shopping Mall",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "100 City Centre Dr, Mississauga, ON L5B 2C9",
                            special: "Canada's largest shopping mall, 360+ stores, major brands like Hudson's Bay, Walmart, Best Buy"
                        },
                        {
                            name: "Heartland Town Centre", 
                            type: "Outdoor Shopping Plaza",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews", 
                            address: "5965 Mavis Rd, Mississauga, ON L5R 3T7",
                            special: "Outdoor lifestyle center, major retailers like Canadian Tire, Chapters, Winners"
                        },
                        {
                            name: "Dixie Outlet Mall",
                            type: "Outlet Shopping Center",
                            rating: "4.0/5", 
                            ratingSource: "Google Reviews",
                            address: "1250 South Service Rd, Mississauga, ON L5E 1V4", 
                            special: "Factory outlet prices, brands like Nike, Adidas, Kitchen Stuff Plus"
                        },
                        {
                            name: "Erin Mills Town Centre",
                            type: "Shopping Mall",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "5100 Erin Mills Pkwy, Mississauga, ON L5M 4Z5",
                            special: "West-end shopping hub, Walmart, Metro, Shoppers Drug Mart, 170+ stores"
                        },
                        {
                            name: "Port Credit GO Station Plaza",
                            type: "Mixed-Use Shopping",
                            rating: "4.2/5", 
                            ratingSource: "Google Reviews",
                            address: "110 Lakeshore Rd E, Mississauga, ON L5G 1E6",
                            special: "Waterfront shopping, upscale boutiques, restaurants, GO train access"
                        },
                        {
                            name: "Meadowvale Town Centre",
                            type: "Community Shopping Center",
                            rating: "3.9/5",
                            ratingSource: "Google Reviews", 
                            address: "6677 Meadowvale Town Centre Cir, Mississauga, ON L5N 2R5",
                            special: "Anchor stores: Metro, Shoppers Drug Mart, variety of services and dining"
                        },
                        {
                            name: "Clarkson GO Centre",
                            type: "Transit-Oriented Shopping",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "2185 Lakeshore Rd W, Mississauga, ON L5J 1J3", 
                            special: "Connected to GO station, Loblaws, LCBO, medical services"
                        },
                        {
                            name: "Streetsville Glen Shopping Centre", 
                            type: "Community Shopping Plaza",
                            rating: "3.8/5",
                            ratingSource: "Google Reviews",
                            address: "6965 Mississauga Rd, Mississauga, ON L5N 2L3",
                            special: "Historic Streetsville area, local businesses, Food Basics, specialty shops"
                        },
                        {
                            name: "Sheridan Centre",
                            type: "Shopping Plaza",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "2225 Erin Mills Pkwy, Mississauga, ON L5K 1T9",
                            special: "Walmart Supercentre, Canadian Tire, diverse dining options"
                        },
                        {
                            name: "Winston Park Centre",
                            type: "Community Shopping", 
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "2225 Hurontario St, Mississauga, ON L5A 2G1",
                            special: "Neighbourhood shopping, Metro, TD Bank, local services"
                        }
                    ],
                    'grocery': [
                        {
                            name: "Loblaws City Centre",
                            type: "Full-Service Supermarket",
                            rating: "4.1/5", 
                            ratingSource: "Google Reviews",
                            address: "100 City Centre Dr, Mississauga, ON L5B 2C9",
                            special: "Premium location in Square One, Joe Fresh clothing, pharmacy, full deli"
                        },
                        {
                            name: "Metro Erin Mills",
                            type: "Full-Service Supermarket", 
                            rating: "4.2/5",
                            ratingSource: "Google Reviews", 
                            address: "5100 Erin Mills Pkwy, Mississauga, ON L5M 4Z5",
                            special: "Large selection, excellent produce, full-service deli and bakery"
                        },
                        {
                            name: "Walmart Supercentre Heartland",
                            type: "Supercentre",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "5965 Mavis Rd, Mississauga, ON L5R 3T7", 
                            special: "One-stop shopping, grocery + general merchandise, competitive prices"
                        },
                        {
                            name: "No Frills Dixie",
                            type: "Discount Supermarket",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews", 
                            address: "1535 Dixie Rd, Mississauga, ON L5E 1V4",
                            special: "Low prices, bulk buying options, PC Optimum rewards"
                        },
                        {
                            name: "Food Basics Meadowvale",
                            type: "Discount Supermarket",
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "6677 Meadowvale Town Centre Cir, Mississauga, ON L5N 2R5", 
                            special: "Affordable groceries, weekly specials, local community focus"
                        },
                        {
                            name: "Farm Boy Mississauga",
                            type: "Premium Grocery",
                            rating: "4.4/5",
                            ratingSource: "Google Reviews",
                            address: "3045 Mavis Rd, Mississauga, ON L5B 4M6",
                            special: "Fresh, local produce, artisanal products, excellent prepared foods"
                        },
                        {
                            name: "Longos Port Credit",
                            type: "Premium Supermarket", 
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "346 Lakeshore Rd W, Mississauga, ON L5H 1G8", 
                            special: "Upscale grocer, excellent meat and seafood, gourmet selections"
                        },
                        {
                            name: "T&T Supermarket Mississauga",
                            type: "Asian Supermarket",
                            rating: "4.2/5", 
                            ratingSource: "Google Reviews",
                            address: "222 Cherry St, Mississauga, ON L5B 0A8",
                            special: "Largest Asian grocery chain, authentic ingredients, hot food counter"
                        },
                        {
                            name: "Oceans Fresh Food Market",
                            type: "International Supermarket",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews", 
                            address: "6085 Mavis Rd, Mississauga, ON L5R 3M6",
                            special: "South Asian specialties, halal meats, international products"
                        },
                        {
                            name: "Coppa's Fresh Market",
                            type: "Independent Grocer",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews",
                            address: "1500 Dundas St E, Mississauga, ON L4X 1L4", 
                            special: "Family-owned, Italian specialties, fresh pasta, excellent customer service"
                        }
                    ],
                    'hospitals': [
                        {
                            name: "Trillium Health Partners - Mississauga Hospital",
                            type: "Full-Service Hospital",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews", 
                            address: "100 Queensway W, Mississauga, ON L5B 1B8",
                            special: "Major trauma center, emergency services, cardiac care, maternity ward"
                        },
                        {
                            name: "Credit Valley Hospital",
                            type: "Full-Service Hospital",
                            rating: "4.1/5", 
                            ratingSource: "Google Reviews",
                            address: "2200 Eglinton Ave W, Mississauga, ON L5M 2N1",
                            special: "Cancer care, cardiac surgery, women's health, mental health services"
                        },
                        {
                            name: "Queensway Health Centre", 
                            type: "Rehabilitation Hospital",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews", 
                            address: "150 Sherway Dr, Etobicoke, ON M9C 1A5",
                            special: "Specialized rehabilitation, complex care, transitional care programs"
                        },
                        {
                            name: "Mississauga Medical Centre",
                            type: "Medical Clinic Complex",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "1333 Neyagawa Blvd, Oakville, ON L6M 0H3", 
                            special: "Multi-specialty clinic, walk-in services, diagnostic imaging"
                        },
                        {
                            name: "Erin Mills Medical Centre",
                            type: "Community Health Center", 
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "5100 Erin Mills Pkwy, Mississauga, ON L5M 4Z5",
                            special: "Family medicine, pediatrics, specialist referrals"
                        },
                        {
                            name: "Sherway Medical Centre",
                            type: "Specialist Medical Center",
                            rating: "4.1/5", 
                            ratingSource: "Google Reviews",
                            address: "1333 Shawnmarr Rd, Mississauga, ON L5J 2P5",
                            special: "Cardiology, orthopedics, diagnostic services"
                        },
                        {
                            name: "Meadowvale Medical Centre", 
                            type: "Family Health Team",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "6630 Meadowvale Town Centre Cir, Mississauga, ON L5N 4L8", 
                            special: "Comprehensive family care, chronic disease management"
                        },
                        {
                            name: "Port Credit Medical Centre",
                            type: "Community Clinic",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "145 Lakeshore Rd W, Mississauga, ON L5H 1G2", 
                            special: "Waterfront location, family practice, urgent care"
                        },
                        {
                            name: "Streetsville Medical Centre",
                            type: "Multi-Specialty Clinic",
                            rating: "3.8/5", 
                            ratingSource: "Google Reviews",
                            address: "34 Queen St S, Mississauga, ON L5M 1J6",
                            special: "Historic Streetsville, family medicine, pediatrics"
                        },
                        {
                            name: "Square One Medical Centre",
                            type: "Walk-in Clinic",
                            rating: "3.7/5",
                            ratingSource: "Google Reviews", 
                            address: "100 City Centre Dr, Mississauga, ON L5B 2C9",
                            special: "Convenient mall location, no appointment needed, extended hours"
                        }
                    ],
                    'parks': [
                        {
                            name: "Jack Darling Memorial Park",
                            type: "Lakefront Park",
                            rating: "4.6/5", 
                            ratingSource: "Google Reviews",
                            address: "1180 Lakeshore Rd W, Mississauga, ON L5H 1G6",
                            special: "Lake Ontario waterfront, marina, beach access, picnic areas, walking trails"
                        },
                        {
                            name: "Kariya Park",
                            type: "Japanese Garden",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews", 
                            address: "3600 Kariya Dr, Mississauga, ON L5B 3C1",
                            special: "Authentic Japanese garden, koi pond, traditional architecture, peaceful setting"
                        },
                        {
                            name: "Rattray Marsh Conservation Area",
                            type: "Nature Preserve",
                            rating: "4.4/5", 
                            ratingSource: "Google Reviews",
                            address: "3050 Mississauga Rd, Mississauga, ON L5L 2L8", 
                            special: "Wetland preserve, bird watching, boardwalk trails, environmental education"
                        },
                        {
                            name: "Erindale Park",
                            type: "River Valley Park",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "1695 Dundas St W, Mississauga, ON L5C 1T9",
                            special: "Credit River valley, hiking trails, historic mill ruins, cross-country skiing"
                        },
                        {
                            name: "Mississauga Valley Park", 
                            type: "Community Park",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "1275 Mississauga Valley Blvd, Mississauga, ON L5A 3R8",
                            special: "Large open spaces, sports fields, playground, community centre"
                        },
                        {
                            name: "Port Credit Memorial Park",
                            type: "Waterfront Park",
                            rating: "4.4/5", 
                            ratingSource: "Google Reviews", 
                            address: "151 Lakeshore Rd W, Mississauga, ON L5H 1G2",
                            special: "Historic lighthouse, lakefront views, festivals and events, marina access"
                        },
                        {
                            name: "Huron Park",
                            type: "Recreation Park",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "830 Hurontario St, Mississauga, ON L5G 3H5", 
                            special: "Sports facilities, tennis courts, baseball diamonds, community programs"
                        },
                        {
                            name: "Creditview Sandalwood Park",
                            type: "Family Park", 
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "6990 Creditview Rd, Mississauga, ON L5N 8R5",
                            special: "Adventure playground, splash pad, sports courts, family-friendly"
                        },
                        {
                            name: "Lakefront Promenade",
                            type: "Waterfront Trail",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews", 
                            address: "Lakeshore Rd W, Mississauga, ON",
                            special: "11km waterfront trail, cycling path, scenic views, connects multiple parks"
                        },
                        {
                            name: "Streetsville Memorial Park",
                            type: "Historic Community Park",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "245 Queen St S, Mississauga, ON L5M 1L2", 
                            special: "Historic village setting, cenotaph, community events, walking paths"
                        }
                    ]
                },
                
                'Toronto': {
                    'schools': [
                        {
                            name: "University of Toronto Schools",
                            type: "Private  High School",
                            rating: "9.8/10",
                            ratingSource: "Fraser Institute",
                            address: "371 Bloor St W, Toronto, ON M5S 2R7",
                            level: "High School",
                            special: "Laboratory school, exceptional academics, university preparation"
                        },
                        {
                            name: "Earl Haig Secondary School",
                            type: "Public  High School", 
                            rating: "9.2/10",
                            ratingSource: "Fraser Institute",
                            address: "100 Princess Ave, Toronto, ON M2N 3R5",
                            level: "High School",
                            special: "Claude Watson Arts Program, gifted program, performing arts focus"
                        },
                        {
                            name: "North Toronto Collegiate Institute",
                            type: "Public  High School",
                            rating: "8.9/10",
                            ratingSource: "Fraser Institute", 
                            address: "70 Roehampton Ave, Toronto, ON M4P 1P9",
                            level: "High School",
                            special: "IB World School, advanced academics, historic building"
                        },
                        {
                            name: "Crescent School", 
                            type: "Private  Boys School",
                            rating: "9.5/10",
                            ratingSource: "Fraser Institute",
                            address: "2365 Bayview Ave, Toronto, ON M2L 1A2",
                            level: "Elementary/High School",
                            special: "All-boys education, strong academics, extensive athletics program"
                        },
                        {
                            name: "Havergal College",
                            type: "Private  Girls School",
                            rating: "9.4/10", 
                            ratingSource: "Fraser Institute",
                            address: "1451 Avenue Rd, Toronto, ON M5N 2H9",
                            level: "Elementary/High School",
                            special: "All-girls education, IB program, leadership development"
                        },
                        {
                            name: "Marc Garneau Collegiate Institute",
                            type: "Public  High School",
                            rating: "8.7/10",
                            ratingSource: "Fraser Institute", 
                            address: "135 Overlea Blvd, Toronto, ON M4H 1A1",
                            level: "High School",
                            special: "STEM focus, aerospace program, technology integration"
                        },
                        {
                            name: "Lawrence Park Collegiate Institute",
                            type: "Public  High School",
                            rating: "8.8/10",
                            ratingSource: "Fraser Institute",
                            address: "125 Chatsworth Dr, Toronto, ON M4R 1S2", 
                            level: "High School",
                            special: "French Immersion, advanced placement, strong community"
                        },
                        {
                            name: "Upper Canada College",
                            type: "Private  Boys School",
                            rating: "9.6/10",
                            ratingSource: "Fraser Institute",
                            address: "200 Lonsdale Rd, Toronto, ON M4V 1W6",
                            level: "Elementary/High School", 
                            special: "Prestigious all-boys school, IB program, extensive alumni network"
                        },
                        {
                            name: "Martingrove Collegiate Institute",
                            type: "Public  High School",
                            rating: "8.1/10", 
                            ratingSource: "Fraser Institute",
                            address: "50 Winterton Dr, Etobicoke, ON M9V 2J9",
                            level: "High School",
                            special: "Diverse programs, arts focus, community partnerships"
                        },
                        {
                            name: "The Bishop Strachan School",
                            type: "Private  Girls School",
                            rating: "9.3/10",
                            ratingSource: "Fraser Institute", 
                            address: "298 Lonsdale Rd, Toronto, ON M4V 1X2",
                            level: "Elementary/High School",
                            special: "All-girls Anglican school, strong academics, leadership programs"
                        }
                    ],
                    // Add other Toronto amenity categories here...
                    'shopping': [
                        {
                            name: "Eaton Centre",
                            type: "Major Shopping Mall",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews", 
                            address: "220 Yonge St, Toronto, ON M5B 2H1",
                            special: "Downtown landmark, 250+ stores, H&M flagship, direct subway access"
                        },
                        {
                            name: "Yorkdale Shopping Centre", 
                            type: "Luxury Shopping Mall",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "3401 Dufferin St, Toronto, ON M6A 2T9", 
                            special: "Luxury brands, Apple Store, Tesla showroom, premium shopping experience"
                        },
                        {
                            name: "Sherway Gardens",
                            type: "Upscale Shopping Centre",
                            rating: "4.2/5", 
                            ratingSource: "Google Reviews",
                            address: "25 The West Mall, Etobicoke, ON M9C 1B8",
                            special: "Upscale retailers, Nordstrom, excellent dining, convenient parking"
                        },
                        {
                            name: "Fairview Mall",
                            type: "Regional Shopping Centre",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "1800 Sheppard Ave E, North York, ON M2J 5A7",
                            special: "Anchor stores include Hudson's Bay, Metro, 170+ stores and services"
                        },
                        {
                            name: "Scarborough Town Centre",
                            type: "Major Shopping Mall",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews", 
                            address: "300 Borough Dr, Scarborough, ON M1P 4P5",
                            special: "Eastern GTA hub, 200+ stores, direct RT access, major renovations"
                        },
                        {
                            name: "Dufferin Mall",
                            type: "Community Shopping Centre",
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "900 Dufferin St, Toronto, ON M6H 4A9",
                            special: "Walmart Supercentre, No Frills, diverse community shopping"
                        },
                        {
                            name: "Pacific Mall",
                            type: "Asian Shopping Centre",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "4300 Steeles Ave E, Markham, ON L3R 0Y5",
                            special: "Largest indoor Asian mall in North America, 270+ stores"
                        },
                        {
                            name: "Hillcrest Mall", 
                            type: "Regional Shopping Centre",
                            rating: "3.8/5",
                            ratingSource: "Google Reviews",
                            address: "9350 Yonge St, Richmond Hill, ON L4C 5G2",
                            special: "Sears outlet, Winners, Good Life Fitness, community focus"
                        },
                        {
                            name: "Promenade Mall",
                            type: "Shopping Centre",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "1 Promenade Cir, Thornhill, ON L4J 4P8",
                            special: "Loblaws, Winners, diverse dining options, movie theatre"
                        }
                    ],
                    'grocery': [
                        {
                            name: "Loblaws at Maple Leaf Gardens",
                            type: "Premium Supermarket",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "60 Carlton St, Toronto, ON M5B 1J2",
                            special: "Historic Maple Leaf Gardens location, Joe Fresh, full-service pharmacy"
                        },
                        {
                            name: "Metro at College Park",
                            type: "Urban Supermarket",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "444 Yonge St, Toronto, ON M5B 2H4",
                            special: "Downtown location, connected to College Park, urban convenience"
                        },
                        {
                            name: "Pusateri's Fine Foods",
                            type: "Gourmet Grocery",
                            rating: "4.4/5",
                            ratingSource: "Google Reviews",
                            address: "57 Yorkville Ave, Toronto, ON M5R 1B7",
                            special: "Luxury grocer, gourmet products, premium meats and seafood"
                        },
                        {
                            name: "T&T Supermarket Cherry Street",
                            type: "Asian Supermarket",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "222 Cherry St, Toronto, ON M5A 3L2",
                            special: "Flagship location, extensive Asian groceries, hot food counter"
                        },
                        {
                            name: "FreshCo Bloor West",
                            type: "Discount Supermarket",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "2289 Bloor St W, Toronto, ON M6S 1P1",
                            special: "Competitive prices, fresh produce, PC Optimum rewards"
                        },
                        {
                            name: "Sobeys Urban Fresh",
                            type: "Urban Format Store",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "87 Front St E, Toronto, ON M5E 1C3",
                            special: "Downtown format, grab-and-go options, Scene+ rewards"
                        },
                        {
                            name: "No Frills Dufferin",
                            type: "Discount Supermarket",
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "900 Dufferin St, Toronto, ON M6H 4A9",
                            special: "Low prices, bulk options, community-focused"
                        },
                        {
                            name: "Longo's Maple Leaf Square",
                            type: "Premium Supermarket",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "15 York St, Toronto, ON M5J 0A3",
                            special: "Entertainment District location, premium products, extended hours"
                        },
                        {
                            name: "Farm Boy Toronto",
                            type: "Fresh Market",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews", 
                            address: "15 Lower Jarvis St, Toronto, ON M5E 1M4",
                            special: "Farm-fresh products, artisanal goods, excellent prepared foods"
                        },
                        {
                            name: "Bulk Barn Queen Street",
                            type: "Bulk Foods Store",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "579 Queen St W, Toronto, ON M5V 2B6",
                            special: "Bulk foods, nuts, grains, baking supplies, eco-friendly shopping"
                        }
                    ],
                    'hospitals': [
                        {
                            name: "Toronto General Hospital",
                            type: "Major Teaching Hospital",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "200 Elizabeth St, Toronto, ON M5G 2C4",
                            special: "World-renowned multi-organ transplant center, cardiac surgery, research"
                        },
                        {
                            name: "Hospital for Sick Children (SickKids)",
                            type: "Pediatric Hospital",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews",
                            address: "555 University Ave, Toronto, ON M5G 1X8",
                            special: "Leading pediatric hospital, research institute, specialized child care"
                        },
                        {
                            name: "Mount Sinai Hospital",
                            type: "Teaching Hospital",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "600 University Ave, Toronto, ON M5G 1X5",
                            special: "Women's and infants' health, high-risk pregnancies, emergency services"
                        },
                        {
                            name: "Princess Margaret Cancer Centre",
                            type: "Cancer Specialty Hospital",
                            rating: "4.4/5",
                            ratingSource: "Google Reviews",
                            address: "610 University Ave, Toronto, ON M5G 2M9",
                            special: "Leading cancer research and treatment, comprehensive cancer care"
                        },
                        {
                            name: "St. Michael's Hospital",
                            type: "Trauma Center",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "30 Bond St, Toronto, ON M5B 1W8",
                            special: "Level 1 trauma center, downtown emergency services, cardiac care"
                        },
                        {
                            name: "Sunnybrook Health Sciences Centre",
                            type: "Academic Health Science Centre",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "2075 Bayview Ave, Toronto, ON M4N 3M5",
                            special: "Trauma center, veterans care, Odette Cancer Centre"
                        },
                        {
                            name: "Toronto Western Hospital",
                            type: "Teaching Hospital",
                            rating: "4.0/5",
                            ratingSource: "Google Reviews",
                            address: "399 Bathurst St, Toronto, ON M5T 2S8",
                            special: "Neurosurgery, spine care, mental health services"
                        },
                        {
                            name: "North York General Hospital",
                            type: "Community Hospital",
                            rating: "4.1/5",
                            ratingSource: "Google Reviews",
                            address: "4001 Leslie St, North York, ON M2K 1E1",
                            special: "Full-service community hospital, emergency services, seniors care"
                        },
                        {
                            name: "Scarborough Health Network",
                            type: "Multi-Site Hospital System",
                            rating: "3.9/5",
                            ratingSource: "Google Reviews",
                            address: "3050 Lawrence Ave E, Scarborough, ON M1P 2V5",
                            special: "Three hospital campuses, emergency services, community focus"
                        },
                        {
                            name: "Women's College Hospital",
                            type: "Ambulatory Care Hospital",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "76 Grenville St, Toronto, ON M5S 1B2",
                            special: "Women's health focus, ambulatory care, mental health services"
                        }
                    ],
                    'parks': [
                        {
                            name: "High Park",
                            type: "Urban Park",
                            rating: "4.6/5",
                            ratingSource: "Google Reviews",
                            address: "1873 Bloor St W, Toronto, ON M6R 2Z3",
                            special: "Toronto's largest park, cherry blossoms, hiking trails, Grenadier Cafe"
                        },
                        {
                            name: "Toronto Islands",
                            type: "Island Park System",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews",
                            address: "Toronto Islands, Toronto, ON",
                            special: "Car-free islands, beaches, Centreville Amusement Park, spectacular city views"
                        },
                        {
                            name: "Trinity Bellwoods Park",
                            type: "Urban Community Park",
                            rating: "4.4/5",
                            ratingSource: "Google Reviews",
                            address: "155 Crawford St, Toronto, ON M6J 2V5",
                            special: "Hip neighborhood park, dog off-leash area, community events, trendy location"
                        },
                        {
                            name: "Riverdale Park East",
                            type: "Scenic Overlook Park",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews",
                            address: "550 Broadview Ave, Toronto, ON M4K 2N6",
                            special: "Best skyline views of downtown Toronto, sledding hill, sports facilities"
                        },
                        {
                            name: "Harbourfront Centre",
                            type: "Waterfront Cultural Park",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "235 Queens Quay W, Toronto, ON M5J 2G8",
                            special: "Cultural events, festivals, waterfront walking, art galleries"
                        },
                        {
                            name: "Scarborough Bluffs",
                            type: "Natural Escarpment Park",
                            rating: "4.7/5",
                            ratingSource: "Google Reviews",
                            address: "1 Brimley Rd S, Scarborough, ON M1M 3W3",
                            special: "Dramatic cliffs, Lake Ontario views, hiking trails, photography spot"
                        },
                        {
                            name: "Rouge Valley",
                            type: "Conservation Area",
                            rating: "4.4/5",
                            ratingSource: "Google Reviews",
                            address: "Rouge Valley, Toronto, ON",
                            special: "Urban wilderness, hiking trails, wildlife viewing, river valleys"
                        },
                        {
                            name: "Kew Gardens",
                            type: "Beachfront Park",
                            rating: "4.3/5",
                            ratingSource: "Google Reviews",
                            address: "2075 Queen St E, Toronto, ON M4E 1E5",
                            special: "Sandy beach, boardwalk, historic Leuty Lifeguard Station"
                        },
                        {
                            name: "Don Valley Brick Works",
                            type: "Historic Site Park",
                            rating: "4.5/5",
                            ratingSource: "Google Reviews",
                            address: "550 Bayview Ave, Toronto, ON M4W 3X8",
                            special: "Former brick factory, nature trails, Saturday farmers market, bird watching"
                        },
                        {
                            name: "Centennial Park",
                            type: "Multi-Use Recreation Park",
                            rating: "4.2/5",
                            ratingSource: "Google Reviews",
                            address: "256 Centennial Park Rd, Etobicoke, ON M9C 5N3",
                            special: "Ski and snowboard facility, golf course, conservatory, large green spaces"
                        }
                    ]
                }
            };
            
            const result = amenityDatabase[city] && amenityDatabase[city][amenity] ? amenityDatabase[city][amenity] : null;
            console.log(' Database lookup:', city, amenity, 'result:', result ? result.length : 'null');
            return result;
        }

        /**
         * Display comprehensive amenity data in the enhanced format
         */
        function displayAmenityData(data, amenity, city) {
            console.log(' displayAmenityData called with:', data.length, 'items for', amenity, 'in', city);
            
            try {
                const amenityLabels = {
                'schools': ' Educational Institutions',
                'shopping': ' Shopping Centers',
                'grocery': ' Grocery Stores', 
                'hospitals': ' Medical Facilities',
                'parks': ' Parks & Recreation'
            };

            const amenityIcons = {
                'schools': '',
                'shopping': '',
                'grocery': '',
                'hospitals': '', 
                'parks': ''
            };

            let content = `
                <div class="amenity-response">
                    <div class="amenity-header">
                        <h2>${amenityIcons[amenity]} ${amenityLabels[amenity]}</h2>
                        <p>Comprehensive ${amenity} information with ratings and details for ${city}</p>
                    </div>
                    <div class="amenity-grid">
            `;

            data.forEach((item, index) => {
                content += renderAmenityCard(item, amenity, index);
            });

            content += `
                    </div>
                </div>
            `;

            console.log(' About to call addMessage with content length:', content.length);
            addMessage('assistant', content, { 
                isAI: true,
                quickReplies: [`Tell me more about ${city} ${amenity}`, `Compare with nearby cities`, `Find specific ${amenity} recommendations`]
            });
            console.log(' addMessage completed successfully');
            
            } catch (error) {
                console.error(' Error in displayAmenityData:', error);
                throw error; // Re-throw to be caught by handleAmenityClick
            }
        }

        /**
         * Get rating class for color-coding
         */
        function getRatingClass(rating) {
            if (rating >= 8.5 || rating >= 4.3) return 'high';
            if (rating >= 7.0 || rating >= 3.8) return 'medium';
            return 'low';
        }

        /**
         * Render individual amenity cards
         */
        function renderAmenityCard(item, amenity, index) {
            const typeInfo = getAmenityTypeInfo(amenity);
            
            // Parse rating safely
            let ratingValue = item.rating;
            let numericRating = parseFloat(ratingValue);
            if (isNaN(numericRating)) {
                // Try to extract number from string like "9.3/10"
                const match = ratingValue.match(/(\d+\.?\d*)/);
                numericRating = match ? parseFloat(match[1]) : 0;
            }
            
            return `
                <div class="amenity-card" role="article" tabindex="0" data-amenity-id="${index}">
                    <div class="amenity-card-header">
                        <div class="amenity-name">${item.name}</div>
                        <div class="amenity-type">${item.type}</div>
                        <div class="amenity-rating ${getRatingClass(numericRating)}">
                             ${item.rating}${item.ratingSource ? ` (${item.ratingSource})` : ''}
                        </div>
                    </div>
                    
                    <div class="amenity-details">
                        <div class="amenity-address">
                             ${item.address}
                        </div>
                        
                        ${item.level ? `
                            <div class="amenity-level">
                                 ${item.level}
                            </div>
                        ` : ''}
                        
                        <div class="amenity-special">
                            ${item.special}
                        </div>
                    </div>
                    
                    <div class="amenity-actions">
                        <button class="amenity-btn primary" onclick="getAmenityDetails('${item.name.replace(/'/g, "\\'")}')">
                            View Details
                        </button>
                        <button class="amenity-btn" onclick="getDirections('${item.address.replace(/'/g, "\\'")}')">
                            Directions
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Get amenity type information for styling
         */
        function getAmenityTypeInfo(amenity) {
            const typeInfo = {
                'schools': { icon: '', label: 'Educational Institution' },
                'shopping': { icon: '', label: 'Shopping Center' },
                'grocery': { icon: '', label: 'Grocery Store' },
                'hospitals': { icon: '', label: 'Medical Facility' },
                'parks': { icon: '', label: 'Park & Recreation' }
            };
            return typeInfo[amenity] || { icon: '', label: 'Location' };
        }

        /**
         * Get directions to an amenity
         */
        function getDirections(address) {
            const encodedAddress = encodeURIComponent(address);
            const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
            window.open(mapsUrl, '_blank');
        }

        /**
         * Get detailed information about an amenity
         */
        function getAmenityDetails(name) {
            sendMessage(`Tell me more detailed information about ${name}, including services, hours, contact information, and recent reviews.`);
        }

        /**
         * Handle "Tell Me More" clicks with auto follow-up questions
         */
        async function handleTellMeMore(id, type = 'property') {
            console.log(' Tell me more:', id, type);
            
            showTypingIndicator();
            addMessage('user', 'Tell me more about this');

            try {
                let response;
                
                // Choose endpoint based on type
                if (type === 'url') {
                    // Use EXA details endpoint for URLs
                    response = await fetch(`${filterState.apiBaseUrl}/api/exa/details?url=${encodeURIComponent(id)}&topic=${filterState.selectedCity || 'real estate'}`);
                } else {
                    // Use regular details endpoint for properties
                    response = await fetch(`${filterState.apiBaseUrl}/api/details?id=${id}&type=${type}`);
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                console.log(' Details received:', data);

                // Display follow-up questions first
                if (data.follow_up_questions && data.follow_up_questions.length > 0) {
                    displayFollowUpQuestions(data.follow_up_questions, id);
                }

                // Then display detailed information
                if (data.details) {
                    displayDetailedInfo(data.details, type);
                }

            } catch (error) {
                console.error(' Error fetching details:', error);
                addMessage('assistant', ' Could not load detailed information. Please try again.');
            } finally {
                hideTypingIndicator();
            }
        }

        /**
         * Display follow-up questions
         */
        function displayFollowUpQuestions(questions, contextId) {
            let html = `
                <div class="follow-up-questions" style="
                    background: linear-gradient(135deg, rgba(51, 128, 141, 0.1) 0%, rgba(29, 116, 128, 0.1) 100%);
                    border: 1px solid rgba(51, 128, 141, 0.2);
                    border-radius: 12px;
                    padding: 20px;
                    margin: 12px 0;
                ">
                    <h4 style="margin: 0 0 16px 0; color: var(--color-primary); display: flex; align-items: center; gap: 8px;">
                        <span></span>
                        <span>You might also want to know:</span>
                    </h4>
                    <div style="display: grid; gap: 10px;">
                        ${questions.map((question, idx) => `
                            <button onclick="sendMessage('${question.replace(/'/g, "\\'")}')" style="
                                padding: 14px 18px;
                                background: white;
                                border: 1px solid rgba(51, 128, 141, 0.2);
                                border-radius: 10px;
                                color: var(--color-text-primary);
                                font-size: 14px;
                                text-align: left;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                display: flex;
                                align-items: center;
                                gap: 10px;
                            " onmouseover="this.style.background='var(--color-bg-secondary)'; this.style.borderColor='var(--color-primary)';" 
                               onmouseout="this.style.background='white'; this.style.borderColor='rgba(51, 128, 141, 0.2)';">
                                <span style="
                                    min-width: 24px;
                                    height: 24px;
                                    background: var(--color-primary);
                                    color: white;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 12px;
                                    font-weight: 600;
                                ">${idx + 1}</span>
                                <span style="flex: 1;">${question}</span>
                                <span style="opacity: 0.5;"></span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            addMessage('assistant', html);
        }

        /**
         * Display detailed information
         */
        function displayDetailedInfo(details, type) {
            let html = '';

            if (type === 'property' && details.address) {
                // Property details
                html = `
                    <div class="detailed-info" style="
                        background: var(--color-bg-primary);
                        border-radius: 12px;
                        padding: 24px;
                        margin: 12px 0;
                        border: 1px solid var(--color-border);
                    ">
                        <h3 style="margin: 0 0 20px 0; color: var(--color-primary);"> Detailed Information</h3>
                        <div style="display: grid; gap: 16px;">
                            ${details.address ? `<div><strong>Address:</strong> ${details.address}</div>` : ''}
                            ${details.price ? `<div><strong>Price:</strong> $${details.price.toLocaleString()}</div>` : ''}
                            ${details.bedrooms ? `<div><strong>Bedrooms:</strong> ${details.bedrooms}</div>` : ''}
                            ${details.bathrooms ? `<div><strong>Bathrooms:</strong> ${details.bathrooms}</div>` : ''}
                            ${details.sqft ? `<div><strong>Square Feet:</strong> ${details.sqft.toLocaleString()}</div>` : ''}
                            ${details.description ? `<div><strong>Description:</strong><br>${details.description}</div>` : ''}
                        </div>
                    </div>
                `;
            } else if (details.text) {
                // General content details
                html = `
                    <div class="detailed-info" style="
                        background: var(--color-bg-primary);
                        border-radius: 12px;
                        padding: 24px;
                        margin: 12px 0;
                        border: 1px solid var(--color-border);
                    ">
                        <h3 style="margin: 0 0 20px 0; color: var(--color-primary);"> ${details.title || 'Detailed Information'}</h3>
                        <div style="line-height: 1.6; color: var(--color-text-primary);">
                            ${details.text}
                        </div>
                        ${details.url ? `
                            <div style="margin-top: 16px;">
                                <a href="${details.url}" target="_blank" style="
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 8px;
                                    padding: 10px 16px;
                                    background: var(--color-primary);
                                    color: white;
                                    text-decoration: none;
                                    border-radius: 8px;
                                    font-weight: 500;
                                    transition: all 0.3s ease;
                                ">
                                    <span>View Full Source</span>
                                    <span></span>
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                html = `
                    <div class="detailed-info" style="
                        background: var(--color-bg-primary);
                        border-radius: 12px;
                        padding: 24px;
                        margin: 12px 0;
                        border: 1px solid var(--color-border);
                    ">
                        <p>${details.message || 'Detailed information is being processed.'}</p>
                    </div>
                `;
            }

            addMessage('assistant', html);
        }

        // ==================== END ENHANCED SIDEBAR HANDLERS ====================

        // ==================== CORE CLASSES ====================
        
        /**
         * Cache utility for storing API responses
         */
        class Cache {
            constructor(ttl = 300000) { // 5 minutes default
                this.cache = new Map();
                this.ttl = ttl;
            }
            
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                if (Date.now() - item.timestamp > this.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                return item.data;
            }
            
            set(key, data) {
                this.cache.set(key, { data, timestamp: Date.now() });
            }
            
            clear() {
                this.cache.clear();
            }
        }

        /**
         * Complete API Service Layer - All 32 Backend Endpoints
         */
        class SummitlyAPI {
            constructor(baseURL = '') {
                this.baseURL = baseURL;
                this.cache = new Cache(300000);
                this.activeRequests = new Map();
            }

            async request(endpoint, options = {}, retries = 3, useCache = false) {
                const url = `${this.baseURL}${endpoint}`;
                const cacheKey = `${endpoint}_${JSON.stringify(options.body || {})}`;
                
                // Check cache
                if (useCache && options.method === 'GET' || options.method === 'POST') {
                    const cached = this.cache.get(cacheKey);
                    if (cached) return cached;
                }
                
                // Retry logic
                for (let attempt = 0; attempt < retries; attempt++) {
                    try {
                        const response = await fetch(url, {
                            ...options,
                            headers: {
                                'Content-Type': 'application/json',
                                ...options.headers
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();
                        
                        if (useCache) {
                            this.cache.set(cacheKey, data);
                        }
                        
                        return data;
                    } catch (error) {
                        console.error(`Attempt ${attempt + 1}/${retries} failed:`, error);
                        if (attempt === retries - 1) throw error;
                        await this.sleep(Math.pow(2, attempt) * 1000);
                    }
                }
            }

            sleep(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // ===== INTELLIGENT CHAT ENDPOINTS =====
            async intelligentChatSync(message, sessionId, context = {}) {
                return await this.request('/api/intelligent-chat-sync', {
                    method: 'POST',
                    body: JSON.stringify({ message, session_id: sessionId, context })
                });
            }

            async intelligentChat(message, sessionId) {
                return await this.request('/api/intelligent-chat', {
                    method: 'POST',
                    body: JSON.stringify({ message, session_id: sessionId })
                });
            }

            async intelligentSearch(message) {
                return await this.request('/api/intelligent-search', {
                    method: 'POST',
                    body: JSON.stringify({ message })
                });
            }

            async intelligentReset(sessionId) {
                return await this.request('/api/intelligent-reset', {
                    method: 'POST',
                    body: JSON.stringify({ session_id: sessionId })
                });
            }

            // ===== VOICE & MULTIMODAL ENDPOINTS =====
            async voiceChat(audioBlob, sessionId) {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                formData.append('session_id', sessionId);

                const response = await fetch(`${this.baseURL}/api/voice-chat`, {
                    method: 'POST',
                    body: formData
                });
                return await response.json();
            }

            async multimodalChat(text, files, sessionId) {
                const formData = new FormData();
                formData.append('text', text);
                formData.append('session_id', sessionId);
                
                if (files && files.length > 0) {
                    files.forEach((file) => {
                        if (file.type.startsWith('image/')) {
                            formData.append('images', file);
                        } else if (file.type.startsWith('video/')) {
                            formData.append('video', file);
                        } else if (file.type.startsWith('audio/')) {
                            formData.append('audio', file);
                        }
                    });
                }

                const response = await fetch(`${this.baseURL}/api/multimodal-chat`, {
                    method: 'POST',
                    body: formData
                });
                return await response.json();
            }

            // ===== PROPERTY & LOCATION ENDPOINTS =====
            async propertyAnalysis(mlsNumber, analysisType = 'full') {
                return await this.request('/api/property-analysis', {
                    method: 'POST',
                    body: JSON.stringify({ mls_number: mlsNumber, analysis_type: analysisType })
                });
            }

            async locationInsights(location, radius = 2) {
                return await this.request('/api/location-insights', {
                    method: 'POST',
                    body: JSON.stringify({ location, radius })
                }, 3, true); // Cache location data
            }

            // ===== REPLIERS MLS ENDPOINTS =====
            async repliersNLPSearch(query, filters = {}) {
                return await this.request('/api/repliers-nlp-search', {
                    method: 'POST',
                    body: JSON.stringify({ query, filters })
                }, 3, true);
            }

            async repliersPropertyDetails(mlsId) {
                return await this.request(`/api/repliers-property-details/${mlsId}`, {
                    method: 'GET'
                }, 3, true);
            }

            async repliersEstimate(mlsNumber) {
                return await this.request('/api/repliers-estimate', {
                    method: 'POST',
                    body: JSON.stringify({ mls_number: mlsNumber })
                });
            }

            // ===== MANAGER ENDPOINTS =====
            async getDashboardStats() {
                return await this.request('/api/manager/dashboard-stats', { method: 'GET' });
            }

            async getLeads() {
                return await this.request('/api/manager/leads', { method: 'GET' });
            }

            async getBrokers() {
                return await this.request('/api/manager/brokers', { method: 'GET' }, 3, true);
            }

            async updateLeadStatus(leadId, status) {
                return await this.request('/api/manager/update-lead-status', {
                    method: 'POST',
                    body: JSON.stringify({ lead_id: leadId, status })
                });
            }

            async assignBroker(leadId, brokerId) {
                return await this.request('/api/manager/assign-broker', {
                    method: 'POST',
                    body: JSON.stringify({ lead_id: leadId, broker_id: brokerId })
                });
            }

            // ===== UTILITY ENDPOINTS =====
            async getHealth() {
                return await this.request('/api/health', { method: 'GET' });
            }
        }

        /**
         * Application State Management
         */
        class AppState {
            constructor() {
                this.sessionId = this.generateSessionId();
                this.chatHistory = [];
                this.userProfile = {};
                this.activeProperty = null;
                this.viewMode = 'chat'; // 'chat' | 'dashboard' | 'search'
                this.uploadedFiles = [];
                this.searchFilters = {};
                this.loadFromStorage();
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            addMessage(sender, content, metadata = {}) {
                const message = {
                    sender,
                    content,
                    metadata,
                    timestamp: new Date()
                };
                this.chatHistory.push(message);
                this.saveToStorage();
                return message;
            }

            clearHistory() {
                this.chatHistory = [];
                this.saveToStorage();
            }

            setActiveProperty(property) {
                this.activeProperty = property;
                this.saveToStorage();
            }

            setViewMode(mode) {
                this.viewMode = mode;
            }

            saveToStorage() {
                try {
                    localStorage.setItem('summitly_state', JSON.stringify({
                        sessionId: this.sessionId,
                        chatHistory: this.chatHistory.slice(-50), // Last 50 messages
                        userProfile: this.userProfile,
                        timestamp: Date.now()
                    }));
                } catch (e) {
                    console.warn('Failed to save to localStorage:', e);
                }
            }

            loadFromStorage() {
                try {
                    const saved = localStorage.getItem('summitly_state');
                    if (!saved) return;
                    
                    const state = JSON.parse(saved);
                    if (Date.now() - state.timestamp > 86400000) return; // 24hr expiry
                    
                    this.sessionId = state.sessionId || this.sessionId;
                    this.chatHistory = state.chatHistory || [];
                    this.userProfile = state.userProfile || {};
                } catch (e) {
                    console.warn('Failed to load from localStorage:', e);
                }
            }
        }

        /**
         * File Upload Manager
         */
        class FileUploadManager {
            constructor() {
                this.files = [];
                this.maxSize = 50 * 1024 * 1024; // 50MB
                this.supportedFormats = {
                    image: ['jpg', 'jpeg', 'png', 'gif', 'webp'],
                    video: ['mp4', 'webm', 'mov'],
                    audio: ['mp3', 'wav', 'webm', 'ogg'],
                    document: ['pdf', 'doc', 'docx']
                };
            }

            validateFile(file) {
                if (file.size > this.maxSize) {
                    throw new Error(`File ${file.name} exceeds 50MB limit`);
                }

                const ext = file.name.split('.').pop().toLowerCase();
                const isSupported = Object.values(this.supportedFormats).some(formats => 
                    formats.includes(ext)
                );

                if (!isSupported) {
                    throw new Error(`File type .${ext} is not supported`);
                }

                return true;
            }

            addFile(file) {
                this.validateFile(file);
                this.files.push({
                    file,
                    id: Date.now() + Math.random(),
                    preview: null
                });
            }

            async generatePreview(file) {
                return new Promise((resolve) => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    } else {
                        resolve(null);
                    }
                });
            }

            removeFile(id) {
                this.files = this.files.filter(f => f.id !== id);
            }

            clear() {
                this.files = [];
            }

            getFiles() {
                return this.files.map(f => f.file);
            }
        }

        /**
         * Voice Recording Manager
         */
        class VoiceManager {
            constructor() {
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.stream = null;
                this.isRecording = false;
                this.audioContext = null;
                this.analyser = null;
            }

            async initialize() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    const source = this.audioContext.createMediaStreamSource(this.stream);
                    source.connect(this.analyser);
                    return true;
                } catch (error) {
                    console.error('Microphone access denied:', error);
                    throw new Error('Please enable microphone access to use voice features');
                }
            }

            async startRecording() {
                if (!this.stream) {
                    await this.initialize();
                }

                this.audioChunks = [];
                this.mediaRecorder = new MediaRecorder(this.stream);
                
                this.mediaRecorder.ondataavailable = (event) => {
                    this.audioChunks.push(event.data);
                };

                this.mediaRecorder.start();
                this.isRecording = true;
            }

            async stopRecording() {
                return new Promise((resolve) => {
                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.audioChunks, { type: 'audio/webm' });
                        this.isRecording = false;
                        resolve(blob);
                    };
                    this.mediaRecorder.stop();
                });
            }

            visualize(canvas) {
                if (!this.analyser || !canvas) return;

                const ctx = canvas.getContext('2d');
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);

                const draw = () => {
                    if (!this.isRecording) return;
                    
                    requestAnimationFrame(draw);
                    this.analyser.getByteFrequencyData(dataArray);

                    ctx.fillStyle = '#e8f4f8';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    const barWidth = (canvas.width / bufferLength) * 2.5;
                    let x = 0;

                    for (let i = 0; i < bufferLength; i++) {
                        const barHeight = (dataArray[i] / 255) * canvas.height;
                        ctx.fillStyle = `rgb(51, 128, 141)`;
                        ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                        x += barWidth + 1;
                    }
                };

                draw();
            }

            cleanup() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
                if (this.audioContext) {
                    this.audioContext.close();
                }
            }
        }

        // ==================== GLOBAL STATE ====================
        
        // Initialize core instances
        const api = new SummitlyAPI(getApiBaseUrl());
        const appState = new AppState();
        const fileManager = new FileUploadManager();
        const voiceManager = new VoiceManager();
        
        // Legacy compatibility
        let chatHistory = appState.chatHistory;
        let isRecording = false;
        let currentSessionId = appState.sessionId;

        // Initialize
        function init() {
            adjustTextareaHeight();
            document.getElementById('chatInput').addEventListener('input', adjustTextareaHeight);
        }

        // Generate Session ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Textarea Auto-resize
        function adjustTextareaHeight() {
            const textarea = document.getElementById('chatInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        
        // Toggle Right Panel
        function toggleRightPanel() {
            const rightPanel = document.getElementById('rightPanel');
            const appContainer = document.querySelector('.app-container');
            rightPanel.classList.toggle('active');
            appContainer.classList.toggle('has-right-panel');
        }
        
        // Show Right Panel with Properties
        function showRightPanel() {
            const rightPanel = document.getElementById('rightPanel');
            const appContainer = document.querySelector('.app-container');
            rightPanel.classList.add('active');
            appContainer.classList.add('has-right-panel');
        }
        
        // Hide Right Panel
        function hideRightPanel() {
            const rightPanel = document.getElementById('rightPanel');
            const appContainer = document.querySelector('.app-container');
            rightPanel.classList.remove('active');
            appContainer.classList.remove('has-right-panel');
        }
        
        // Chat History Manager (for sidebar display)
        const chatHistoryManager = {
            sessions: [],
            currentSessionId: null,
            
            init() {
                this.loadFromStorage();
                // Create a new session if none exists or no current session
                if (this.sessions.length === 0 || !this.currentSessionId) {
                    this.createNewSession();
                }
                this.renderHistory();
            },
            
            loadFromStorage() {
                try {
                    const stored = localStorage.getItem('summitly_chat_history');
                    if (stored) {
                        const data = JSON.parse(stored);
                        this.sessions = data.sessions || [];
                        this.currentSessionId = data.currentSessionId || null;
                    }
                } catch (e) {
                    console.error('Error loading chat history:', e);
                    this.sessions = [];
                }
            },
            
            saveToStorage() {
                try {
                    localStorage.setItem('summitly_chat_history', JSON.stringify({
                        sessions: this.sessions,
                        currentSessionId: this.currentSessionId
                    }));
                } catch (e) {
                    console.error('Error saving chat history:', e);
                }
            },
            
            createNewSession() {
                const session = {
                    id: Date.now().toString(),
                    title: 'New Chat',
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                this.sessions.unshift(session);
                this.currentSessionId = session.id;
                this.saveToStorage();
                this.renderHistory();
                return session;
            },
            
            updateSessionTitle(sessionId, title) {
                const session = this.sessions.find(s => s.id === sessionId);
                if (session) {
                    // Use first message as title (truncated)
                    session.title = title.substring(0, 40) + (title.length > 40 ? '...' : '');
                    session.updatedAt = new Date().toISOString();
                    this.saveToStorage();
                    this.renderHistory();
                }
            },
            
            addMessageToSession(sessionId, message) {
                const session = this.sessions.find(s => s.id === sessionId);
                if (session) {
                    session.messages.push(message);
                    session.updatedAt = new Date().toISOString();
                    // Update title if it's the first user message
                    if (message.role === 'user' && session.title === 'New Chat') {
                        this.updateSessionTitle(sessionId, message.content);
                    }
                    this.saveToStorage();
                }
            },
            
            loadSession(sessionId) {
                const session = this.sessions.find(s => s.id === sessionId);
                if (session) {
                    this.currentSessionId = sessionId;
                    this.renderHistory();
                    // Clear chat and reload messages
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages) {
                        chatMessages.innerHTML = '';
                        session.messages.forEach(msg => {
                            if (msg.role === 'user') {
                                addMessage(msg.content, 'user');
                            } else {
                                addMessage(msg.content, 'assistant');
                            }
                        });
                    }
                }
            },
            
            renderHistory() {
                const container = document.getElementById('chatHistoryList');
                if (!container) return;
                
                if (this.sessions.length === 0) {
                    container.innerHTML = `
                        <div class="chat-history-empty">
                            <p>No chat history yet.</p>
                            <p>Start a conversation to see it here!</p>
                        </div>
                    `;
                    return;
                }
                
                // Group by date
                const today = new Date().toDateString();
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                
                let html = '';
                let currentGroup = '';
                
                this.sessions.forEach(session => {
                    const sessionDate = new Date(session.updatedAt).toDateString();
                    let groupLabel = '';
                    
                    if (sessionDate === today) {
                        groupLabel = 'Today';
                    } else if (sessionDate === yesterday) {
                        groupLabel = 'Yesterday';
                    } else {
                        groupLabel = new Date(session.updatedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }
                    
                    if (groupLabel !== currentGroup) {
                        currentGroup = groupLabel;
                        html += `<div class="chat-history-label">${groupLabel}</div>`;
                    }
                    
                    const isActive = session.id === this.currentSessionId ? 'active' : '';
                    html += `
                        <div class="chat-history-item ${isActive}" onclick="chatHistoryManager.loadSession('${session.id}')">
                            <div class="chat-history-item-title">
                                <span class="icon"></span>
                                <span>${session.title}</span>
                            </div>
                            <div class="chat-history-item-meta">
                                ${session.messages.length} messages
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            startNewChat() {
                // Clear current chat
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = '';
                }
                // Reset properties panel
                const propertyCardsContainer = document.getElementById('propertyCardsContainer');
                const rightPanelEmpty = document.getElementById('rightPanelEmpty');
                if (propertyCardsContainer) {
                    propertyCardsContainer.innerHTML = '';
                    propertyCardsContainer.style.display = 'none';
                }
                if (rightPanelEmpty) {
                    rightPanelEmpty.style.display = 'block';
                }
                // Create new session
                this.createNewSession();
                // Show welcome message
                showWelcomeScreen();
                // Close sidebar on mobile
                toggleSidebar();
            }
        };
        
        // Add property to right panel
        function addPropertyToRightPanel(property) {
            const container = document.getElementById('propertyCardsContainer');
            const emptyState = document.getElementById('rightPanelEmpty');
            
            if (!container) return;
            
            // Hide empty state and show container
            if (emptyState) emptyState.style.display = 'none';
            container.style.display = 'flex';
            
            const price = property.listPrice || property.price || 0;
            const address = property.streetAddress || property.address || 'Address unavailable';
            const city = property.city || '';
            const beds = property.bedroomsTotal || property.bedrooms || 0;
            const baths = property.bathroomsTotalInteger || property.bathrooms || 0;
            const sqft = property.sqft || property.square_footage || null;
            const images = property.images || [property.image || 'https://via.placeholder.com/400x200?text=No+Image'];
            const image = images[0] || 'https://via.placeholder.com/400x200?text=No+Image';
            const mls = property.mlsNumber || property.mls || '';
            const cardIndex = container.children.length;
            
            const cardHtml = `
                <div class="property-card-mini" data-mls="${mls}" data-index="${cardIndex}" data-images='${JSON.stringify(images).replace(/'/g, "&apos;")}' data-current-image="0">
                    <div style="position: relative;">
                        <img src="${image}" alt="${address}" class="property-card-mini-image" id="right-panel-img-${cardIndex}" onerror="this.src='https://via.placeholder.com/400x200?text=No+Image'">
                        ${images.length > 1 ? `
                            <button class="image-nav-btn image-nav-btn-prev" onclick="event.stopPropagation(); navigateRightPanelImage(${cardIndex}, -1)" style="position: absolute; left: 8px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;"></button>
                            <button class="image-nav-btn image-nav-btn-next" onclick="event.stopPropagation(); navigateRightPanelImage(${cardIndex}, 1)" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;"></button>
                            <div class="image-counter-badge" id="right-panel-counter-${cardIndex}" style="position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px;">1 / ${images.length}</div>
                        ` : ''}
                    </div>
                    <div class="property-card-mini-content">
                        <div class="property-card-mini-price">$${price.toLocaleString()}</div>
                        <div class="property-card-mini-address">${address}${city ? ', ' + city : ''}</div>
                        <div class="property-card-mini-details">
                            <span> ${beds}</span>
                            <span> ${baths}</span>
                            ${sqft ? `<span> ${sqft.toLocaleString()} sqft</span>` : ''}
                        </div>
                        ${mls ? `<div style="font-size: 11px; color: #888; margin-top: 4px;">MLS: ${mls}</div>` : ''}
                        <div style="display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap;">
                            <button class="btn-small btn-primary" onclick="event.stopPropagation(); openPropertyDetailsPanel('${mls}')" style="font-size: 11px; padding: 6px 10px;">
                                 Details
                            </button>
                            <button class="btn-small btn-primary" onclick="event.stopPropagation(); openAIAnalysisPanel('${mls}', 'property')" style="font-size: 11px; padding: 6px 10px;">
                                 AI
                            </button>
                            <button class="btn-small btn-primary" onclick="event.stopPropagation(); openMarketAnalysisClickHandler('${mls}', this)" style="font-size: 11px; padding: 6px 10px;">
                                 Market
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', cardHtml);
            
            // Show right panel
            showRightPanel();
        }
        
        // Navigate images in right panel property cards
        function navigateRightPanelImage(cardIndex, direction) {
            const container = document.getElementById('propertyCardsContainer');
            const card = container.querySelector(`[data-index="${cardIndex}"]`);
            if (!card) return;
            
            try {
                const images = JSON.parse(card.dataset.images || '[]');
                if (images.length <= 1) return;
                
                let currentIndex = parseInt(card.dataset.currentImage || '0');
                currentIndex = (currentIndex + direction + images.length) % images.length;
                card.dataset.currentImage = currentIndex;
                
                const img = document.getElementById(`right-panel-img-${cardIndex}`);
                const counter = document.getElementById(`right-panel-counter-${cardIndex}`);
                
                if (img) img.src = images[currentIndex];
                if (counter) counter.textContent = `${currentIndex + 1} / ${images.length}`;
            } catch (error) {
                console.error('Error navigating right panel image:', error);
            }
        }
        
        // Clear properties from right panel
        function clearRightPanelProperties() {
            const container = document.getElementById('propertyCardsContainer');
            const emptyState = document.getElementById('rightPanelEmpty');
            
            if (container) {
                container.innerHTML = '';
                container.style.display = 'none';
            }
            if (emptyState) {
                emptyState.style.display = 'block';
            }
        }
        
        // Initialize chat history on page load
        document.addEventListener('DOMContentLoaded', function() {
            chatHistoryManager.init();
        });

        // Handle Enter Key
        function handleKeyPress(event) {
            const suggestionsBox = document.getElementById('autocompleteSuggestions');
            const isVisible = suggestionsBox.classList.contains('show');
            
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (isVisible) {
                    const activeItem = suggestionsBox.querySelector('.suggestion-item.active');
                    if (activeItem) {
                        selectSuggestion(activeItem.dataset.text);
                        return;
                    }
                }
                sendUserMessage();
            } else if (event.key === 'ArrowDown' && isVisible) {
                event.preventDefault();
                navigateSuggestions('down');
            } else if (event.key === 'ArrowUp' && isVisible) {
                event.preventDefault();
                navigateSuggestions('up');
            } else if (event.key === 'Escape' && isVisible) {
                hideSuggestions();
            }
        }

        // Autocomplete Suggestions Data
        const suggestionData = {
            'property': [
                { icon: '', text: 'Show me 2-bedroom condos in Toronto under $800K' },
                { icon: '', text: 'Search for houses in Mississauga with 3+ bedrooms' },
                { icon: '', text: 'Find luxury condos in downtown Vancouver' },
                { icon: '', text: 'Show properties near good schools in Ottawa' }
            ],
            'market': [
                { icon: '', text: 'What are the current market trends in Toronto?' },
                { icon: '', text: 'Show me average home prices in Vancouver' },
                { icon: '', text: 'Market analysis for Calgary real estate' },
                { icon: '', text: 'Investment opportunities in Montreal' }
            ],
            'neighborhood': [
                { icon: '', text: 'Tell me about the Yorkville neighborhood' },
                { icon: '', text: 'Which areas have the best schools?' },
                { icon: '', text: 'Neighborhoods near public transit in Toronto' },
                { icon: '', text: 'Family-friendly neighborhoods in Oakville' }
            ],
            'price': [
                { icon: '', text: 'Properties under $500K in the GTA' },
                { icon: '', text: 'Luxury homes over $2M in Vancouver' },
                { icon: '', text: 'Best value properties in Hamilton' },
                { icon: '', text: 'Price trends for condos in Toronto' }
            ],
            'compare': [
                { icon: '', text: 'Compare Toronto vs Montreal real estate market' },
                { icon: '', text: 'Compare condo prices in downtown vs suburbs' },
                { icon: '', text: 'Investment comparison: Calgary vs Edmonton' }
            ]
        };

        let currentSuggestionIndex = -1;

        // Generate dynamic suggestions based on user input
        function generateDynamicSuggestions(input) {
            const dynamicSuggestions = [];
            const words = input.toLowerCase().split(' ').filter(w => w.length > 0);
            const lastWord = words[words.length - 1] || '';
            
            // City detection
            const cities = ['toronto', 'mississauga', 'brampton', 'ottawa', 'vancouver', 'calgary', 'hamilton', 'oakville', 'burlington', 'kitchener', 'waterloo', 'guelph', 'kingston', 'london', 'windsor', 'montreal'];
            const detectedCity = words.find(w => cities.some(city => city.startsWith(w) && w.length >= 3));
            const fullCity = detectedCity ? cities.find(c => c.startsWith(detectedCity)) : null;
            const cityCapitalized = fullCity ? fullCity.charAt(0).toUpperCase() + fullCity.slice(1) : null;
            
            // Property type detection
            const propertyTypes = ['condo', 'house', 'townhouse', 'detached', 'semi', 'apartment', 'bungalow'];
            const detectedType = words.find(w => propertyTypes.some(type => type.includes(w) || w.includes(type)));
            
            // Price detection
            const hasPriceIntent = words.some(w => ['under', 'below', 'less', 'over', 'above', 'budget', 'afford', 'cheap', 'expensive', 'luxury'].includes(w));
            const hasPrice = input.match(/\$?\d+[km]?/i);
            
            // Bedroom detection
            const bedroomMatch = input.match(/(\d)\s*(?:bed|bedroom|br)/i);
            const bedrooms = bedroomMatch ? bedroomMatch[1] : null;
            
            // Generate contextual completions
            if (cityCapitalized) {
                if (bedrooms) {
                    dynamicSuggestions.push({ icon: '', text: `Show me ${bedrooms}-bedroom homes in ${cityCapitalized}` });
                    dynamicSuggestions.push({ icon: '', text: `Find ${bedrooms}-bedroom condos in ${cityCapitalized} under $800K` });
                } else if (detectedType) {
                    const typeCapitalized = detectedType.charAt(0).toUpperCase() + detectedType.slice(1);
                    dynamicSuggestions.push({ icon: '', text: `Search for ${typeCapitalized}s in ${cityCapitalized}` });
                    dynamicSuggestions.push({ icon: '', text: `${typeCapitalized}s in ${cityCapitalized} under $700K` });
                } else {
                    dynamicSuggestions.push({ icon: '', text: `Show me homes for sale in ${cityCapitalized}` });
                    dynamicSuggestions.push({ icon: '', text: `Find condos in ${cityCapitalized}` });
                    dynamicSuggestions.push({ icon: '', text: `What are market trends in ${cityCapitalized}?` });
                    dynamicSuggestions.push({ icon: '', text: `Best neighborhoods in ${cityCapitalized}` });
                }
            } else if (bedrooms) {
                dynamicSuggestions.push({ icon: '', text: `${bedrooms}-bedroom homes in Toronto` });
                dynamicSuggestions.push({ icon: '', text: `${bedrooms}-bedroom condos under $600K` });
                dynamicSuggestions.push({ icon: '', text: `Find ${bedrooms}-bedroom properties near me` });
            } else if (hasPriceIntent || hasPrice) {
                dynamicSuggestions.push({ icon: '', text: 'Properties under $500K in the GTA' });
                dynamicSuggestions.push({ icon: '', text: 'Homes between $500K and $800K' });
                dynamicSuggestions.push({ icon: '', text: 'Luxury properties over $1.5M' });
            }
            
            return dynamicSuggestions;
        }

        // Handle Input Change
        function handleInputChange(event) {
            const input = event.target.value.toLowerCase().trim();
            const suggestionsBox = document.getElementById('autocompleteSuggestions');
            
            // Only show suggestions if user is typing a real estate query
            if (input.length < 3) {
                hideSuggestions();
                return;
            }

            // First try dynamic suggestions based on user input
            let suggestions = generateDynamicSuggestions(input);
            
            // If no dynamic suggestions, use filtered static suggestions
            if (suggestions.length === 0) {
                let allSuggestions = [
                    ...suggestionData.property,
                    ...suggestionData.market,
                    ...suggestionData.price,
                    ...suggestionData.neighborhood,
                    ...suggestionData.compare
                ];
                
                // Filter suggestions that match what user is typing
                suggestions = allSuggestions.filter(item => {
                    const text = item.text.toLowerCase();
                    const words = input.split(' ');
                    // Check if any word in the input matches words in the suggestion
                    return words.some(word => word.length > 2 && text.includes(word));
                });
                
                // If no matches, check for keyword categories
                if (suggestions.length === 0) {
                    if (input.includes('property') || input.includes('home') || input.includes('house') || input.includes('condo') || input.includes('search') || input.includes('find') || input.includes('show')) {
                        suggestions = suggestionData.property.slice(0, 3);
                    } else if (input.includes('market') || input.includes('trend') || input.includes('price') || input.includes('cost')) {
                        suggestions = [...suggestionData.market.slice(0, 2), ...suggestionData.price.slice(0, 1)];
                    } else if (input.includes('neighborhood') || input.includes('area') || input.includes('school') || input.includes('transit')) {
                        suggestions = suggestionData.neighborhood.slice(0, 3);
                    }
                }
            }
            
            // Limit to top 5 suggestions
            suggestions = suggestions.slice(0, 5);

            if (suggestions.length > 0) {
                showSuggestions(suggestions);
            } else {
                hideSuggestions();
            }
        }

        // Show Suggestions
        function showSuggestions(suggestions) {
            const suggestionsBox = document.getElementById('autocompleteSuggestions');
            currentSuggestionIndex = -1;
            
            suggestionsBox.innerHTML = suggestions.map((item, index) => `
                <div class="suggestion-item" onclick="selectSuggestion('${item.text.replace(/'/g, "\\'")}')" data-text="${item.text}" data-index="${index}">
                    <span class="suggestion-icon">${item.icon}</span>
                    <span class="suggestion-text">${item.text}</span>
                </div>
            `).join('');
            
            suggestionsBox.classList.add('show');
        }

        // Hide Suggestions
        function hideSuggestions() {
            const suggestionsBox = document.getElementById('autocompleteSuggestions');
            suggestionsBox.classList.remove('show');
            currentSuggestionIndex = -1;
        }

        // Navigate Suggestions with Arrow Keys
        function navigateSuggestions(direction) {
            const suggestionsBox = document.getElementById('autocompleteSuggestions');
            const items = suggestionsBox.querySelectorAll('.suggestion-item');
            
            if (items.length === 0) return;
            
            // Remove active class from current item
            if (currentSuggestionIndex >= 0 && currentSuggestionIndex < items.length) {
                items[currentSuggestionIndex].classList.remove('active');
            }
            
            // Update index
            if (direction === 'down') {
                currentSuggestionIndex = (currentSuggestionIndex + 1) % items.length;
            } else {
                currentSuggestionIndex = currentSuggestionIndex <= 0 ? items.length - 1 : currentSuggestionIndex - 1;
            }
            
            // Add active class to new item
            items[currentSuggestionIndex].classList.add('active');
            items[currentSuggestionIndex].scrollIntoView({ block: 'nearest' });
        }

        // Select Suggestion
        function selectSuggestion(text) {
            const input = document.getElementById('chatInput');
            input.value = text;
            hideSuggestions();
            input.focus();
        }

        // Close suggestions when clicking outside
        document.addEventListener('click', function(event) {
            const suggestionsBox = document.getElementById('autocompleteSuggestions');
            const chatInput = document.getElementById('chatInput');
            
            if (!suggestionsBox.contains(event.target) && event.target !== chatInput) {
                hideSuggestions();
            }
        });

        // ==================== ENHANCED MESSAGE HANDLING ====================

        /**
         * Send User Message (with file support)
         */
        function sendUserMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const files = fileManager.getFiles();
            
            // If files attached, use multimodal
            if (files.length > 0) {
                sendMultimodalMessage();
                return;
            }
            
            if (!message) return;
            
            sendMessage(message);
            input.value = '';
            adjustTextareaHeight();
        }

        /**
         * Send Message (main function)
         */
        function sendMessage(message) {
            // Hide autocomplete suggestions immediately
            hideSuggestions();
            
            // Hide welcome screen
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
            
            // Hide trending prompts
            const trendingPrompts = document.getElementById('trendingPromptsSection');
            if (trendingPrompts) {
                trendingPrompts.style.display = 'none';
            }

            // Add user message to UI
            addMessage('user', message);
            appState.addMessage('user', message);
            
            // Save to chat history manager
            if (chatHistoryManager.currentSessionId) {
                chatHistoryManager.addMessageToSession(chatHistoryManager.currentSessionId, {
                    role: 'user',
                    content: message,
                    timestamp: new Date().toISOString()
                });
            }

            // Detect if this is a property search query
            const isPropertySearch = /\b(properties|homes|houses|condos|listings|show me|find|search)\b/i.test(message) &&
                                    /\b(in|near|at|around|for sale|for rent|to buy)\b/i.test(message);
            
            // Show appropriate loading indicator
            if (isPropertySearch) {
                console.log(' Property search detected - showing market stats loader');
                showMarketStatsLoader();
            } else {
                showTypingIndicator();
            }

            // Call AI API with enhanced error handling
            handleAIResponseWithErrorBoundary(message);
        }

        /**
         * Enhanced Message Rendering
         */
        function addMessage(sender, content, options = {}) {
            console.log(' addMessage called:', { sender, contentLength: content?.length, hasHTML: content?.includes('<div'), openai: options.openai });
            
            const container = document.getElementById('chatContainer');
            if (!container) {
                console.error(' chatContainer not found!');
                return;
            }
            
            const message = document.createElement('div');
            message.className = 'message';
            
            const isUser = sender === 'user';
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Save AI messages to chat history (user messages are saved in sendMessage)
            if (!isUser && chatHistoryManager.currentSessionId) {
                chatHistoryManager.addMessageToSession(chatHistoryManager.currentSessionId, {
                    role: 'assistant',
                    content: content.substring(0, 500), // Save truncated version for history display
                    timestamp: new Date().toISOString()
                });
            }
            
            // Determine AI provider label
            let aiLabel = 'Summitly AI';
            let badgeHTML = '';
            let contentClass = 'message-content';
            
            if (!isUser) {
                if (options.openai) {
                    // Remove AI Enhanced badge - just use standard styling
                    contentClass += ' openai-enhanced';
                    console.log(' Using OpenAI for message');
                } else if (options.exa) {
                    aiLabel = 'Summitly AI (Research Mode)';
                } else if (options.llama) {
                    aiLabel = 'Summitly AI (Local Model)';
                }
            }
            
            message.innerHTML = `
                <div class="message-avatar ${isUser ? 'user-avatar' : 'ai-avatar'}">
                    ${isUser ? 'U' : ''}
                </div>
                <div class="${contentClass}">
                    <div class="message-header">
                        <span class="message-author">${isUser ? 'You' : aiLabel}</span>
                        ${badgeHTML}
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text"></div>
                    ${options.quickReplies ? generateQuickReplies(options.quickReplies) : ''}
                    ${options.properties ? generatePropertyCards(options.properties) : ''}
                    ${options.sources ? generateSourceLinks(options.sources) : ''}
                </div>
            `;
            
            // CRITICAL FIX: Set content as innerHTML to render HTML (photos, cards, etc.)
            const messageTextDiv = message.querySelector('.message-text');
            if (messageTextDiv) {
                // Enhance text responses for better visual appeal
                const enhancedContent = enhanceTextResponse(content, !isUser);
                messageTextDiv.innerHTML = enhancedContent;
                console.log(' Enhanced content rendered:', enhancedContent.includes('<h3') ? 'Enhanced with formatting' : enhancedContent.includes('<div') ? 'Contains HTML' : 'Plain text');
            }
            
            container.appendChild(message);
            console.log(' Message added to DOM');
            scrollToBottom();
        }

        /**
         * File Upload Integration
         */
        function showFileUpload() {
            const input = document.getElementById('fileInput');
            if (!input) {
                const newInput = document.createElement('input');
                newInput.type = 'file';
                newInput.id = 'fileInput';
                newInput.multiple = true;
                newInput.accept = 'image/*,video/*,.pdf,.doc,.docx';
                newInput.style.display = 'none';
                newInput.onchange = (e) => handleFileUpload(Array.from(e.target.files));
                document.body.appendChild(newInput);
                newInput.click();
            } else {
                input.click();
            }
        }

        /**
         * Drag and Drop Support
         */
        function setupDragDrop() {
            const inputArea = document.querySelector('.input-area');
            if (!inputArea) return;

            inputArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                inputArea.style.background = 'rgba(51, 128, 141, 0.1)';
            });

            inputArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                inputArea.style.background = '';
            });

            inputArea.addEventListener('drop', (e) => {
                e.preventDefault();
                inputArea.style.background = '';
                const files = Array.from(e.dataTransfer.files);
                handleFileUpload(files);
            });
        }

        /**
         * Keyboard Shortcuts
         */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Cmd/Ctrl + K: Focus search/input
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('chatInput')?.focus();
                }

                // Cmd/Ctrl + D: Toggle Dashboard
                if ((e.metaKey || e.ctrlKey) && e.key === 'd') {
                    e.preventDefault();
                    toggleDashboard();
                }

                // Cmd/Ctrl + N: New Chat
                if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                    e.preventDefault();
                    startNewChat();
                }

                // Cmd/Ctrl + U: Upload File
                if ((e.metaKey || e.ctrlKey) && e.key === 'u') {
                    e.preventDefault();
                    showFileUpload();
                }

                // Cmd/Ctrl + Shift + V: Voice Input
                if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'v') {
                    e.preventDefault();
                    openVoiceModal();
                }
            });
        }

        /**
         * Enhanced Initialization
         */
        function init() {
            // FIRST PRIORITY: Check if user name exists - hide modal if they're a returning user
            const userName = localStorage.getItem('summitly_user_name');
            const modal = document.getElementById('welcomeModal');
            
            if (userName) {
                // Returning user - hide the modal immediately
                if (modal) {
                    modal.style.display = 'none';
                }
                console.log(' Welcome back,', userName);
                // Update welcome message with user's name
                setTimeout(() => {
                    const titleElement = document.getElementById('welcomeTitle');
                    if (titleElement) {
                        titleElement.innerHTML = `Welcome back, ${userName}! <br><span style="font-size: 20px; font-weight: 400;">Your AI Real Estate Assistant</span>`;
                    }
                }, 100);
            } else {
                // First-time user - modal is already visible by default
                console.log(' First visit - Welcome modal shown');
            }
            
            // Initialize other components
            adjustTextareaHeight();
            document.getElementById('chatInput').addEventListener('input', adjustTextareaHeight);
            setupDragDrop();
            setupKeyboardShortcuts();
            
            // Check system health
            checkSystemHealth();
        }

        /**
         * Check System Health
         */
        async function checkSystemHealth() {
            try {
                const health = await api.getHealth();
                if (health.status === 'healthy') {
                    console.log(' All systems operational');
                }
            } catch (error) {
                console.warn(' Some services may be unavailable');
            }
        }

        /**
         * Start New Chat
         */
        function startNewChat() {
            if (confirm('Start a new conversation? Current chat will be saved.')) {
                appState.clearHistory();
                chatHistory = [];
                document.getElementById('chatContainer').innerHTML = `
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon"></div>
                        <h1 class="welcome-title">Welcome to Summitly AI</h1>
                        <p class="welcome-subtitle">
                            Your intelligent real estate assistant powered by Llama 3.2, Exa AI, and live MLS data.
                        </p>
                    </div>
                `;
                appState.sessionId = appState.generateSessionId();
                currentSessionId = appState.sessionId;
                
                // Clear right panel properties
                clearRightPanelProperties();
                
                // Create new chat history session
                chatHistoryManager.createNewSession();
                
                // Close sidebar on mobile
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if (sidebar && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                }
                
                init();
            }
        }

        // DUPLICATE FUNCTION REMOVED - Using the enhanced version at line 3762

        // Generate or retrieve persistent user ID for context tracking
        function getUserId() {
            let userId = localStorage.getItem('summitly_user_id');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('summitly_user_id', userId);
                console.log(' Generated new user ID:', userId);
            }
            return userId;
        }

        // Enhanced AI response handler with GPT-5-nano powered chatbot (Feature 2)
        async function handleAIResponse(userMessage) {
            try {
                // Call GPT-5-nano enhanced API endpoint (with rental/sale detection fix)
                const response = await fetch(`${getApiBaseUrl()}/api/chat-gpt4`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: getUserId(),
                        message: userMessage
                    })
                });

                const data = await response.json();
                
                // Hide typing indicator and market stats loader
                hideTypingIndicator();
                hideMarketStatsLoader();
                
                console.log(' Context-Aware API Response:', data);

                // Handle context-aware response format
                if (data.response) {
                    // NEW: Check if this is a valuation request from orchestrator
                    if (data.intent === 'valuation' && data.mls_number) {
                        console.log(' Valuation request detected - MLS:', data.mls_number);
                        
                        // The intelligent-chat endpoint already returns structured valuation data
                        console.log(' Using structured valuation data from chat response:', data.structured_data);
                        
                        // Check if we have structured valuation data to render a card
                        if (data.response_type === 'valuation' && data.structured_data) {
                            // Use the structured data to render valuation card
                            const valuationHTML = renderValuationCard(data);
                            addMessage('ai', valuationHTML, {
                                quickReplies: data.predicted_questions || [],
                                openai: true
                            });
                        } else {
                            // Fallback: Use the pre-formatted HTML response from backend
                            addMessage('ai', data.response, {
                                quickReplies: data.predicted_questions || [],
                                openai: true
                            });
                        }
                    } 
                    // Check if this response includes property results
                    else if (data.properties && Array.isArray(data.properties) && data.properties.length > 0) {
                        console.log(' Context-aware property search - showing results');
                        console.log(' [CITY DEBUG] API response data keys:', Object.keys(data));
                        console.log(' [CITY DEBUG] data.city:', data.city);
                        console.log(' [CITY DEBUG] data.location:', data.location);
                        console.log(' [CITY DEBUG] data.filters:', data.filters);
                        console.log(' [CITY DEBUG] data.filters?.city:', data.filters?.city);
                        console.log(' [CITY DEBUG] data.state_summary:', data.state_summary);
                        
                        // Extract city from filters or state_summary
                        let searchCity = data.city || data.location || data.filters?.city || data.filters?.location;
                        
                        // If still not found, try to extract from state_summary or message
                        if (!searchCity && data.state_summary && typeof data.state_summary === 'string') {
                            const cityMatch = data.state_summary.match(/in ([A-Z][a-z]+(?:\s[A-Z][a-z]+)?)/i);
                            if (cityMatch) {
                                searchCity = cityMatch[1];
                                console.log(' [CITY DEBUG] Extracted from state_summary:', searchCity);
                            }
                        }
                        
                        console.log(' [CITY DEBUG] FINAL searchCity:', searchCity);
                        
                        // Use suggestions from backend (supports both field names for backward compatibility)
                        const suggestions = data.suggestions || data.predicted_questions || data.quick_replies || [];
                        
                        // Get total count from backend response
                        const totalCount = data.total_count || data.count || data.total || null;
                        console.log(' [TOTAL COUNT] From backend:', totalCount);
                        
                        addPropertySearchMessage(data.properties, data.response, suggestions, searchCity, totalCount);
                    } else {
                        // Display AI response (text only)
                        // Use suggestions from backend (supports both field names)
                        const suggestions = data.suggestions || data.predicted_questions || data.quick_replies || [];
                        addMessage('ai', data.response, {
                            quickReplies: suggestions,
                            openai: true
                        });
                    }
                    
                    // Display suggestions/predicted questions as quick-reply buttons
                    // Backend sends 'suggestions', but also support legacy field names
                    const suggestions = data.suggestions || data.predicted_questions || data.quick_replies || [];
                    if (suggestions && suggestions.length > 0) {
                        console.log(' Suggestions from GPT-4:', suggestions);
                        displayQuickReplies(suggestions);
                    }
                    
                    // Update engagement indicator
                    if (data.engagement_level !== undefined) {
                        console.log(' Engagement level:', data.engagement_level);
                        updateEngagementIndicator(data.engagement_level);
                    }
                    
                    // Display suggested actions
                    if (data.suggested_actions && data.suggested_actions.length > 0) {
                        console.log(' Suggested actions:', data.suggested_actions);
                        displaySuggestedActions(data.suggested_actions);
                    }
                    
                    // Display extracted preferences (optional)
                    if (data.search_context) {
                        console.log(' Search context:', data.search_context);
                        updatePreferencesDisplay(data.search_context);
                    }
                } else if (data.success) {
                    // Fallback to old format if using intelligent-chat-sync endpoint
                    // Extract AI provider flags
                    const isOpenAI = data.openai_enhanced || false;
                    const isExa = data.exa_enhanced || false;
                    const isLlama = data.llama_fallback || false;
                    
                    // Log which AI was used
                    if (isOpenAI) {
                        console.log(' OpenAI-enhanced response detected');
                    } else if (isExa) {
                        console.log(' Exa-enhanced response detected');
                    } else if (isLlama) {
                        console.log(' Llama fallback response detected');
                    }
                    
                    // Check if this is a valuation response with structured data
                    if (data.response_type === 'valuation' && data.structured_data) {
                        console.log(' Rendering beautiful valuation card with AI estimate');
                        
                        // Use new beautiful card renderer
                        const valuationHTML = renderValuationCard(data);
                        
                        addMessage('ai', valuationHTML, {
                            quickReplies: data.quick_replies || [],
                            openai: isOpenAI,
                            exa: isExa,
                            llama: isLlama
                        });
                    } 
                    // Check if this is a property search response with properties array
                    else if (data.properties && Array.isArray(data.properties) && data.properties.length > 0) {
                        console.log(' Rendering property search results');
                        const suggestions = data.suggestions || data.quick_replies || data.predicted_questions || [];
                        const totalCount = data.total_count || data.count || data.total || null;
                        const searchCity = data.city || data.location || data.filters?.city || null;
                        addPropertySearchMessage(data.properties, data.response, suggestions, searchCity, totalCount);
                    }
                    // Check if response contains EXA results (market analysis, etc.)
                    else if (data.exa_results && data.exa_results.length > 0) {
                        console.log(' Rendering EXA results with AI summary');
                        await renderExaResultsWithSummary(data, userMessage);
                    }
                    else {
                        // Regular message response (including property details with HTML)
                        console.log(' Rendering regular message', data.response ? 'with content' : 'empty');
                        console.log(' Response contains HTML:', data.response.includes('<div'));
                        
                        // Check if response contains URLs for summary generation
                        const urlRegex = /https?:\/\/[^\s]+/g;
                        const urls = data.response.match(urlRegex);
                        
                        if (urls && urls.length > 2 && shouldGenerateSummary(userMessage)) {
                            // Generate AI summary for responses with multiple URLs
                            await addMessageWithExaSummary(data.response, userMessage, urls, data.quick_replies || []);
                        } else {
                            console.log(' Regular OpenAI response - About to call addMessage:', {
                                length: data.response.length,
                                preview: data.response.substring(0, 200) + '...',
                                containsSchools: data.response.includes('schools'),
                                containsSchoolsLower: data.response.toLowerCase().includes('schools'),
                                containsType: data.response.includes('Type:'),
                                containsRating: data.response.includes('Rating:'),
                                containsAddress: data.response.includes('Address:'),
                                isOpenAI: isOpenAI,
                                firstLine: data.response.split('\n')[0],
                                fullResponseForDebug: data.response // Show full response to debug content
                            });
                            
                            addMessage('ai', data.response, {
                                quickReplies: data.quick_replies || [],
                                openai: isOpenAI,
                                exa: isExa,
                                llama: isLlama
                            });
                            
                            console.log(' addMessage called for regular OpenAI response');
                        }
                    }
                } else {
                    console.log(' API returned error:', data.error);
                    addMessage('ai', data.error || 'Sorry, I encountered an error processing your request.');
                }
            } catch (error) {
                console.error('Error calling API:', error);
                hideTypingIndicator();
                hideMarketStatsLoader();
                
                // Enhanced error handling for production
                let errorMessage = 'Sorry, I\'m having trouble connecting to the server. Please try again.';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMessage = ' Connection issue. Please check your internet connection and try again.';
                } else if (error.message.includes('500')) {
                    errorMessage = ' Our AI service is temporarily unavailable. We\'re working to fix this quickly!';
                } else if (error.message.includes('timeout')) {
                    errorMessage = ' Request timed out. The AI is taking longer than usual - please try again.';
                }
                
                addMessage('ai', errorMessage);
                
                // Log error for production monitoring
                console.log(' Production Error Details:', {
                    error: error.message,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                });
            }
        }

        // ============================================================================
        // FEATURE 2: CONVERSATION CONTEXT PERSISTENCE - UI COMPONENTS
        // ============================================================================

        // Display quick-reply buttons for predicted questions
        function displayQuickReplies(questions) {
            const existingReplies = document.querySelector('.quick-replies');
            if (existingReplies) existingReplies.remove();
            if (!questions || questions.length === 0) return;
            
            const quickReplyContainer = document.createElement('div');
            quickReplyContainer.className = 'quick-replies';
            quickReplyContainer.style.cssText = `display: flex; gap: 8px; padding: 12px; flex-wrap: wrap; justify-content: center; margin-top: 12px; animation: slideUp 0.3s ease-out;`;
            
            questions.forEach(question => {
                const button = document.createElement('button');
                button.className = 'quick-reply-btn';
                button.textContent = question;
                button.style.cssText = `background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);`;
                
                button.addEventListener('mouseover', () => {
                    button.style.transform = 'translateY(-2px)';
                    button.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.3)';
                });
                
                button.addEventListener('mouseout', () => {
                    button.style.transform = 'translateY(0)';
                    button.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.2)';
                });
                
                button.addEventListener('click', () => {
                    const chatInput = document.querySelector('#chat-input') || document.querySelector('.chat-input input');
                    if (chatInput) {
                        chatInput.value = question;
                        const sendBtn = document.querySelector('.send-btn') || document.querySelector('button[onclick*="sendMessage"]');
                        if (sendBtn) sendBtn.click();
                    }
                });
                
                quickReplyContainer.appendChild(button);
            });
            
            const chatMessages = document.querySelector('.chat-messages') || document.querySelector('#chatMessages');
            if (chatMessages) {
                chatMessages.appendChild(quickReplyContainer);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Update engagement indicator
        function updateEngagementIndicator(level) {
            let indicator = document.querySelector('.engagement-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'engagement-indicator';
                indicator.style.cssText = `position: fixed; top: 80px; right: 20px; background: white; padding: 12px 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1000; transition: all 0.3s ease;`;
                document.body.appendChild(indicator);
            }
            
            let emoji, text, color;
            if (level >= 9) { emoji = ''; text = 'Hot Lead!'; color = '#ff4757'; }
            else if (level >= 7) { emoji = ''; text = 'Highly Engaged'; color = '#ffa502'; }
            else if (level >= 5) { emoji = ''; text = 'Engaged'; color = '#1976D2'; }
            else if (level >= 3) { emoji = ''; text = 'Exploring'; color = '#2ed573'; }
            else { emoji = ''; text = 'Browsing'; color = '#94a3b8'; }
            
            indicator.innerHTML = `<div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 20px;">${emoji}</span><div><div style="font-weight: 600; font-size: 12px; color: ${color};">${text}</div><div style="font-size: 10px; color: #64748b;">Engagement: ${level}/10</div></div></div>`;
        }

        // Display suggested actions
        function displaySuggestedActions(actions) {
            const existingActions = document.querySelector('.suggested-actions');
            if (existingActions) existingActions.remove();
            if (!actions || actions.length === 0) return;
            
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'suggested-actions';
            actionsContainer.style.cssText = `display: flex; gap: 12px; padding: 16px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 12px; margin: 16px 12px;`;
            
            actions.forEach(action => {
                const actionBtn = document.createElement('button');
                actionBtn.innerHTML = `<span style="margin-right: 6px;">${getActionIcon(action.action)}</span>${action.label}`;
                actionBtn.style.cssText = `background: white; border: 2px solid #667eea; color: #667eea; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s ease; flex: 1;`;
                
                actionBtn.addEventListener('mouseover', () => { actionBtn.style.background = '#667eea'; actionBtn.style.color = 'white'; });
                actionBtn.addEventListener('mouseout', () => { actionBtn.style.background = 'white'; actionBtn.style.color = '#667eea'; });
                actionBtn.addEventListener('click', () => handleSuggestedAction(action));
                
                actionsContainer.appendChild(actionBtn);
            });
            
            const chatMessages = document.querySelector('.chat-messages') || document.querySelector('#chatMessages');
            if (chatMessages) chatMessages.appendChild(actionsContainer);
        }

        function getActionIcon(actionType) {
            const icons = {'search': '', 'broker': '', 'valuation': '', 'comparison': '', 'filter': '', 'neighborhood': ''};
            return icons[actionType] || '';
        }

        function handleSuggestedAction(action) {
            console.log(' Action clicked:', action);
            const chatInput = document.querySelector('#chat-input') || document.querySelector('.chat-input input');
            const sendBtn = document.querySelector('.send-btn');
            
            switch(action.action) {
                case 'search':
                    const searchTab = document.querySelector('#search-tab') || document.querySelector('[data-tab="search"]');
                    if (searchTab) searchTab.click();
                    break;
                case 'broker':
                    if (chatInput) { chatInput.value = 'I want to connect with a broker'; if (sendBtn) sendBtn.click(); }
                    break;
                case 'valuation':
                    if (chatInput) { chatInput.value = 'I want a property valuation'; if (sendBtn) sendBtn.click(); }
                    break;
                default:
                    if (chatInput) { chatInput.value = action.label; if (sendBtn) sendBtn.click(); }
            }
        }

        function updatePreferencesDisplay(preferences) {
            let prefsPanel = document.querySelector('.preferences-panel');
            if (!prefsPanel) {
                prefsPanel = document.createElement('div');
                prefsPanel.className = 'preferences-panel';
                prefsPanel.style.cssText = `position: fixed; top: 160px; right: 20px; background: white; padding: 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); max-width: 250px; z-index: 1000;`;
                document.body.appendChild(prefsPanel);
            }
            
            let html = '<div style="font-weight: 600; margin-bottom: 12px; color: #1a1a1a; font-size: 14px;">Your Preferences</div>';
            if (preferences.locations && preferences.locations.length > 0) {
                html += `<div style="margin-bottom: 8px;"><span style="color: #64748b; font-size: 12px;"> Locations:</span><br/><span style="font-size: 13px; color: #1a1a1a;">${preferences.locations.join(', ')}</span></div>`;
            }
            if (preferences.property_types && preferences.property_types.length > 0) {
                html += `<div style="margin-bottom: 8px;"><span style="color: #64748b; font-size: 12px;"> Types:</span><br/><span style="font-size: 13px; color: #1a1a1a;">${preferences.property_types.join(', ')}</span></div>`;
            }
            if (preferences.price_ranges && preferences.price_ranges.length > 0) {
                const range = preferences.price_ranges[0];
                const priceText = range.max ? `Up to $${(range.max/1000).toFixed(0)}k` : range.min ? `From $${(range.min/1000).toFixed(0)}k` : '';
                if (priceText) html += `<div style="margin-bottom: 8px;"><span style="color: #64748b; font-size: 12px;"> Budget:</span><br/><span style="font-size: 13px; color: #1a1a1a;">${priceText}</span></div>`;
            }
            if (preferences.bedrooms_ranges && preferences.bedrooms_ranges.length > 0) {
                html += `<div style="margin-bottom: 8px;"><span style="color: #64748b; font-size: 12px;"> Bedrooms:</span><br/><span style="font-size: 13px; color: #1a1a1a;">${preferences.bedrooms_ranges.join(', ')}</span></div>`;
            }
            prefsPanel.innerHTML = html;
        }

        if (!document.getElementById('context-animations')) {
            const style = document.createElement('style');
            style.id = 'context-animations';
            style.textContent = `@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }`;
            document.head.appendChild(style);
        }

        // ============================================================================
        // END FEATURE 2 UI COMPONENTS
        // ============================================================================

        /**
         * Enhanced AI Response Handler with Error Boundaries and Performance Monitoring
         */
        async function handleAIResponseWithErrorBoundary(userMessage) {
            const startTime = Date.now();
            let responseType = 'unknown';
            
            try {
                // Validate input
                if (!userMessage || userMessage.trim().length === 0) {
                    throw new Error('Empty message provided');
                }
                
                if (userMessage.length > 2000) {
                    showToast('Message too long. Please keep it under 2000 characters.', 'warning');
                    hideTypingIndicator();
                    return;
                }
                
                // Check for rate limiting (simple client-side)
                const now = Date.now();
                const lastRequest = localStorage.getItem('lastRequestTime');
                if (lastRequest && (now - parseInt(lastRequest)) < 1000) {
                    showToast('Please wait a moment between messages', 'warning');
                    hideTypingIndicator();
                    return;
                }
                localStorage.setItem('lastRequestTime', now.toString());
                
                // Set appropriate loading indicator based on message content
                const messageLower = userMessage.toLowerCase();
                if (messageLower.includes('search') || messageLower.includes('find') || messageLower.includes('properties')) {
                    showSearchingIndicator();
                    responseType = 'property_search';
                } else if (messageLower.includes('value') || messageLower.includes('worth') || messageLower.includes('price')) {
                    showTypingIndicator('Calculating property valuation...');
                    responseType = 'valuation';
                } else if (messageLower.includes('mls') || /[A-Z]\d{7,8}/.test(userMessage)) {
                    showLoadingPropertyDetails();
                    responseType = 'property_details';
                } else {
                    showTypingIndicator();
                    responseType = 'general_chat';
                }
                
                // Call the original AI response handler
                const result = await handleAIResponse(userMessage);
                
                // Performance monitoring
                const responseTime = Date.now() - startTime;
                if (responseTime > 10000) { // 10 seconds
                    console.warn(`Slow response detected: ${responseTime}ms for ${responseType}`);
                }
                
                // Log successful interaction
                console.log(` AI Response completed: ${responseType} in ${responseTime}ms`);
                
                return result;
                
            } catch (error) {
                console.error(' Error in AI response handler:', error);
                hideTypingIndicator();
                hideMarketStatsLoader();
                
                // Categorize errors and provide appropriate user feedback
                let userMessage = 'I encountered an error processing your request.';
                let logLevel = 'error';
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    userMessage = ' Unable to connect to our AI service. Please check your internet connection and try again.';
                    logLevel = 'warn';
                } else if (error.message.includes('429')) {
                    userMessage = ' Too many requests. Please wait a moment and try again.';
                    logLevel = 'warn';
                } else if (error.message.includes('500') || error.message.includes('502') || error.message.includes('503')) {
                    userMessage = ' Our AI service is temporarily unavailable. We\'re working to fix this quickly!';
                } else if (error.message.includes('timeout')) {
                    userMessage = ' The request timed out. Our AI is taking longer than usual - please try again.';
                } else if (error.message.includes('Empty message')) {
                    userMessage = ' Please enter a message before sending.';
                    logLevel = 'warn';
                }
                
                // Show user-friendly error message
                addMessage('ai', userMessage, {
                    quickReplies: ['Try again', 'Contact support', 'Search properties', 'Get help']
                });
                
                showToast('Request failed - please try again', 'error');
                
                // Log error details for monitoring
                const errorLog = {
                    error: error.message,
                    stack: error.stack,
                    responseType: responseType,
                    responseTime: Date.now() - startTime,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    sessionId: currentSessionId
                };
                
                console[logLevel](' Error Details:', errorLog);
                
                // Store error for potential reporting
                try {
                    const errors = JSON.parse(localStorage.getItem('chatErrors') || '[]');
                    errors.push(errorLog);
                    // Keep only last 10 errors
                    localStorage.setItem('chatErrors', JSON.stringify(errors.slice(-10)));
                } catch (storageError) {
                    console.warn('Failed to store error log:', storageError);
                }
            }
        }

        /**
         * Check if message should trigger EXA summary generation
         */
        function shouldGenerateSummary(message) {
            const summaryKeywords = ['market', 'analysis', 'trends', 'research', 'compare', 'investment', 'roi', 'neighborhood'];
            return summaryKeywords.some(keyword => message.toLowerCase().includes(keyword));
        }

        /**
         * Render EXA results with AI-generated summary
         */
        async function renderExaResultsWithSummary(data, query) {
            try {
                const exaResults = data.exa_results || [];
                const urls = exaResults.map(r => r.url);
                
                // Call summary endpoint
                const summaryResponse = await fetch(`${filterState.apiBaseUrl}/api/exa/summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        city: filterState.selectedCity,
                        query: query,
                        urls: urls,
                        results: exaResults
                    })
                });

                if (summaryResponse.ok) {
                    const summaryData = await summaryResponse.json();
                    displayExaSummaryAndSources(summaryData, exaResults);
                } else {
                    // Fallback: show results without summary
                    displayExaResults(exaResults);
                }
            } catch (error) {
                console.error('Error generating EXA summary:', error);
                displayExaResults(data.exa_results);
            }
        }

        /**
         * Add message with EXA summary
         */
        async function addMessageWithExaSummary(responseText, query, urls, quickReplies = []) {
            try {
                // Extract text content from response (remove URLs for cleaner display)
                const cleanText = responseText.replace(/https?:\/\/[^\s]+/g, '').trim();
                
                // Generate summary
                const summaryResponse = await fetch(`${filterState.apiBaseUrl}/api/exa/summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        city: filterState.selectedCity,
                        query: query,
                        urls: urls,
                        results: urls.map(url => ({ url, text: cleanText, title: 'Source' }))
                    })
                });

                if (summaryResponse.ok) {
                    const summaryData = await summaryResponse.json();
                    
                    // Combine summary with original response
                    const enhancedHTML = `
                        ${cleanText ? `<div style="margin-bottom: 20px;">${cleanText}</div>` : ''}
                        ${generateExaSummaryHTML(summaryData.summary, urls)}
                    `;
                    
                    addMessage('ai', enhancedHTML, { quickReplies });
                } else {
                    // Fallback: show original response
                    addMessage('ai', responseText, { quickReplies });
                }
            } catch (error) {
                console.error('Error adding message with summary:', error);
                addMessage('ai', responseText, { quickReplies });
            }
        }

        /**
         * Display EXA summary and sources
         */
        function displayExaSummaryAndSources(summaryData, results) {
            const html = generateExaSummaryHTML(summaryData.summary, summaryData.sources);
            addMessage('assistant', html);
        }

        /**
         * Escape HTML to prevent rendering issues
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Format bullet text - preserve markdown bold (**text**) but escape other HTML
         */
        function formatBulletText(text) {
            // First escape all HTML
            let formatted = escapeHtml(text);
            
            // Then convert markdown bold to HTML
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            return formatted;
        }

        /**
         * Generate EXA summary HTML
         */
        function generateExaSummaryHTML(summary, sources) {
            const bullets = summary?.bullets || [];
            const sourcesArray = sources || [];
            
            console.log(' Generating EXA summary HTML:', {
                bulletsCount: bullets.length,
                sourcesCount: sourcesArray.length,
                bullets: bullets
            });

            // Filter out empty bullets
            const validBullets = bullets.filter(b => b && b.trim().length > 0);
            
            if (validBullets.length === 0) {
                console.warn(' No valid bullets to display');
                return `
                    <div class="exa-summary-container" style="
                        background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
                        border-radius: 16px;
                        padding: 24px;
                        color: white;
                        margin: 12px 0;
                        box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                    ">
                        <h3 style="margin: 0 0 16px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                            <span></span>
                            <span>AI Market Summary</span>
                        </h3>
                        <div style="padding: 16px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">
                            <p style="margin: 0; opacity: 0.9;"> Analyzing market data...</p>
                            <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.7;">Check the data sources below for detailed information</p>
                        </div>
                        ${sourcesArray.length > 0 ? `
                            <details open style="margin-top: 20px; cursor: pointer;">
                                <summary style="font-weight: 600; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; user-select: none; display: flex; align-items: center; justify-content: space-between;">
                                    <span> Data Sources (${sourcesArray.length})</span>
                                    <span style="font-size: 12px; opacity: 0.7;">Click to collapse</span>
                                </summary>
                                <div style="margin-top: 12px; max-height: 300px; overflow-y: auto;">
                                    ${sourcesArray.map((url, idx) => {
                                        try {
                                            const hostname = new URL(url).hostname;
                                            return `
                                                <div style="margin: 8px 0; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; transition: all 0.3s ease;" 
                                                     onmouseover="this.style.background='rgba(255,255,255,0.15)'" 
                                                     onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                                    <a href="${url}" target="_blank" style="color: white; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                                                        <span style="min-width: 28px; height: 28px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600;">${idx + 1}</span>
                                                        <div style="flex: 1;">
                                                            <div style="font-size: 13px; font-weight: 500; margin-bottom: 2px;">${hostname}</div>
                                                            <div style="font-size: 11px; opacity: 0.7;">Click to view source</div>
                                                        </div>
                                                        <span style="font-size: 14px; opacity: 0.7;"></span>
                                                    </a>
                                                </div>
                                            `;
                                        } catch (e) {
                                            return `
                                                <div style="margin: 8px 0; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                                    <a href="${url}" target="_blank" style="color: white; text-decoration: none;">
                                                        <span>${idx + 1}. ${url}</span>
                                                    </a>
                                                </div>
                                            `;
                                        }
                                    }).join('')}
                                </div>
                            </details>
                        ` : ''}
                    </div>
                `;
            }

            return `
                <div class="exa-summary-container" style="
                    background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%);
                    border-radius: 16px;
                    padding: 24px;
                    color: white;
                    margin: 12px 0;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
                ">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                        <span></span>
                        <span>AI Market Summary</span>
                    </h3>
                    
                    <div class="summary-bullets" style="margin-bottom: 20px;">
                        ${validBullets.map(bullet => `
                            <div style="margin: 10px 0; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; backdrop-filter: blur(10px); line-height: 1.6; font-size: 15px;">
                                ${formatBulletText(bullet)}
                            </div>
                        `).join('')}
                    </div>

                    ${sourcesArray.length > 0 ? `
                        <details style="margin-top: 20px; cursor: pointer;">
                            <summary style="font-weight: 600; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; user-select: none; display: flex; align-items: center; justify-content: space-between;">
                                <span> Data Sources (${sourcesArray.length})</span>
                                <span style="font-size: 12px; opacity: 0.7;">Click to expand</span>
                            </summary>
                            <div style="margin-top: 12px; max-height: 300px; overflow-y: auto;">
                                ${sourcesArray.map((url, idx) => {
                                    const hostname = new URL(url).hostname;
                                    return `
                                        <div style="margin: 8px 0; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; transition: all 0.3s ease;" 
                                             onmouseover="this.style.background='rgba(255,255,255,0.15)'" 
                                             onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                            <a href="${url}" target="_blank" style="color: white; text-decoration: none; display: flex; align-items: center; gap: 10px;">
                                                <span style="min-width: 28px; height: 28px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600;">${idx + 1}</span>
                                                <div style="flex: 1;">
                                                    <div style="font-size: 13px; font-weight: 500; margin-bottom: 2px;">${hostname}</div>
                                                    <div style="font-size: 11px; opacity: 0.7;">Click to view source</div>
                                                </div>
                                                <span style="font-size: 14px; opacity: 0.7;"></span>
                                            </a>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </details>
                    ` : ''}
                </div>
            `;
        }

        /**
         * Display EXA results without summary (fallback)
         */
        function displayExaResults(results) {
            if (!results || results.length === 0) {
                addMessage('assistant', 'No results found.');
                return;
            }

            let html = `
                <div class="exa-results" style="padding: 16px; background: var(--color-bg-primary); border-radius: 12px; margin: 12px 0;">
                    <h3 style="margin: 0 0 16px 0; color: var(--color-primary);"> Search Results</h3>
                    <div style="display: grid; gap: 12px;">
                        ${results.slice(0, 10).map((result, idx) => `
                            <div style="padding: 14px; background: var(--color-bg-secondary); border-radius: 8px; border-left: 3px solid var(--color-primary); transition: all 0.3s ease;" 
                                 onmouseover="this.style.transform='translateX(4px)'" 
                                 onmouseout="this.style.transform='translateX(0)'">
                                <div style="display: flex; align-items: start; gap: 12px;">
                                    <span style="min-width: 24px; height: 24px; background: var(--color-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${idx + 1}</span>
                                    <div style="flex: 1;">
                                        <a href="${result.url}" target="_blank" style="color: var(--color-primary); text-decoration: none; font-weight: 600; font-size: 15px; display: inline-flex; align-items: center; gap: 6px;">
                                            ${result.title || 'View Source'}
                                            <span style="font-size: 12px; opacity: 0.7;"></span>
                                        </a>
                                        ${result.text ? `<p style="margin: 8px 0 0 0; font-size: 14px; color: var(--color-text-secondary); line-height: 1.5;">${result.text.substring(0, 200)}...</p>` : ''}
                                        <button onclick="handleTellMeMore('${result.url}', 'url')" style="
                                            margin-top: 10px;
                                            padding: 6px 14px;
                                            background: rgba(51, 128, 141, 0.1);
                                            border: 1px solid rgba(51, 128, 141, 0.3);
                                            border-radius: 6px;
                                            color: var(--color-primary);
                                            font-size: 13px;
                                            font-weight: 500;
                                            cursor: pointer;
                                            transition: all 0.3s ease;
                                        " onmouseover="this.style.background='rgba(51, 128, 141, 0.2)'" 
                                           onmouseout="this.style.background='rgba(51, 128, 141, 0.1)'">
                                             Tell Me More
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            addMessage('assistant', html);
        }

        // ==================== UI HELPER FUNCTIONS ====================
        
        function formatNumber(num) {
            if (num === null || num === undefined) return 'N/A';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#1976D2'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showLoadingOverlay(message = 'Processing...') {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                `;
                overlay.innerHTML = `
                    <div style="background: white; padding: 32px; border-radius: 12px; text-align: center;">
                        <div class="spinner" style="width: 48px; height: 48px; border: 4px solid #e3f2fd; border-top-color: #1976D2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                        <p style="color: #1a1a1a; font-size: 16px;">${message}</p>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'flex';
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        // ==================== ENHANCED UI RENDERERS ====================

        /**
         * Render Property Card with Gallery
         */
        function renderPropertyCard(property) {
            const images = property.images || [property.image || '/static/images/no-property-image.svg'];
            let imageGalleryHTML = '';
            
            if (images.length > 1) {
                imageGalleryHTML = `
                    <div class="property-image-carousel" data-property-id="${property.id}">
                        <img src="${images[0]}" alt="${property.address}" class="property-image">
                        <button class="carousel-btn prev" onclick="navigateCarousel('${property.id}', -1)"></button>
                        <button class="carousel-btn next" onclick="navigateCarousel('${property.id}', 1)"></button>
                        <div class="image-counter">1 / ${images.length}</div>
                    </div>
                `;
            } else {
                imageGalleryHTML = `<img src="${images[0]}" alt="${property.address}" class="property-image">`;
            }

            return `
                <div class="property-card" data-property-id="${property.id}" data-images='${JSON.stringify(images)}'>
                    ${imageGalleryHTML}
                    <div class="property-details">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div class="property-price">${property.price}</div>
                            <button class="favorite-btn" onclick="toggleFavorite('${property.id}')" style="background: none; border: none; font-size: 20px; cursor: pointer;"></button>
                        </div>
                        <div class="property-address">${property.address}</div>
                        <div class="property-specs">
                            ${property.beds ? `<span class="property-spec"> ${property.beds} beds</span>` : ''}
                            ${property.baths ? `<span class="property-spec"> ${property.baths} baths</span>` : ''}
                            ${property.sqft ? `<span class="property-spec"> ${property.sqft}</span>` : ''}
                            ${property.type ? `<span class="property-spec"> ${property.type}</span>` : ''}
                        </div>
                        ${property.tags ? `
                            <div class="property-tags" style="display: flex; gap: 8px; margin: 12px 0;">
                                ${property.tags.map(tag => `<span class="tag" style="padding: 4px 12px; background: rgba(51, 128, 141, 0.1); border-radius: 12px; font-size: 12px;">${tag}</span>`).join('')}
                            </div>
                        ` : ''}
                        <div class="property-actions">
                            <button class="btn-small" onclick="viewPropertyDetails('${property.id}', '${property.mls_number || ''}')">Full Details</button>
                            <button class="btn-small" onclick="scheduleViewing('${property.id}')">Schedule Tour</button>
                            <button class="btn-small" onclick="calculateROI('${property.mls_number || property.id}')">ROI Analysis</button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Navigate Image Carousel
         */
        function navigateCarousel(propertyId, direction) {
            const card = document.querySelector(`[data-property-id="${propertyId}"]`);
            if (!card) return;

            const images = JSON.parse(card.dataset.images || '[]');
            const img = card.querySelector('.property-image');
            const counter = card.querySelector('.image-counter');
            
            let currentIndex = parseInt(card.dataset.currentIndex || '0');
            currentIndex = (currentIndex + direction + images.length) % images.length;
            
            card.dataset.currentIndex = currentIndex;
            img.src = images[currentIndex];
            if (counter) counter.textContent = `${currentIndex + 1} / ${images.length}`;
        }

        /**
         * Navigate Property Card Images (for search results)
         * @param {number} cardIndex - The index of the property card
         * @param {number} direction - Direction to navigate (-1 for prev, 1 for next)
         */
        function navigatePropertyImage(cardIndex, direction) {
            const card = document.querySelector(`[data-index="${cardIndex}"]`);
            if (!card) return;

            try {
                const imagesAttr = card.dataset.images;
                if (!imagesAttr) return;
                
                const images = JSON.parse(imagesAttr.replace(/&apos;/g, "'"));
                if (!images || images.length <= 1) return;

                const img = document.getElementById(`prop-img-${cardIndex}`);
                const counter = document.getElementById(`img-counter-${cardIndex}`);
                
                if (!img) return;

                let currentIndex = parseInt(card.dataset.currentImage || '0');
                currentIndex = (currentIndex + direction + images.length) % images.length;
                
                // Update card data and image
                card.dataset.currentImage = currentIndex;
                img.src = images[currentIndex];
                
                // Add fade animation
                img.style.opacity = '0.5';
                setTimeout(() => {
                    img.style.opacity = '1';
                }, 100);
                
                // Update counter
                if (counter) {
                    counter.textContent = `${currentIndex + 1} / ${images.length}`;
                }
                
                console.log(` [Image Nav] Card ${cardIndex}: Showing image ${currentIndex + 1} of ${images.length}`);
            } catch (error) {
                console.error('Error navigating property images:', error);
            }
        }

        /**
         * Render Audio Player
         */
        function renderAudioPlayer(audioUrl, transcription = '') {
            return `
                <div class="audio-player-card" style="background: var(--color-surface); padding: 16px; border-radius: var(--radius-md); margin: 12px 0;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <button onclick="toggleAudioPlay(this)" style="width: 40px; height: 40px; border-radius: 50%; background: var(--color-primary); color: white; border: none; cursor: pointer; font-size: 18px;">
                            
                        </button>
                        <audio src="${audioUrl}" style="display: none;"></audio>
                        <div class="audio-waveform" style="flex: 1; height: 40px; background: var(--color-bg-secondary); border-radius: 4px;"></div>
                    </div>
                    ${transcription ? `<p style="font-size: 13px; color: var(--color-text-secondary); font-style: italic;">"${transcription}"</p>` : ''}
                </div>
            `;
        }

        function toggleAudioPlay(button) {
            const audio = button.nextElementSibling;
            if (audio.paused) {
                audio.play();
                button.textContent = '';
            } else {
                audio.pause();
                button.textContent = '';
            }
        }

        /**
         * Render Location Insights Map
         */
        function renderLocationMap(locationData) {
            return `
                <div class="location-map-card" style="background: var(--color-surface); border-radius: var(--radius-lg); overflow: hidden; margin: 16px 0;">
                    <div style="padding: 20px; border-bottom: 1px solid var(--color-border);">
                        <h3 style="margin: 0 0 8px 0;"> ${locationData.location}</h3>
                        <p style="color: var(--color-text-secondary); font-size: 14px;">Neighborhood Insights</p>
                    </div>
                    <div class="location-insights" style="padding: 20px;">
                        ${locationData.schools ? `
                            <div class="insight-item" style="display: flex; gap: 16px; padding: 16px; background: var(--color-bg-secondary); border-radius: var(--radius-md); margin-bottom: 12px;">
                                <span style="font-size: 32px;"></span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">Schools</div>
                                    <div style="font-size: 14px; color: var(--color-text-secondary);">${locationData.schools.count} within ${locationData.schools.radius}km</div>
                                    <div style="color: var(--color-success); font-size: 14px;"> ${locationData.schools.rating}/10</div>
                                </div>
                            </div>
                        ` : ''}
                        ${locationData.transit ? `
                            <div class="insight-item" style="display: flex; gap: 16px; padding: 16px; background: var(--color-bg-secondary); border-radius: var(--radius-md); margin-bottom: 12px;">
                                <span style="font-size: 32px;"></span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">Transit</div>
                                    <div style="font-size: 14px; color: var(--color-text-secondary);">${locationData.transit.stations} stations nearby</div>
                                    <div style="font-size: 14px;">Walk Score: ${locationData.transit.walkScore}/100</div>
                                </div>
                            </div>
                        ` : ''}
                        ${locationData.amenities ? `
                            <div class="insight-item" style="display: flex; gap: 16px; padding: 16px; background: var(--color-bg-secondary); border-radius: var(--radius-md);">
                                <span style="font-size: 32px;"></span>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">Amenities</div>
                                    <div style="font-size: 14px; color: var(--color-text-secondary);">${locationData.amenities.restaurants}+ restaurants, ${locationData.amenities.stores}+ stores</div>
                                    <div style="font-size: 14px;">Bike Score: ${locationData.amenities.bikeScore}/100</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        /**
         * Render Search Results
         */
        function renderSearchResults(properties, query) {
            if (!properties || properties.length === 0) {
                return `
                    <div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <p>No properties found for "${query}"</p>
                        <button class="btn-small" onclick="sendMessage('Show me all available properties')" style="margin-top: 16px;">Browse All</button>
                    </div>
                `;
            }

            return `
                <div class="search-results-header" style="margin-bottom: 16px;">
                    <h3 style="margin: 0;">Found ${properties.length} ${properties.length === 1 ? 'property' : 'properties'}</h3>
                    <p style="color: var(--color-text-secondary); font-size: 14px; margin: 4px 0 0 0;">Matching your search criteria</p>
                </div>
                <div class="properties-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                    ${properties.map(prop => renderPropertyCard(prop)).join('')}
                </div>
            `;
        }

        // Add valuation message with structured data
        async function addValuationMessage(structuredData, aiAnalysisText = '', quickReplies = []) {
            const container = document.getElementById('chatContainer');
            const message = document.createElement('div');
            message.className = 'message';
            
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            // Fetch owner-listed price from Repliers if MLS number is available
            let ownerListedPrice = null;
            let propertyImages = [];
            if (structuredData.property && structuredData.property.mls_number) {
                try {
                    const response = await fetch(`${getApiBaseUrl()}/api/property-details?mls=${structuredData.property.mls_number}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();
                    if (data.success && data.property) {
                        ownerListedPrice = data.property.price || data.property.list_price;
                        propertyImages = data.property.images || [];
                    }
                } catch (error) {
                    console.error('Failed to fetch owner-listed price:', error);
                }
            }
            
            // Build owner-listed price section (shown first)
            let ownerPriceHTML = '';
            if (ownerListedPrice) {
                ownerPriceHTML = `
                    <div class="valuation-section" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 24px; border-radius: var(--radius-lg); margin-bottom: 24px;">
                        <h3 class="section-title" style="margin-bottom: 16px;">
                            <span class="section-icon"></span>
                            Owner Listed Price
                        </h3>
                        <div style="text-align: center;">
                            <div style="font-size: 42px; font-weight: 700; color: var(--color-primary); margin-bottom: 8px;">
                                $${formatNumber(ownerListedPrice)}
                            </div>
                            <div style="font-size: 14px; color: var(--color-text-secondary);">
                                Current asking price from MLS listing
                            </div>
                        </div>
                    </div>
                `;
            }

            // Build property images section
            let propertyImagesHTML = '';
            if (propertyImages && propertyImages.length > 0) {
                propertyImagesHTML = `
                    <div class="valuation-section" style="margin-bottom: 24px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            ${propertyImages.slice(0, 4).map(img => `
                                <img src="${img}" alt="Property" 
                                     style="width: 100%; height: 150px; object-fit: cover; border-radius: var(--radius-md);"
                                     onerror="this.style.display='none'">
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Build property info section
            let propertyInfoHTML = '';
            if (structuredData.property) {
                const prop = structuredData.property;
                propertyInfoHTML = `
                    <div class="valuation-section">
                        <h3 class="section-title">
                            <span class="section-icon"></span>
                            Property Information
                        </h3>
                        <div class="property-info-grid">
                            ${prop.address ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">Address</div>
                                    <div class="property-info-value">${prop.address}</div>
                                </div>
                            ` : ''}
                            ${prop.mls_number ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">MLS Number</div>
                                    <div class="property-info-value">${prop.mls_number}</div>
                                </div>
                            ` : ''}
                            ${prop.property_type ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">Property Type</div>
                                    <div class="property-info-value">${capitalizeFirst(prop.property_type)}</div>
                                </div>
                            ` : ''}
                            ${prop.bedrooms ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">Bedrooms</div>
                                    <div class="property-info-value">${prop.bedrooms}</div>
                                </div>
                            ` : ''}
                            ${prop.bathrooms ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">Bathrooms</div>
                                    <div class="property-info-value">${prop.bathrooms}</div>
                                </div>
                            ` : ''}
                            ${prop.square_footage ? `
                                <div class="property-info-item">
                                    <div class="property-info-label">Square Footage</div>
                                    <div class="property-info-value">${formatNumber(prop.square_footage)} sq ft</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Build valuation stats section
            let valuationStatsHTML = '';
            if (structuredData.valuation) {
                const val = structuredData.valuation;
                
                valuationStatsHTML = `
                    <div class="valuation-section">
                        <h3 class="section-title">
                            <span class="section-icon"></span>
                            AI Estimated Value
                        </h3>
                        <div class="valuation-stats">
                            <div class="stat-card">
                                <div class="stat-label">Our AI Estimate</div>
                                <div class="stat-value">$${formatNumber(val.estimated_value)}</div>
                                <div class="stat-sublabel">${val.method || 'Direct Comparison Approach'}</div>
                            </div>
                            ${val.value_range ? `
                                <div class="stat-card">
                                    <div class="stat-label">Value Range</div>
                                    <div class="stat-value" style="font-size: 18px;">
                                        $${formatNumber(val.value_range.min)} - $${formatNumber(val.value_range.max)}
                                    </div>
                                    <div class="stat-sublabel">Based on comparable properties</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Build market data section
            let marketDataHTML = '';
            if (structuredData.market_data) {
                const market = structuredData.market_data;
                marketDataHTML = `
                    <div class="valuation-section">
                        <h3 class="section-title">
                            <span class="section-icon"></span>
                            Market Context
                        </h3>
                        <div class="market-grid">
                            ${market.avg_price_per_sqft ? `
                                <div class="market-item">
                                    <div class="market-item-label">Avg Price per Sq Ft</div>
                                    <div class="market-item-value">$${formatNumber(market.avg_price_per_sqft)}</div>
                                </div>
                            ` : ''}
                            ${market.comparables_analyzed ? `
                                <div class="market-item">
                                    <div class="market-item-label">Comparables Analyzed</div>
                                    <div class="market-item-value">${market.comparables_analyzed}</div>
                                </div>
                            ` : ''}
                            ${market.area ? `
                                <div class="market-item">
                                    <div class="market-item-label">Area</div>
                                    <div class="market-item-value">${market.area}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Build comparables section
            let comparablesHTML = '';
            if (structuredData.comparables && structuredData.comparables.length > 0) {
                const comparablesCards = structuredData.comparables.map((comp, index) => `
                    <div class="comparable-card" data-mls="${comp.mls_id}" data-index="${index}">
                        <div class="comparable-header">
                            <div class="comparable-price">$${formatNumber(comp.sale_price || comp.price)}</div>
                            ${comp.similarity_score ? `
                                <div class="comparable-similarity">${Math.round(comp.similarity_score)}% match</div>
                            ` : ''}
                        </div>
                        <div class="comparable-address" id="comp-address-${index}">
                            ${comp.address && comp.address !== 'Unknown' ? comp.address : '<span class="loading-address">Loading address...</span>'}
                        </div>
                        ${comp.mls_id ? `<div style="font-size: 12px; color: var(--color-text-secondary); margin: 4px 0;">MLS: ${comp.mls_id}</div>` : ''}
                        ${comp.sale_date ? `<div style="font-size: 12px; color: var(--color-text-secondary); margin: 4px 0;"> ${comp.sale_date}</div>` : ''}
                        <div class="comparable-specs">
                            ${comp.bedrooms ? `<div class="comparable-spec"> ${comp.bedrooms} beds</div>` : ''}
                            ${comp.bathrooms ? `<div class="comparable-spec"> ${comp.bathrooms} baths</div>` : ''}
                            ${comp.sqft || comp.square_footage ? `<div class="comparable-spec"> ${formatNumber(comp.sqft || comp.square_footage)} sq ft</div>` : ''}
                            ${comp.distance_km || comp.distance ? `<div class="comparable-spec"> ${comp.distance_km || comp.distance} km away</div>` : ''}
                        </div>
                        <div class="comparable-actions" style="margin-top: 12px; display: flex; gap: 6px; flex-wrap: wrap;">
                            <button class="btn-small btn-primary" onclick="openPropertyDetailsPanel('${comp.mls_id}')">
                                 View Details
                            </button>
                            <button class="btn-small btn-primary" onclick="openAIAnalysisPanel('${comp.mls_id}', 'comparable')">
                                 AI Analysis
                            </button>
                            <button class="btn-small btn-primary" onclick="debugMarketAnalysisClick('${comp.mls_id}', ${JSON.stringify(comp).replace(/'/g, '&apos;')})">
                                 Market Analysis
                            </button>
                        </div>
                    </div>
                `).join('');

                comparablesHTML = `
                    <div class="valuation-section">
                        <h3 class="section-title">
                            <span class="section-icon"></span>
                            Comparable Properties (${structuredData.comparables.length})
                        </h3>
                        <div class="comparables-grid">
                            ${comparablesCards}
                        </div>
                    </div>
                `;
            }

            // Build metadata section
            let metadataHTML = '';
            if (structuredData.metadata) {
                const meta = structuredData.metadata;
                metadataHTML = `
                    <div class="valuation-section">
                        <div class="valuation-metadata">
                            ${meta.valuation_date ? `
                                <div class="metadata-item">
                                    <span class="metadata-label">Valuation Date:</span> ${meta.valuation_date}
                                </div>
                            ` : ''}
                            ${meta.data_source ? `
                                <div class="metadata-item">
                                    <span class="metadata-label">Data Source:</span> ${meta.data_source}
                                </div>
                            ` : ''}
                            ${meta.disclaimer ? `
                                <div class="metadata-item" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border);">
                                    <em>${meta.disclaimer}</em>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Build AI Analysis section from the response text
            let aiAnalysisHTML = '';
            if (aiAnalysisText) {
                // Convert markdown to HTML (basic conversion)
                const analysisHTML = aiAnalysisText
                    .replace(/### \*\*(.+?)\*\*/g, '<h4 style="color: var(--color-primary); margin: 16px 0 8px 0;">$1</h4>')
                    .replace(/## (.+)/g, '<h3 style="margin: 20px 0 12px 0; color: var(--color-text);">$1</h3>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n\n/g, '</p><p style="margin: 12px 0;">')
                    .replace(/\n/g, '<br>');
                
                aiAnalysisHTML = `
                    <div class="valuation-section">
                        <h3 class="section-title">
                            <span class="section-icon"></span>
                            AI Analysis & Insights
                        </h3>
                        <div style="background: var(--color-bg-secondary); padding: 20px; border-radius: var(--radius-md); line-height: 1.7;">
                            <p style="margin: 12px 0;">${analysisHTML}</p>
                        </div>
                    </div>
                `;
            }

            // Build Data Sources section
            const dataSourcesHTML = `
                <div class="valuation-section">
                    <h3 class="section-title">
                        <span class="section-icon"></span>
                        Data Sources & Methodology
                    </h3>
                    <div style="background: #f8f9fa; padding: 16px; border-radius: var(--radius-md); border-left: 4px solid var(--color-primary);">
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <strong> Primary Data Source:</strong> 
                                <span style="color: var(--color-text-secondary);">Repliers.io Real Estate MLS Database</span>
                            </div>
                            <div>
                                <strong> Methodology:</strong> 
                                <span style="color: var(--color-text-secondary);">Direct Comparison Approach (CUSPAP)</span>
                            </div>
                            <div>
                                <strong> AI Model:</strong> 
                                <span style="color: var(--color-text-secondary);">Llama 3.2 90B Vision + RAG (Retrieval-Augmented Generation)</span>
                            </div>
                            <div>
                                <strong> Analysis Date:</strong> 
                                <span style="color: var(--color-text-secondary);">${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                            </div>
                            <div>
                                <strong> Data Freshness:</strong> 
                                <span style="color: var(--color-text-secondary);">Live MLS data updated in real-time</span>
                            </div>
                            <div style="margin-top: 8px; padding-top: 12px; border-top: 1px solid var(--color-border);">
                                <em style="font-size: 13px; color: var(--color-text-secondary);">
                                     This analysis combines machine learning with professional appraisal methodologies 
                                    to provide accurate market valuations based on current Canadian real estate data.
                                </em>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Build the complete valuation card
            const valuationCard = `
                <div class="valuation-card">
                    <div class="valuation-header">
                        <h2 class="valuation-title"> Property Valuation Report</h2>
                        <p class="valuation-subtitle">Comprehensive market analysis using live Canadian real estate data</p>
                    </div>
                    <div class="valuation-body">
                        ${ownerPriceHTML}
                        ${propertyImagesHTML}
                        ${propertyInfoHTML}
                        ${valuationStatsHTML}
                        ${marketDataHTML}
                        ${comparablesHTML}
                        ${aiAnalysisHTML}
                        ${dataSourcesHTML}
                        ${metadataHTML}
                    </div>
                </div>
            `;

            message.innerHTML = `
                <div class="message-avatar ai-avatar"></div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">Summitly AI</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">
                        ${valuationCard}
                        ${quickReplies.length > 0 ? generateQuickReplies(quickReplies) : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(message);
            scrollToBottom();
            
            chatHistory.push({ 
                sender: 'ai', 
                content: 'Property Valuation Report', 
                structuredData: structuredData, 
                timestamp: new Date() 
            });

            // Fetch real addresses for comparables with "Unknown" address
            if (structuredData.comparables) {
                structuredData.comparables.forEach((comp, index) => {
                    if ((!comp.address || comp.address === 'Unknown') && comp.mls_id) {
                        fetchComparableAddress(comp.mls_id, index);
                    }
                });
            }
        }

        /**
         * Fetch real property address from Repliers API
         */
        async function fetchComparableAddress(mlsId, index) {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/property-details?mls=${mlsId}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.success && data.property && data.property.address) {
                    const addressElement = document.getElementById(`comp-address-${index}`);
                    if (addressElement) {
                        const fullAddress = `${data.property.address.street}, ${data.property.address.city}, ${data.property.address.province}`;
                        addressElement.innerHTML = fullAddress;
                        addressElement.classList.remove('loading-address');
                    }
                }
            } catch (error) {
                console.error(`Failed to fetch address for MLS ${mlsId}:`, error);
                const addressElement = document.getElementById(`comp-address-${index}`);
                if (addressElement) {
                    addressElement.innerHTML = `MLS ${mlsId}`;
                    addressElement.classList.remove('loading-address');
                }
            }
        }

        /**
         *  Enhanced Property Analysis Formatter
         * Specifically formats property valuation and analysis content
         * @param {string} content - Property analysis text
         * @returns {string} Formatted HTML with professional property analysis layout
         */
        function enhancePropertyAnalysis(content) {
            console.log(' Enhancing property analysis content');
            
            const sections = content.split(/(?=|||||)/);
            let enhanced = '<div class="property-analysis-container" style="background: #ffffff; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin: 16px 0;">';
            
            for (let section of sections) {
                section = section.trim();
                if (!section) continue;
                
                // Main property analysis section
                if (section.startsWith(' Property Analysis')) {
                    const lines = section.split('\n').filter(l => l.trim());
                    const title = lines[0].replace(' ', '');
                    const mainAnalysis = lines.slice(1).join(' ').trim();
                    
                    enhanced += `
                    <div class="analysis-header" style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); padding: 24px; color: white;">
                        <h2 style="margin: 0 0 16px 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px;">
                            <span style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 50%; font-size: 20px;"></span>
                            ${title}
                        </h2>
                    </div>
                    <div class="analysis-content" style="padding: 24px;">
                        ${formatAnalysisContent(mainAnalysis)}
                    </div>`;
                }
                
                // Warning/Important note section
                else if (section.startsWith('')) {
                    const content = section.replace(/\s*\*\*Important Note:\*\*\s*/, '').trim();
                    enhanced += `
                    <div class="warning-section" style="margin: 0 24px 24px 24px; background: linear-gradient(135deg, rgba(255, 165, 0, 0.1) 0%, rgba(255, 140, 0, 0.05) 100%); border-left: 4px solid #FFA500; padding: 20px; border-radius: 8px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="background: #FFA500; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;"></span>
                            <div>
                                <h4 style="margin: 0 0 8px 0; color: #CC7A00; font-weight: 600; font-size: 16px;">Important Market Context</h4>
                                <p style="margin: 0; line-height: 1.6; color: #8B5A00; font-size: 14px;">${content}</p>
                            </div>
                        </div>
                    </div>`;
                }
                
                // Regular content sections
                else {
                    enhanced += `
                    <div style="padding: 0 24px 16px 24px;">
                        <p style="line-height: 1.7; color: #2c3e50; font-size: 15px; margin: 12px 0;">${formatAnalysisText(section)}</p>
                    </div>`;
                }
            }
            
            enhanced += '</div>';
            return enhanced;
        }

        /**
         * Format analysis content with value highlighting
         */
        function formatAnalysisContent(text) {
            // Highlight key values and percentages
            let formatted = text
                .replace(/\$[\d,]+/g, match => `<strong style="color: #1976D2; font-weight: 700; background: rgba(25, 118, 210, 0.1); padding: 2px 6px; border-radius: 4px;">${match}</strong>`)
                .replace(/(\d+%)(?!\w)/g, '<strong style="color: #27ae60; font-weight: 600;">$1</strong>')
                .replace(/(high confidence \(\d+%\))/gi, '<span style="background: rgba(39, 174, 96, 0.1); color: #27ae60; padding: 4px 8px; border-radius: 12px; font-weight: 600; font-size: 13px;">$1</span>');
            
            return `<p style="font-size: 16px; line-height: 1.8; color: #2c3e50; margin: 0;">${formatted}</p>`;
        }

        /**
         * Format analysis text with better typography
         */
        function formatAnalysisText(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #2c3e50; font-weight: 600;">$1</strong>')
                .replace(/MLS [A-Z]\d+/g, match => `<span style="background: rgba(25, 118, 210, 0.1); color: #1976D2; padding: 2px 6px; border-radius: 4px; font-weight: 500; font-size: 13px;">${match}</span>`)
                .replace(/\$[\d,]+/g, match => `<strong style="color: #1976D2; font-weight: 600;">${match}</strong>`)
                .replace(/(\d+%)(?!\w)/g, '<strong style="color: #27ae60;">$1</strong>');
        }

        /**
         *  Enhance ChatGPT Text Response with Visual Formatting
         * Transforms plain text responses into visually appealing, structured content
         * @param {string} content - Raw text content from ChatGPT
         * @param {boolean} isAI - Whether this is an AI response
         * @returns {string} Enhanced HTML with better typography and visual hierarchy
         */
        /**
         *  Enhanced School Data Visualization
         * Production-ready school listings with accessibility and modern design
         */
        function enhanceSchoolDataVisualization(content) {
            console.log(' Enhancing school data visualization');
            
            const lines = content.split('\n').filter(line => line.trim());
            let schoolsHtml = `
                <div class="schools-container" role="region" aria-label="School Information">
                    <div class="schools-header">
                        <h3 class="schools-title">
                            <span></span>
                            Educational Institutions
                        </h3>
                        <p class="schools-subtitle">Comprehensive school information with ratings and details</p>
                    </div>
            `;
            
            let currentSchool = {};
            let schoolCount = 0;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Match school entries (numbered list format)
                const schoolMatch = line.match(/^(\d+)\.\s*\*\*(.+?)\*\*/);
                if (schoolMatch) {
                    // Save previous school if exists
                    if (currentSchool.name) {
                        schoolsHtml += renderSchoolCard(currentSchool, schoolCount++);
                    }
                    
                    // Start new school
                    const fullName = schoolMatch[2];
                    currentSchool = {
                        name: fullName,
                        type: extractSchoolType(fullName),
                        level: extractSchoolLevel(fullName),
                        features: [],
                        rating: 'Not Rated',
                        address: 'Address not available'
                    };
                    continue;
                }
                
                // Parse school details
                if (line.includes('**Level:**')) {
                    currentSchool.level = line.replace(/.*\*\*Level:\*\*\s*/, '').replace(/\*\*/g, '');
                } else if (line.includes('**Type:**')) {
                    currentSchool.type = line.replace(/.*\*\*Type:\*\*\s*/, '').replace(/\*\*/g, '');
                } else if (line.includes('**Notable Features:**') || line.includes('**Programs:**')) {
                    currentSchool.features = line.replace(/.*\*\*.*?\*\*\s*/, '').split(',').map(f => f.trim());
                } else if (line.includes('**Address:**')) {
                    currentSchool.address = line.replace(/.*\*\*Address:\*\*\s*/, '').replace(/\*\*/g, '');
                } else if (line.includes('**Rating:**')) {
                    currentSchool.rating = line.replace(/.*\*\*Rating:\*\*\s*/, '').replace(/\*\*/g, '');
                }
            }
            
            // Add last school
            if (currentSchool.name) {
                schoolsHtml += renderSchoolCard(currentSchool, schoolCount++);
            }
            
            schoolsHtml += `
                </div>
                <div style="margin-top: 16px; padding: 12px; background: var(--color-bg-secondary); border-radius: 8px; font-size: 13px; color: var(--color-text-secondary); text-align: center;">
                     <strong>Real-time data:</strong> School information is fetched live and may vary. Contact schools directly for the most current details.
                </div>
            `;
            
            return schoolsHtml;
        }
        
        /**
         * Extract school type from name
         */
        function extractSchoolType(name) {
            const nameLower = name.toLowerCase();
            if (nameLower.includes('catholic') || nameLower.includes('separate')) return 'Catholic';
            if (nameLower.includes('private') || nameLower.includes('independent')) return 'Private';
            if (nameLower.includes('montessori')) return 'Montessori';
            if (nameLower.includes('french') || nameLower.includes('immersion')) return 'French Immersion';
            return 'Public';
        }
        
        /**
         * Extract school level from name
         */
        function extractSchoolLevel(name) {
            const nameLower = name.toLowerCase();
            if (nameLower.includes('elementary') || nameLower.includes('primary')) return 'Elementary';
            if (nameLower.includes('middle') || nameLower.includes('junior')) return 'Middle School';
            if (nameLower.includes('high') || nameLower.includes('secondary') || nameLower.includes('collegiate')) return 'High School';
            if (nameLower.includes('k-8') || nameLower.includes('k-12')) return 'K-12';
            return 'Mixed Levels';
        }
        
        /**
         * Render individual school card
         */
        function renderSchoolCard(school, index) {
            const ratingClass = getRatingClass(school.rating);
            const features = school.features.slice(0, 4); // Limit features
            
            return `
                <article class="school-item" role="article" tabindex="0" aria-label="School: ${school.name}">
                    <div class="school-header">
                        <div>
                            <h4 class="school-name">${school.name}</h4>
                            <div class="school-type">${school.type}  ${school.level}</div>
                        </div>
                        <div class="school-rating ${ratingClass}" aria-label="Rating: ${school.rating}">
                             ${school.rating}
                        </div>
                    </div>
                    
                    <div class="school-details">
                        <div class="school-address">
                            <span></span>
                            ${school.address}
                        </div>
                        <div class="school-level">
                            <span></span>
                            ${school.level}
                        </div>
                    </div>
                    
                    ${features.length > 0 ? `
                        <div class="school-features">
                            <div class="school-features-title">
                                <span></span>
                                Notable Features
                            </div>
                            <div class="school-features-list">
                                ${features.map(feature => `
                                    <span class="school-feature-tag">${feature}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="school-actions">
                        <button class="school-btn primary" onclick="getSchoolDetails('${school.name}')">
                            View Details
                        </button>
                        <button class="school-btn" onclick="getSchoolDirections('${school.address}')">
                            Directions
                        </button>
                    </div>
                </article>
            `;
        }
        
        // Duplicate getRatingClass function removed - using the numeric version above
        
        /**
         * School action handlers
         */
        function getSchoolDetails(schoolName) {
            sendMessage(`Tell me more details about ${schoolName} school including programs, enrollment, and contact information`);
        }
        
        function getSchoolDirections(address) {
            if (address && address !== 'Address not available') {
                const encodedAddress = encodeURIComponent(address);
                window.open(`https://maps.google.com/maps?q=${encodedAddress}`, '_blank');
            } else {
                showToast('Address not available for directions', 'warning');
            }
        }

        /**
         *  Enhance Structured Lists (Schools, Shopping, Amenities)
         * Formats list-based responses into attractive, structured cards
         */
        function enhanceStructuredListResponse(content) {
            console.log(' Enhancing structured list response');
            console.log(' Raw content for parsing:');
            console.log(content);
            console.log(' First 10 lines:');
            content.split('\n').slice(0, 10).forEach((line, i) => {
                console.log(`Line ${i}: "${line}"`);
            });
            
            // Split content into sections
            const lines = content.split('\n').filter(line => line.trim());
            let enhanced = '<div class="structured-list-response" style="padding: 20px; background: linear-gradient(135deg, #f8fcfd 0%, #e8f4f8 100%); border-radius: 16px; margin: 16px 0;">';
            
            // Determine content type and header based on actual content analysis
            let headerTitle = "Local Information";
            let headerIcon = "";
            
            const contentLower = content.toLowerCase();
            const hasSchoolKeywords = contentLower.includes('school') || contentLower.includes('elementary') || 
                                    contentLower.includes('secondary') || contentLower.includes('high school') ||
                                    contentLower.includes('collegiate') || contentLower.includes('academy');
            const hasShoppingKeywords = contentLower.includes('shopping') || contentLower.includes('mall') || 
                                      contentLower.includes('retail') || contentLower.includes('store');
            const hasGroceryKeywords = contentLower.includes('grocery') || contentLower.includes('supermarket') ||
                                     contentLower.includes('loblaws') || contentLower.includes('metro') || 
                                     contentLower.includes('food basics');
            const hasHealthKeywords = contentLower.includes('hospital') || contentLower.includes('medical') || 
                                    contentLower.includes('health') || contentLower.includes('clinic');
            const hasRestaurantKeywords = contentLower.includes('restaurant') || contentLower.includes('dining') ||
                                        contentLower.includes('food') || contentLower.includes('cuisine');
            const hasParkKeywords = contentLower.includes('park') || contentLower.includes('recreation') ||
                                  contentLower.includes('green space') || contentLower.includes('outdoor');
            const hasMarketKeywords = contentLower.includes('market') || contentLower.includes('trend') ||
                                    contentLower.includes('price') || contentLower.includes('investment');
            
            // Priority-based detection (most specific first)
            if (hasSchoolKeywords) {
                headerTitle = "Educational Institutions";
                headerIcon = "";
                return enhanceSchoolDataVisualization(content);
            } else if (hasGroceryKeywords && !hasShoppingKeywords) {
                headerTitle = "Grocery Stores & Supermarkets";
                headerIcon = "";
            } else if (hasShoppingKeywords) {
                headerTitle = "Shopping Centers & Retail";
                headerIcon = "";
            } else if (hasHealthKeywords) {
                headerTitle = "Hospitals & Medical Centers";
                headerIcon = "";
            } else if (hasRestaurantKeywords) {
                headerTitle = "Dining & Restaurants";
                headerIcon = "";
            } else if (hasParkKeywords) {
                headerTitle = "Parks & Recreation";
                headerIcon = "";
            } else if (hasMarketKeywords) {
                headerTitle = "Market Analysis & Trends";
                headerIcon = "";
            }
            
            console.log(' Header detection:', {
                contentType: headerTitle,
                hasSchoolKeywords,
                hasShoppingKeywords,
                hasGroceryKeywords,
                hasHealthKeywords,
                hasRestaurantKeywords,
                hasParkKeywords,
                hasMarketKeywords
            });
            
            // Add header
            enhanced += `
            <div style="text-align: center; margin-bottom: 32px;">
                <h2 style="color: #1976D2; font-size: 24px; font-weight: 700; margin: 0 0 12px 0; display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <span style="background: linear-gradient(135deg, #1976D2, #1565C0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 28px;">${headerIcon}</span>
                    ${headerTitle}
                </h2>
            </div>`;
            
            let currentItem = null;
            let items = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                console.log(` Processing line ${i}: "${line}"`);
                
                // Skip empty lines
                if (!line) continue;
                
                // Detect numbered list items - multiple formats
                if (line.match(/^\d+\./)) {
                    // Save previous item
                    if (currentItem) {
                        items.push(currentItem);
                        console.log(' Saved item:', currentItem.name, 'with details:', currentItem.details);
                    }
                    
                    // Extract item name - handle different formats
                    let name = '';
                    if (line.includes('**')) {
                        // Format: "1. **Name**" or "1. **Name** - additional info"
                        const nameMatch = line.match(/^\d+\.\s\*\*(.*?)\*\*/);
                        name = nameMatch ? nameMatch[1].trim() : '';
                    } else {
                        // Format: "1. Name" or "1. Name - additional info"
                        name = line.replace(/^\d+\.\s*/, '').split('-')[0].trim();
                    }
                    
                    currentItem = {
                        name: name,
                        details: {},
                        description: ''
                    };
                    console.log(' Started new item:', name);
                    
                    // Check if there's inline information in the same line
                    if (line.includes(' - ')) {
                        const parts = line.split(' - ');
                        for (let i = 1; i < parts.length; i++) {
                            const part = parts[i].trim();
                            if (part.toLowerCase().includes('location:') || part.toLowerCase().includes('address:')) {
                                currentItem.details['Address'] = part.replace(/location:\s*/i, '').replace(/address:\s*/i, '').trim();
                                console.log(' Found inline address:', currentItem.details['Address']);
                            } else if (part.toLowerCase().includes('special:') || part.toLowerCase().includes('known for:')) {
                                currentItem.description = part.replace(/special:\s*/i, '').replace(/known for:\s*/i, '').trim();
                                console.log(' Found inline description:', currentItem.description);
                            }
                        }
                    }
                }
                // Parse item details - handle multiple formats
                else if (currentItem && ((line.includes('-') && line.includes('**') && line.includes(':')) || 
                                       (line.includes('**') && line.includes(':') && !line.match(/^\d+\./)))) {
                    // Handle both "- **Type:**" and "   - **Type:**" formats
                    const detailMatch = line.match(/.*?-\s*\*\*(.*?)\*\*:\s*(.*)/);
                    if (detailMatch) {
                        const key = detailMatch[1].trim();
                        const value = detailMatch[2].trim();
                        
                        console.log(` Parsing detail line: "${line}"`);
                        console.log(` Extracted key: "${key}", value: "${value}"`);
                        
                        // Handle different key variations
                        if (key === 'Special Features' || key === 'Specialty') {
                            currentItem.description = value;
                            console.log(` Added description: ${value}`);
                        } else {
                            currentItem.details[key] = value;
                            console.log(` Added detail: ${key} = ${value}`);
                        }
                    } else {
                        console.log(` Failed to parse detail line: "${line}"`);
                    }
                }
                // Alternative parsing for details without dash (format: "   **Type:** Value")
                else if (currentItem && line.includes('**') && line.includes(':') && !line.match(/^\d+\./)) {
                    const detailMatch = line.match(/\*\*(.*?)\*\*:\s*(.*)/);
                    if (detailMatch) {
                        const key = detailMatch[1].trim();
                        const value = detailMatch[2].trim();
                        
                        console.log(` Parsing alt detail line: "${line}"`);
                        console.log(` Extracted key: "${key}", value: "${value}"`);
                        
                        if (key === 'Special Features' || key === 'Specialty') {
                            currentItem.description = value;
                            console.log(` Added description from alt format: ${value}`);
                        } else {
                            currentItem.details[key] = value;
                            console.log(` Added detail from alt format: ${key} = ${value}`);
                        }
                    } else {
                        console.log(` Failed to parse alt detail line: "${line}"`);
                    }
                }
                // Parse simple format without markdown (format: "Location: Address" or "Special Features: Description")
                else if (currentItem && line.includes(':') && !line.match(/^\d+\./) && !line.includes('**')) {
                    const parts = line.split(':');
                    if (parts.length >= 2) {
                        const key = parts[0].replace(/^-\s*/, '').trim();
                        const value = parts.slice(1).join(':').trim();
                        
                        console.log(` Parsing simple format: "${line}"`);
                        console.log(` Simple key: "${key}", value: "${value}"`);
                        
                        // Map common keys
                        if (key.toLowerCase().includes('location') || key.toLowerCase().includes('address')) {
                            currentItem.details['Address'] = value;
                            console.log(` Added address (simple): ${value}`);
                        } else if (key.toLowerCase().includes('special') || key.toLowerCase().includes('known for') || 
                                 key.toLowerCase().includes('features') || key.toLowerCase().includes('unique')) {
                            currentItem.description = value;
                            console.log(` Added description (simple): ${value}`);
                        } else if (key.toLowerCase().includes('type') || key.toLowerCase().includes('category')) {
                            currentItem.details['Type'] = value;
                            console.log(` Added type (simple): ${value}`);
                        }
                    }
                }
            }
            
            // Add the last item
            if (currentItem) {
                items.push(currentItem);
                console.log(' Final item saved:', currentItem.name, 'with details:', currentItem.details);
            }
            
            console.log(' Final parsing results:');
            console.log(` Found ${items.length} items total`);
            items.forEach((item, i) => {
                console.log(`Item ${i+1}: "${item.name}"`);
                console.log(`  Details:`, JSON.stringify(item.details, null, 2));
                console.log(`  Description:`, item.description);
                console.log(`  Type:`, item.details['Type']);
                console.log(`  Address:`, item.details['Address']);
            });
            
            // Render items as cards
            enhanced += '<div class="items-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; margin-top: 24px;">';
            
            items.forEach((item, index) => {
                const rating = item.details['Rating'] || 'N/A';
                const type = item.details['Type'] || '';
                const address = item.details['Address'] || '';
                
                console.log(` Rendering card ${index + 1} for "${item.name}":`, {
                    rating: rating,
                    type: type,
                    address: address,
                    description: item.description,
                    allDetails: item.details
                });
                
                // Color scheme based on rating
                let ratingColor = '#1976D2';
                let ratingBg = 'rgba(25, 118, 210, 0.1)';
                if (rating !== 'N/A') {
                    const ratingNum = parseFloat(rating);
                    if (ratingNum >= 8.5) {
                        ratingColor = '#27ae60';
                        ratingBg = 'rgba(39, 174, 96, 0.1)';
                    } else if (ratingNum >= 7.5) {
                        ratingColor = '#f39c12';
                        ratingBg = 'rgba(243, 156, 18, 0.1)';
                    } else if (ratingNum < 7.0) {
                        ratingColor = '#e74c3c';
                        ratingBg = 'rgba(231, 76, 60, 0.1)';
                    }
                }
                
                enhanced += `
                <div class="item-card" style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 8px 24px rgba(25, 118, 210, 0.1); border: 1px solid rgba(25, 118, 210, 0.1); transition: all 0.3s ease; position: relative; overflow: hidden;">
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, ${ratingColor}, ${ratingColor}88);"></div>
                    
                    <div style="display: flex; justify-content: between; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
                        <div style="flex: 1;">
                            <h3 style="color: #2c3e50; font-size: 20px; font-weight: 700; margin: 0 0 8px 0; line-height: 1.3;">${item.name}</h3>
                            ${type ? `<span style="background: rgba(25, 118, 210, 0.1); color: #1976D2; padding: 4px 12px; border-radius: 20px; font-size: 14px; font-weight: 600;">${type}</span>` : ''}
                        </div>
                        ${rating !== 'N/A' ? `
                        <div style="background: ${ratingBg}; border: 2px solid ${ratingColor}; border-radius: 12px; padding: 8px 12px; text-align: center; min-width: 60px;">
                            <div style="color: ${ratingColor}; font-weight: 700; font-size: 18px; line-height: 1;">${rating}</div>
                            <div style="color: ${ratingColor}; font-size: 11px; opacity: 0.8;">RATING</div>
                        </div>` : ''}
                    </div>
                    
                    ${address ? `
                    <div style="display: flex; align-items: start; gap: 8px; margin: 16px 0; padding: 12px; background: rgba(25, 118, 210, 0.05); border-radius: 8px;">
                        <span style="color: #1976D2; font-size: 16px; margin-top: 2px;"></span>
                        <span style="color: #1565C0; font-size: 14px; line-height: 1.4;">${address}</span>
                    </div>` : ''}
                    
                    ${item.description ? `
                    <div style="margin-top: 16px;">
                        <h4 style="color: #1976D2; font-size: 14px; font-weight: 600; margin: 0 0 8px 0; text-transform: uppercase; letter-spacing: 0.5px;">What Makes It Special</h4>
                        <p style="color: #4a6741; font-size: 14px; line-height: 1.6; margin: 0; background: rgba(39, 174, 96, 0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #27ae60;">${item.description}</p>
                    </div>` : ''}
                </div>`;
            });
            
            enhanced += '</div></div>';
            
            console.log(' Enhanced structured list with', items.length, 'items');
            return enhanced;
        }

        function enhanceTextResponse(content, isAI = true) {
            console.log(' === ENHANCEMENT FUNCTION CALLED ===');
            console.log(' enhanceTextResponse called:', { contentLength: content.length, isAI, hasHTML: content.includes('<div'), preview: content.substring(0, 100) });
            console.log(' Full content for debugging:', content);
            
            // Skip enhancement if content already has HTML tags (valuation cards, photos, etc.)
            if (content.includes('<div') || content.includes('<img') || content.includes('<button')) {
                console.log(' Skipping enhancement: content already has HTML');
                return content;
            }
            
            // Skip enhancement for non-AI messages
            if (!isAI) {
                console.log(' Skipping enhancement: not AI message');
                return content;
            }

            // Special handling for property analysis content
            if (content.includes('Property Analysis') || content.includes('valuation') || 
                content.includes('comparable') || content.includes('market analysis')) {
                return enhancePropertyAnalysis(content);
            }

            // Special handling for structured lists (schools, shopping centers, amenities)
            // Only apply structured formatting to list-based content with specific patterns
            const hasNumberedList = content.match(/^\d+\.\s+/m); // Numbered list at start of line
            const hasStructuredKeywords = content.includes('**Type:**') || content.includes('**Address:**') || 
                                        content.includes('**Specialty:**') || content.includes('Location:') ||
                                        content.includes('Special Features:');
            const hasLocationBasedContent = (content.includes('schools') || content.includes('grocery') || 
                                           content.includes('shopping') || content.includes('hospital') || 
                                           content.includes('park')) && hasNumberedList;
            
            const isStructuredContent = hasLocationBasedContent && 
                                      (hasStructuredKeywords || content.length > 500) &&
                                      !content.toLowerCase().includes('market trend') &&
                                      !content.toLowerCase().includes('investment') &&
                                      !content.toLowerCase().includes('analysis');
                
                console.log(' Structured content detection:', {
                isStructuredContent,
                hasSchools: content.includes('schools'),
                hasType: content.includes('Type:') || content.includes('**Type:**'),
                hasAddress: content.includes('Address:') || content.includes('**Address:**'),
                hasSpecialty: content.includes('**Specialty:**'),
                hasSecondarySchool: content.includes('Secondary School'),
                hasElementarySchool: content.includes('Elementary School'),
                hasColonelBy: content.includes('Colonel By'),
                hasLisgar: content.includes('Lisgar Collegiate'),
                hasNumberedList: content.includes('1.') && content.includes('**'),
                hasSimpleNumberedList: content.match(/\d+\.\s+\w+/) !== null,
                contentLength: content.length,
                contentPreview: content.substring(0, 300),
                firstFewLines: content.split('\n').slice(0, 5)
            });            if (isStructuredContent) {
                console.log(' Detected structured list content, applying enhanced formatting');
                return enhanceStructuredListResponse(content);
            }
            
            // Split into paragraphs and process each
            const paragraphs = content.split('\n').filter(line => line.trim());
            let enhanced = '';
            let inList = false;
            
            for (let i = 0; i < paragraphs.length; i++) {
                const para = paragraphs[i].trim();
                if (!para) continue;
                
                // Headers (lines that are standalone and followed by content)
                if (i < paragraphs.length - 1 && 
                    para.length < 80 && 
                    !para.includes('.') && 
                    !para.startsWith('-') && 
                    !para.startsWith('') &&
                    !para.includes('$') &&
                    paragraphs[i + 1].trim().length > para.length) {
                    
                    if (inList) {
                        enhanced += '</ul>';
                        inList = false;
                    }
                    enhanced += `<h3 style="color: #1976D2; font-size: 18px; font-weight: 700; margin: 20px 0 12px 0; display: flex; align-items: center; gap: 8px;">
                        <span style="background: linear-gradient(135deg, #1976D2, #1565C0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 16px;"></span>
                        ${para}
                    </h3>`;
                    continue;
                }
                
                // List items (lines starting with bullet points, dashes, or numbers)
                if (para.match(/^[-*]\s/) || para.match(/^\d+\.\s/)) {
                    if (!inList) {
                        enhanced += '<ul style="margin: 16px 0; padding-left: 0; list-style: none;">';
                        inList = true;
                    }
                    
                    const listContent = para.replace(/^[-*]\s/, '').replace(/^\d+\.\s/, '');
                    enhanced += `<li style="margin: 8px 0; padding: 12px 16px; background: rgba(25, 118, 210, 0.05); border-left: 3px solid #1976D2; border-radius: 0 8px 8px 0; display: flex; align-items: start; gap: 8px;">
                        <span style="color: #1976D2; font-weight: 600; margin-top: 2px;"></span>
                        <span style="line-height: 1.6;">${listContent}</span>
                    </li>`;
                    continue;
                }
                
                // Close list if we were in one
                if (inList && !para.match(/^[-*]\s/) && !para.match(/^\d+\.\s/)) {
                    enhanced += '</ul>';
                    inList = false;
                }
                
                // Key information (lines with important keywords)
                if (para.includes('important') || para.includes('note') || para.includes('remember') || 
                    para.includes('tip') || para.includes('warning') || para.includes('advice')) {
                    enhanced += `<div style="background: linear-gradient(135deg, rgba(25, 118, 210, 0.1), rgba(21, 101, 192, 0.05)); border: 1px solid rgba(25, 118, 210, 0.2); border-radius: 12px; padding: 16px; margin: 16px 0; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="background: #1976D2; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-top: 2px;"></span>
                            <div style="line-height: 1.7; color: #1565C0;">${para}</div>
                        </div>
                    </div>`;
                    continue;
                }
                
                // Price/dollar mentions (make them stand out)
                let processedPara = para;
                if (para.includes('$')) {
                    processedPara = para.replace(/\$[\d,]+/g, match => 
                        `<strong style="color: #1976D2; font-weight: 700;">${match}</strong>`
                    );
                }
                
                // Regular paragraphs with better typography
                enhanced += `<p style="line-height: 1.7; margin: 12px 0; color: #1a1a1a; font-size: 15px;">${processedPara}</p>`;
            }
            
            // Close any open list
            if (inList) {
                enhanced += '</ul>';
            }
            
            // Wrap everything in a styled container
            const result = `<div style="padding: 4px 0;">${enhanced}</div>`;
            console.log(' Enhanced content generated:', { originalLength: content.length, enhancedLength: result.length, hasHeaders: result.includes('<h3'), hasLists: result.includes('<ul>') });
            return result;
        }

        /**
         *  Render Beautiful Valuation Card with AI Estimate
         * Formats structured valuation data from backend into visually appealing HTML
         * @param {Object} valuationData - Structured valuation data from backend API
         * @returns {string} HTML string for valuation card
         */
        function renderValuationCard(valuationData) {
            const structured = valuationData.structured_data || valuationData;
            
            // Extract data with fallbacks
            const listPrice = structured.list_price || 0;
            const aiEstimate = structured.ai_estimate || structured.valuation?.estimated_value || 0;
            const adjustmentRange = structured.adjustment_range || structured.valuation?.value_range || {};
            const confidence = structured.confidence || structured.valuation?.confidence_score || 0;
            const description = structured.description || '';
            const comparables = structured.comparables || structured.comparables_simple || [];
            const property = structured.property || {};
            
            // Calculate range
            const rangeLow = adjustmentRange.low || (aiEstimate * 0.93);
            const rangeHigh = adjustmentRange.high || (aiEstimate * 1.07);
            
            // Calculate price difference
            let priceDiff = 0;
            let priceDiffPct = 0;
            let diffIndicator = '';
            let diffColor = '';
            let diffIcon = '';
            
            if (listPrice > 0 && aiEstimate > 0) {
                priceDiff = aiEstimate - listPrice;
                priceDiffPct = (priceDiff / listPrice) * 100;
                
                if (Math.abs(priceDiffPct) >= 1) {
                    if (priceDiffPct > 0) {
                        diffIndicator = 'Above List Price';
                        diffColor = '#4CAF50';
                        diffIcon = '';
                    } else {
                        diffIndicator = 'Below List Price';
                        diffColor = '#FF9800';
                        diffIcon = '';
                    }
                }
            }
            
            // Build HTML with BRAND COLORS
            const html = `
                <div class="valuation-card" style="background: linear-gradient(135deg, #1976D2 0%, #1565C0 100%); border-radius: 16px; padding: 24px; margin: 16px 0; color: white; box-shadow: 0 8px 20px rgba(25, 118, 210, 0.3);">
                    <h2 style="margin: 0 0 20px 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                        <span style="background: rgba(255, 255, 255, 0.2); padding: 8px; border-radius: 8px; font-size: 20px;"></span>
                        Property Valuation Report
                    </h2>
                    
                    <!-- Property Info -->
                    ${property.address ? `
                        <div style="background: rgba(255, 255, 255, 0.1); padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 14px; opacity: 0.9;"> ${property.address || ''}</div>
                            ${property.city ? `<div style="font-size: 13px; opacity: 0.8; margin-top: 4px;">${property.city}, ${property.province || 'ON'}</div>` : ''}
                            ${property.bedrooms || property.bathrooms || property.sqft ? `
                                <div style="font-size: 13px; opacity: 0.9; margin-top: 8px;">
                                    ${property.bedrooms ? property.bedrooms + ' bed' : ''} 
                                    ${property.bathrooms ? '  ' + property.bathrooms + ' bath' : ''} 
                                    ${property.sqft ? '  ' + property.sqft.toLocaleString() + ' sqft' : ''}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    <!-- Price Comparison -->
                    <div class="price-comparison" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                        <!-- List Price -->
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 16px; border-radius: 12px; backdrop-filter: blur(10px); text-align: center;">
                            <div style="font-size: 13px; opacity: 0.9; margin-bottom: 8px;"> List Price</div>
                            <div style="font-size: 28px; font-weight: 700;">$${listPrice.toLocaleString()}</div>
                        </div>
                        
                        <!-- AI Estimate -->
                        <div style="background: rgba(255, 255, 255, 0.25); padding: 16px; border-radius: 12px; border: 2px solid rgba(255, 255, 255, 0.4); text-align: center;">
                            <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; opacity: 0.95;"> AI Estimated Value</div>
                            <div style="font-size: 28px; font-weight: 800;">$${aiEstimate.toLocaleString()}</div>
                            <div style="font-size: 12px; margin-top: 8px; opacity: 0.9;">
                                Range: $${Math.round(rangeLow).toLocaleString()} - $${Math.round(rangeHigh).toLocaleString()}
                            </div>
                            <div style="font-size: 11px; margin-top: 6px; opacity: 0.85;">
                                 Confidence: ${confidence}%
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Difference Indicator -->
                    ${diffIndicator ? `
                        <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                            <span style="font-size: 14px;">${diffIcon} ${diffIndicator}: </span>
                            <span style="font-size: 16px; font-weight: 700; color: ${diffColor};">
                                $${Math.abs(priceDiff).toLocaleString()} (${priceDiffPct > 0 ? '+' : ''}${priceDiffPct.toFixed(1)}%)
                            </span>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Description Section -->
                ${description ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 16px 0; color: #333; font-size: 18px; font-weight: 700;"> Property Analysis</h3>
                        <div style="color: #666; line-height: 1.8;">
                            ${formatPropertyDescription(description)}
                        </div>
                    </div>
                ` : ''}
                
                <!-- Comparable Properties -->
                ${comparables && comparables.length > 0 ? `
                    <div style="background: white; border-radius: 12px; padding: 20px; margin: 16px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 16px 0; color: #333; font-size: 18px; font-weight: 700;"> Comparable Properties (${comparables.length})</h3>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                            ${comparables.slice(0, 5).map((comp, i) => `
                                <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; border-left: 4px solid #1976D2;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 700; color: #333; margin-bottom: 4px;">${i + 1}. ${comp.address || 'Comparable Property'}</div>
                                            <div style="font-size: 13px; color: #666;">MLS: ${comp.mls_id || 'N/A'}</div>
                                            <div style="font-size: 14px; color: #1976D2; margin-top: 6px; font-weight: 600;">
                                                Sold: $${(comp.sold_price || comp.sale_price || 0).toLocaleString()}
                                            </div>
                                            <div style="font-size: 12px; color: #999; margin-top: 4px;">${comp.sold_date || comp.sale_date || 'Recently'}</div>
                                        </div>
                                        <div style="background: #1976D2; color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                             ${(comp.distance_km || 0).toFixed(1)}km
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${comparables.length > 5 ? `
                            <div style="text-align: center; margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px;">
                                <span style="color: #1976D2; font-weight: 600;">+${comparables.length - 5} more comparables analyzed</span>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <!-- Data Sources Footer -->
                <div style="background: #f8f9fa; border-radius: 8px; padding: 14px; margin: 16px 0; border-left: 4px solid #4CAF50;">
                    <div style="font-size: 12px; color: #666; line-height: 1.6;">
                        <div style="margin-bottom: 6px;"><strong> Data Sources:</strong> Repliers MLS Database, Recent Sales Data, Market Trends</div>
                        <div style="margin-bottom: 6px;"><strong> AI Model:</strong> OpenAI GPT-4o-mini with Canadian Real Estate Training</div>
                        <div><strong> Analysis Date:</strong> ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</div>
                    </div>
                </div>
            `;
            
            return html;
        }

        /**
         * Format property description with better visual structure
         * @param {string} description - Raw description text
         * @returns {string} Formatted HTML
         */
        function formatPropertyDescription(description) {
            if (!description) return '';
            
            const lines = description.split('\n').filter(line => line.trim());
            let formatted = '';
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                // Convert bullet points
                if (trimmed.startsWith('') || trimmed.startsWith('-') || trimmed.startsWith('*')) {
                    formatted += `<div style="margin: 8px 0 8px 20px; color: #555;"> ${trimmed.substring(1).trim()}</div>`;
                }
                // Headers (lines ending with colon)
                else if (trimmed.endsWith(':')) {
                    formatted += `<div style="font-weight: 700; color: #1976D2; margin: 16px 0 8px 0;">${trimmed}</div>`;
                }
                // Section markers (## or **)
                else if (trimmed.startsWith('##') || trimmed.startsWith('**')) {
                    const text = trimmed.replace(/^##\s*/, '').replace(/^\*\*/, '').replace(/\*\*$/, '');
                    formatted += `<div style="font-weight: 700; color: #1976D2; margin: 16px 0 8px 0;">${text}</div>`;
                }
                // Regular paragraphs
                else {
                    formatted += `<div style="margin: 8px 0;">${trimmed}</div>`;
                }
            }
            
            return formatted;
        }

        /**
         * Display property search results - CanaryAI Style
         * Properties go to right panel, summary goes to chat center
         */
        function addPropertySearchMessage(properties, responseText, quickReplies = [], searchCity = null, totalCount = null) {
            const container = document.getElementById('chatContainer');
            const message = document.createElement('div');
            message.className = 'message';
            
            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            console.log(' [PROPERTY CARDS] Search city parameter:', searchCity);
            console.log(' [CANARY STYLE] Sending', properties.length, 'properties to right panel');
            console.log(' [TOTAL COUNT] Backend reported total:', totalCount);
            
            // Clear and populate right panel with property cards
            clearRightPanelProperties();
            properties.forEach(prop => {
                addPropertyToRightPanel({
                    listPrice: prop.price || prop.list_price,
                    streetAddress: prop.full_address || prop.address,
                    city: searchCity || prop.city || 'Toronto',
                    bedroomsTotal: prop.bedrooms || prop.beds,
                    bathroomsTotalInteger: prop.bathrooms || prop.baths,
                    sqft: prop.sqft || prop.square_footage,
                    images: prop.images || [prop.image_url],
                    mlsNumber: prop.mls_number || prop.mls_id
                });
            });
            
            // Show right panel
            showRightPanel();
            
            // Calculate property statistics for summary
            const stats = calculatePropertyStats(properties);
            
            // Build CanaryAI-style summary for chat center (pass totalCount for accurate messaging)
            const summaryHtml = generateCanarySummary(properties, stats, searchCity, responseText, totalCount);
            
            message.innerHTML = `
                <div class="message-avatar ai-avatar">
                    <img src="summitly_logo.webp" alt="Summitly" style="width: 100%; height: 100%; object-fit: contain; border-radius: 50%;" onerror="this.style.display='none'; this.parentElement.innerHTML='';">
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-author">Summitly AI</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">
                        ${summaryHtml}
                        ${quickReplies.length > 0 ? generateQuickReplies(quickReplies) : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(message);
            scrollToBottom();
            
            chatHistory.push({ 
                sender: 'ai', 
                content: 'Property Search Results', 
                properties: properties, 
                timestamp: new Date() 
            });
        }
        
        /**
         * Calculate statistics from property list
         */
        function calculatePropertyStats(properties) {
            const prices = properties.map(p => p.price || p.list_price || 0).filter(p => p > 0);
            const beds = properties.map(p => p.bedrooms || p.beds || 0).filter(b => b > 0);
            const baths = properties.map(p => p.bathrooms || p.baths || 0).filter(b => b > 0);
            const sqfts = properties.map(p => p.sqft || p.square_footage || 0).filter(s => s > 0);
            
            const median = arr => {
                if (arr.length === 0) return 0;
                const sorted = [...arr].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
            };
            
            return {
                count: properties.length,
                priceRange: prices.length > 0 ? { min: Math.min(...prices), max: Math.max(...prices), median: median(prices) } : null,
                bedsRange: beds.length > 0 ? { min: Math.min(...beds), max: Math.max(...beds), median: median(beds) } : null,
                bathsRange: baths.length > 0 ? { min: Math.min(...baths), max: Math.max(...baths), median: median(baths) } : null,
                sqftRange: sqfts.length > 0 ? { min: Math.min(...sqfts), max: Math.max(...sqfts), median: median(sqfts) } : null
            };
        }
        
        /**
         * Generate CanaryAI-style property summary
         */
        function generateCanarySummary(properties, stats, city, responseText, totalCount = null) {
            const cityName = city || 'your area';
            
            // Extract property type from first property or default
            const propertyType = properties[0]?.property_type || properties[0]?.type || 'properties';
            
            // Use total count from backend if available, otherwise show displayed count
            const displayCount = stats.count;
            const actualTotal = totalCount || displayCount;
            const showingSubset = actualTotal > displayCount;
            
            let html = `
                <div class="canary-summary" style="background: linear-gradient(135deg, #f8fbff 0%, #e8f4fd 100%); border-radius: 16px; padding: 24px; border: 1px solid rgba(25, 118, 210, 0.15);">
                    <!-- Header -->
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                        <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #1976D2, #1565C0); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white;"></div>
                        <div>
                            ${showingSubset ? `
                                <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #1a1a1a;">Found ${actualTotal} ${propertyType}</h3>
                                <p style="margin: 4px 0 0 0; font-size: 14px; color: #666;">Showing ${displayCount} great options in ${cityName}</p>
                            ` : `
                                <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #1a1a1a;">Showing ${displayCount} great ${propertyType}</h3>
                                <p style="margin: 4px 0 0 0; font-size: 14px; color: #666;">in ${cityName}</p>
                            `}
                        </div>
                    </div>
                    
                    <!-- Stats Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
            `;
            
            // Price Range
            if (stats.priceRange) {
                html += `
                    <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e0e0e0;">
                        <div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Price Range</div>
                        <div style="font-size: 16px; font-weight: 600; color: #1976D2;">$${formatNumber(stats.priceRange.min)} - $${formatNumber(stats.priceRange.max)}</div>
                        <div style="font-size: 13px; color: #666; margin-top: 4px;">Median: $${formatNumber(stats.priceRange.median)}</div>
                    </div>
                `;
            }
            
            // Bedrooms & Bathrooms
            if (stats.bedsRange || stats.bathsRange) {
                html += `
                    <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e0e0e0;">
                        <div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Bedrooms & Bathrooms</div>
                        ${stats.bedsRange ? `<div style="font-size: 14px; color: #333;">${stats.bedsRange.min} to ${stats.bedsRange.max} bedrooms (median: ${stats.bedsRange.median})</div>` : ''}
                        ${stats.bathsRange ? `<div style="font-size: 14px; color: #333;">${stats.bathsRange.min} to ${stats.bathsRange.max} bathrooms (median: ${stats.bathsRange.median})</div>` : ''}
                    </div>
                `;
            }
            
            // Size
            if (stats.sqftRange) {
                html += `
                    <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e0e0e0;">
                        <div style="font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Living Area</div>
                        <div style="font-size: 16px; font-weight: 600; color: #333;">${formatNumber(stats.sqftRange.min)} - ${formatNumber(stats.sqftRange.max)} sq ft</div>
                        <div style="font-size: 13px; color: #666; margin-top: 4px;">Median: ${formatNumber(stats.sqftRange.median)} sq ft</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                    
                    <!-- Response Text / AI Commentary -->
                    ${responseText ? `
                        <div style="background: white; border-radius: 12px; padding: 16px; border-left: 4px solid #1976D2; margin-bottom: 16px;">
                            <p style="margin: 0; font-size: 14px; line-height: 1.6; color: #333;">${responseText}</p>
                        </div>
                    ` : ''}
                    
                    <!-- Properties Panel Indicator -->
                    <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(25, 118, 210, 0.08); border-radius: 8px; padding: 12px 16px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 14px; color: #1976D2; font-weight: 500;">${displayCount} properties loaded in the panel</span>
                        </div>
                        <button onclick="toggleRightPanel()" style="background: #1976D2; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500;">
                            View Properties
                        </button>
                    </div>
                    
                    <!-- Follow-up Suggestions -->
                    <div style="margin-top: 16px;">
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">Would you like me to filter these results further?</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <button class="btn-small" onclick="sendMessage('Show me only properties under $400K')" style="background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 12px;">Under $400K</button>
                            <button class="btn-small" onclick="sendMessage('Show me 2+ bedroom options')" style="background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 12px;">2+ Bedrooms</button>
                            <button class="btn-small" onclick="sendMessage('Sort by lowest price')" style="background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 12px;">Lowest Price First</button>
                            <button class="btn-small" onclick="sendMessage('Show me the newest listings')" style="background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; cursor: pointer; font-size: 12px;">Newest Listings</button>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function generatePropertyCards(properties) {
            return properties.map(prop => {
                // Format price properly
                let formattedPrice = 'Price on Request';
                if (prop.price || prop.listPrice) {
                    const priceValue = prop.price || prop.listPrice;
                    formattedPrice = typeof priceValue === 'number' ? 
                        `$${priceValue.toLocaleString()}` : 
                        (priceValue === 'N/A' ? 'Price on Request' : priceValue);
                }
                
                // Get address (handle both 'address' and 'location' fields)
                const address = prop.address || prop.location || 'Property Address';
                
                // Get bedrooms (handle N/A)
                const bedrooms = (prop.bedrooms === 'N/A' || prop.bedrooms === null || prop.bedrooms === undefined) ? 
                    (prop.beds || 'Studio') : prop.bedrooms;
                
                // Get bathrooms
                const bathrooms = prop.bathrooms || prop.baths || 0;
                
                // Get sqft
                const sqft = (prop.sqft && prop.sqft !== 'N/A') ? prop.sqft : null;
                
                // Get image URL
                const imageUrl = prop.image || prop.image_url || 'https://via.placeholder.com/400x300?text=Property+Image';
                
                // Get property ID
                const propertyId = prop.mlsNumber || prop.mls_number || prop.id || '';
                
                return `
                <div class="property-card">
                    <img src="${imageUrl}" alt="${address}" class="property-image" onerror="this.src='https://via.placeholder.com/400x300?text=Property+Image'">
                    <div class="property-details">
                        <div class="property-price">${formattedPrice}</div>
                        <div class="property-address">${address}</div>
                        <div class="property-specs">
                            <span class="property-spec"> ${bedrooms} bed${bedrooms !== 1 && bedrooms !== 'Studio' ? 's' : ''}</span>
                            <span class="property-spec"> ${bathrooms} bath${bathrooms !== 1 ? 's' : ''}</span>
                            ${sqft ? `<span class="property-spec"> ${sqft}</span>` : ''}
                        </div>
                        <div class="property-actions">
                            <button class="btn-small" onclick="viewProperty('${propertyId}')"> View Details</button>
                            <button class="btn-small" onclick="analyzeProperty('${propertyId}', '${address.replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')"> AI Analysis</button>
                            <button class="btn-small" onclick="showMarketAnalysis('${address.replace(/'/g, '\\\'').replace(/"/g, '&quot;')}')"> Market Analysis</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function generateQuickReplies(replies) {
            return `
                <div class="quick-replies">
                    ${replies.map(reply => `
                        <button class="quick-reply-btn" onclick="sendMessage('${reply}')">${reply}</button>
                    `).join('')}
                </div>
            `;
        }

        function generateSourceLinks(sources) {
            return `
                <div class="source-links">
                    ${sources.map(source => `
                        <a href="${source.url}" class="source-link" target="_blank"> ${source.title}</a>
                    `).join('')}
                </div>
            `;
        }

        /**
         * Show professional market stats loading animation with rotating insights
         * Perplexity/Gemini-style loading experience
         */
        function showMarketStatsLoader() {
            const container = document.getElementById('chatContainer');
            
            // Remove any existing loader
            const existingLoader = document.getElementById('marketStatsLoader');
            if (existingLoader) {
                existingLoader.remove();
            }
            
            const loader = document.createElement('div');
            loader.className = 'message';
            loader.id = 'marketStatsLoader';
            
            // Canadian real estate market insights
            const insights = [
                " Searching <strong>live MLS database</strong> for the best properties...",
                " Canada's housing market shows <strong>increased stability</strong> in 2025",
                " GTA inventory is <strong>rising</strong> with more listings available",
                " Interest rates are <strong>gradually easing</strong> across major cities",
                " Analyzing <strong>market trends</strong> in your area...",
                " Toronto remains one of Canada's <strong>hottest markets</strong>",
                " Average home prices are <strong>stabilizing</strong> after peak volatility",
                " Finding properties that match <strong>your criteria</strong>..."
            ];
            
            let currentInsightIndex = 0;
            
            loader.innerHTML = `
                <div class="message-avatar ai-avatar"></div>
                <div class="message-content">
                    <div class="market-stats-loader">
                        <div class="loader-header">
                            <div class="loader-icon"></div>
                            <div>
                                <div class="loader-title">Searching Properties</div>
                                <div class="loader-subtitle">Analyzing market data...</div>
                            </div>
                        </div>
                        
                        <div class="market-insight-carousel">
                            <div class="market-insight active" id="currentInsight">
                                ${insights[0]}
                            </div>
                        </div>
                        
                        <div class="loading-stats-grid">
                            <div class="loading-stat-card">
                                <span class="loading-stat-icon"></span>
                                <div class="loading-stat-label">Active Listings</div>
                                <div class="loading-stat-value">12,000+</div>
                            </div>
                            <div class="loading-stat-card">
                                <span class="loading-stat-icon"></span>
                                <div class="loading-stat-label">Cities Covered</div>
                                <div class="loading-stat-value">450+</div>
                            </div>
                            <div class="loading-stat-card">
                                <span class="loading-stat-icon"></span>
                                <div class="loading-stat-label">Real-time Data</div>
                                <div class="loading-stat-value">Live</div>
                            </div>
                            <div class="loading-stat-card">
                                <span class="loading-stat-icon"></span>
                                <div class="loading-stat-label">Accuracy</div>
                                <div class="loading-stat-value">99%</div>
                            </div>
                        </div>
                        
                        <div class="loading-progress-bar">
                            <div class="loading-progress-fill"></div>
                        </div>
                        <div class="loading-status-text">Fetching live MLS listings...</div>
                    </div>
                </div>
            `;
            
            container.appendChild(loader);
            scrollToBottom();
            
            // Rotate insights every 2.5 seconds
            const insightElement = loader.querySelector('#currentInsight');
            const rotationInterval = setInterval(() => {
                currentInsightIndex = (currentInsightIndex + 1) % insights.length;
                
                // Fade out
                insightElement.style.opacity = '0';
                insightElement.style.transform = 'translateY(-10px)';
                
                setTimeout(() => {
                    insightElement.innerHTML = insights[currentInsightIndex];
                    // Fade in
                    insightElement.style.opacity = '1';
                    insightElement.style.transform = 'translateY(0)';
                }, 300);
            }, 2500);
            
            // Store interval ID for cleanup
            loader.dataset.intervalId = rotationInterval;
            
            return loader;
        }

        /**
         * Hide market stats loader
         */
        function hideMarketStatsLoader() {
            const loader = document.getElementById('marketStatsLoader');
            if (loader) {
                // Clear rotation interval
                if (loader.dataset.intervalId) {
                    clearInterval(parseInt(loader.dataset.intervalId));
                }
                
                // Fade out animation
                loader.style.opacity = '0';
                loader.style.transform = 'translateY(-20px)';
                loader.style.transition = 'all 0.4s ease-out';
                
                setTimeout(() => {
                    loader.remove();
                }, 400);
            }
        }

        /**
         * Enhanced typing indicator with smooth animations
         * Used for non-property queries (general chat, valuations, etc.)
         */
        function showTypingIndicator(customMessage = null) {
            const container = document.getElementById('chatContainer');
            
            // Remove any existing typing indicator
            const existingIndicator = document.getElementById('typingIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            const indicator = document.createElement('div');
            indicator.className = 'message';
            indicator.id = 'typingIndicator';
            
            const statusText = customMessage || 'AI is thinking...';
            
            // Determine icon and color based on message type
            let icon = '';
            let accentColor = '#1976D2';
            let statusIcon = '';
            
            if (statusText.includes('valuation') || statusText.includes('Calculating')) {
                icon = '';
                accentColor = '#1976D2';
                statusIcon = '';
            } else if (statusText.includes('Searching') || statusText.includes('database')) {
                icon = '';
                accentColor = '#1976D2';
                statusIcon = '';
            } else if (statusText.includes('Analyzing')) {
                icon = '';
                accentColor = '#1976D2';
                statusIcon = '';
            } else if (statusText.includes('Loading')) {
                icon = '';
                accentColor = '#1976D2';
                statusIcon = '';
            }
            
            indicator.innerHTML = `
                <div class="message-avatar ai-avatar">${icon}</div>
                <div class="message-content">
                    <div class="typing-indicator-enhanced" style="
                        background: linear-gradient(135deg, ${accentColor}15 0%, ${accentColor}08 100%);
                        border-radius: 12px;
                        padding: 16px 20px;
                        border-left: 3px solid ${accentColor};
                        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                        animation: slideInLeft 0.3s ease-out;
                    ">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="typing-dots-enhanced">
                                <div class="typing-dot-enhanced" style="background: ${accentColor};"></div>
                                <div class="typing-dot-enhanced" style="background: ${accentColor}; animation-delay: 0.2s;"></div>
                                <div class="typing-dot-enhanced" style="background: ${accentColor}; animation-delay: 0.4s;"></div>
                            </div>
                            <span class="typing-text-enhanced" style="color: ${accentColor}; font-weight: 500;">
                                ${statusIcon} ${statusText}
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(indicator);
            scrollToBottom();
        }
        
        function showSearchingIndicator() {
            showTypingIndicator('Searching MLS database...');
        }
        
        function showAnalyzingIndicator() {
            showTypingIndicator('Analyzing properties...');
        }
        
        function showLoadingPropertyDetails() {
            showTypingIndicator('Loading property details...');
        }

        // ==================== AI ANALYSIS SIDE PANEL ====================

        /**
         * Open AI Analysis Panel with Perplexity-style animation (Quick Insights Mode)
         */
        async function openAIAnalysisPanel(mlsId, type = 'property') {
            const panel = document.getElementById('aiAnalysisPanel');
            const body = document.getElementById('aiPanelBody');
            
            // Open panel
            panel.classList.add('open');
            
            // Show analyzing animation
            body.innerHTML = `
                <div class="ai-analyzing">
                    <div class="ai-analyzing-icon"></div>
                    <div class="ai-analyzing-text">Analyzing Property Data...</div>
                    <div class="ai-analyzing-sources">
                        <div class="ai-source-item">
                            <div class="ai-source-icon"></div>
                            <div class="ai-source-text">Fetching property details</div>
                            <div class="ai-source-status"></div>
                        </div>
                        <div class="ai-source-item">
                            <div class="ai-source-icon"></div>
                            <div class="ai-source-text">Analyzing schools & amenities</div>
                            <div class="ai-source-status">...</div>
                        </div>
                        <div class="ai-source-item">
                            <div class="ai-source-icon"></div>
                            <div class="ai-source-text">Generating AI insights</div>
                            <div class="ai-source-status">...</div>
                        </div>
                        <div class="ai-source-item">
                            <div class="ai-source-icon"></div>
                            <div class="ai-source-text">Calculating value estimate</div>
                            <div class="ai-source-status">...</div>
                        </div>
                    </div>
                </div>
            `;

            // Simulate analysis steps
            await new Promise(resolve => setTimeout(resolve, 500));
            updateAnalysisStep(1);
            await new Promise(resolve => setTimeout(resolve, 600));
            updateAnalysisStep(2);
            await new Promise(resolve => setTimeout(resolve, 700));
            updateAnalysisStep(3);
            
            // Fetch lightweight AI analysis (Quick Insights Mode)
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/property-analysis`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mls_number: mlsId,
                        mode: 'quick_insights',
                        session_id: currentSessionId
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Display quick insights
                    displayQuickInsights(data, mlsId);
                } else {
                    body.innerHTML = `
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 16px;"></div>
                            <p>Unable to fetch analysis. Please try again.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('AI Analysis error:', error);
                body.innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <p>Error loading analysis: ${error.message}</p>
                    </div>
                `;
            }
        }

        function updateAnalysisStep(step) {
            const sources = document.querySelectorAll('.ai-source-item');
            if (sources[step]) {
                const status = sources[step].querySelector('.ai-source-status');
                if (status) status.textContent = '';
            }
        }

        /**
         * Helper function to render schools section
         */
        function renderSchoolsSection(schools) {
            console.log(' [Schools Render] Processing schools:', schools);
            
            let schoolsHtml = '<div class="insight-section" style="background: #f8fffe; border-left: 4px solid #20b2aa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">';
            schoolsHtml += '<h3 class="insight-title" style="margin: 0 0 12px 0; color: #20b2aa; font-size: 16px; font-weight: 600;"> Local Schools Available</h3>';
            schoolsHtml += '<div class="schools-container">';
            
            if (schools && Array.isArray(schools) && schools.length > 0) {
                schools.forEach(school => {
                    const name = school.name || school.school_name || school.title || 'Local School';
                    const rating = school.rating || school.score || school.grade || '8';
                    const type = school.type || school.level || school.category || 'Mixed';
                    const distance = school.distance || school.proximity || 'Nearby';
                    
                    schoolsHtml += '<div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e0f2f1;">';
                    schoolsHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">';
                    schoolsHtml += '<strong style="color: #1b5e20; font-size: 14px;">' + name + '</strong>';
                    schoolsHtml += '<span style="background: #4caf50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;"> ' + rating + '/10</span>';
                    schoolsHtml += '</div>';
                    schoolsHtml += '<div style="font-size: 12px; color: #666;">';
                    schoolsHtml += '<span style="background: #e8f5e8; padding: 2px 6px; border-radius: 4px; margin-right: 6px;">' + type + '</span>';
                    schoolsHtml += '<span style="color: #757575;"> ' + distance + '</span>';
                    schoolsHtml += '</div>';
                    schoolsHtml += '</div>';
                });
            } else {
                // Fallback school display
                schoolsHtml += '<div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e0f2f1;">';
                schoolsHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">';
                schoolsHtml += '<strong style="color: #1b5e20; font-size: 14px;">Local Schools Available</strong>';
                schoolsHtml += '<span style="background: #4caf50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;"> 8/10</span>';
                schoolsHtml += '</div>';
                schoolsHtml += '<div style="font-size: 12px; color: #666;">';
                schoolsHtml += '<span style="background: #e8f5e8; padding: 2px 6px; border-radius: 4px; margin-right: 6px;">Mixed</span>';
                schoolsHtml += '<span style="color: #757575;"> Nearby</span>';
                schoolsHtml += '</div>';
                schoolsHtml += '</div>';
            }
            
            schoolsHtml += '</div>';
            schoolsHtml += '</div>';
            
            return schoolsHtml;
        }

        // ==================== SCHOOLS FUNCTIONALITY (FEATURE 1) ====================

        let currentPropertyMLS = null;  // Track which property schools are for

        /**
         * CRITICAL: Update the current property context.
         * This is called whenever a property card is clicked or viewed.
         */
        function updatePropertyContext(propertyData) {
            currentPropertyMLS = propertyData.mls_number || propertyData.mlsNumber || null;
            console.log(` [JS] Property context updated: MLS ${currentPropertyMLS}`);
            
            // Extract city for market analysis
            const city = propertyData.city || 
                        propertyData.location || 
                        (propertyData.address && propertyData.address.split(',')[0].trim()) || 
                        'Ontario';
            
            // Refresh all property-specific data
            if (currentPropertyMLS) {
                loadSchoolsForProperty(currentPropertyMLS, propertyData);
                
                // FEATURE 2: Load market analysis for this property's city
                updateMarketContext(city, currentPropertyMLS);
            }
        }

        /**
         * CRITICAL: Load schools specifically for this MLS property.
         * Must show different schools for each property!
         */
        async function loadSchoolsForProperty(mlsNumber, propertyData) {
            try {
                console.log(` [FETCH] Loading schools for MLS: ${mlsNumber}`);
                
                // Show loading state
                const schoolsContent = document.getElementById('schools-content');
                const schoolsLoading = document.getElementById('schools-loading');
                const schoolsError = document.getElementById('schools-error');
                
                if (schoolsLoading) schoolsLoading.classList.remove('hidden');
                if (schoolsContent) schoolsContent.innerHTML = '';
                if (schoolsError) schoolsError.classList.add('hidden');
                
                // Get city from property data
                const city = propertyData.city || 
                            propertyData.location || 
                            (propertyData.address && propertyData.address.split(',')[0].trim()) || 
                            'Ontario';
                
                // Fetch schools from backend
                const response = await fetch(
                    `${getApiBaseUrl()}/api/schools/${mlsNumber}?city=${encodeURIComponent(city)}&limit=5`,
                    {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Schools API failed with status ${response.status}`);
                }
                
                const schoolsData = await response.json();
                console.log(` [FETCH] Schools data received:`, schoolsData);
                
                // Hide loading state
                if (schoolsLoading) schoolsLoading.classList.add('hidden');
                
                if (schoolsData.success && schoolsData.schools && schoolsData.schools.length > 0) {
                    renderSchoolsList(schoolsData.schools, mlsNumber);
                    const schoolsSection = document.getElementById('schools-section');
                    if (schoolsSection) schoolsSection.classList.remove('hidden');
                } else {
                    showSchoolsError('No schools found nearby. Try a different property.');
                }
                
            } catch (error) {
                console.error(' [FETCH] Schools fetch error:', error);
                const schoolsLoading = document.getElementById('schools-loading');
                if (schoolsLoading) schoolsLoading.classList.add('hidden');
                showSchoolsError(`Error loading schools: ${error.message}`);
            }
        }

        /**
         * Render schools list with proper formatting and animations.
         * CRITICAL: Include MLS number for reference.
         */
        function renderSchoolsList(schools, mlsNumber) {
            const schoolsContent = document.getElementById('schools-content');
            
            if (!schoolsContent) {
                console.error(' Schools content element not found');
                return;
            }
            
            if (!schools || schools.length === 0) {
                schoolsContent.innerHTML = '<p style="color: #666;">No schools found.</p>';
                return;
            }
            
            let html = `<div class="schools-metadata">
                        MLS #${mlsNumber}  ${schools.length} schools found
                    </div>`;
            
            schools.forEach((school, index) => {
                const ratingDisplay = typeof school.rating === 'number' 
                    ? `${school.rating.toFixed(1)}/10` 
                    : (school.rating || 'N/A');
                
                const distanceDisplay = (school.distance_km && typeof school.distance_km === 'number')
                    ? `${school.distance_km.toFixed(1)} km away`
                    : (school.distance_km ? `${school.distance_km} km away` : 'Distance not available');
                
                const programsHTML = school.programs && school.programs.length > 0
                    ? `<div class="school-programs">
                        <strong>Programs:</strong><br/>
                        ${school.programs.map(p => `<span class="program-tag">${p}</span>`).join('')}
                    </div>`
                    : '';
                
                html += `
                    <div class="school-card" style="animation: slideInUp 0.3s ease forwards; animation-delay: ${index * 50}ms;">
                        <div class="school-name">${school.name}</div>
                        <div>
                            <span class="school-type">${school.type || 'School'}</span>
                            ${school.rating ? `<span class="school-rating"> ${ratingDisplay}</span>` : ''}
                        </div>
                        <div class="school-distance">
                             ${distanceDisplay}
                        </div>
                        ${school.address ? `<div class="school-address" style="font-size: 12px; color: #666; margin-top: 4px;">${school.address}</div>` : ''}
                        ${programsHTML}
                        ${school.website ? `<div style="margin-top: 8px;"><a href="${school.website}" target="_blank" class="info-link">Visit Website </a></div>` : ''}
                    </div>
                `;
            });
            
            schoolsContent.innerHTML = html;
        }

        /**
         * Display error message in schools section.
         */
        function showSchoolsError(message) {
            const errorEl = document.getElementById('schools-error');
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
            
            const contentEl = document.getElementById('schools-content');
            if (contentEl) {
                contentEl.innerHTML = '';
            }
        }

        /**
         * Refresh schools data for current property.
         */
        function refreshSchoolsData() {
            if (currentPropertyMLS) {
                console.log(` [REFRESH] Reloading schools for MLS ${currentPropertyMLS}`);
                // Get current property data from context
                const currentProperty = getCurrentPropertyFromContext();
                if (currentProperty) {
                    loadSchoolsForProperty(currentPropertyMLS, currentProperty);
                }
            } else {
                alert('Please select a property first to view nearby schools.');
            }
        }

        /**
         * Get current property data from context (helper function).
         */
        function getCurrentPropertyFromContext() {
            // This is a placeholder - in practice, this would retrieve 
            // the current property data from the session or state
            return {
                mls_number: currentPropertyMLS,
                city: 'Toronto', // Fallback
                // Add other property data as needed
            };
        }

        /**
         * Enhanced renderSchoolsSection that integrates with the new schools API
         */
        function renderSchoolsSection(schools, mlsId) {
            console.log(' [Schools Render] Processing schools:', schools);
            
            // If we have an MLS ID, use the new dynamic schools system
            if (mlsId && mlsId !== 'N/A') {
                return `
                    <div id="schools-section" class="insight-section" style="background: #f8fffe; border-left: 4px solid #20b2aa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0; color: #20b2aa; font-size: 16px; font-weight: 600;"> Nearby Schools</h3>
                            <button class="refresh-btn" onclick="refreshSchoolsData()" style="background: none; border: none; cursor: pointer; color: #20b2aa; font-size: 16px;" title="Refresh schools data"></button>
                        </div>
                        
                        <div id="schools-loading" class="schools-loading hidden">
                            <div style="margin: 10px 0; text-align: center;">
                                <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #20b2aa; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <p style="margin: 10px 0 0 0; color: #666;">Fetching nearby schools...</p>
                            </div>
                        </div>
                        
                        <div id="schools-content" class="schools-list"></div>
                        
                        <div id="schools-error" class="schools-error hidden"></div>
                    </div>
                `;
            }
            
            // Fallback to original static implementation if no MLS ID
            let schoolsHtml = '<div class="insight-section" style="background: #f8fffe; border-left: 4px solid #20b2aa; padding: 16px; border-radius: 8px; margin-bottom: 16px;">';
            schoolsHtml += '<h3 class="insight-title" style="margin: 0 0 12px 0; color: #20b2aa; font-size: 16px; font-weight: 600;"> Local Schools Available</h3>';
            schoolsHtml += '<div class="schools-container">';
            
            if (schools && Array.isArray(schools) && schools.length > 0) {
                schools.forEach(school => {
                    const name = school.name || school.school_name || school.title || 'Local School';
                    const rating = school.rating || school.score || school.grade || '8';
                    const type = school.type || school.level || school.category || 'Mixed';
                    const distance = school.distance || school.proximity || 'Nearby';
                    
                    schoolsHtml += '<div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e0f2f1;">';
                    schoolsHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">';
                    schoolsHtml += '<strong style="color: #1b5e20; font-size: 14px;">' + name + '</strong>';
                    schoolsHtml += '<span style="background: #4caf50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;"> ' + rating + '/10</span>';
                    schoolsHtml += '</div>';
                    schoolsHtml += '<div style="font-size: 12px; color: #666;">';
                    schoolsHtml += '<span style="background: #e8f5e8; padding: 2px 6px; border-radius: 4px; margin-right: 6px;">' + type + '</span>';
                    schoolsHtml += '<span style="color: #757575;"> ' + distance + '</span>';
                    schoolsHtml += '</div>';
                    schoolsHtml += '</div>';
                });
            } else {
                // Fallback school display
                schoolsHtml += '<div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #e0f2f1;">';
                schoolsHtml += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">';
                schoolsHtml += '<strong style="color: #1b5e20; font-size: 14px;">Local Schools Available</strong>';
                schoolsHtml += '<span style="background: #4caf50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;"> 8/10</span>';
                schoolsHtml += '</div>';
                schoolsHtml += '<div style="font-size: 12px; color: #666;">';
                schoolsHtml += '<span style="background: #e8f5e8; padding: 2px 6px; border-radius: 4px; margin-right: 6px;">Mixed</span>';
                schoolsHtml += '<span style="color: #757575;"> Nearby</span>';
                schoolsHtml += '</div>';
                schoolsHtml += '</div>';
            }
            
            schoolsHtml += '</div>';
            schoolsHtml += '</div>';
            
            return schoolsHtml;
        }

        // ==================== END SCHOOLS FUNCTIONALITY ====================

        // ==================== MARKET ANALYSIS FUNCTIONALITY (FEATURE 2) ====================

        /**
         * Global market analysis data store
         */
        let currentMarketData = null;
        let marketChartsInstances = {};

        /**
         * Load market analysis for a specific city/location
         * CRITICAL: Each city must show different data
         */
        async function loadMarketAnalysis(city, province = 'ON', mlsId = null) {
            console.log(' [Market] Loading market analysis for:', city, province);
            
            try {
                // Show loading state
                showMarketLoading();
                
                // Build API URL using correct base URL
                const apiUrl = `${getApiBaseUrl()}/api/market-analysis/${encodeURIComponent(city)}?province=${province}${mlsId ? `&mls_number=${mlsId}` : ''}`;
                console.log(' [Market] API URL:', apiUrl);
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                console.log(' [Market] API Response:', data);
                
                if (data.success) {
                    currentMarketData = data;
                    renderMarketAnalysis(data);
                    
                    // Render graphs after a short delay to ensure DOM is ready
                    setTimeout(() => {
                        renderMarketGraphs(data.graphs || []);
                    }, 100);
                    
                } else {
                    showMarketError(data.error || 'Failed to load market analysis');
                }
            } catch (error) {
                console.error(' [Market] Load error:', error);
                showMarketError('Network error loading market analysis');
            }
        }

        /**
         * Render market analysis section with statistics and AI insights
         */
        function renderMarketAnalysis(data) {
            console.log(' [Market] Rendering market analysis:', data);
            
            const container = document.getElementById('market-analysis-content');
            if (!container) {
                console.warn(' [Market] Market analysis container not found');
                return;
            }
            
            const stats = data.statistics || {};
            const analysis = data.ai_analysis || '';
            const city = data.city || 'Unknown';
            
            // Build statistics grid
            let statsHtml = '';
            if (Object.keys(stats).length > 0) {
                statsHtml = `
                    <div class="market-stats-grid">
                        ${stats.average_price ? `
                            <div class="market-stat-item">
                                <div class="market-stat-value">$${stats.average_price.toLocaleString()}</div>
                                <div class="market-stat-label">Avg Price</div>
                            </div>
                        ` : ''}
                        ${stats.days_on_market ? `
                            <div class="market-stat-item">
                                <div class="market-stat-value">${stats.days_on_market}</div>
                                <div class="market-stat-label">Days on Market</div>
                            </div>
                        ` : ''}
                        ${stats.price_per_sqft ? `
                            <div class="market-stat-item">
                                <div class="market-stat-value">$${stats.price_per_sqft}</div>
                                <div class="market-stat-label">Price/Sqft</div>
                            </div>
                        ` : ''}
                        ${stats.price_trend_yoy ? `
                            <div class="market-stat-item">
                                <div class="market-stat-value">${stats.price_trend_yoy > 0 ? '+' : ''}${stats.price_trend_yoy}%</div>
                                <div class="market-stat-label">YoY Trend</div>
                            </div>
                        ` : ''}
                        ${stats.active_listings ? `
                            <div class="market-stat-item">
                                <div class="market-stat-value">${stats.active_listings}</div>
                                <div class="market-stat-label">Active Listings</div>
                            </div>
                        ` : ''}
                        ${stats.market_condition ? `
                            <div class="market-stat-item">
                                <div class="market-stat-value" style="font-size: 12px;">${stats.market_condition}</div>
                                <div class="market-stat-label">Market</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            // Build AI analysis section
            let analysisHtml = '';
            if (analysis) {
                analysisHtml = `
                    <div class="market-analysis-text">
                        <p>${analysis}</p>
                    </div>
                `;
            }
            
            // Build graphs container
            const graphsHtml = `
                <div class="market-graphs-container" id="market-graphs-container">
                    <div class="market-graphs-header">
                        <div class="market-graphs-title"> Market Trends & Analysis</div>
                    </div>
                    <div class="market-graphs-grid" id="market-graphs-grid">
                        <!-- Charts will be rendered here -->
                    </div>
                </div>
            `;
            
            // Build metadata
            const timestamp = data.analysis_timestamp ? new Date(data.analysis_timestamp).toLocaleString() : 'Recent';
            const metadataHtml = `
                <div class="market-metadata">
                     Market data for ${city}  Generated: ${timestamp}
                </div>
            `;
            
            // Update container
            container.innerHTML = statsHtml + analysisHtml + graphsHtml + metadataHtml;
            
            // Hide loading, show content
            hideMarketLoading();
            console.log(' [Market] Market analysis rendered successfully');
        }

        /**
         * Render market analysis graphs using Chart.js
         */
        function renderMarketGraphs(graphs) {
            console.log(' [Market] Rendering graphs:', graphs);
            
            if (!graphs || graphs.length === 0) {
                console.warn(' [Market] No graphs to render');
                return;
            }
            
            const graphsContainer = document.getElementById('market-graphs-grid');
            if (!graphsContainer) {
                console.warn(' [Market] Graphs container not found');
                return;
            }
            
            // Clear existing charts
            Object.values(marketChartsInstances).forEach(chart => {
                if (chart) chart.destroy();
            });
            marketChartsInstances = {};
            
            // Clear container
            graphsContainer.innerHTML = '';
            
            // Render each graph
            graphs.forEach((graph, index) => {
                const graphId = graph.id || `market-chart-${index}`;
                
                // Create graph HTML
                const graphHtml = `
                    <div class="market-graph-item">
                        <div class="market-graph-title">${graph.title || 'Market Chart'}</div>
                        ${graph.subtitle ? `<div class="market-graph-subtitle">${graph.subtitle}</div>` : ''}
                        <div class="market-chart-container">
                            <canvas id="${graphId}" width="400" height="250"></canvas>
                        </div>
                    </div>
                `;
                
                graphsContainer.innerHTML += graphHtml;
            });
            
            // Wait for DOM to update, then create charts
            setTimeout(() => {
                graphs.forEach((graph, index) => {
                    const graphId = graph.id || `market-chart-${index}`;
                    createMarketChart(graphId, graph);
                });
            }, 50);
        }

        /**
         * Create a single Chart.js chart
         */
        function createMarketChart(canvasId, graphData) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.warn(` [Market] Canvas ${canvasId} not found`);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const chartType = graphData.type || 'line';
            
            try {
                // Chart configuration
                const config = {
                    type: chartType,
                    data: graphData.data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    boxWidth: 12,
                                    fontSize: 11
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        scales: chartType !== 'pie' ? {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                ticks: {
                                    fontSize: 10
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                ticks: {
                                    fontSize: 10
                                }
                            }
                        } : {}
                    }
                };
                
                // Create chart
                const chart = new Chart(ctx, config);
                marketChartsInstances[canvasId] = chart;
                
                console.log(` [Market] Chart ${canvasId} created successfully`);
            } catch (error) {
                console.error(` [Market] Chart creation error for ${canvasId}:`, error);
            }
        }

        /**
         * Render market analysis section HTML structure
         */
        function renderMarketAnalysisSection(city, mlsId) {
            console.log(' [Market] Rendering market section for:', city, mlsId);
            
            // If no city, don't render section
            if (!city || city === 'N/A' || city === 'Unknown') {
                return '';
            }
            
            return `
                <div id="market-analysis-section" class="market-analysis-container">
                    <div class="market-analysis-header">
                        <div class="market-analysis-title"> Market Analysis</div>
                        <div class="market-analysis-subtitle">Real-time market data and trends for ${city}</div>
                    </div>
                    
                    <div id="market-analysis-loading" class="market-loading hidden">
                        <div style="margin: 10px 0; text-align: center;">
                            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin: 10px 0 0 0; color: #1976d2;">Analyzing market trends...</p>
                        </div>
                    </div>
                    
                    <div id="market-analysis-content"></div>
                    
                    <div id="market-analysis-error" class="market-error hidden"></div>
                </div>
            `;
        }

        /**
         * Show market loading state
         */
        function showMarketLoading() {
            const loading = document.getElementById('market-analysis-loading');
            const content = document.getElementById('market-analysis-content');
            const error = document.getElementById('market-analysis-error');
            
            if (loading) loading.classList.remove('hidden');
            if (content) content.innerHTML = '';
            if (error) error.classList.add('hidden');
        }

        /**
         * Hide market loading state
         */
        function hideMarketLoading() {
            const loading = document.getElementById('market-analysis-loading');
            if (loading) loading.classList.add('hidden');
        }

        /**
         * Show market error message
         */
        function showMarketError(message) {
            const loading = document.getElementById('market-analysis-loading');
            const error = document.getElementById('market-analysis-error');
            
            if (loading) loading.classList.add('hidden');
            if (error) {
                error.innerHTML = message;
                error.classList.remove('hidden');
            }
        }

        /**
         * Update property context to include market analysis loading
         */
        function updateMarketContext(city, mlsId) {
            console.log(' [Market] Updating market context:', city, mlsId);
            
            // Trigger market analysis load
            if (city && city !== 'N/A' && city !== 'Unknown') {
                setTimeout(() => {
                    loadMarketAnalysis(city, 'ON', mlsId);
                }, 500); // Small delay to let the section render first
            }
        }

        // ==================== CENTER PANEL MARKET ANALYSIS FUNCTIONALITY ====================
        
        /**
         * Simple debug function to test if button clicks are working
         */
        // ==================== USER NAME MANAGEMENT ====================
        
        /**
         * Save user name from welcome modal
         */
        function saveUserName() {
            const nameInput = document.getElementById('userName');
            const name = nameInput.value.trim();
            
            if (name === '') {
                nameInput.style.borderColor = '#e53e3e';
                nameInput.focus();
                return;
            }
            
            // Store name in localStorage
            localStorage.setItem('summitly_user_name', name);
            
            // Close welcome modal
            document.getElementById('welcomeModal').style.display = 'none';
            
            // Update welcome title
            updateWelcomeTitle(name);
            
            // Add personalized welcome message
            setTimeout(() => {
                const welcomeScreen = document.getElementById('welcomeScreen');
                if (welcomeScreen) {
                    // Update the welcome title to include user's name
                    const titleElement = document.getElementById('welcomeTitle');
                    if (titleElement) {
                        titleElement.innerHTML = `Welcome ${name}! <br>Your AI Real Estate Assistant`;
                    }
                }
            }, 300);
            
            console.log(` User name saved: ${name}`);
        }
        
        /**
         * Get user name from localStorage
         */
        function getUserName() {
            return localStorage.getItem('summitly_user_name') || null;
        }
        
        /**
         * Update welcome title with user name
         */
        function updateWelcomeTitle(name = null) {
            const userName = name || getUserName() || 'Guest';
            const titleElement = document.getElementById('welcomeTitle');
            if (titleElement) {
                titleElement.textContent = `Welcome ${userName} to Your AI Real Estate Assistant`;
            }
        }
        
        /**
         * Check if user name exists on page load
         */
        function checkUserName() {
            const userName = getUserName();
            const modal = document.getElementById('welcomeModal');
            
            if (userName) {
                // User has already provided name, hide welcome modal
                if (modal) {
                    modal.style.display = 'none';
                }
                updateWelcomeTitle(userName);
                console.log(' Returning user:', userName);
            } else {
                // First-time user - ensure modal is visible
                if (modal) {
                    modal.style.display = 'block';
                }
                console.log(' First-time user - showing name modal');
            }
        }
        
        /**
         * Show voice feature disabled message
         */
        function showVoiceDisabled() {
            alert(' Voice Assistant\n\nThis feature is temporarily disabled to prevent interface issues.\n\nPlease use the text chat for now. Voice functionality will be restored soon!');
        }

        // Simple test function with no parameters to verify clicking works
        function simpleMarketTest() {
            console.log(' SIMPLE MARKET TEST CLICKED! ');
            alert(' SIMPLE TEST WORKED! \nBasic clicking is functional!');
            return false;
        }

        // Initialize app on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' Initializing Summitly AI...');
            
            // Check if user name already exists
            checkUserName();
            
            console.log(' Setting up global click listener for debugging...');
            document.addEventListener('click', function(event) {
                if (event.target.tagName === 'BUTTON' && event.target.textContent.includes('Market Analysis')) {
                    console.log(' BUTTON CLICKED:', event.target);
                    console.log(' Button text:', event.target.textContent);
                    console.log(' Button onclick:', event.target.getAttribute('onclick'));
                    // alert(` MARKET ANALYSIS BUTTON DETECTED!\nText: ${event.target.textContent}\nOnclick: ${event.target.getAttribute('onclick')}`);
                }
            });
        });

        // Quick test function to verify button clicks are registering
        function testMarketAnalysisClick(mlsId, propertyData) {
            console.log(' MARKET ANALYSIS BUTTON CLICKED! ');
            console.log('MLS ID:', mlsId);
            console.log('Property Data:', propertyData);
            alert(`Market Analysis Clicked!\nMLS: ${mlsId}\nThis confirms the button is working!`);
            
            // Now call the actual function
            return openMarketAnalysisCenterPanel(mlsId, propertyData);
        }

        function debugMarketAnalysisClick(mlsId, propertyData) {
            window.marketAnalysisClickCount = (window.marketAnalysisClickCount || 0) + 1;
            console.log(' [BUTTON DEBUG] Market Analysis button clicked!');
            console.log(' [BUTTON DEBUG] Arguments received:', { mlsId, propertyData });
            console.log(' [BUTTON DEBUG] Testing panel existence...');
            
            // Show immediate alert to confirm button is working
            alert(`DEBUG: Market Analysis Clicked! \nClick #${window.marketAnalysisClickCount}\nMLS: ${mlsId}\n\nButton is definitely working!`);
            
            // Test if panel exists in DOM
            const panel = document.getElementById('marketAnalysisPanel');
            console.log(' [BUTTON DEBUG] Panel in DOM:', panel ? 'FOUND' : 'NOT FOUND');
            if (panel) {
                console.log(' [BUTTON DEBUG] Panel classes:', panel.className);
                console.log(' [BUTTON DEBUG] Panel style display:', window.getComputedStyle(panel).display);
            }
            
            alert(`Market Analysis button clicked!\nMLS: ${mlsId}\nPanel exists: ${panel ? 'YES' : 'NO'}\nCheck console for details.`);
            return openMarketAnalysisCenterPanel(mlsId, propertyData);
        }
        
        // Global debug function to track all market analysis button clicks
        window.marketAnalysisClickCount = 0;
        
        /**
         * Safe click handler that doesn't rely on JSON.stringify in onclick
         * FIXED: Now reads city directly from data-city attribute instead of parsing address
         */
        function openMarketAnalysisClickHandler(mlsId, buttonElement) {
            window.marketAnalysisClickCount = (window.marketAnalysisClickCount || 0) + 1;
            console.log(` MARKET ANALYSIS CLICK HANDLER #${window.marketAnalysisClickCount} `);
            console.log('MLS ID:', mlsId);
            console.log('Button Element:', buttonElement);
            
            // Extract city from data-city attribute on property card
            let city = 'Toronto'; // default
            try {
                console.log(' [City Extraction] Starting city extraction...');
                
                // Find the property card container
                const propertyCard = buttonElement.closest('.property-search-card') || buttonElement.closest('.property-card') || buttonElement.closest('.property');
                console.log(' [City Extraction] Property card found:', propertyCard ? 'YES' : 'NO');
                
                if (propertyCard) {
                    // Read city directly from data-city attribute
                    const dataCity = propertyCard.getAttribute('data-city');
                    console.log(' [City Extraction] data-city attribute:', dataCity);
                    
                    if (dataCity && dataCity.trim() !== '') {
                        city = dataCity.trim();
                        console.log(' [City Extraction] Successfully extracted city from data-city:', city);
                    } else {
                        // Fallback: try to extract from address element
                        const addressElement = propertyCard.querySelector('.property-address');
                        console.log(' [City Extraction] data-city not found, trying address element...');
                        
                        if (addressElement) {
                            const fullAddress = addressElement.textContent || addressElement.innerText || '';
                            console.log(' [City Extraction] Full address found:', fullAddress);
                            
                            // Extract city from address (usually format: "123 Street, City, Province")
                            const addressParts = fullAddress.split(',');
                            if (addressParts.length >= 2) {
                                const rawCity = addressParts[addressParts.length - 2].trim();
                                city = rawCity.replace(/\s+(ON|Ontario|BC|AB|MB|SK|QC|Quebec|NB|NS|PE|NL|NT|YT|NU)\s*.*$/i, '').trim();
                                console.log(' [City Extraction] Extracted from address:', city);
                            }
                        }
                    }
                } else {
                    console.log(' [City Extraction] No property card found, using default Toronto');
                }
            } catch (error) {
                console.warn(' [City Extraction] Error:', error);
                city = 'Toronto'; // fallback
            }
            
            // Log success
            console.log(` MARKET ANALYSIS CLICKED! \nClick #${window.marketAnalysisClickCount}\nMLS: ${mlsId}\nCity: ${city}\n\nOpening ${city} market data...`);
            
            // Create property data object with extracted city
            const propertyData = {
                mls_number: mlsId,
                mls_id: mlsId,
                city: city
            };
            
            console.log(' Calling openMarketAnalysisCenterPanel with city:', city);
            return openMarketAnalysisCenterPanel(mlsId, propertyData);
        }
        
        /**
         * Open Market Analysis in center panel
         */
        async function openMarketAnalysisCenterPanel(mlsId, propertyData = null) {
            console.log(` [Market Analysis] Opening panel for MLS: ${mlsId}`);
            console.log(' [Market Analysis] Property Data:', propertyData);
            console.log(' [DEBUG] Market Analysis button clicked!');
            console.log(' [DEBUG] MLS ID:', mlsId);
            console.log(' [DEBUG] Property Data:', propertyData);
            console.log(' [DEBUG] Property Data Type:', typeof propertyData);
            console.log(' [Center Panel] Opening market analysis for MLS:', mlsId);
            
            const panel = document.getElementById('marketAnalysisPanel');
            const body = document.getElementById('marketAnalysisBody');
            const subtitle = document.getElementById('marketAnalysisSubtitle');
            
            console.log(' [DEBUG] DOM Elements found:');
            console.log(' [DEBUG] Panel:', panel ? 'Found' : 'NOT FOUND');
            console.log(' [DEBUG] Body:', body ? 'Found' : 'NOT FOUND');
            console.log(' [DEBUG] Subtitle:', subtitle ? 'Found' : 'NOT FOUND');
            
            // Parse propertyData if it's a string
            if (typeof propertyData === 'string') {
                console.log(' [DEBUG] Parsing property data string:', propertyData.substring(0, 100) + '...');
                try {
                    const cleanedData = propertyData.replace(/&apos;/g, "'");
                    propertyData = JSON.parse(cleanedData);
                    console.log(' [DEBUG] Successfully parsed property data:', propertyData);
                } catch (e) {
                    console.error(' [DEBUG] Failed to parse property data:', e.message);
                    console.warn(' [Center Panel] Failed to parse property data:', e.message);
                    propertyData = { mls_number: mlsId };
                }
            }
            
            console.log(' [DEBUG] Final property data:', propertyData);
            
            // Extract city from property data (CRITICAL FIX: Check all possible city sources)
            let city = 'Toronto'; // default
            console.log(' [City] Extracting city from property data:', propertyData);
            console.log(' [City] propertyData.city:', propertyData?.city);
            console.log(' [City] propertyData.location:', propertyData?.location);
            console.log(' [City] propertyData.address?.city:', propertyData?.address?.city);
            console.log(' [City] propertyData.full_address:', propertyData?.full_address);
            
            // Priority 1: Direct city field from click handler
            if (propertyData?.city && propertyData.city.trim() !== '' && propertyData.city !== 'Toronto') {
                city = propertyData.city.trim();
                console.log(' [City] Using city from propertyData.city:', city);
            }
            // Priority 2: City from address object
            else if (propertyData?.address?.city && propertyData.address.city.trim() !== '' && propertyData.address.city !== 'Toronto') {
                city = propertyData.address.city.trim();
                console.log(' [City] Using city from propertyData.address.city:', city);
            }
            // Priority 3: Extract from location string
            else if (propertyData?.location && propertyData.location.includes(',')) {
                city = propertyData.location.split(',')[0]?.trim();
                if (city && city !== 'Toronto') {
                    console.log(' [City] Extracted from propertyData.location:', city);
                } else {
                    city = 'Toronto';
                }
            }
            // Priority 4: Extract from full_address
            else if (propertyData?.full_address && propertyData.full_address.includes(',')) {
                const addressParts = propertyData.full_address.split(',');
                if (addressParts.length >= 2) {
                    const extractedCity = addressParts[addressParts.length - 2].trim();
                    // Remove province codes
                    city = extractedCity.replace(/\s+(ON|Ontario|BC|AB|MB|SK|QC|Quebec|NB|NS|PE|NL|NT|YT|NU)\s*.*$/i, '').trim();
                    if (city && city !== 'Toronto' && city.length > 2) {
                        console.log(' [City] Extracted from full_address:', city);
                    } else {
                        city = 'Toronto';
                    }
                }
            }
            // Fallback: Check if any field has Toronto value
            else if (propertyData?.city === 'Toronto' || propertyData?.address?.city === 'Toronto') {
                city = 'Toronto';
                console.log(' [City] Confirmed Toronto from data');
            } else {
                console.log(' [City] No city found, using default Toronto');
            }
            
            console.log(` [City] FINAL city for market analysis: ${city}`);
            
            // Open panel
            console.log(' [DEBUG] Opening panel...');
            panel.classList.add('open');
            console.log(' [DEBUG] Panel opened, class added');
            
            subtitle.textContent = `Market data and trends for ${city}`;
            console.log(' [DEBUG] Subtitle updated');
            
            // Show loading state
            console.log(' [DEBUG] Setting loading state...');
            body.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top: 4px solid #1976d2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                    <p style="color: #1976d2; font-size: 16px;">Loading market analysis for ${city}...</p>
                </div>
            `;
            console.log(' [DEBUG] Loading state set');
            
            try {
                // Fetch market analysis data
                const baseUrl = getApiBaseUrl();
                const apiUrl = `${baseUrl}/api/market-analysis/${encodeURIComponent(city)}?province=ON${mlsId ? `&mls_number=${mlsId}` : ''}`;
                console.log(' [DEBUG] Base URL:', baseUrl);
                console.log(' [DEBUG] Full API URL:', apiUrl);
                console.log(' [Center Panel] API URL:', apiUrl);
                
                console.log(' [DEBUG] Starting fetch request...');
                
                const response = await fetch(apiUrl);
                console.log(' [DEBUG] Fetch response received:', response.status, response.statusText);
                
                const data = await response.json();
                console.log(' [DEBUG] Response data:', data);
                
                if (data.success) {
                    console.log(' [DEBUG] Data fetch successful, rendering panel...');
                    renderMarketAnalysisCenterPanel(city, data);
                } else {
                    console.error(' [DEBUG] API returned error:', data.error);
                    throw new Error(data.error || 'Failed to load market analysis');
                }
            } catch (error) {
                console.error(' [DEBUG] Catch block - Error details:', error);
                console.error(' [DEBUG] Error stack:', error.stack);
                console.error(' [Center Panel] Market analysis error:', error);
                body.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #d32f2f;">
                        <h3>Error Loading Market Analysis</h3>
                        <p>${error.message}</p>
                        <button class="btn-primary" onclick="openMarketAnalysisCenterPanel('${mlsId}', ${JSON.stringify(propertyData).replace(/'/g, '&apos;')})">Retry</button>
                    </div>
                `;
            }
        }
        
        /**
         * Render market analysis in center panel
         */
        function renderMarketAnalysisCenterPanel(city, data) {
            console.log(' [DEBUG] Starting to render market analysis panel');
            console.log(' [DEBUG] City:', city);
            console.log(' [DEBUG] Data:', data);
            
            const body = document.getElementById('marketAnalysisBody');
            console.log(' [DEBUG] Body element:', body ? 'Found' : 'NOT FOUND');
            
            const stats = data.statistics || {};
            const analysis = data.ai_analysis || '';
            
            console.log(' [DEBUG] Statistics:', stats);
            console.log(' [DEBUG] AI Analysis:', analysis);
            console.log(' [DEBUG] Graphs:', data.graphs);
            
            let htmlContent = `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #1976d2; margin-bottom: 16px; font-size: 18px;"> ${city} Market Statistics</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            `;
            
            // Market Statistics
            if (stats.average_price) {
                htmlContent += `
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #1976d2;">$${stats.average_price.toLocaleString()}</div>
                        <div style="font-size: 14px; color: #666; margin-top: 4px;">Average Price</div>
                    </div>
                `;
            }
            
            if (stats.days_on_market) {
                htmlContent += `
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #1976d2;">${stats.days_on_market}</div>
                        <div style="font-size: 14px; color: #666; margin-top: 4px;">Days on Market</div>
                    </div>
                `;
            }
            
            if (stats.price_per_sqft) {
                htmlContent += `
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #1976d2;">$${stats.price_per_sqft}</div>
                        <div style="font-size: 14px; color: #666; margin-top: 4px;">Price per Sqft</div>
                    </div>
                `;
            }
            
            if (stats.active_listings) {
                htmlContent += `
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: #1976d2;">${stats.active_listings}</div>
                        <div style="font-size: 14px; color: #666; margin-top: 4px;">Active Listings</div>
                    </div>
                `;
            }
            
            htmlContent += `</div></div>`;
            
            // AI Analysis
            if (analysis) {
                htmlContent += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #1976d2; margin-bottom: 12px; font-size: 18px;"> AI Market Insights</h3>
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; line-height: 1.6;">
                            <p style="margin: 0;">${analysis}</p>
                        </div>
                    </div>
                `;
            }
            
            // Charts Container
            if (data.graphs && data.graphs.length > 0) {
                htmlContent += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #1976d2; margin-bottom: 16px; font-size: 18px;"> Market Trends</h3>
                        <div id="center-market-graphs-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                            <!-- Charts will be rendered here -->
                        </div>
                    </div>
                `;
            }
            
            console.log(' [DEBUG] Setting HTML content...');
            body.innerHTML = htmlContent;
            console.log(' [DEBUG] HTML content set successfully');
            
            // Render charts if available
            if (data.graphs && data.graphs.length > 0) {
                console.log(' [DEBUG] Rendering graphs:', data.graphs.length, 'graphs found');
                setTimeout(() => {
                    renderCenterMarketGraphs(data.graphs);
                }, 100);
            } else {
                console.log(' [DEBUG] No graphs to render');
            }
        }
        
        /**
         * Render market graphs in center panel
         */
        function renderCenterMarketGraphs(graphs) {
            const graphsContainer = document.getElementById('center-market-graphs-grid');
            if (!graphsContainer) return;
            
            // Clear existing content
            graphsContainer.innerHTML = '';
            
            // Render each graph
            graphs.forEach((graph, index) => {
                const graphId = `center-market-chart-${index}`;
                
                const graphHtml = `
                    <div style="background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #333;">${graph.title || 'Market Chart'}</div>
                        ${graph.subtitle ? `<div style="font-size: 14px; color: #666; margin-bottom: 16px;">${graph.subtitle}</div>` : ''}
                        <div style="position: relative;">
                            <canvas id="${graphId}" width="400" height="250"></canvas>
                        </div>
                    </div>
                `;
                
                graphsContainer.innerHTML += graphHtml;
            });
            
            // Create charts
            setTimeout(() => {
                graphs.forEach((graph, index) => {
                    const graphId = `center-market-chart-${index}`;
                    createMarketChart(graphId, graph);
                });
            }, 50);
        }
        
        /**
         * Close Market Analysis center panel
         */
        function closeMarketAnalysisPanel() {
            console.log(' [DEBUG] Closing market analysis panel');
            const panel = document.getElementById('marketAnalysisPanel');
            console.log(' [DEBUG] Panel found:', panel ? 'Yes' : 'No');
            panel.classList.remove('open');
            console.log(' [DEBUG] Panel closed successfully');
        }

        // ==================== END CENTER PANEL MARKET ANALYSIS ====================

        /**
         * Open Market Analysis in right sidebar (restored sidebar functionality)
         * This function opens the AI Analysis Panel and focuses on the market analysis section
         */
        async function openMarketAnalysis(mlsId, propertyData = null) {
            console.log(' [Market] Opening market analysis for MLS:', mlsId);
            
            // Parse propertyData if it's a string
            if (typeof propertyData === 'string') {
                try {
                    const cleanedData = propertyData.replace(/&apos;/g, "'");
                    propertyData = JSON.parse(cleanedData);
                } catch (e) {
                    console.warn(' [Market] Failed to parse property data:', e.message);
                    propertyData = { mls_number: mlsId };
                }
            }
            
            // Extract city from property data
            let city = 'Toronto'; // default
            if (propertyData?.city) {
                city = propertyData.city;
            } else if (propertyData?.location) {
                city = propertyData.location.split(',')[0]?.trim();
            } else if (propertyData?.address?.city) {
                city = propertyData.address.city;
            }
            
            console.log(' [Market] Using city:', city, 'for MLS:', mlsId);
            
            // Open the AI Analysis panel first
            await openAIAnalysisPanel(mlsId, 'property');
            
            // Wait a moment for the panel to open, then load and scroll to market analysis
            setTimeout(() => {
                // Force load market analysis with extracted city
                console.log(' [Market] Force loading market analysis for:', city);
                loadMarketAnalysis(city, 'ON', mlsId);
                
                // Scroll to market analysis section
                setTimeout(() => {
                    const marketSection = document.getElementById('market-analysis-section');
                    if (marketSection) {
                        marketSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        console.log(' [Market] Scrolled to market analysis section');
                    } else {
                        console.warn(' [Market] Market analysis section not found in panel');
                    }
                }, 500);
            }, 1000);
        }

        /**
         * Display Quick Insights in AI Analysis Panel with enhanced debugging
         */
        function displayQuickInsights(data, mlsId) {
            const body = document.getElementById('aiPanelBody');
            
            // Enhanced debugging
            console.log(' [AI Panel] Full data structure received:', data);
            console.log(' [AI Panel] Insights structure:', data.insights || {});
            
            const insights = data.insights || {};
            const estimated = insights.estimated_value || {};
            const actualPrice = insights.actual_price;
            
            // Extract city from data for market analysis
            const city = data.city || 
                        insights.city || 
                        data.location || 
                        insights.location ||
                        (data.address && data.address.split(',')[0].trim()) ||
                        (insights.address && insights.address.split(',')[0].trim()) ||
                        'Unknown';
            
            console.log(' [AI Panel] Extracted city for market analysis:', city);
            
            // Multiple fallback strategies for schools data
            let schools = insights.schools || [];
            if (!Array.isArray(schools) || schools.length === 0) {
                // Try alternative data paths
                schools = data.schools || insights.local_schools || insights.nearby_schools || [];
                console.log(' [Fallback] Trying alternative schools data paths:', {
                    dataSchools: data.schools,
                    localSchools: insights.local_schools, 
                    nearbySchools: insights.nearby_schools,
                    finalSchools: schools
                });
            }
            
            const neighborhood = insights.neighborhood || {};
            const connectivity = insights.connectivity || {};
            const market = insights.market_trend || {};
            const rental = insights.rental_potential || {};
            const pros = insights.pros || [];
            const cons = insights.cons || [];
            const sources = data.sources || [];
            
            // Debug logging for schools
            console.log(' [AI Panel] Schools data found:', schools);
            console.log(' [AI Panel] Schools type check:', typeof schools, Array.isArray(schools), schools?.length);
            console.log(' [AI Panel] Schools condition result:', (schools && Array.isArray(schools) && schools.length > 0));
            if (schools && Array.isArray(schools) && schools.length > 0) {
                console.log(' [AI Panel] First school item:', schools[0]);
            }
            console.log(' [AI Panel] Neighborhood data:', neighborhood);
            console.log(' [AI Panel] Connectivity data:', connectivity);

            // Build the HTML content step by step
            let htmlContent = '<div style="line-height: 1.7;">';
            
            // Price Comparison Section
            htmlContent += `
                <div style="background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); padding: 24px; border-radius: var(--radius-lg); margin-bottom: 20px; color: white;">
                    <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;"> MLS ${mlsId}</div>`;
                    
            if (actualPrice) {
                htmlContent += `
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 13px; opacity: 0.8; margin-bottom: 4px;">List Price</div>
                        <div style="font-size: 28px; font-weight: 700;">$${formatNumber(actualPrice)}</div>
                    </div>`;
            }
            
            htmlContent += `
                    <div>
                        <div style="font-size: 13px; opacity: 0.8; margin-bottom: 4px;"> AI Estimated Value</div>
                        <div style="position: relative; margin-bottom: 8px;">
                            <div style="font-size: 28px; font-weight: 700; filter: blur(8px); user-select: none; pointer-events: none;">
                                $${formatNumber((estimated.mid || estimated.estimated_value || 500000))}
                            </div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; gap: 8px; background: rgba(255, 255, 255, 0.95); padding: 8px 16px; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                <span style="font-size: 20px; animation: shimmer 2s infinite;"></span>
                                <span style="font-size: 14px; font-weight: 600; color: #1976D2;">Premium Analysis</span>
                            </div>
                        </div>
                        <style>
                            @keyframes shimmer {
                                0%, 100% { opacity: 0.6; transform: scale(1); }
                                50% { opacity: 1; transform: scale(1.1); }
                            }
                            @keyframes pulse-glow {
                                0%, 100% { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 0 0 0 rgba(25, 118, 210, 0.4); }
                                50% { box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2), 0 0 20px 5px rgba(25, 118, 210, 0.6); }
                            }
                            @keyframes gradient-shift {
                                0% { background-position: 0% 50%; }
                                50% { background-position: 100% 50%; }
                                100% { background-position: 0% 50%; }
                            }
                        </style>
                    </div>`;
            
            if (mlsId) {
                htmlContent += `
                    <div style="margin-top: 20px;">
                        <button onclick="viewFullPropertyReport('${mlsId}')" 
                            style="width: 100%; padding: 16px 24px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%); background-size: 200% 200%; color: #1a1a1a; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4); animation: pulse-glow 2s infinite; position: relative; overflow: hidden;"
                            onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.animation='gradient-shift 1s ease infinite, pulse-glow 2s infinite';"
                            onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.animation='pulse-glow 2s infinite';">
                            <span style="font-size: 22px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));"></span>
                            <span style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);">Unlock Full Property Report</span>
                            <span style="position: absolute; top: 4px; right: 4px; background: rgba(255, 255, 255, 0.9); color: #FF6B6B; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; letter-spacing: 0.5px;">PREMIUM</span>
                        </button>
                        <div style="text-align: center; margin-top: 8px; font-size: 11px; opacity: 0.7; font-style: italic;">
                            Click to reveal detailed AI valuation analysis
                        </div>
                    </div>`;
            }
            
            htmlContent += `
                    </div>
                </div>`;
            
            // Schools Section using helper function (FEATURE 1: Dynamic Schools)
            htmlContent += renderSchoolsSection(schools, mlsId);
            
            // Market Analysis Section using helper function (FEATURE 2: Market Trends)
            htmlContent += renderMarketAnalysisSection(city, mlsId);
            
            // Neighborhood Section
            if ((neighborhood && Object.keys(neighborhood).length > 0) || insights.walkability || insights.walkability_score) {
                htmlContent += `
                    <div class="insight-section" style="background: #e3f2fd; border-left: 4px solid #1976D2; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h3 class="insight-title" style="margin: 0 0 12px 0; color: #1976D2; font-size: 16px; font-weight: 600;"> Neighborhood Data</h3>`;
                        
                if (neighborhood.summary) {
                    htmlContent += `<p style="margin-bottom: 12px; color: #333; font-size: 14px; line-height: 1.5;">${neighborhood.summary}</p>`;
                }
                
                htmlContent += '<div class="neighborhood-metrics" style="display: grid; gap: 8px;">';
                
                if (neighborhood.safety_score || insights.safety_score) {
                    htmlContent += `
                        <div class="metric-row" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #bbdefb;">
                            <span style="font-size: 13px; color: #666;"> Safety Score:</span>
                            <strong style="color: #1976D2;">${neighborhood.safety_score || insights.safety_score}/10</strong>
                        </div>`;
                }
                
                // Walkability handling
                const walkability = neighborhood.walkability || insights.walkability || insights.walkability_score || neighborhood.walkability_score;
                console.log(' [Walkability Debug] Found value:', walkability);
                
                if (walkability !== null && walkability !== undefined) {
                    const suffix = (typeof walkability === 'number' && walkability <= 10) ? '/10' : 
                                  (typeof walkability === 'number' && walkability <= 100) ? '/100' : '';
                    htmlContent += `
                        <div class="metric-row" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #bbdefb;">
                            <span style="font-size: 13px; color: #666;"> Walkability:</span>
                            <strong style="color: #1976D2;">${walkability}${suffix}</strong>
                        </div>`;
                } else {
                    htmlContent += `
                        <div class="metric-row" style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #bbdefb;">
                            <span style="font-size: 13px; color: #666;"> Walkability:</span>
                            <strong style="color: #1976D2;">Data being analyzed...</strong>
                        </div>`;
                }
                
                if (neighborhood.demographics) {
                    htmlContent += `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #bbdefb;">
                            <div style="font-size: 12px; color: #666; font-weight: 600; margin-bottom: 4px;">Demographics:</div>
                            <div style="font-size: 13px; color: #555; line-height: 1.4;">${neighborhood.demographics}</div>
                        </div>`;
                }
                
                htmlContent += '</div></div>';
            }
            
            // Add other sections as needed
            if (market && market.summary) {
                htmlContent += `
                    <div class="insight-section" style="margin-bottom: 16px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;"> Market Trend</h3>
                        <p>${market.summary}</p>
                    </div>`;
            }
            
            if (rental && rental.summary) {
                htmlContent += `
                    <div class="insight-section" style="margin-bottom: 16px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 8px;"> Investment Outlook</h3>
                        <p>${rental.summary}</p>
                    </div>`;
            }
            
            // Close the main content div and set innerHTML
            htmlContent += '</div>';
            body.innerHTML = htmlContent;
            
            // FEATURE 1: Load real schools data after content is rendered
            if (mlsId && mlsId !== 'N/A') {
                console.log(' [SCHOOLS] Triggering schools load for MLS:', mlsId);
                console.log(' [MARKET] Triggering market analysis for city:', city);
                setTimeout(() => {
                    // Create property data object for schools API with correct city
                    const propertyData = {
                        mls_number: mlsId,
                        city: city || 'Toronto', // Use the actual city extracted from AI analysis
                    };
                    updatePropertyContext(propertyData);
                }, 100); // Small delay to ensure DOM elements are ready
            }
        }

        function closeAIAnalysisPanel() {
            const panel = document.getElementById('aiAnalysisPanel');
            panel.classList.remove('open');
        }

        /**
         * View full property valuation report
         * Closes the AI Analysis panel and sends a chat message to generate the full report
         */
        function viewFullPropertyReport(mlsNumber) {
            if (!mlsNumber) {
                console.error('MLS number not available');
                return;
            }
            
            // Close the AI Analysis panel
            closeAIAnalysisPanel();
            
            // Send message to generate full valuation report
            // Use explicit valuation phrasing to trigger the valuation handler
            const message = `What is the valuation estimate for property MLS ${mlsNumber}? Please provide a full property valuation analysis.`;
            sendMessage(message);
            
            // Scroll to chat to show the response
            setTimeout(() => {
                const chatContainer = document.querySelector('.chat-container') || document.querySelector('#chatMessages');
                if (chatContainer) {
                    chatContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 300);
        }

        function toggleDataSources() {
            const content = document.getElementById('sourcesContent');
            const toggle = document.getElementById('sourcesToggle');
            
            if (content && toggle) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    toggle.textContent = ' Hide Sources';
                } else {
                    content.style.display = 'none';
                    toggle.textContent = 'View Sources ';
                }
            }
        }

        function closeAIAnalysisPanel() {
            const panel = document.getElementById('aiAnalysisPanel');
            panel.classList.remove('open');
        }

        /**
         * View Property Details - Opens modal with full property information
         */
        async function viewPropertyDetails(propertyId, mlsNumber) {
            // Use MLS number if available, otherwise use property ID
            const mls = mlsNumber || propertyId;
            
            if (!mls) {
                showToast('No MLS number available', 'error');
                return;
            }
            
            // Show loading modal
            const modal = document.createElement('div');
            modal.className = 'property-details-modal';
            modal.id = 'propertyDetailsModal';
            modal.innerHTML = `
                <div class="modal-backdrop" onclick="closePropertyDetails()"></div>
                <div class="property-details-content">
                    <button class="modal-close-btn" onclick="closePropertyDetails()"></button>
                    <div class="property-loading">
                        <div class="spinner" style="width: 48px; height: 48px; border: 4px solid #e3f2fd; border-top-color: #1976D2; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                        <p>Loading property details...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            try {
                // Fetch property details from our /api/property-details endpoint
                const response = await fetch(`${getApiBaseUrl()}/api/property-details?mls=${mls}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success && data.property) {
                    displayPropertyDetails(data.property);
                } else {
                    document.querySelector('.property-loading').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;"></div>
                            <p>Unable to load property details.</p>
                            <button class="btn-small btn-primary" onclick="closePropertyDetails()" style="margin-top: 16px;">Close</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error fetching property details:', error);
                document.querySelector('.property-loading').innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;"></div>
                        <p>Error: ${error.message}</p>
                        <button class="btn-small btn-primary" onclick="closePropertyDetails()" style="margin-top: 16px;">Close</button>
                    </div>
                `;
            }
        }

        function displayPropertyDetails(property) {
            const content = document.querySelector('.property-details-content');
            const images = property.images || [];
            
            content.innerHTML = `
                <button class="modal-close-btn" onclick="closePropertyDetails()"></button>
                <div class="property-details-body">
                    <!-- Image Carousel -->
                    ${images.length > 0 ? `
                        <div class="property-carousel">
                            <div class="carousel-main">
                                <img src="${images[0]}" alt="Property" class="carousel-main-image" id="mainImage" onerror="this.src='/static/images/no-property-image.svg'">
                                ${images.length > 1 ? `
                                    <button class="carousel-nav prev" onclick="navigatePropertyCarousel(-1)"></button>
                                    <button class="carousel-nav next" onclick="navigatePropertyCarousel(1)"></button>
                                    <div class="carousel-counter">${1} / ${images.length}</div>
                                ` : ''}
                            </div>
                            ${images.length > 1 ? `
                                <div class="carousel-thumbnails">
                                    ${images.map((img, index) => `
                                        <img src="${img}" alt="Thumbnail ${index + 1}" 
                                             class="carousel-thumb ${index === 0 ? 'active' : ''}" 
                                             onclick="selectPropertyImage(${index})"
                                             onerror="this.src='/static/images/no-property-thumbnail.svg'">
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div style="height: 300px; background: var(--color-bg-primary); display: flex; align-items: center; justify-content: center; font-size: 48px; border-radius: var(--radius-lg);">
                            
                        </div>
                    `}

                    <!-- Property Header -->
                    <div class="property-header">
                        <h2 class="property-title">${property.address || 'Property Details'}</h2>
                        <div class="property-price-badge">$${formatNumber(property.price || property.list_price)}</div>
                    </div>

                    <!-- Key Details Grid -->
                    <div class="property-details-grid">
                        ${property.bedrooms ? `
                            <div class="detail-item">
                                <div class="detail-icon"></div>
                                <div>
                                    <div class="detail-label">Bedrooms</div>
                                    <div class="detail-value">${property.bedrooms}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${property.bathrooms ? `
                            <div class="detail-item">
                                <div class="detail-icon"></div>
                                <div>
                                    <div class="detail-label">Bathrooms</div>
                                    <div class="detail-value">${property.bathrooms}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${property.sqft || property.square_footage ? `
                            <div class="detail-item">
                                <div class="detail-icon"></div>
                                <div>
                                    <div class="detail-label">Square Feet</div>
                                    <div class="detail-value">${formatNumber(property.sqft || property.square_footage)}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${property.property_type ? `
                            <div class="detail-item">
                                <div class="detail-icon"></div>
                                <div>
                                    <div class="detail-label">Type</div>
                                    <div class="detail-value">${capitalizeFirst(property.property_type)}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${property.lot_size ? `
                            <div class="detail-item">
                                <div class="detail-icon"></div>
                                <div>
                                    <div class="detail-label">Lot Size</div>
                                    <div class="detail-value">${property.lot_size}</div>
                                </div>
                            </div>
                        ` : ''}
                        ${property.year_built ? `
                            <div class="detail-item">
                                <div class="detail-icon"></div>
                                <div>
                                    <div class="detail-label">Year Built</div>
                                    <div class="detail-value">${property.year_built}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Description -->
                    ${property.description ? `
                        <div class="property-section">
                            <h3 class="section-header"> Description</h3>
                            <p class="property-description">${property.description}</p>
                        </div>
                    ` : ''}

                    <!-- Features -->
                    ${property.features && property.features.length > 0 ? `
                        <div class="property-section">
                            <h3 class="section-header"> Key Features</h3>
                            <ul class="features-list">
                                ${property.features.map(feature => `<li>${feature}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    <!-- MLS Information -->
                    <div class="property-section">
                        <h3 class="section-header"> Property Information</h3>
                        <div class="info-grid">
                            ${property.mls_number ? `
                                <div class="info-row">
                                    <span class="info-label">MLS Number:</span>
                                    <span class="info-value">${property.mls_number}</span>
                                </div>
                            ` : ''}
                            ${property.status ? `
                                <div class="info-row">
                                    <span class="info-label">Status:</span>
                                    <span class="info-value">${property.status}</span>
                                </div>
                            ` : ''}
                            ${property.list_date ? `
                                <div class="info-row">
                                    <span class="info-label">Listed Date:</span>
                                    <span class="info-value">${property.list_date}</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="property-actions-bar">
                        <button class="btn-primary" onclick="openPropertyDetailsPanel('${property.mls_number}')">
                             View Details
                        </button>
                        <button class="btn-primary" onclick="openAIAnalysisPanel('${property.mls_number}', 'property')">
                             AI Analysis
                        </button>
                        <button class="btn-primary" onclick="openMarketAnalysisCenterPanel('${property.mls_number}', ${JSON.stringify(property).replace(/'/g, '&apos;')})">
                             Market Analysis
                        </button>
                    </div>
                </div>
            `;

            // Store images for carousel navigation
            window.propertyImages = images;
            window.currentImageIndex = 0;
        }

        function navigatePropertyCarousel(direction) {
            const images = window.propertyImages || [];
            if (images.length <= 1) return;

            window.currentImageIndex = (window.currentImageIndex + direction + images.length) % images.length;
            selectPropertyImage(window.currentImageIndex);
        }

        function selectPropertyImage(index) {
            const images = window.propertyImages || [];
            if (!images[index]) return;

            const mainImage = document.getElementById('mainImage');
            const counter = document.querySelector('.carousel-counter');
            const thumbs = document.querySelectorAll('.carousel-thumb');

            if (mainImage) mainImage.src = images[index];
            if (counter) counter.textContent = `${index + 1} / ${images.length}`;
            
            thumbs.forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });

            window.currentImageIndex = index;
        }

        function closePropertyDetails() {
            const modal = document.getElementById('propertyDetailsModal');
            if (modal) modal.remove();
        }

        // ==================== VOICE & MULTIMODAL FEATURES ====================

        /**
         * Handle Voice Input
         */
        async function handleVoiceInput() {
            try {
                if (voiceManager.isRecording) {
                    // Stop recording
                    showLoadingOverlay('Processing your voice...');
                    const audioBlob = await voiceManager.stopRecording();
                    
                    // Send to API
                    const response = await api.voiceChat(audioBlob, appState.sessionId);
                    hideLoadingOverlay();
                    
                    if (response.success) {
                        // Add user message (transcription)
                        if (response.transcription) {
                            addMessage('user', response.transcription);
                        }
                        
                        // Add AI response
                        if (response.audio_url) {
                            const audioHTML = renderAudioPlayer(response.audio_url, response.response);
                            addMessage('ai', audioHTML);
                        } else {
                            addMessage('ai', response.response);
                        }
                        
                        showToast('Voice message processed!', 'success');
                    } else {
                        showToast('Voice processing failed', 'error');
                    }
                    
                    closeVoiceModal();
                } else {
                    // Start recording
                    await voiceManager.startRecording();
                    isRecording = true;
                    
                    // Visualize
                    const canvas = document.getElementById('voiceWaveform');
                    if (canvas) {
                        voiceManager.visualize(canvas);
                    }
                    
                    // Update UI
                    const btn = document.querySelector('.voice-btn-primary');
                    if (btn) {
                        btn.textContent = ' Stop Recording';
                        btn.style.background = 'var(--color-error)';
                    }
                }
            } catch (error) {
                console.error('Voice error:', error);
                showToast(error.message || 'Voice feature unavailable', 'error');
                hideLoadingOverlay();
            }
        }

        /**
         * Handle File Upload
         */
        async function handleFileUpload(files) {
            if (!files || files.length === 0) return;

            try {
                // Validate files
                for (const file of files) {
                    fileManager.addFile(file);
                }

                // Show preview
                const previewGrid = document.getElementById('filePreviewGrid') || createFilePreviewGrid();
                previewGrid.innerHTML = '';

                for (const fileItem of fileManager.files) {
                    const preview = await fileManager.generatePreview(fileItem.file);
                    const previewCard = document.createElement('div');
                    previewCard.className = 'file-preview-card';
                    previewCard.style.cssText = 'position: relative; background: var(--color-surface); border-radius: 8px; padding: 12px; border: 1px solid var(--color-border);';
                    previewCard.innerHTML = `
                        ${preview ? `<img src="${preview}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;">` : ''}
                        <div style="font-size: 13px; margin-bottom: 4px;">${fileItem.file.name}</div>
                        <div style="font-size: 11px; color: var(--color-text-secondary);">${(fileItem.file.size / 1024).toFixed(1)} KB</div>
                        <button onclick="removeFile('${fileItem.id}')" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;"></button>
                    `;
                    previewGrid.appendChild(previewCard);
                }

                showToast(`${files.length} file(s) ready to upload`, 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function createFilePreviewGrid() {
            const grid = document.createElement('div');
            grid.id = 'filePreviewGrid';
            grid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; margin-top: 16px;';
            const inputArea = document.querySelector('.input-area');
            if (inputArea) {
                inputArea.insertBefore(grid, inputArea.firstChild);
            }
            return grid;
        }

        function removeFile(fileId) {
            fileManager.removeFile(fileId);
            const previewGrid = document.getElementById('filePreviewGrid');
            if (previewGrid) {
                handleFileUpload(fileManager.getFiles());
                if (fileManager.files.length === 0) {
                    previewGrid.remove();
                }
            }
        }

        /**
         * Send Multimodal Message (Text + Files)
         */
        async function sendMultimodalMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            const files = fileManager.getFiles();

            if (!message && files.length === 0) {
                showToast('Please enter a message or upload files', 'error');
                return;
            }

            try {
                showLoadingOverlay('Analyzing...');

                // Add user message
                if (message) {
                    addMessage('user', message);
                }
                if (files.length > 0) {
                    addMessage('user', ` ${files.length} file(s) attached`);
                }

                // Call multimodal API
                const response = await api.multimodalChat(message || 'Analyze these files', files, appState.sessionId);
                
                hideLoadingOverlay();

                if (response.success) {
                    addMessage('ai', response.response);
                    showToast('Analysis complete!', 'success');
                } else {
                    throw new Error(response.error || 'Analysis failed');
                }

                // Clear input
                input.value = '';
                fileManager.clear();
                const previewGrid = document.getElementById('filePreviewGrid');
                if (previewGrid) previewGrid.remove();
                adjustTextareaHeight();
                
            } catch (error) {
                hideLoadingOverlay();
                showToast(error.message, 'error');
                addMessage('ai', 'Sorry, I encountered an error processing your files. Please try again.');
            }
        }

        /**
         * Property Actions
         */
        async function viewPropertyDetails(propertyId, mlsNumber) {
            try {
                console.log(' Opening property details panel for MLS:', mlsNumber);
                
                // Open the property details panel
                openPropertyDetailsPanel(mlsNumber || propertyId);
                
            } catch (error) {
                console.error(' View Details error:', error);
                showToast('Failed to load property details', 'error');
            }
        }

        /**
         * Open Property Details Side Panel
         */
        async function openPropertyDetailsPanel(mlsNumber) {
            const panel = document.getElementById('propertyDetailsPanel');
            const panelBody = document.getElementById('propertyPanelBody');
            
            // Open panel immediately with loading state
            panel.classList.add('open');
            
            // Show loading state
            panelBody.innerHTML = `
                <div class="property-detail-loading">
                    <div class="property-loading-spinner"></div>
                    <div style="font-size: 18px; font-weight: 600; color: var(--color-text); margin-bottom: 12px;">
                        Loading Property Details...
                    </div>
                    <div style="font-size: 14px; color: var(--color-text-secondary);">
                        MLS: ${mlsNumber}
                    </div>
                </div>
            `;
            
            try {
                // Fetch property details from API
                const response = await fetch(`${getApiBaseUrl()}/api/property-details?mls=${mlsNumber}`);
                const data = await response.json();
                
                if (data.success && data.property) {
                    const prop = data.property;
                    const address = prop.address || {};
                    const details = prop.details || {};
                    const images = prop.images || [];
                    
                    // Build full address
                    const fullAddress = prop.address?.full_address || 
                                      `${address.street || ''}, ${address.city || ''}, ${address.province || 'ON'}`.trim();
                    
                    // Format price
                    const price = typeof prop.price === 'number' ? `$${prop.price.toLocaleString()}` : (prop.price || 'Price on request');
                    
                    // Get first image
                    const imageUrl = images.length > 0 ? images[0] : 'https://via.placeholder.com/500x280?text=No+Image';
                    
                    // Populate panel with property details
                    panelBody.innerHTML = `
                        <div class="property-detail-image-section">
                            <img src="${imageUrl}" alt="Property" class="property-detail-image" 
                                 onerror="this.src='https://via.placeholder.com/500x280?text=No+Image'">
                            <div class="property-detail-price-badge">${price}</div>
                        </div>
                        
                        <div class="property-detail-content">
                            <div class="property-detail-address">${fullAddress}</div>
                            <div class="property-detail-mls">MLS: ${prop.mls_number || mlsNumber}</div>
                            
                            <div class="property-detail-specs">
                                ${details.bedrooms && details.bedrooms !== 'N/A' ? `
                                    <div class="property-spec-item">
                                        <div class="property-spec-icon"></div>
                                        <div>
                                            <div class="property-spec-label">Bedrooms</div>
                                            <div class="property-spec-value">${details.bedrooms}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${details.bathrooms && details.bathrooms !== 'N/A' ? `
                                    <div class="property-spec-item">
                                        <div class="property-spec-icon"></div>
                                        <div>
                                            <div class="property-spec-label">Bathrooms</div>
                                            <div class="property-spec-value">${details.bathrooms}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${details.sqft && details.sqft !== 'N/A' ? `
                                    <div class="property-spec-item">
                                        <div class="property-spec-icon"></div>
                                        <div>
                                            <div class="property-spec-label">Square Feet</div>
                                            <div class="property-spec-value">${formatNumber(details.sqft)}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${details.property_type ? `
                                    <div class="property-spec-item">
                                        <div class="property-spec-icon"></div>
                                        <div>
                                            <div class="property-spec-label">Type</div>
                                            <div class="property-spec-value">${details.property_type}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${details.lot_size && details.lot_size !== 'N/A' ? `
                                    <div class="property-spec-item">
                                        <div class="property-spec-icon"></div>
                                        <div>
                                            <div class="property-spec-label">Lot Size</div>
                                            <div class="property-spec-value">${details.lot_size}</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${details.year_built && details.year_built !== 'N/A' ? `
                                    <div class="property-spec-item">
                                        <div class="property-spec-icon"></div>
                                        <div>
                                            <div class="property-spec-label">Year Built</div>
                                            <div class="property-spec-value">${details.year_built}</div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${prop.description ? `
                                <div class="property-detail-description">
                                    <strong>Description:</strong><br>
                                    ${prop.description}
                                </div>
                            ` : ''}
                            
                            ${prop.features && prop.features.length > 0 ? `
                                <div class="property-detail-features">
                                    <strong>Features:</strong>
                                    <ul style="margin: 8px 0; padding-left: 20px; list-style: disc;">
                                        ${prop.features.map(f => `<li style="margin: 4px 0;">${f}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${images.length > 1 ? `
                                <div class="property-detail-gallery">
                                    <strong>Photo Gallery (${images.length} photos):</strong>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 8px;">
                                        ${images.slice(1, 5).map((img, idx) => `
                                            <img src="${img}" alt="Property photo ${idx + 2}" 
                                                 style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer;"
                                                 onerror="this.style.display='none'">
                                        `).join('')}
                                    </div>
                                    ${images.length > 5 ? `
                                        <div style="text-align: center; margin-top: 8px; color: var(--color-text-secondary); font-size: 14px;">
                                            + ${images.length - 5} more photos
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            ${prop.agent && prop.agent.name !== 'N/A' ? `
                                <div class="property-detail-agent" style="margin-top: 16px; padding: 12px; background: var(--color-bg-secondary); border-radius: 8px;">
                                    <strong>Listing Agent:</strong><br>
                                    <div style="margin-top: 8px;">
                                        <div> ${prop.agent.name}</div>
                                        ${prop.agent.phone !== 'N/A' ? `<div> ${prop.agent.phone}</div>` : ''}
                                        ${prop.agent.email !== 'N/A' ? `<div> ${prop.agent.email}</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="property-detail-actions">
                                <button class="btn-primary" onclick="openPropertyDetailsPanel('${mlsNumber}');">
                                     View Details
                                </button>
                                <button class="btn-primary" onclick="openAIAnalysisPanel('${mlsNumber}', 'property');">
                                     AI Analysis
                                </button>
                                <button class="btn-primary" onclick="openMarketAnalysisCenterPanel('${mlsNumber}', { city: '${address.city || 'Toronto'}', mls_number: '${mlsNumber}', address: ${JSON.stringify(address).replace(/'/g, '&apos;')} });">
                                     Market Analysis
                                </button>
                            </div>
                            <div class="property-detail-actions" style="margin-top: 12px;">
                                <button class="btn-secondary" onclick="sendMessage('Calculate ROI for MLS ${mlsNumber}'); closePropertyDetailsPanel();">
                                     Calculate ROI
                                </button>
                                <button class="btn-secondary" onclick="sendMessage('Schedule a viewing for ${mlsNumber}'); closePropertyDetailsPanel();">
                                     Schedule Viewing
                                </button>
                                <button class="btn-secondary" onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}', '_blank')">
                                     View on Map
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Show error state
                    panelBody.innerHTML = `
                        <div class="property-detail-loading">
                            <div style="font-size: 48px; margin-bottom: 20px;"></div>
                            <div style="font-size: 18px; font-weight: 600; color: var(--color-text); margin-bottom: 12px;">
                                Property Not Found
                            </div>
                            <div style="font-size: 14px; color: var(--color-text-secondary); margin-bottom: 24px;">
                                Unable to load details for MLS: ${mlsNumber}
                            </div>
                            <button class="btn-secondary" onclick="closePropertyDetailsPanel()">Close</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(' Error loading property details:', error);
                panelBody.innerHTML = `
                    <div class="property-detail-loading">
                        <div style="font-size: 48px; margin-bottom: 20px;"></div>
                        <div style="font-size: 18px; font-weight: 600; color: var(--color-text); margin-bottom: 12px;">
                            Error Loading Details
                        </div>
                        <div style="font-size: 14px; color: var(--color-text-secondary); margin-bottom: 24px;">
                            ${error.message}
                        </div>
                        <button class="btn-secondary" onclick="closePropertyDetailsPanel()">Close</button>
                    </div>
                `;
            }
        }

        /**
         * Close Property Details Panel
         */
        function closePropertyDetailsPanel() {
            const panel = document.getElementById('propertyDetailsPanel');
            panel.classList.remove('open');
        }

        async function calculateROI(mlsNumber) {
            sendMessage(`Calculate the investment ROI for MLS ${mlsNumber}`);
        }

        function scheduleViewing(propertyId) {
            const message = `I would like to schedule a viewing for property ${propertyId}`;
            sendMessage(message);
            showToast('Viewing request sent!', 'success');
        }

        function toggleFavorite(propertyId) {
            // TODO: Implement favorites
            showToast('Added to favorites!', 'success');
        }

        /**
         * Property Search with Filters
         */
        async function searchProperties(query, filters = {}) {
            try {
                showLoadingOverlay('Searching properties...');
                
                const response = await api.repliersNLPSearch(query, filters);
                hideLoadingOverlay();
                
                if (response.success && response.properties) {
                    const resultsHTML = renderSearchResults(response.properties, query);
                    addMessage('ai', resultsHTML);
                    showToast(`Found ${response.properties.length} properties`, 'success');
                } else {
                    addMessage('ai', 'No properties found matching your criteria. Try adjusting your search.');
                }
            } catch (error) {
                hideLoadingOverlay();
                showToast('Search failed', 'error');
                addMessage('ai', 'Sorry, the search service is temporarily unavailable.');
            }
        }

        /**
         * Location Insights
         */
        async function getLocationInsights(location) {
            try {
                showLoadingOverlay('Analyzing neighborhood...');
                
                const response = await api.locationInsights(location);
                hideLoadingOverlay();
                
                if (response.success && response.insights) {
                    const mapHTML = renderLocationMap(response.insights);
                    addMessage('ai', mapHTML);
                } else {
                    addMessage('ai', `Here's what I know about ${location}...`);
                }
            } catch (error) {
                hideLoadingOverlay();
                addMessage('ai', 'Location analysis is currently unavailable.');
            }
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }

        /**
         * Scroll to bottom of chat - with option to prevent scroll for property results
         * @param {boolean} force - Set to false to prevent scrolling (e.g., for property cards)
         */
        function scrollToBottom(force = true) {
            if (!force) return; // Don't scroll for property results
            
            const container = document.getElementById('chatContainer');
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }

        /**
         * Scroll to top of results - used when displaying property cards
         */
        function scrollToResultsTop() {
            const container = document.getElementById('chatContainer');
            if (!container) return;
            
            // Find the last message (property results)
            const messages = container.querySelectorAll('.message');
            const lastMessage = messages[messages.length - 1];
            
            if (lastMessage) {
                // Smooth scroll to the start of the results
                lastMessage.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // ==================== MANAGER DASHBOARD ====================

        /**
         * Toggle Dashboard View
         */
        async function toggleDashboard() {
            const sidebar = document.getElementById('sidebar');
            const chatContainer = document.getElementById('chatContainer');
            
            if (appState.viewMode === 'dashboard') {
                // Switch back to chat
                appState.setViewMode('chat');
                loadDashboard(false);
            } else {
                // Switch to dashboard
                appState.setViewMode('dashboard');
                await loadDashboard(true);
            }
        }

        /**
         * Load Manager Dashboard
         */
        async function loadDashboard(show = true) {
            if (!show) {
                // Return to chat view
                location.reload();
                return;
            }

            try {
                showLoadingOverlay('Loading dashboard...');
                
                const [statsResponse, leadsResponse, brokersResponse] = await Promise.all([
                    api.getDashboardStats(),
                    api.getLeads(),
                    api.getBrokers()
                ]);
                
                hideLoadingOverlay();

                const chatContainer = document.getElementById('chatContainer');
                chatContainer.innerHTML = renderDashboard(statsResponse, leadsResponse, brokersResponse);
                
            } catch (error) {
                hideLoadingOverlay();
                showToast('Failed to load dashboard', 'error');
                console.error('Dashboard error:', error);
            }
        }

        /**
         * Render Dashboard HTML
         */
        function renderDashboard(stats, leads, brokers) {
            return `
                <div class="manager-dashboard-view" style="padding: 24px;">
                    <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
                        <div>
                            <h2 style="margin: 0 0 8px 0;">Lead Management Dashboard</h2>
                            <p style="color: var(--color-text-secondary); margin: 0;">Monitor and manage your real estate leads</p>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="exportLeads()" class="btn-small"> Export Excel</button>
                            <button onclick="toggleDashboard()" class="btn-small"> Back to Chat</button>
                        </div>
                    </div>
                    
                    <div class="dashboard-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
                        <div class="stat-card">
                            <div class="stat-value">${stats.total_leads || 0}</div>
                            <div class="stat-label">Total Leads</div>
                            <div class="stat-sublabel" style="color: var(--color-success);">+12% this week</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.active_leads || 0}</div>
                            <div class="stat-label">Active Leads</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${brokers.brokers?.length || 0}</div>
                            <div class="stat-label">Active Brokers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round((stats.conversion_rate || 0) * 100)}%</div>
                            <div class="stat-label">Conversion Rate</div>
                        </div>
                    </div>
                    
                    <div class="leads-section" style="background: var(--color-surface); border-radius: var(--radius-lg); padding: 24px;">
                        <h3 style="margin: 0 0 20px 0;">Recent Leads</h3>
                        <div class="leads-table-container" style="overflow-x: auto;">
                            <table class="leads-table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid var(--color-border);">
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Name</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Email</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Status</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Broker</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Date</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${leads.leads?.map(lead => `
                                        <tr style="border-bottom: 1px solid var(--color-border);">
                                            <td style="padding: 12px;">${lead.name || 'N/A'}</td>
                                            <td style="padding: 12px;">${lead.email || 'N/A'}</td>
                                            <td style="padding: 12px;">
                                                <select onchange="updateLeadStatus(${lead.id}, this.value)" style="padding: 6px 12px; border: 1px solid var(--color-border); border-radius: 6px;">
                                                    <option value="New" ${lead.status === 'New' ? 'selected' : ''}>New</option>
                                                    <option value="Contacted" ${lead.status === 'Contacted' ? 'selected' : ''}>Contacted</option>
                                                    <option value="Qualified" ${lead.status === 'Qualified' ? 'selected' : ''}>Qualified</option>
                                                    <option value="Converted" ${lead.status === 'Converted' ? 'selected' : ''}>Converted</option>
                                                    <option value="Lost" ${lead.status === 'Lost' ? 'selected' : ''}>Lost</option>
                                                </select>
                                            </td>
                                            <td style="padding: 12px;">
                                                <select onchange="assignBrokerToLead(${lead.id}, this.value)" style="padding: 6px 12px; border: 1px solid var(--color-border); border-radius: 6px;">
                                                    <option value="">Unassigned</option>
                                                    ${brokers.brokers?.map(broker => `
                                                        <option value="${broker.id}" ${lead.assigned_broker === broker.name ? 'selected' : ''}>
                                                            ${broker.name}
                                                        </option>
                                                    `).join('') || ''}
                                                </select>
                                            </td>
                                            <td style="padding: 12px; color: var(--color-text-secondary);">${lead.date || 'N/A'}</td>
                                            <td style="padding: 12px;">
                                                <button onclick="viewLeadDetails(${lead.id})" class="btn-small">View</button>
                                            </td>
                                        </tr>
                                    `).join('') || '<tr><td colspan="6" style="padding: 24px; text-align: center; color: var(--color-text-secondary);">No leads found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Update Lead Status
         */
        async function updateLeadStatus(leadId, status) {
            try {
                const response = await api.updateLeadStatus(leadId, status);
                if (response.success) {
                    showToast(`Lead status updated to ${status}`, 'success');
                }
            } catch (error) {
                showToast('Failed to update status', 'error');
            }
        }

        /**
         * Assign Broker to Lead
         */
        async function assignBrokerToLead(leadId, brokerId) {
            if (!brokerId) return;
            
            try {
                const response = await api.assignBroker(leadId, parseInt(brokerId));
                if (response.success) {
                    showToast('Broker assigned successfully', 'success');
                }
            } catch (error) {
                showToast('Failed to assign broker', 'error');
            }
        }

        function viewLeadDetails(leadId) {
            showToast('Lead details view coming soon', 'info');
        }

        function exportLeads() {
            showToast('Exporting leads to Excel...', 'info');
            // API call would go here
        }

        // Property Actions (Legacy support)
        function viewProperty(id) {
            viewPropertyDetails(id);
        }

        function analyzeProperty(id) {
            calculateROI(id);
        }

        // Voice Functions
        function openVoiceModal() {
            document.getElementById('voiceModal').classList.add('active');
        }

        function closeVoiceModal() {
            document.getElementById('voiceModal').classList.remove('active');
            if (isRecording) toggleVoiceRecording();
        }

        function toggleVoiceRecording() {
            isRecording = !isRecording;
            const btn = event.target;
            if (isRecording) {
                btn.textContent = ' Stop Recording';
                btn.style.background = 'var(--color-error)';
            } else {
                btn.textContent = ' Start Recording';
                btn.style.background = 'var(--color-primary)';
                closeVoiceModal();
                // Simulate voice to text
                setTimeout(() => {
                    sendMessage('Show me 2-bedroom condos in downtown Toronto under $800K');
                }, 500);
            }
        }

        // Other Functions
        function uploadFile() {
            alert('File upload feature - Connect to your backend /upload endpoint');
        }

        function showFileUpload() {
            alert('File attachment feature - Connect to your backend');
        }

        function startNewChat() {
            if (confirm('Start a new conversation? Current chat will be saved.')) {
                chatHistory = [];
                document.getElementById('chatContainer').innerHTML = `
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon"></div>
                        <h1 class="welcome-title" id="welcomeTitle">Welcome ${getUserName()} to Your AI Real Estate Assistant</h1>
                        <p class="welcome-subtitle">
                            Powered by Llama 3.2 and Exa AI with live market data. Ask anything about Canadian real estate.
                        </p>
                    </div>
                `;
                currentSessionId = generateSessionId();
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
        }

        function showSettings() {
            alert('Settings panel - Configure voice preferences, broker selection, notification settings');
        }

        // ==================== PRODUCTION INITIALIZATION ====================
        
        /**
         * Initialize production-ready Summitly frontend
         */
        function initProduction() {
            console.log(' Summitly Production Frontend Initializing...');
            
            // Run original initialization
            init();
            
            // Test API connectivity
            testApiConnectivity();
            
            // Setup keyboard shortcuts
            setupKeyboardShortcuts();
            
            console.log(' Summitly Production Frontend Ready!');
        }
        
        /**
         * Test API connectivity and show status
         */
        async function testApiConnectivity() {
            try {
                // Try a simple health check first
                const response = await fetch(`${getApiBaseUrl()}/health`, { 
                    method: 'GET'
                }).catch(() => {
                    // If /health doesn't exist, try root endpoint
                    return fetch(getApiBaseUrl(), { method: 'GET' });
                });
                
                console.log(' API connection successful');
                updateConnectionStatus('connected');
            } catch (error) {
                console.error(' API connection failed:', error);
                updateConnectionStatus('disconnected');
            }
        }
        
        /**
         * Update connection status indicator
         */
        function updateConnectionStatus(status) {
            const statusDot = document.querySelector('.status-dot');
            const statusBadge = document.querySelector('.status-badge');
            
            if (statusDot && statusBadge) {
                switch (status) {
                    case 'connected':
                        statusDot.style.background = 'var(--color-success)';
                        statusBadge.innerHTML = '<div class="status-dot"></div>AI Connected';
                        break;
                    case 'warning':
                        statusDot.style.background = 'var(--color-warning)';
                        statusBadge.innerHTML = '<div class="status-dot"></div>Limited Service';
                        break;
                    case 'disconnected':
                        statusDot.style.background = 'var(--color-error)';
                        statusBadge.innerHTML = '<div class="status-dot"></div>Connecting...';
                        break;
                }
            }
        }
        
        /**
         * Setup keyboard shortcuts for better UX
         */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + Enter to send message
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    const input = document.querySelector('.message-input');
                    if (input && input.value.trim()) {
                        sendMessage(input.value.trim());
                        input.value = '';
                    }
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
        }

        // ==================== NEW INTENT ENDPOINT FUNCTIONS ====================
        
        /**
         * Calculate ROI and investment analysis for a property
         */
        async function calculatePropertyROI(mlsNumber, purchasePrice = null) {
            const price = purchasePrice || prompt('Enter purchase price:', '');
            if (!price) return;
            
            const downPayment = prompt('Enter down payment percentage (default 20):', '20');
            const rentalIncome = prompt('Enter expected monthly rental income:', '');
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/roi-analysis`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mls_number: mlsNumber,
                        purchase_price: parseInt(price),
                        down_payment: parseInt(downPayment || 20),
                        rental_income: parseInt(rentalIncome || 0),
                        session_id: currentSessionId
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessage('ai', data.response, {
                        quickReplies: data.quick_replies || []
                    });
                } else {
                    showToast('Error calculating ROI: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('ROI calculation error:', error);
                showToast('Failed to calculate ROI', 'error');
            }
        }
        
        /**
         * Calculate mortgage payments and affordability
         */
        async function calculateMortgage(purchasePrice = null) {
            const price = purchasePrice || prompt('Enter purchase price:', '');
            if (!price) return;
            
            const downPayment = prompt('Enter down payment percentage (default 20):', '20');
            const interestRate = prompt('Enter interest rate (default 5.25):', '5.25');
            const annualIncome = prompt('Enter annual income (optional):', '');
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/mortgage-calculator`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        purchase_price: parseInt(price),
                        down_payment: parseInt(downPayment || 20),
                        interest_rate: parseFloat(interestRate || 5.25),
                        annual_income: annualIncome ? parseInt(annualIncome) : null,
                        session_id: currentSessionId
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessage('ai', data.response, {
                        quickReplies: data.quick_replies || []
                    });
                } else {
                    showToast('Error calculating mortgage: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Mortgage calculation error:', error);
                showToast('Failed to calculate mortgage', 'error');
            }
        }
        
        /**
         * Compare multiple properties side by side
         */
        async function compareProperties(propertyIds) {
            if (!propertyIds || propertyIds.length < 2) {
                showToast('Select at least 2 properties to compare', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/property-comparison`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        property_ids: propertyIds,
                        session_id: currentSessionId
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessage('ai', data.response, {
                        quickReplies: data.quick_replies || []
                    });
                } else {
                    showToast('Error comparing properties: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Property comparison error:', error);
                showToast('Failed to compare properties', 'error');
            }
        }
        
        /**
         * Create property alert with search criteria
         */
        async function createPropertyAlert(criteria = null) {
            let searchCriteria = criteria;
            
            if (!searchCriteria) {
                const location = prompt('Enter location (e.g., Toronto, Mississauga):', 'Toronto');
                const maxPrice = prompt('Enter maximum price:', '1000000');
                const minBedrooms = prompt('Enter minimum bedrooms (optional):', '');
                const propertyType = prompt('Enter property type (condo, house, townhouse, or any):', 'any');
                
                searchCriteria = {
                    location: location,
                    max_price: parseInt(maxPrice),
                    bedrooms: minBedrooms ? parseInt(minBedrooms) : null,
                    property_type: propertyType
                };
            }
            
            const alertName = prompt('Name this alert:', `Properties in ${searchCriteria.location}`);
            if (!alertName) return;
            
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/property-alerts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        alert_name: alertName,
                        criteria: searchCriteria,
                        user_id: 'user_' + currentSessionId,
                        session_id: currentSessionId
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessage('ai', data.response, {
                        quickReplies: data.quick_replies || []
                    });
                } else {
                    showToast('Error creating alert: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Property alert error:', error);
                showToast('Failed to create property alert', 'error');
            }
        }
        
        /**
         * View current offers and incentives
         */
        async function viewCurrentOffers() {
            try {
                const response = await fetch(`${getApiBaseUrl()}/api/offers-incentives`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessage('ai', data.response, {
                        quickReplies: data.quick_replies || []
                    });
                } else {
                    showToast('Error fetching offers: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Offers error:', error);
                showToast('Failed to fetch current offers', 'error');
            }
        }
        
        /**
         * View properties for specific offer
         */
        function viewOfferProperties(offerId) {
            sendMessage(`Show me properties available for offer: ${offerId}`);
        }
        
        /**
         * Modify existing alert
         */
        function modifyAlert(alertId) {
            sendMessage(`Modify my property alert ${alertId}`);
        }
        
        /**
         * Search properties now with current criteria
         */
        function searchPropertiesNow() {
            sendMessage('Show me properties matching my saved criteria');
        }
        
        /**
         * Enhanced property actions - add to existing cards
         */
        function addPropertyActionButtons(propertyCard, mlsNumber) {
            const existingActions = propertyCard.querySelector('.property-actions');
            if (existingActions) {
                const newButtons = `
                    <button class="btn-small btn-secondary" onclick="calculatePropertyROI('${mlsNumber}')" title="Calculate ROI">
                         ROI
                    </button>
                    <button class="btn-small btn-secondary" onclick="calculateMortgage()" title="Mortgage Calculator">
                         Mortgage
                    </button>
                    <button class="btn-small btn-secondary" onclick="saveProperty('${mlsNumber}')" title="Save Property">
                         Save
                    </button>
                `;
                existingActions.insertAdjacentHTML('beforeend', newButtons);
            }
        }
        
        /**
         * Save property for later
         */
        function saveProperty(mlsNumber) {
            // In production, this would save to user's favorites
            showToast('Property saved to your favorites!', 'success');
            sendMessage(`Save property ${mlsNumber} to my favorites`);
        }
        
        /**
         * Enhanced property search with all filters
         */
        function searchPropertiesAdvanced() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
                <div class="modal-content" style="max-width: 600px;">
                    <h2 style="margin: 0 0 20px 0;">Advanced Property Search</h2>
                    <form id="advancedSearchForm" style="display: grid; gap: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Location</label>
                                <input type="text" name="location" placeholder="Toronto, Mississauga, etc." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Property Type</label>
                                <select name="property_type" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Any</option>
                                    <option value="condo">Condo</option>
                                    <option value="house">House</option>
                                    <option value="townhouse">Townhouse</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Min Price</label>
                                <input type="number" name="min_price" placeholder="500000" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Max Price</label>
                                <input type="number" name="max_price" placeholder="1000000" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Bedrooms</label>
                                <select name="bedrooms" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Any</option>
                                    <option value="1">1+</option>
                                    <option value="2">2+</option>
                                    <option value="3">3+</option>
                                    <option value="4">4+</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: 500;">Bathrooms</label>
                                <select name="bathrooms" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    <option value="">Any</option>
                                    <option value="1">1+</option>
                                    <option value="2">2+</option>
                                    <option value="3">3+</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 12px; margin-top: 20px;">
                            <button type="submit" style="flex: 1; padding: 12px; background: var(--color-primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                 Search Properties
                            </button>
                            <button type="button" onclick="this.closest('.modal').remove()" style="padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('advancedSearchForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const criteria = Object.fromEntries(formData.entries());
                
                // Build search query
                let query = 'Show me ';
                if (criteria.bedrooms) query += `${criteria.bedrooms} bedroom `;
                if (criteria.property_type) query += `${criteria.property_type}s `;
                else query += 'properties ';
                if (criteria.location) query += `in ${criteria.location} `;
                if (criteria.min_price && criteria.max_price) {
                    query += `priced between $${criteria.min_price} and $${criteria.max_price}`;
                } else if (criteria.max_price) {
                    query += `under $${criteria.max_price}`;
                } else if (criteria.min_price) {
                    query += `over $${criteria.min_price}`;
                }
                
                modal.remove();
                sendMessage(query.trim());
            });
        }
        
        // Initialize production version on load
        window.addEventListener('load', initProduction);
    </script>
</body>
</html>

